<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Travel Buddy V16</title>
    
    <!-- 1. éŒ¯èª¤åµæ¸¬å™¨ -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            if (msg.includes("ResizeObserver")) return false;
            alert("âš ï¸ ç™¼ç”ŸéŒ¯èª¤ï¼š\n" + msg + "\nç¬¬ " + line + " è¡Œ");
            return false;
        };
    </script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Zen+Maru+Gothic:wght@500;700&display=swap" rel="stylesheet">

    <style>
        /* iOS Safe Area & Full Height Fix */
        html, body { height: 100%; overscroll-behavior: none; }
        body { 
            background-color: #FDFCF8;
            height: 100dvh; 
            display: flex;
            flex-direction: column;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        #map-container { height: 100%; width: 100%; position: absolute; top: 0; left: 0; z-index: 0; }
        #modal-map { height: 200px; width: 100%; z-index: 1; }
        
        .calc-btn { @apply bg-gray-50 rounded-xl p-3 text-lg font-bold text-gray-600 active:bg-gray-200 transition-colors shadow-sm border border-gray-100; }
        .calc-btn-op { @apply bg-orange-50 text-orange-500 border-orange-100; }
        .calc-btn-eq { @apply bg-coffee text-white border-coffee active:bg-gray-700 text-2xl; }
    </style>

    <!-- Firebase SDKs -->
    <script type="module">
        import { createApp, ref, computed, onMounted, nextTick, watch } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getDatabase, ref as dbRef, set, onValue, update, push } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';

        // -----------------------------------------------------------
        // âœ… å·²ä¿®æ­£ Key
        // -----------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyDFUGYOobmVxYfQMBYz1iq4z1HlrdbTi8Q",
            authDomain: "travel-55c4b.firebaseapp.com",
            databaseURL: "https://travel-55c4b-default-rtdb.firebaseio.com",
            projectId: "travel-55c4b",
            storageBucket: "travel-55c4b.firebasestorage.app",
            messagingSenderId: "925227625640",
            appId: "1:925227625640:web:bdc242cbddf8e1d6f8a69d",
            measurementId: "G-K1B4N26V1T"
        };
        // -----------------------------------------------------------

        let appInstance, dbInstance;
        try {
            appInstance = initializeApp(firebaseConfig);
            dbInstance = getDatabase(appInstance);
        } catch (e) {
            alert("Firebase é€£ç·šå¤±æ•—ï¼š" + e.message);
        }

        tailwind.config = {
            theme: {
                extend: {
                    colors: { milk: '#FDFCF8', coffee: '#4A3B32', latte: '#D4A373', mocha: '#9C6644', cream: '#F3EFE0', skyblue: '#E0F2FE' },
                    fontFamily: { sans: ['Zen Maru Gothic', 'Noto Sans TC', 'sans-serif'] }
                }
            }
        }

        const CITY_DB = {
            'tokyo': { c: 'JPY', l: 'ja', f: 'ğŸ‡¯ğŸ‡µ' }, 'japan': { c: 'JPY', l: 'ja', f: 'ğŸ‡¯ğŸ‡µ' },
            'seoul': { c: 'KRW', l: 'ko', f: 'ğŸ‡°ğŸ‡·' }, 'korea': { c: 'KRW', l: 'ko', f: 'ğŸ‡°ğŸ‡·' },
            'london': { c: 'GBP', l: 'en', f: 'ğŸ‡¬ğŸ‡§' }, 'uk': { c: 'GBP', l: 'en', f: 'ğŸ‡¬ğŸ‡§' },
            'bangkok': { c: 'THB', l: 'th', f: 'ğŸ‡¹ğŸ‡­' }, 'thailand': { c: 'THB', l: 'th', f: 'ğŸ‡¹ğŸ‡­' },
            'vietnam': { c: 'VND', l: 'vi', f: 'ğŸ‡»ğŸ‡³' }, 'new zealand': { c: 'NZD', l: 'en', f: 'ğŸ‡³ğŸ‡¿' },
            'usa': { c: 'USD', l: 'en', f: 'ğŸ‡ºğŸ‡¸' }, 'taiwan': { c: 'TWD', l: 'zh-TW', f: 'ğŸ‡¹ğŸ‡¼' }
        };

        const DEFAULT_CHECKLIST = [{ id: 1, text: 'è­·ç…§', checked: false }, { id: 2, text: 'ç¶²å¡/Wi-Fi', checked: false }];

        createApp({
            setup() {
                // UI & State
                const pageState = ref('landing'); 
                const savedTrips = ref([]);
                const activeTab = ref('itinerary');
                const viewMode = ref('list');
                const showMenu = ref(false); 
                const showSettings = ref(false);
                const isLoading = ref(false);
                const isSyncing = ref(true);
                const tripId = ref('');
                const wizardStep = ref(1);
                const wizardData = ref({ destination: '', currency: 'TWD', rate: 1, lang: 'en', flag: 'âœˆï¸' });

                // Data
                const days = ref([{ activities: [] }, { activities: [] }]); 
                const currentDayIndex = ref(0);
                const people = ref(['æˆ‘']);
                const expenses = ref([]);
                const exchangeRate = ref(1);
                const targetLang = ref('en');
                const targetCurrency = ref('USD');
                const tripTitle = ref('My Trip');
                const checklist = ref([]);
                const chatMessages = ref([]);
                const flightInfo = ref({ code: '', time: '' });
                const transportLinks = ref([]); 
                
                // V16: Favorites Data
                const favorites = ref([]); // [{id, title, places: []}]
                const viewingGroupId = ref(null); // ID of the group currently viewing
                
                // Forms
                const newPersonName = ref('');
                const useForeignCurrency = ref(false);
                const showActivityModal = ref(false);
                const showExpenseModal = ref(false);
                const showTranslateModal = ref(false);
                const showCalculatorModal = ref(false);
                const showImagePreview = ref(null);
                
                // V16: Favorites Modals
                const showGroupModal = ref(false);
                const showPlaceModal = ref(false);
                const formGroup = ref({ title: '' });
                const formPlace = ref({ id: null, name: '', location: '', lat: null, lng: null, notes: '' });
                
                const isEditing = ref(false);
                const formActivity = ref({ id: null, time: '10:00', title: '', location: '', notes: '', weather: null, lat: null, lng: null, image: null });
                const locationMode = ref('auto'); 
                const searchResultAddress = ref('');
                const searchResults = ref([]);
                
                const formExpense = ref({ title: '', inputAmount: '', payer: '' });
                const formChat = ref('');
                const chatImage = ref(null);
                const translateText = ref('');
                const translatedResult = ref('');
                const isTranslating = ref(false);
                
                const calcExpression = ref(''); 
                const newItemText = ref('');
                const joinIdInput = ref('');
                
                const newLinkTitle = ref('');
                const newLinkUrl = ref('');

                let map = null;
                let modalMap = null;
                let modalMarker = null;
                let markers = [];
                let userMarker = null;

                onMounted(() => {
                    try {
                        const localTrips = localStorage.getItem('mySavedTrips');
                        if (localTrips) savedTrips.value = JSON.parse(localTrips);
                        const urlParams = new URLSearchParams(window.location.search);
                        const id = urlParams.get('id');
                        if (id) loadTrip(id);
                        else pageState.value = 'landing';
                    } catch(e) { console.error(e); pageState.value = 'landing'; }
                });

                // --- V15 Search Logic (Reused for Places) ---
                const searchLocationGeneric = async (query, targetObj) => {
                    if (!query) return;
                    isLoading.value = true;
                    searchResults.value = [];
                    try {
                        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=5`);
                        const data = await res.json();
                        if (data && data.length > 0) searchResults.value = data;
                        else alert("æ‰¾ä¸åˆ°åœ°é»");
                    } catch (e) { alert("æœå°‹éŒ¯èª¤"); } 
                    finally { isLoading.value = false; }
                };

                const selectSearchResultGeneric = (result, targetObj) => {
                    targetObj.lat = parseFloat(result.lat);
                    targetObj.lng = parseFloat(result.lon);
                    const simpleName = result.display_name.split(',')[0];
                    targetObj.location = simpleName; // Update display name
                    searchResultAddress.value = result.display_name;
                    searchResults.value = [];
                };

                // Wrapper for Activity Search
                const searchLocation = () => searchLocationGeneric(formActivity.value.location, formActivity.value);
                const selectSearchResult = (r) => selectSearchResultGeneric(r, formActivity.value);

                // Wrapper for Place Search (V16)
                const searchPlaceLocation = () => searchLocationGeneric(formPlace.value.location, formPlace.value);
                const selectPlaceSearchResult = (r) => selectSearchResultGeneric(r, formPlace.value);

                // --- V16 Favorites Logic ---
                const addGroup = () => {
                    if(!formGroup.value.title) return;
                    favorites.value.push({ id: Date.now(), title: formGroup.value.title, places: [] });
                    formGroup.value.title = '';
                    showGroupModal.value = false;
                    saveToCloud();
                };

                const deleteGroup = (id) => {
                    if(confirm("ç¢ºå®šåˆªé™¤æ­¤ç¾¤çµ„ï¼Ÿ")) {
                        favorites.value = favorites.value.filter(g => g.id !== id);
                        saveToCloud();
                    }
                };

                const openGroup = (id) => { viewingGroupId.value = id; };
                const closeGroup = () => { viewingGroupId.value = null; };

                const openAddPlaceModal = () => {
                    formPlace.value = { id: Date.now(), name: '', location: '', lat: null, lng: null, notes: '' };
                    searchResults.value = [];
                    searchResultAddress.value = '';
                    showPlaceModal.value = true;
                };

                const savePlace = () => {
                    if(!formPlace.value.name) return;
                    const groupIndex = favorites.value.findIndex(g => g.id === viewingGroupId.value);
                    if(groupIndex !== -1) {
                        if(!favorites.value[groupIndex].places) favorites.value[groupIndex].places = [];
                        favorites.value[groupIndex].places.push({...formPlace.value});
                        saveToCloud();
                    }
                    showPlaceModal.value = false;
                };

                const deletePlace = (placeId) => {
                    const groupIndex = favorites.value.findIndex(g => g.id === viewingGroupId.value);
                    if(groupIndex !== -1) {
                        favorites.value[groupIndex].places = favorites.value[groupIndex].places.filter(p => p.id !== placeId);
                        saveToCloud();
                    }
                };

                // --- Calculator ---
                const appendCalc = (val) => {
                    const lastChar = calcExpression.value.slice(-1);
                    if (['+','-','*','/','.'].includes(val) && ['+','-','*','/','.'].includes(lastChar)) {
                        calcExpression.value = calcExpression.value.slice(0, -1) + val;
                        return;
                    }
                    calcExpression.value += val;
                };
                const clearCalc = () => calcExpression.value = '';
                const backspaceCalc = () => calcExpression.value = calcExpression.value.slice(0, -1);
                const calculateResult = () => {
                    try {
                        if (!calcExpression.value) return;
                        if (/[^0-9+\-*/.]/.test(calcExpression.value)) return;
                        const result = eval(calcExpression.value); 
                        calcExpression.value = String(result);
                    } catch (e) { calcExpression.value = 'Error'; setTimeout(() => calcExpression.value = '', 1000); }
                };
                const calcResultValue = computed(() => {
                    try {
                        if (!calcExpression.value) return 0;
                        if (/[^0-9+\-*/.]/.test(calcExpression.value)) return 0;
                        return eval(calcExpression.value) || 0;
                    } catch (e) { return 0; }
                });

                // --- Sync & Persistence ---
                const loadTrip = (id) => {
                    tripId.value = id;
                    const newUrl = `${window.location.pathname}?id=${id}`;
                    window.history.pushState({ path: newUrl }, '', newUrl);
                    pageState.value = 'app'; 
                    initSync(id);
                };

                const initSync = (id) => {
                    if (!dbInstance) return;
                    isSyncing.value = true;
                    const tripRef = dbRef(dbInstance, 'trips/' + id);
                    onValue(tripRef, (snapshot) => {
                        isSyncing.value = false;
                        const data = snapshot.val();
                        if (data) {
                            days.value = data.days || [{ activities: [] }];
                            people.value = data.people || ['æˆ‘'];
                            expenses.value = data.expenses || [];
                            exchangeRate.value = data.exchangeRate || 1;
                            targetLang.value = data.targetLang || 'en';
                            targetCurrency.value = data.targetCurrency || 'USD';
                            tripTitle.value = data.title || 'New Trip';
                            checklist.value = data.checklist || [...DEFAULT_CHECKLIST];
                            chatMessages.value = data.chatMessages ? Object.values(data.chatMessages) : [];
                            flightInfo.value = data.flightInfo || { code: '', time: '' };
                            transportLinks.value = data.transportLinks || [];
                            favorites.value = data.favorites || []; // V16 load
                            
                            if (viewMode.value === 'map' && activeTab.value === 'itinerary') {
                                setTimeout(() => { initMap(); updateMapMarkers(); }, 500);
                            }
                        } else {
                            alert("æ‰¾ä¸åˆ°è¡Œç¨‹");
                            pageState.value = 'landing';
                        }
                    });
                };

                const saveToCloud = () => {
                    if (!dbInstance) return;
                    update(dbRef(dbInstance, 'trips/' + tripId.value), {
                        days: days.value,
                        people: people.value,
                        expenses: expenses.value,
                        exchangeRate: exchangeRate.value,
                        title: tripTitle.value,
                        targetLang: targetLang.value,
                        targetCurrency: targetCurrency.value,
                        checklist: checklist.value,
                        flightInfo: flightInfo.value,
                        transportLinks: transportLinks.value,
                        favorites: favorites.value // V16 save
                    });
                    const existing = savedTrips.value.findIndex(t => t.id === tripId.value);
                    if (existing !== -1) savedTrips.value[existing].title = tripTitle.value;
                    else savedTrips.value.unshift({ id: tripId.value, title: tripTitle.value });
                    localStorage.setItem('mySavedTrips', JSON.stringify(savedTrips.value));
                };

                // --- Map Fix ---
                const initMap = () => {
                    const container = document.getElementById('map');
                    if (!container) return; 
                    if (map) { 
                        if(map.getContainer() !== container) { map.remove(); map = null; } 
                        else { map.invalidateSize(); return; }
                    }
                    map = L.map('map', {zoomControl: false}).setView([35,139], 13);
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);
                    L.control.zoom({ position: 'bottomright' }).addTo(map);
                };

                const updateMapMarkers = () => {
                    if(!map) return;
                    map.invalidateSize();
                    markers.forEach(m=>map.removeLayer(m));
                    markers=[];
                    const acts = sortedActivities.value;
                    const bounds = [];
                    acts.forEach(item => {
                        if(item.lat && item.lng){
                            const icon = L.divIcon({className: 'custom-div-icon', html: `<div style="background:#4A3B32;color:#fff;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;border:2px solid #fff;box-shadow:0 2px 5px rgba(0,0,0,0.3);">${item.time.split(':')[0]}</div>`, iconSize:[32,32], iconAnchor:[16,16]});
                            markers.push(L.marker([item.lat, item.lng], {icon}).addTo(map).bindPopup(item.title));
                            bounds.push([item.lat, item.lng]);
                        }
                    });
                    if(bounds.length>0) map.fitBounds(bounds, {padding:[50,50]});
                };

                watch(viewMode, (v) => { if (v === 'map') nextTick(() => { setTimeout(() => { initMap(); updateMapMarkers(); }, 100); }); });
                watch(activeTab, (t) => { if (t === 'itinerary' && viewMode.value === 'map') nextTick(() => { setTimeout(() => { initMap(); updateMapMarkers(); }, 300); }); });

                // --- Actions ---
                const createTrip = async () => {
                    const newId = Math.random().toString(36).substring(2, 8).toUpperCase();
                    const initialData = { days: [{activities:[]},{activities:[]}], people: ['æˆ‘'], expenses: [], exchangeRate: Number(wizardData.value.rate), targetCurrency: wizardData.value.currency.toUpperCase(), targetLang: wizardData.value.lang, title: tripTitle.value, checklist: [...DEFAULT_CHECKLIST], createdAt: Date.now() };
                    await set(dbRef(dbInstance, 'trips/' + newId), initialData);
                    loadTrip(newId);
                };
                
                const processImage = (file, callback) => {
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        const img = new Image();
                        img.onload = () => {
                            const cvs = document.createElement('canvas');
                            const ctx = cvs.getContext('2d');
                            const scale = Math.min(1, 800 / img.width);
                            cvs.width = img.width * scale; cvs.height = img.height * scale;
                            ctx.drawImage(img, 0, 0, cvs.width, cvs.height);
                            callback(cvs.toDataURL('image/jpeg', 0.7));
                        }; img.src = ev.target.result;
                    }; reader.readAsDataURL(file);
                };

                const changeDay = (idx) => { currentDayIndex.value = idx; };
                
                const addDay = () => { days.value.push({ activities: [] }); changeDay(days.value.length - 1); saveToCloud(); };

                const deleteLocalTrip = (idx) => {
                    if(confirm("ç¢ºå®šç§»é™¤æ­¤è¡Œç¨‹ï¼Ÿ(é›²ç«¯è³‡æ–™ä¸æœƒåˆªé™¤)")) {
                        savedTrips.value.splice(idx, 1);
                        localStorage.setItem('mySavedTrips', JSON.stringify(savedTrips.value));
                    }
                };

                const backToLanding = () => { tripId.value = ''; window.history.pushState({ path: window.location.pathname }, '', window.location.pathname); pageState.value = 'landing'; };
                const joinTrip = () => { if(joinIdInput.value) loadTrip(joinIdInput.value); };
                const locateUser = () => { if (!map) return; navigator.geolocation.getCurrentPosition(p=>{ if(userMarker) map.removeLayer(userMarker); userMarker = L.circleMarker([p.coords.latitude, p.coords.longitude], {radius:8, fillColor:"#3B82F6", color:"#fff", weight:2, fillOpacity:1}).addTo(map); map.setView([p.coords.latitude, p.coords.longitude], 15); }); };
                const saveCurrentLocation = () => { isLoading.value = true; navigator.geolocation.getCurrentPosition(async (p) => { formActivity.value.lat = p.coords.latitude; formActivity.value.lng = p.coords.longitude; locationMode.value = 'manual'; searchResultAddress.value = "å·²å®šä½åˆ°ç›®å‰ä½ç½®"; try { const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${p.coords.latitude}&lon=${p.coords.longitude}`); const data = await res.json(); if(data && data.display_name) formActivity.value.location = data.display_name.split(',')[0]; } catch(e){} isLoading.value = false; }, () => { alert("ç„¡æ³•å®šä½"); isLoading.value=false; }); };
                const startWizard = () => { pageState.value = 'wizard'; wizardStep.value = 1; };
                const detectDestination = async () => { if(!wizardData.value.destination) return; let key = wizardData.value.destination.toLowerCase(); if(key.includes('ç´è¥¿è˜­')) key='nz'; if(key.includes('æ±äº¬')) key='tokyo'; const info = CITY_DB[key] || { c:'USD', l:'en', f:'âœˆï¸' }; wizardData.value.currency=info.c; wizardData.value.lang=info.l; wizardData.value.flag=info.f; tripTitle.value = `${wizardData.value.destination}ä¹‹æ—…`; wizardStep.value=2; };
                const openAddModal = () => { if(activeTab.value==='itinerary') { isEditing.value=false; formActivity.value={id:Date.now(),time:'10:00',title:'',location:'',image:null}; locationMode.value='auto'; searchResults.value=[]; searchResultAddress.value=''; showActivityModal.value=true; } else if(activeTab.value==='expenses') { formExpense.value={title:'',inputAmount:'',payer:people.value[0]}; useForeignCurrency.value=false; showExpenseModal.value=true; } };
                
                // Map inside modal
                const initModalMap = () => {
                    if (modalMap) { modalMap.invalidateSize(); return; }
                    modalMap = L.map('modal-map', {zoomControl:false}).setView([35.6895, 139.6917], 13);
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(modalMap);
                    modalMarker = L.marker([35.6895, 139.6917], {draggable: true}).addTo(modalMap);
                    modalMarker.on('dragend', function(e){ const p = e.target.getLatLng(); formActivity.value.lat=p.lat; formActivity.value.lng=p.lng; modalMap.panTo(p); });
                    modalMap.on('click', function(e) { modalMarker.setLatLng(e.latlng); formActivity.value.lat=e.latlng.lat; formActivity.value.lng=e.latlng.lng; });
                };

                watch(locationMode, (v) => {
                    if (v === 'manual') {
                        nextTick(() => {
                            initModalMap();
                            setTimeout(() => {
                                modalMap.invalidateSize();
                                if(formActivity.value.lat) {
                                    const ll = [formActivity.value.lat, formActivity.value.lng];
                                    modalMarker.setLatLng(ll); modalMap.setView(ll, 15);
                                }
                            }, 300);
                        });
                    }
                });

                const saveActivity = async () => { if (!formActivity.value.title) return; if (locationMode.value === 'auto' && formActivity.value.location && !formActivity.value.lat) { await searchLocation(); } const targetDay = days.value[currentDayIndex.value]; if(isEditing.value) { const idx = targetDay.activities.findIndex(a=>a.id===formActivity.value.id); if(idx!==-1) targetDay.activities[idx]={...formActivity.value}; } else targetDay.activities.push({...formActivity.value}); showActivityModal.value=false; saveToCloud(); if(viewMode.value==='map') setTimeout(()=>updateMapMarkers(),500); };
                const saveExpense = () => { let amt = formExpense.value.inputAmount; let orig = null; if(useForeignCurrency.value){ orig=`${amt} ${targetCurrency.value}`; amt=Math.round(amt*exchangeRate.value); } expenses.value.unshift({id:Date.now(), title:formExpense.value.title, amount:amt, originalAmount:orig, payer:formExpense.value.payer, date:new Date().toLocaleDateString()}); showExpenseModal.value=false; saveToCloud(); };
                const deleteActivity = (id) => { days.value[currentDayIndex.value].activities = days.value[currentDayIndex.value].activities.filter(a=>a.id!==id); saveToCloud(); if(viewMode.value==='map') setTimeout(()=>updateMapMarkers(),500); };
                const deleteExpense = (id) => { expenses.value = expenses.value.filter(e=>e.id!==id); saveToCloud(); };
                const sendMessage = () => { if(!formChat.value.trim() && !chatImage.value) return; push(dbRef(dbInstance, 'trips/'+tripId.value+'/chatMessages'), {user:people.value[0], text:formChat.value, image:chatImage.value, time:new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}); formChat.value=''; chatImage.value=null; };
                const addCheckItem = () => { if(newItemText.value) { checklist.value.push({id:Date.now(), text:newItemText.value, checked:false}); newItemText.value=''; saveToCloud(); }};
                const toggleCheck = (id) => { const i = checklist.value.find(x=>x.id===id); if(i) i.checked=!i.checked; saveToCloud(); };
                const deleteCheckItem = (id) => { checklist.value=checklist.value.filter(x=>x.id!==id); saveToCloud(); };
                const performTranslation = async () => { if (!translateText.value) return; isTranslating.value = true; translatedResult.value = ''; try { const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(translateText.value)}&langpair=zh-TW|${targetLang.value}`); const data = await res.json(); if (data && data.responseData) translatedResult.value = data.responseData.translatedText; else translatedResult.value = "ç¿»è­¯å¤±æ•—"; } catch (e) { translatedResult.value = "é€£ç·šéŒ¯èª¤"; } finally { isTranslating.value = false; } };
                const editActivity = (item)=>{isEditing.value=true; formActivity.value=JSON.parse(JSON.stringify(item)); locationMode.value=formActivity.value.lat?'manual':'auto'; searchResults.value=[]; searchResultAddress.value=''; showActivityModal.value=true;};
                const addPerson = ()=>{if(newPersonName.value){people.value.push(newPersonName.value);newPersonName.value='';saveToCloud();}};
                const removePerson = (i)=>{people.value.splice(i,1);saveToCloud();};
                const resetData = ()=>{if(confirm('æ¸…ç©ºï¼Ÿ')){days.value=[{activities:[]}];expenses.value=[];saveToCloud();}};
                const updateTripSettings = ()=>{saveToCloud();showSettings.value=false;};
                const saveFlight = ()=>saveToCloud();
                const searchFlight = ()=>{ if(flightInfo.value.code) window.open(`https://www.google.com/search?q=${flightInfo.value.code}+èˆªç­`, '_blank'); };
                
                // Transport & Favorites
                const addTransportLink = () => { if (!newLinkTitle.value || !newLinkUrl.value) return; transportLinks.value.push({ id: Date.now(), title: newLinkTitle.value, url: newLinkUrl.value, type: 'link' }); newLinkTitle.value = ''; newLinkUrl.value = ''; saveToCloud(); };
                const deleteTransportLink = (id) => { transportLinks.value = transportLinks.value.filter(t => t.id !== id); saveToCloud(); };
                const openNavigation = (location) => { if (!location) return; window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(location)}`, '_blank'); };

                const handleChatImageUpload = (e) => processImage(e.target.files[0], b=>chatImage.value=b);
                const removeChatImage = () => chatImage.value=null;
                const handleActivityImageUpload = (e) => processImage(e.target.files[0], b=>formActivity.value.image=b);
                const removeActivityImage = () => formActivity.value.image=null;

                // Getters
                const currentDayActivities = computed(() => days.value[currentDayIndex.value]?.activities || []);
                const sortedActivities = computed(() => [...currentDayActivities.value].sort((a, b) => a.time.localeCompare(b.time)));
                const totalExpense = computed(() => expenses.value.reduce((s,i)=>s+(i.amount||0),0));
                const perPersonShare = computed(() => people.value.length ? Math.round(totalExpense.value/people.value.length) : 0);
                const debts = computed(() => { if(!people.value.length) return []; const paid={}; people.value.forEach(p=>paid[p]=0); expenses.forEach(e=>{if(paid[e.payer]!==undefined) paid[e.payer]+=e.amount;}); const bals = people.value.map(p=>({name:p, bal:paid[p]-perPersonShare.value})); let res=[], d=bals.filter(b=>b.bal<-1).sort((a,b)=>a.bal-b.bal), c=bals.filter(b=>b.bal>1).sort((a,b)=>b.bal-a.bal); let i=0,j=0; while(i<d.length && j<c.length){ let amt=Math.min(Math.abs(d[i].bal), c[j].bal); amt=Math.floor(amt); if(amt>0) res.push({from:d[i].name, to:c[j].name, amount:amt}); d[i].bal+=amt; c[j].bal-=amt; if(Math.abs(d[i].bal)<1)i++; if(c[j].bal<1)j++; } return res; });
                const currentGroup = computed(() => favorites.value.find(g => g.id === viewingGroupId.value) || {}); // V16

                return {
                    pageState, wizardStep, wizardData, tripTitle, savedTrips,
                    activeTab, viewMode, showSettings, showMenu, isSyncing, tripId, joinIdInput,
                    days, currentDayIndex, currentDayActivities, sortedActivities,
                    people, expenses, newPersonName, exchangeRate, targetCurrency, targetLang,
                    showActivityModal, showExpenseModal, showTranslateModal, showCalculatorModal, showImagePreview,
                    isEditing, formActivity, formExpense, formChat, chatImage, translateText, translatedResult, isTranslating,
                    calcExpression, calcResultValue,
                    newItemText, totalExpense, perPersonShare, debts, useForeignCurrency, checklist, chatMessages, flightInfo,
                    locationMode, searchResultAddress, searchResults, isLoading,
                    transportLinks, newLinkTitle, newLinkUrl,
                    favorites, viewingGroupId, currentGroup, showGroupModal, showPlaceModal, formGroup, formPlace, // V16
                    startWizard, detectDestination, createTrip, loadTrip, deleteLocalTrip, backToLanding, joinTrip,
                    changeDay, addDay,
                    openAddModal, editActivity, saveActivity, deleteActivity,
                    saveExpense, deleteExpense, addPerson, removePerson, resetData, shareLink: ()=>navigator.clipboard.writeText(window.location.href).then(()=>alert('Copied!')), updateTripSettings,
                    toggleCheck, addCheckItem, deleteCheckItem, sendMessage, saveFlight, searchFlight,
                    handleChatImageUpload, removeChatImage,
                    handleActivityImageUpload, removeActivityImage,
                    searchLocation, selectSearchResult, saveCurrentLocation, performTranslation, appendCalc, clearCalc, backspaceCalc, calculateResult,
                    locateUser, getWeatherIcon: (c)=>{if(c===undefined)return'ğŸŒ¤ï¸';if(c<=3)return'â˜ï¸';if(c<=60)return'ğŸŒ§ï¸';return'â›ˆï¸';},
                    formatNumber: (n)=>n.toString().replace(/\B(?=(\d{3})+(?!\d))/g,","),
                    openNavigation, addTransportLink, deleteTransportLink,
                    addGroup, deleteGroup, openGroup, closeGroup, openAddPlaceModal, savePlace, deletePlace, searchPlaceLocation, selectPlaceSearchResult // V16
                };
            }
        }).mount('#app');
    </script>
</head>
<body>
    <div id="app" class="w-full h-full relative">
        
        <!-- 1. Landing -->
        <div v-if="pageState === 'landing'" class="h-full flex flex-col p-6 overflow-y-auto bg-milk">
            <div class="mt-8 mb-6 text-center"><h1 class="text-4xl font-bold text-coffee mb-1">Travel Buddy</h1><p class="text-latte font-bold text-sm tracking-widest">MOBILE V16</p></div>
            <button @click="startWizard" class="bg-coffee text-white p-5 rounded-2xl shadow-xl flex items-center justify-between mb-6 group active:scale-95 transition flex-shrink-0"><div class="flex items-center gap-4"><div class="bg-white/10 w-12 h-12 rounded-full flex items-center justify-center text-2xl">âœˆï¸</div><div class="text-left"><h3 class="font-bold text-lg">å»ºç«‹æ–°è¡Œç¨‹</h3></div></div><i class="fa-solid fa-arrow-right"></i></button>
            <div class="bg-white p-2 rounded-2xl border border-stone-100 flex gap-2 mb-8 shadow-sm flex-shrink-0"><input v-model="joinIdInput" placeholder="è¼¸å…¥è¡Œç¨‹ ID..." class="flex-1 bg-transparent p-3 outline-none font-bold text-coffee"><button @click="joinTrip" class="bg-latte text-white px-4 rounded-xl font-bold">åŠ å…¥</button></div>
            <h3 class="font-bold text-gray-400 text-sm mb-3 px-2">æˆ‘çš„è¡Œç¨‹</h3>
            <div class="space-y-3 pb-10"><div v-for="(trip, idx) in savedTrips" :key="trip.id" class="bg-white p-4 rounded-2xl border border-stone-100 shadow-sm flex justify-between items-center"><div @click="loadTrip(trip.id)" class="flex-1 cursor-pointer"><h4 class="font-bold text-coffee text-lg">{{ trip.title }}</h4></div><button @click="deleteLocalTrip(idx)" class="w-8 h-8 flex items-center justify-center text-gray-300"><i class="fa-solid fa-trash"></i></button></div></div>
        </div>

        <!-- 2. Wizard -->
        <div v-if="pageState === 'wizard'" class="h-full flex flex-col p-8 bg-milk">
            <div v-if="wizardStep === 1" class="flex-1 flex flex-col justify-center"><button @click="pageState='landing'" class="absolute top-6 left-6 text-gray-400"><i class="fa-solid fa-arrow-left"></i></button><h2 class="text-3xl font-bold text-coffee mb-2">å»å“ªè£¡?</h2><input v-model="wizardData.destination" @keyup.enter="detectDestination" placeholder="è¼¸å…¥åœ°é»..." class="w-full bg-white border-2 border-stone-100 rounded-2xl p-4 text-xl font-bold mb-4"><button @click="detectDestination" class="bg-latte text-white w-full py-4 rounded-2xl font-bold">ä¸‹ä¸€æ­¥</button></div>
            <div v-if="wizardStep === 2" class="flex-1 flex flex-col justify-center text-center"><button @click="wizardStep=1" class="absolute top-6 left-6 text-gray-400"><i class="fa-solid fa-arrow-left"></i></button><div class="text-6xl mb-4">{{ wizardData.flag }}</div><input v-model="tripTitle" class="w-full bg-white border-b-2 border-gray-200 text-center font-bold text-xl mb-4"><div class="flex gap-4 mb-8"><input v-model="wizardData.currency" class="flex-1 bg-white p-2 rounded-lg text-center border font-bold"><input v-model="wizardData.rate" type="number" class="flex-1 bg-white p-2 rounded-lg text-center border font-bold"></div><button @click="createTrip" class="bg-coffee text-white w-full py-4 rounded-2xl font-bold">å»ºç«‹</button></div>
        </div>

        <!-- 3. App -->
        <div v-if="pageState === 'app'" class="h-full flex flex-col bg-milk">
            <header class="flex-shrink-0 px-4 h-16 flex justify-between items-center bg-milk/95 backdrop-blur z-20 border-b border-gray-100/50">
                <button @click="backToLanding" class="w-10 h-10 flex items-center justify-center text-gray-500"><i class="fa-solid fa-chevron-left"></i></button>
                <div class="text-center">
                    <h1 class="text-lg font-bold text-coffee truncate max-w-[150px]">{{ tripTitle }}</h1>
                    <div class="flex items-center justify-center gap-1"><span class="w-1.5 h-1.5 rounded-full" :class="isSyncing ? 'bg-orange-400 animate-pulse' : 'bg-green-500'"></span><span class="text-[10px] text-gray-400 font-bold tracking-wider">ONLINE</span></div>
                </div>
                <button @click="showMenu = !showMenu" class="w-10 h-10 flex items-center justify-center text-coffee"><i class="fa-solid fa-bars text-xl"></i></button>
                <div v-if="showMenu" class="absolute top-14 right-4 w-48 bg-white rounded-2xl shadow-xl border border-stone-100 overflow-hidden py-1 z-50">
                    <button @click="showCalculatorModal=true;showMenu=false" class="w-full text-left px-4 py-3 hover:bg-gray-50 flex items-center gap-3 text-sm font-bold text-gray-600"><i class="fa-solid fa-calculator w-5"></i>è¨ˆç®—æ©Ÿ</button>
                    <button @click="showTranslateModal=true;showMenu=false" class="w-full text-left px-4 py-3 hover:bg-gray-50 flex items-center gap-3 text-sm font-bold text-gray-600"><i class="fa-solid fa-language w-5"></i>ç¿»è­¯åŠ©æ‰‹</button>
                    <div class="h-px bg-gray-100 my-1"></div>
                    <button @click="showSettings=true;showMenu=false" class="w-full text-left px-4 py-3 hover:bg-gray-50 flex items-center gap-3 text-sm font-bold text-gray-600"><i class="fa-solid fa-gear w-5"></i>è¨­å®š</button>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto relative pt-20 pb-24 hide-scrollbar">
                <!-- Itinerary -->
                <div v-if="activeTab === 'itinerary'" class="min-h-full pb-24">
                    <div class="sticky top-0 z-10 bg-milk/95 backdrop-blur px-4 py-2 flex gap-2 overflow-x-auto hide-scrollbar border-b border-gray-100/50">
                        <button v-for="(day, idx) in days" :key="idx" @click="changeDay(idx)" class="flex-shrink-0 flex flex-col items-center justify-center w-14 h-16 rounded-xl border transition-all" :class="currentDayIndex === idx ? 'bg-coffee border-coffee text-white shadow-md scale-105' : 'bg-white border-stone-100 text-gray-400'"><span class="text-[9px] font-bold opacity-70">DAY</span><span class="text-lg font-bold">{{ idx + 1 }}</span></button>
                        <button @click="addDay" class="flex-shrink-0 w-14 h-16 rounded-xl border border-dashed border-latte/30 text-latte flex items-center justify-center"><i class="fa-solid fa-plus text-xl"></i></button>
                    </div>
                    <div class="px-6 py-2 flex justify-end" v-if="currentDayActivities.length > 0"><div class="bg-gray-100 rounded-lg p-1 flex"><button @click="viewMode='list'" class="px-3 py-1 rounded-md text-xs font-bold transition-all" :class="viewMode==='list'?'bg-white shadow text-coffee':'text-gray-400'">åˆ—è¡¨</button><button @click="viewMode='map'" class="px-3 py-1 rounded-md text-xs font-bold transition-all" :class="viewMode==='map'?'bg-white shadow text-coffee':'text-gray-400'">åœ°åœ–</button></div></div>
                    <div class="px-4">
                        <div v-show="viewMode === 'list'" class="space-y-4">
                            <div class="bg-white rounded-2xl p-4 border border-stone-100 shadow-sm"><div class="flex justify-between mb-2"><span class="text-xs font-bold text-gray-400">FLIGHT</span><button @click="saveFlight" class="text-xs text-latte font-bold">Save</button></div><div class="flex gap-2"><input v-model="flightInfo.code" placeholder="BR198" class="flex-1 bg-gray-50 rounded p-2 text-sm font-bold uppercase"><input v-model="flightInfo.time" type="time" class="w-20 bg-gray-50 rounded p-2 text-sm"></div></div>
                            <div v-if="currentDayActivities.length === 0" class="text-center py-10 opacity-40"><i class="fa-solid fa-route text-4xl mb-2 text-latte"></i><p class="text-xs font-bold">NO PLAN</p></div>
                            <div v-for="item in sortedActivities" :key="item.id" class="flex gap-3 relative"><div class="flex flex-col items-center pt-2 w-10"><span class="text-xs font-bold text-coffee">{{ item.time }}</span><div class="w-px h-full bg-gray-200 my-1"></div></div><div class="flex-1 bg-white p-3 rounded-2xl border border-stone-100 shadow-sm mb-2" @click="editActivity(item)"><div class="flex justify-between items-start"><h3 class="font-bold text-coffee text-base">{{ item.title }}</h3><div v-if="item.weather" class="text-[10px] bg-sky-50 text-sky-600 px-1.5 py-0.5 rounded">{{ getWeatherIcon(item.weather.code) }} {{ item.weather.temp }}Â°</div></div><div class="flex items-center gap-1 text-xs text-gray-400 mt-1 mb-2"><i class="fa-solid fa-location-dot"></i> {{ item.location || 'Location' }}</div><div v-if="item.image" class="h-24 w-full rounded-lg overflow-hidden mb-2 bg-gray-100"><img :src="item.image" class="w-full h-full object-cover"></div><div v-if="item.notes" class="bg-cream/30 p-2 rounded-lg text-xs text-gray-600">{{ item.notes }}</div><button @click.stop="openNavigation(item.location)" class="w-full bg-blue-50 text-blue-600 py-2 rounded-lg text-xs font-bold mt-2"><i class="fa-solid fa-diamond-turn-right mr-1"></i>å°èˆª</button></div></div>
                        </div>
                        <div v-show="viewMode === 'map'" class="relative w-full h-[65vh] bg-gray-100 rounded-3xl overflow-hidden shadow-inner border border-gray-200"><div id="map-container"><div id="map" style="width: 100%; height: 100%;"></div></div><button @click="locateUser" class="absolute bottom-4 right-4 bg-white w-10 h-10 rounded-xl shadow-lg flex items-center justify-center text-blue-500 z-[400]"><i class="fa-solid fa-location-crosshairs"></i></button></div>
                    </div>
                </div>

                <!-- V16: Favorites Tab -->
                <div v-if="activeTab === 'favorites'" class="px-4 pb-24 h-full flex flex-col">
                    <div class="flex items-center justify-between mt-2 mb-4">
                        <h2 class="font-bold text-coffee text-lg">â¤ï¸ å–œæ„›çš„åœ°é»</h2>
                        <button v-if="!viewingGroupId" @click="showGroupModal=true" class="text-xs bg-latte text-white px-3 py-1.5 rounded-lg font-bold">å»ºç«‹ç¾¤çµ„</button>
                        <button v-else @click="closeGroup" class="text-xs bg-gray-100 text-gray-500 px-3 py-1.5 rounded-lg font-bold">è¿”å›åˆ—è¡¨</button>
                    </div>

                    <!-- Groups List -->
                    <div v-if="!viewingGroupId" class="space-y-3">
                        <div v-if="favorites.length === 0" class="text-center py-10 opacity-40"><p class="text-sm font-bold text-gray-400">é‚„æ²’æœ‰æ”¶è—ç¾¤çµ„</p></div>
                        <div v-for="group in favorites" :key="group.id" @click="openGroup(group.id)" class="bg-white p-4 rounded-2xl border border-stone-100 shadow-sm flex justify-between items-center active:scale-[0.98] transition">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-red-50 text-red-400 rounded-xl flex items-center justify-center text-xl"><i class="fa-solid fa-heart"></i></div>
                                <div>
                                    <h3 class="font-bold text-coffee">{{ group.title }}</h3>
                                    <p class="text-xs text-gray-400">{{ (group.places || []).length }} å€‹åœ°é»</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button @click.stop="deleteGroup(group.id)" class="w-8 h-8 rounded-full bg-gray-50 text-gray-300 hover:text-red-400 flex items-center justify-center"><i class="fa-solid fa-trash text-xs"></i></button>
                                <i class="fa-solid fa-chevron-right text-gray-300 text-xs"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Places List (Inside Group) -->
                    <div v-else class="flex-1 flex flex-col">
                        <div class="bg-orange-50 p-3 rounded-xl mb-4 border border-orange-100 text-center">
                            <h3 class="font-bold text-orange-800">{{ currentGroup.title }}</h3>
                        </div>
                        
                        <div class="flex-1 overflow-y-auto space-y-3 pb-20">
                            <div v-if="!currentGroup.places || currentGroup.places.length === 0" class="text-center py-8 opacity-40"><p class="text-xs text-gray-400">é‚„æ²’æœ‰åœ°é»ï¼Œå¿«æ–°å¢ä¸€å€‹ï¼</p></div>
                            <div v-for="place in (currentGroup.places || [])" :key="place.id" class="bg-white p-4 rounded-2xl border border-stone-100 shadow-sm">
                                <div class="flex justify-between items-start mb-1">
                                    <h4 class="font-bold text-coffee">{{ place.name }}</h4>
                                    <button @click="deletePlace(place.id)" class="text-gray-300 hover:text-red-400"><i class="fa-solid fa-times"></i></button>
                                </div>
                                <div class="flex items-center gap-1 text-xs text-gray-400 mb-2">
                                    <i class="fa-solid fa-location-dot"></i> {{ place.location || 'æœªçŸ¥ä½ç½®' }}
                                </div>
                                <p v-if="place.notes" class="text-xs text-gray-500 bg-gray-50 p-2 rounded-lg mb-2">{{ place.notes }}</p>
                                <button @click="openNavigation(place.location)" class="w-full bg-blue-50 text-blue-600 py-2 rounded-lg text-xs font-bold"><i class="fa-solid fa-diamond-turn-right mr-1"></i>å°èˆª</button>
                            </div>
                        </div>
                        
                        <button @click="openAddPlaceModal" class="w-full bg-coffee text-white py-3 rounded-xl font-bold shadow-lg mt-2 flex items-center justify-center gap-2"><i class="fa-solid fa-plus"></i> æ–°å¢åœ°é»</button>
                    </div>
                </div>

                <!-- Chat -->
                <div v-if="activeTab === 'chat'" class="px-4 h-full flex flex-col pb-24 overflow-x-hidden">
                    <div class="flex-1 overflow-y-auto py-4 space-y-3">
                        <div v-for="(msg,i) in chatMessages" :key="i" class="flex flex-col" :class="msg.user===people[0]?'items-end':'items-start'"><div class="p-3 rounded-2xl max-w-[85%] text-sm" :class="msg.user===people[0]?'bg-coffee text-white rounded-tr-none':'bg-white border border-gray-100 text-coffee rounded-tl-none'"><img v-if="msg.image" :src="msg.image" class="rounded mb-1 max-w-full" @click="showImagePreview=msg.image">{{ msg.text }}</div><span class="text-[10px] text-gray-300 mt-1">{{ msg.user }}</span></div>
                    </div>
                    <div class="bg-white p-2 rounded-2xl border border-stone-100 flex gap-2 shadow-lg mb-2 items-center relative flex-shrink-0 w-full box-border mx-auto">
                        <div v-if="chatImage" class="absolute bottom-full left-0 mb-2 p-1 bg-white shadow rounded"><img :src="chatImage" class="h-16"><button @click="removeChatImage" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-4 h-4 text-[10px] flex items-center justify-center">Ã—</button></div>
                        <label class="text-gray-400 p-2 flex-shrink-0 cursor-pointer"><i class="fa-solid fa-image text-lg"></i><input type="file" @change="handleChatImageUpload" class="hidden" accept="image/*"></label>
                        <input v-model="formChat" class="flex-1 bg-transparent text-sm outline-none" style="min-width: 0;" placeholder="è¨Šæ¯...">
                        <button @click="sendMessage" class="bg-latte text-white w-10 h-10 rounded-xl flex items-center justify-center flex-shrink-0 shadow-md"><i class="fa-solid fa-paper-plane text-sm"></i></button>
                    </div>
                </div>

                <!-- Transport -->
                <div v-if="activeTab === 'transport'" class="px-4 pb-24">
                    <h2 class="font-bold text-coffee mb-4 mt-2">äº¤é€šå‚³é€é–€</h2>
                    <div class="space-y-3 mb-6"><div v-for="link in transportLinks" :key="link.id" class="bg-white p-4 rounded-xl border border-stone-50 shadow-sm flex items-center justify-between"><a :href="link.url" target="_blank" class="flex items-center gap-3 flex-1"><div class="w-10 h-10 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center"><i class="fa-solid fa-train"></i></div><span class="font-bold text-coffee">{{ link.title }}</span></a><button @click="deleteTransportLink(link.id)" class="text-gray-300 hover:text-red-400 p-2"><i class="fa-solid fa-trash"></i></button></div></div>
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-100"><h3 class="text-xs font-bold text-gray-400 mb-2">æ–°å¢æ›¸ç±¤</h3><div class="space-y-2"><input v-model="newLinkTitle" placeholder="åç¨±" class="w-full bg-white p-2 rounded-lg border text-sm"><input v-model="newLinkUrl" placeholder="ç¶²å€" class="w-full bg-white p-2 rounded-lg border text-sm"><button @click="addTransportLink" class="w-full bg-coffee text-white py-2 rounded-lg font-bold text-sm">æ–°å¢</button></div></div>
                </div>

                <div v-if="activeTab === 'checklist'" class="px-4 pb-24"><h2 class="font-bold text-coffee mb-4 mt-2">æ¸…å–®</h2><div class="space-y-2 mb-4"><div v-for="item in checklist" :key="item.id" @click="toggleCheck(item.id)" class="bg-white p-3 rounded-xl border border-stone-50 flex items-center gap-3" :class="item.checked?'opacity-50':''"><div class="w-5 h-5 rounded-full border flex items-center justify-center" :class="item.checked?'bg-green-500 border-green-500 text-white':'border-gray-200'"><i class="fa-solid fa-check text-xs"></i></div><span class="flex-1 font-bold text-sm">{{ item.text }}</span><button @click.stop="deleteCheckItem(item.id)" class="text-red-200"><i class="fa-solid fa-times"></i></button></div></div><div class="flex gap-2"><input v-model="newItemText" placeholder="æ–°å¢..." class="flex-1 bg-white border rounded-xl p-3 shadow-sm"><button @click="addCheckItem" class="bg-coffee text-white px-4 rounded-xl"><i class="fa-solid fa-plus"></i></button></div></div>
                <div v-if="activeTab === 'expenses'" class="px-4 pb-24"><div class="bg-coffee rounded-3xl p-6 text-white shadow-xl mb-6 mt-2"><p class="text-xs opacity-60">TOTAL</p><h2 class="text-3xl font-bold mb-2">{{ formatNumber(totalExpense) }}</h2><div class="flex justify-between text-xs opacity-80 pt-4 border-t border-white/10"><span>æ¯äºº ${{ formatNumber(perPersonShare) }}</span><span>{{ people.length }} äºº</span></div></div><div class="space-y-2 mb-20"><div v-for="exp in expenses" :key="exp.id" class="bg-white p-3 rounded-xl flex justify-between items-center shadow-sm border border-stone-50"><div class="flex gap-3"><div class="w-8 h-8 rounded-full bg-cream flex items-center justify-center text-xs font-bold text-coffee">{{ exp.payer[0] }}</div><div><p class="font-bold text-sm">{{ exp.title }}</p><p class="text-[10px] text-gray-400">{{ exp.date }} <span v-if="exp.originalAmount" class="text-latte">({{ exp.originalAmount }})</span></p></div></div><div class="text-right"><p class="font-bold text-sm">${{ formatNumber(exp.amount) }}</p><button @click="deleteExpense(exp.id)" class="text-red-200 text-xs">åˆªé™¤</button></div></div></div></div>
            </main>

            <nav class="flex-shrink-0 bg-white/95 backdrop-blur border-t border-gray-100 flex justify-between px-4 pt-2 pb-safe z-30 text-[9px] font-bold text-gray-400">
                <button @click="activeTab='itinerary'" class="flex flex-col items-center gap-1" :class="activeTab==='itinerary'?'text-coffee':''"><i class="fa-solid fa-map text-lg"></i>è¡Œç¨‹</button>
                <button @click="activeTab='transport'" class="flex flex-col items-center gap-1" :class="activeTab==='transport'?'text-coffee':''"><i class="fa-solid fa-train-subway text-lg"></i>äº¤é€š</button>
                <button @click="activeTab='favorites'" class="flex flex-col items-center gap-1" :class="activeTab==='favorites'?'text-coffee':''"><i class="fa-solid fa-heart text-lg"></i>æ”¶è—</button>
                <button @click="activeTab='chat'" class="flex flex-col items-center gap-1" :class="activeTab==='chat'?'text-coffee':''"><i class="fa-solid fa-comments text-lg"></i>èŠå¤©</button>
                <button @click="activeTab='expenses'" class="flex flex-col items-center gap-1" :class="activeTab==='expenses'?'text-coffee':''"><i class="fa-solid fa-wallet text-lg"></i>éŒ¢åŒ…</button>
            </nav>
            <button v-if="activeTab!=='chat' && activeTab!=='checklist' && activeTab!=='transport' && activeTab!=='favorites'" @click="openAddModal" class="absolute bottom-6 left-1/2 -translate-x-1/2 w-14 h-14 bg-coffee text-white rounded-full shadow-2xl flex items-center justify-center text-xl z-40 mb-safe active:scale-90 transition-transform"><i class="fa-solid fa-plus"></i></button>

            <!-- V16 Modals: Add Group & Add Place -->
            <div v-if="showGroupModal" class="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-6"><div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl"><h3 class="font-bold text-coffee mb-4">å»ºç«‹æ”¶è—ç¾¤çµ„</h3><input v-model="formGroup.title" class="w-full border rounded-xl p-3 mb-4 font-bold" placeholder="ç¾¤çµ„åç¨± (ä¾‹: å¿…åƒç¾é£Ÿ)"><div class="flex gap-2"><button @click="showGroupModal=false" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold text-gray-500">å–æ¶ˆ</button><button @click="addGroup" class="flex-1 py-3 bg-coffee text-white rounded-xl font-bold">å»ºç«‹</button></div></div></div>
            
            <div v-if="showPlaceModal" class="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-6"><div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl"><h3 class="font-bold text-coffee mb-4">æ–°å¢åœ°é»åˆ°ã€Œ{{ currentGroup.title }}ã€</h3><div class="space-y-3 mb-4"><input v-model="formPlace.name" class="w-full border rounded-xl p-3 font-bold" placeholder="åœ°é»åç¨±"><div class="flex gap-2"><input v-model="formPlace.location" class="flex-1 bg-gray-50 rounded-xl p-3 text-sm" placeholder="æœå°‹åœ°é»..."><button @click="searchPlaceLocation" class="bg-coffee text-white px-3 rounded-xl text-sm font-bold">æœ</button></div>
            
            <!-- Place Search Results -->
            <div v-if="searchResults.length > 0" class="bg-white border border-stone-100 rounded-xl overflow-hidden shadow-sm max-h-32 overflow-y-auto"><div v-for="(res, idx) in searchResults" :key="idx" @click="selectPlaceSearchResult(res)" class="p-2 border-b border-gray-50 hover:bg-gray-50 cursor-pointer"><p class="font-bold text-coffee text-xs">{{ res.display_name.split(',')[0] }}</p></div></div>
            <p v-if="searchResultAddress" class="text-xs text-green-600"><i class="fa-solid fa-check-circle"></i> {{ searchResultAddress }}</p>
            
            <textarea v-model="formPlace.notes" class="w-full border rounded-xl p-3 text-sm" placeholder="å‚™è¨»..." rows="2"></textarea></div><div class="flex gap-2"><button @click="showPlaceModal=false" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold text-gray-500">å–æ¶ˆ</button><button @click="savePlace" class="flex-1 py-3 bg-coffee text-white rounded-xl font-bold">å„²å­˜</button></div></div></div>

            <!-- Existing Modals -->
            <div v-if="showActivityModal" class="fixed inset-0 bg-black/50 z-[60] flex items-end justify-center"><div class="bg-milk w-full rounded-t-[2rem] p-6 shadow-2xl max-h-[85vh] overflow-y-auto pb-safe"><h3 class="text-lg font-bold mb-4 text-coffee">{{ isEditing ? 'ç·¨è¼¯' : 'æ–°å¢' }}è¡Œç¨‹</h3><div class="space-y-4"><div class="flex gap-3"><input v-model="formActivity.time" type="time" class="w-1/3 bg-white border border-stone-100 rounded-xl p-3 font-bold"><input v-model="formActivity.title" placeholder="æ¨™é¡Œ" class="flex-1 bg-white border border-stone-100 rounded-xl p-3 font-bold"></div><div class="bg-white border border-stone-100 rounded-xl p-2"><div class="flex gap-1 mb-2"><button @click="locationMode='auto'" class="flex-1 py-1.5 rounded-lg text-xs font-bold transition-colors" :class="locationMode==='auto'?'bg-gray-100 text-coffee':'text-gray-400'">æœå°‹</button><button @click="locationMode='manual'" class="flex-1 py-1.5 rounded-lg text-xs font-bold transition-colors" :class="locationMode==='manual'?'bg-gray-100 text-coffee':'text-gray-400'">åœ°åœ–</button></div><button @click="saveCurrentLocation" class="w-full bg-blue-50 text-blue-600 py-2 rounded-lg text-xs font-bold mb-2 flex items-center justify-center gap-2"><i class="fa-solid fa-location-crosshairs"></i> {{ isLoading ? 'å®šä½ä¸­...' : 'ğŸ“ å®šä½ç›®å‰ä½ç½® (å„²å­˜)' }}</button><div v-show="locationMode==='auto'" class="flex gap-2"><input v-model="formActivity.location" placeholder="è¼¸å…¥åœ°é»..." class="flex-1 bg-gray-50 rounded-lg p-2 text-sm"><button @click="searchLocation" class="bg-coffee text-white px-3 rounded-lg text-xs font-bold">æœ</button></div><div v-if="locationMode==='auto' && searchResults.length > 0" class="bg-white border border-stone-100 rounded-xl mt-2 overflow-hidden shadow-sm"><div v-for="(res, idx) in searchResults" :key="idx" @click="selectSearchResult(res)" class="p-3 border-b border-gray-50 last:border-0 hover:bg-gray-50 cursor-pointer"><p class="font-bold text-coffee text-sm">{{ res.display_name.split(',')[0] }}</p><p class="text-[10px] text-gray-400 truncate">{{ res.display_name }}</p></div></div><p v-if="searchResultAddress && searchResults.length === 0" class="text-xs text-green-600 bg-green-50 p-2 rounded-lg mt-2"><i class="fa-solid fa-check-circle mr-1"></i>å·²ç¢ºèª: {{ searchResultAddress }}</p><div v-show="locationMode==='manual'"><div id="modal-map"></div><p class="text-[10px] text-center text-gray-400 mt-1">æ‹–æ›³åœ°åœ–ä»¥å®šä½</p></div></div><textarea v-model="formActivity.notes" rows="2" placeholder="å‚™è¨»" class="w-full bg-white border border-stone-100 rounded-xl p-3 text-sm"></textarea><label class="block w-full border-2 border-dashed border-gray-200 rounded-xl p-3 text-center text-gray-400 text-xs"><span v-if="!formActivity.image"><i class="fa-solid fa-camera mr-1"></i>ä¸Šå‚³ç…§ç‰‡</span><span v-else class="text-coffee">å·²é¸æ“‡ç…§ç‰‡ (é»æ“Šæ›´æ›)</span><input type="file" @change="handleActivityImageUpload" class="hidden" accept="image/*"></label></div><div class="flex gap-3 mt-6"><button @click="showActivityModal=false" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold text-gray-500">å–æ¶ˆ</button><button @click="saveActivity" class="flex-1 py-3 bg-coffee text-white rounded-xl font-bold">å„²å­˜</button></div></div></div>
            <div v-if="showExpenseModal" class="fixed inset-0 bg-black/50 z-[60] flex items-end justify-center"><div class="bg-milk w-full rounded-t-3xl p-6 pb-safe"><h3 class="font-bold mb-4">è¨˜å¸³</h3><div class="flex bg-gray-100 p-1 rounded-xl mb-4"><button @click="useForeignCurrency=false" class="flex-1 py-2 rounded-lg text-xs font-bold" :class="!useForeignCurrency?'bg-white shadow':''">TWD</button><button @click="useForeignCurrency=true" class="flex-1 py-2 rounded-lg text-xs font-bold" :class="useForeignCurrency?'bg-white shadow':''">{{ targetCurrency }}</button></div><input v-model="formExpense.title" placeholder="é …ç›®" class="w-full bg-white border rounded-xl p-3 mb-2"><div class="flex gap-2 mb-4"><input v-model.number="formExpense.inputAmount" type="number" placeholder="é‡‘é¡" class="flex-1 bg-white border rounded-xl p-3"><select v-model="formExpense.payer" class="w-1/3 bg-white border rounded-xl p-3"><option v-for="p in people" :value="p">{{p}}</option></select></div><button @click="saveExpense" class="w-full bg-coffee text-white py-3 rounded-xl font-bold">å„²å­˜</button><button @click="showExpenseModal=false" class="w-full mt-2 text-gray-400 py-2">å–æ¶ˆ</button></div></div>
            <div v-if="showSettings" class="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-6"><div class="bg-white w-full max-w-sm rounded-2xl p-6"><h3 class="font-bold mb-4">è¨­å®š</h3><div class="space-y-3 mb-4"><input v-model="tripTitle" class="w-full bg-gray-50 p-2 rounded border" placeholder="è¡Œç¨‹åç¨±"><input v-model="exchangeRate" type="number" class="w-full bg-gray-50 p-2 rounded border" placeholder="åŒ¯ç‡"></div><div class="space-y-2"><div v-for="(p,i) in people" :key="i" class="flex justify-between bg-gray-50 p-2 rounded"><span>{{p}}</span><button @click="removePerson(i)" class="text-red-300">Ã—</button></div><div class="flex gap-2"><input v-model="newPersonName" placeholder="æ–°æˆå“¡" class="flex-1 border rounded p-1"><button @click="addPerson" class="bg-coffee text-white px-3 rounded">+</button></div></div><div class="flex gap-2 mt-6"><button @click="updateTripSettings" class="flex-1 bg-coffee text-white py-2 rounded-lg">å„²å­˜</button><button @click="showSettings=false" class="flex-1 bg-gray-100 py-2 rounded-lg">å–æ¶ˆ</button></div></div></div>
            <div v-if="showCalculatorModal" class="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-6"><div class="bg-white w-full rounded-2xl p-6"><div class="text-right text-2xl font-bold mb-4 bg-gray-50 p-3 rounded">{{ calcExpression || 0 }}<div class="text-xs text-gray-400 mt-1">={{ formatNumber(Math.round(calcResultValue)) }} / {{ formatNumber(Math.round(calcResultValue * exchangeRate)) }} TWD</div></div><div class="grid grid-cols-4 gap-2"><button @click="clearCalc" class="calc-btn text-red-400">C</button><button @click="appendCalc('/')" class="calc-btn calc-btn-op">Ã·</button><button @click="appendCalc('*')" class="calc-btn calc-btn-op">Ã—</button><button @click="backspaceCalc" class="calc-btn"><i class="fa-solid fa-delete-left"></i></button><button @click="appendCalc('7')" class="calc-btn">7</button><button @click="appendCalc('8')" class="calc-btn">8</button><button @click="appendCalc('9')" class="calc-btn">9</button><button @click="appendCalc('-')" class="calc-btn calc-btn-op">-</button><button @click="appendCalc('4')" class="calc-btn">4</button><button @click="appendCalc('5')" class="calc-btn">5</button><button @click="appendCalc('6')" class="calc-btn">6</button><button @click="appendCalc('+')" class="calc-btn calc-btn-op">+</button><button @click="appendCalc('1')" class="calc-btn">1</button><button @click="appendCalc('2')" class="calc-btn">2</button><button @click="appendCalc('3')" class="calc-btn">3</button><button class="calc-btn row-span-2 calc-btn-eq flex items-center justify-center" @click="calculateResult">=</button><button @click="appendCalc('0')" class="calc-btn col-span-2">0</button><button @click="appendCalc('.')" class="calc-btn">.</button></div><button @click="showCalculatorModal=false" class="w-full mt-4 py-2 text-gray-400 font-bold">é—œé–‰</button></div></div>
            <div v-if="showTranslateModal" class="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-6"><div class="bg-white w-full rounded-2xl p-6 shadow-2xl"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-coffee">å³æ™‚ç¿»è­¯ ({{ targetLang }})</h3><button @click="showTranslateModal=false"><i class="fa-solid fa-times text-gray-400"></i></button></div><textarea v-model="translateText" class="w-full border rounded-xl p-3 mb-4 h-24" placeholder="è¼¸å…¥è¦ç¿»è­¯çš„æ–‡å­—..."></textarea><div v-if="translatedResult" class="bg-blue-50 p-3 rounded-xl mb-4 text-blue-800 font-bold text-lg">{{ translatedResult }}</div><button @click="performTranslation" class="w-full bg-blue-500 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2"><i v-if="isTranslating" class="fa-solid fa-circle-notch animate-spin"></i>{{ isTranslating ? 'ç¿»è­¯ä¸­...' : 'ç¿»è­¯' }}</button></div></div>
            <div v-if="showImagePreview" class="fixed inset-0 bg-black/95 z-[70] flex items-center justify-center" @click="showImagePreview=null"><img :src="showImagePreview" class="max-w-full max-h-full"></div>
        </div>
    </div>
</body>
</html>