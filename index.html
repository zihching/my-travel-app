<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Travel Buddy - 旅遊小幫手</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Leaflet (Map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- FontAwesome (Icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase (Modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 全域變數供 Vue 使用
        window.firebaseModules = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc, serverTimestamp, where };
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'milk-yellow': '#FFF8E7',
                        'milk-yellow-dark': '#FDF0D0',
                        'coffee': '#432818',
                        'coffee-light': '#6F4E37',
                        'accent': '#BB9457'
                    },
                    fontFamily: {
                        sans: ['Noto Sans TC', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* 隱藏 Scrollbar 但保留功能 */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        body {
            background-color: #FFF8E7;
            color: #432818;
            -webkit-tap-highlight-color: transparent;
        }
        /* Leaflet 地圖高度 */
        #map {
            height: 100%;
            width: 100%;
            z-index: 0;
        }
        .app-container {
            max-width: 480px; /* 手機寬度模擬 */
            margin: 0 auto;
            background-color: #FFF8E7;
            min-height: 100vh;
            position: relative;
            box-shadow: 0 0 20px rgba(67, 40, 24, 0.1);
        }
        .slide-enter-active, .slide-leave-active {
            transition: all 0.3s ease;
        }
        .slide-enter-from, .slide-leave-to {
            opacity: 0;
            transform: translateY(10px);
        }
    </style>
</head>
<body>

<div id="app" class="app-container flex flex-col h-screen overflow-hidden">

    <!-- Loading Screen -->
    <div v-if="loading" class="absolute inset-0 z-50 flex items-center justify-center bg-milk-yellow flex-col">
        <i class="fa-solid fa-plane fa-bounce text-4xl text-coffee mb-4"></i>
        <p class="text-coffee font-bold">載入旅程中...</p>
    </div>

    <!-- Top Bar (Header) -->
    <div class="px-4 pt-4 pb-2 bg-milk-yellow z-10 shadow-sm" v-if="currentTab !== 'map'">
        <div class="flex justify-between items-center mb-2">
            <h1 class="text-xl font-bold text-coffee"><i class="fa-solid fa-suitcase-rolling mr-2"></i>我們的旅程</h1>
            <div class="flex gap-2">
                <button @click="showCalc = !showCalc" class="p-2 rounded-full bg-milk-yellow-dark text-coffee">
                    <i class="fa-solid fa-calculator"></i>
                </button>
            </div>
        </div>
        
        <!-- Horizontal Date Slider (Only for Itinerary) -->
        <div v-if="currentTab === 'itinerary'" class="flex overflow-x-auto no-scrollbar gap-2 py-2">
            <button 
                v-for="(day, index) in tripDays" 
                :key="index"
                @click="selectedDayIndex = index"
                class="flex-shrink-0 px-4 py-2 rounded-xl transition-all duration-300 flex flex-col items-center min-w-[70px]"
                :class="selectedDayIndex === index ? 'bg-coffee text-milk-yellow shadow-md transform scale-105' : 'bg-milk-yellow-dark text-coffee-light'"
            >
                <span class="text-xs font-bold">Day {{ index + 1 }}</span>
                <span class="text-sm">{{ formatDate(day) }}</span>
            </button>
            <button @click="addDay" class="flex-shrink-0 px-3 py-2 rounded-xl bg-white border border-dashed border-coffee text-coffee">
                <i class="fa-solid fa-plus"></i>
            </button>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="flex-1 overflow-y-auto overflow-x-hidden relative bg-milk-yellow pb-20 no-scrollbar">
        
        <!-- TAB: Itinerary -->
        <div v-if="currentTab === 'itinerary'" class="p-4 space-y-4">
            <!-- Weather Widget (Mock/API) -->
            <div class="bg-gradient-to-r from-blue-100 to-blue-50 rounded-2xl p-4 flex items-center justify-between shadow-sm text-coffee">
                <div>
                    <div class="text-xs opacity-70">當地天氣 (Day {{ selectedDayIndex + 1 }})</div>
                    <div class="text-2xl font-bold flex items-center gap-2">
                        <span v-if="currentWeather">{{ currentWeather.temp }}°C</span>
                        <span v-else>--°C</span>
                        <i class="fa-solid fa-cloud-sun text-orange-400"></i>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-sm font-bold">{{ tripLocation }}</div>
                    <div class="text-xs">{{ currentWeather ? currentWeather.desc : '多雲時晴' }}</div>
                </div>
            </div>

            <!-- Flight Info Card (Only Day 1) -->
            <div v-if="selectedDayIndex === 0" class="bg-white rounded-2xl p-4 shadow-sm border-l-4 border-accent relative">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="font-bold text-coffee"><i class="fa-solid fa-plane-departure mr-2"></i>航班資訊</h3>
                    <button @click="editingFlight = !editingFlight" class="text-xs text-gray-400"><i class="fa-solid fa-pen"></i></button>
                </div>
                <div v-if="!editingFlight">
                    <div class="flex justify-between text-sm mb-1">
                        <span>{{ flightInfo.code || '航班號' }}</span>
                        <span>{{ flightInfo.time || '時間' }}</span>
                    </div>
                    <div class="text-xs text-gray-500">{{ flightInfo.terminal || '航廈/登機門' }}</div>
                </div>
                <div v-else class="space-y-2">
                    <input v-model="flightInfo.code" placeholder="航班號 (例如 BR198)" class="w-full text-sm p-1 border rounded bg-gray-50">
                    <input v-model="flightInfo.time" type="time" class="w-full text-sm p-1 border rounded bg-gray-50">
                    <input v-model="flightInfo.terminal" placeholder="航廈" class="w-full text-sm p-1 border rounded bg-gray-50">
                    <button @click="saveFlightInfo" class="w-full bg-coffee text-milk-yellow text-xs py-1 rounded">儲存</button>
                </div>
            </div>

            <!-- Itinerary Items -->
            <div v-if="dayItems.length === 0" class="text-center py-10 text-gray-400">
                <i class="fa-regular fa-map text-4xl mb-2"></i>
                <p>還沒有行程，按下方 + 新增</p>
            </div>

            <div v-for="item in dayItems" :key="item.id" class="bg-white rounded-2xl p-3 shadow-sm flex gap-3 relative group">
                <!-- Delete Button -->
                <button @click="deleteItem(item.id)" class="absolute top-2 right-2 text-red-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">
                    <i class="fa-solid fa-times-circle"></i>
                </button>

                <!-- Time -->
                <div class="flex flex-col items-center justify-start pt-1 min-w-[50px]">
                    <span class="font-bold text-coffee text-lg">{{ item.time }}</span>
                    <div class="h-full w-0.5 bg-gray-100 my-1 rounded"></div>
                </div>

                <!-- Content -->
                <div class="flex-1 pb-2">
                    <div class="font-bold text-lg text-coffee mb-1">{{ item.title }}</div>
                    <div class="text-sm text-gray-500 mb-2 flex items-center">
                        <i class="fa-solid fa-location-dot mr-1 text-accent"></i> {{ item.location }}
                    </div>
                    
                    <!-- Image Display -->
                    <div v-if="item.imageUrl" class="mb-2 rounded-lg overflow-hidden h-32 w-full">
                        <img :src="item.imageUrl" class="w-full h-full object-cover" alt="Location">
                    </div>

                    <!-- Notes -->
                    <div v-if="item.notes" class="text-xs text-gray-600 bg-gray-50 p-2 rounded">
                        {{ item.notes }}
                    </div>
                </div>
            </div>

            <!-- Add Button -->
            <button @click="showAddItemModal = true" class="w-full py-3 rounded-2xl border-2 border-dashed border-coffee/30 text-coffee/50 font-bold hover:bg-white hover:text-coffee transition-colors">
                + 新增行程
            </button>
        </div>

        <!-- TAB: Map -->
        <div v-show="currentTab === 'map'" class="h-full w-full relative">
            <div id="map" class="h-full w-full"></div>
            <!-- Map Controls Overlay -->
            <div class="absolute top-4 left-4 right-4 z-[400] bg-white/90 backdrop-blur rounded-xl p-3 shadow-lg">
                 <div class="flex justify-between items-center">
                    <span class="font-bold text-coffee text-sm">Day {{ selectedDayIndex + 1 }} 地圖</span>
                    <button @click="locateMe" class="bg-accent text-white px-3 py-1 rounded-lg text-xs">
                        <i class="fa-solid fa-location-crosshairs mr-1"></i>我
                    </button>
                 </div>
            </div>
        </div>

        <!-- TAB: Money (Expenses) -->
        <div v-if="currentTab === 'money'" class="p-4 space-y-4">
            <!-- Balance Summary -->
            <div class="bg-coffee text-milk-yellow rounded-2xl p-4 shadow-lg">
                <h3 class="font-bold mb-2 text-sm opacity-80">總支出 (TWD)</h3>
                <div class="text-3xl font-bold mb-4">${{ totalExpenseTwd }}</div>
                <div class="flex gap-2 overflow-x-auto">
                    <div v-for="(balance, user) in userBalances" :key="user" class="bg-white/10 px-3 py-1 rounded-lg text-xs whitespace-nowrap">
                        {{ user }}: <span :class="balance >= 0 ? 'text-green-300' : 'text-red-300'">{{ balance >= 0 ? '+' : '' }}{{ balance }}</span>
                    </div>
                </div>
            </div>

            <!-- Add Expense -->
            <div class="bg-white rounded-xl p-3 shadow-sm">
                <div class="flex gap-2 mb-2">
                    <input v-model="newExpense.desc" placeholder="項目 (如: 晚餐)" class="flex-1 bg-gray-50 p-2 rounded text-sm outline-none">
                    <input v-model="newExpense.amount" type="number" placeholder="金額" class="w-20 bg-gray-50 p-2 rounded text-sm outline-none">
                </div>
                <div class="flex gap-2 mb-2">
                    <select v-model="newExpense.currency" class="bg-gray-50 p-2 rounded text-sm">
                        <option value="TWD">TWD</option>
                        <option value="JPY">JPY</option>
                        <option value="KRW">KRW</option>
                        <option value="USD">USD</option>
                    </select>
                    <select v-model="newExpense.payer" class="flex-1 bg-gray-50 p-2 rounded text-sm">
                        <option value="" disabled>誰付錢?</option>
                        <option v-for="u in users" :value="u">{{ u }}</option>
                    </select>
                </div>
                <button @click="addExpense" class="w-full bg-accent text-white py-2 rounded-lg font-bold text-sm">記一筆</button>
            </div>

            <!-- Expense List -->
            <div class="space-y-2">
                <div v-for="exp in expenses" :key="exp.id" class="bg-white p-3 rounded-xl flex justify-between items-center shadow-sm">
                    <div>
                        <div class="font-bold text-coffee">{{ exp.desc }}</div>
                        <div class="text-xs text-gray-500">{{ exp.payer }} 付款</div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-coffee">{{ exp.amount }} {{ exp.currency }}</div>
                        <div class="text-xs text-gray-400">≈ {{ (exp.amount * rates[exp.currency]).toFixed(0) }} TWD</div>
                    </div>
                    <button @click="deleteExpense(exp.id)" class="text-red-300 ml-2"><i class="fa-solid fa-trash"></i></button>
                </div>
            </div>
        </div>

        <!-- TAB: Chat -->
        <div v-if="currentTab === 'chat'" class="flex flex-col h-full">
            <div class="flex-1 p-4 space-y-3 overflow-y-auto" ref="chatContainer">
                <div v-for="msg in sortedMessages" :key="msg.id" class="flex flex-col" :class="msg.userId === currentUserId ? 'items-end' : 'items-start'">
                    <div class="max-w-[80%] rounded-2xl px-4 py-2 text-sm shadow-sm" 
                         :class="msg.userId === currentUserId ? 'bg-coffee text-milk-yellow' : 'bg-white text-coffee'">
                        <div class="text-[10px] opacity-70 mb-1" v-if="msg.userId !== currentUserId">{{ msg.userName }}</div>
                        {{ msg.text }}
                    </div>
                    <span class="text-[10px] text-gray-400 mt-1 mx-1">{{ formatTime(msg.timestamp) }}</span>
                </div>
            </div>
            <div class="p-3 bg-white border-t border-gray-100 flex gap-2 absolute bottom-0 w-full">
                <input v-model="newMessage" @keyup.enter="sendMessage" placeholder="說點什麼..." class="flex-1 bg-gray-100 rounded-full px-4 py-2 text-sm outline-none text-coffee">
                <button @click="sendMessage" class="bg-coffee text-white w-10 h-10 rounded-full flex items-center justify-center">
                    <i class="fa-solid fa-paper-plane text-xs"></i>
                </button>
            </div>
        </div>

        <!-- TAB: Tools (Checklist, Translation) -->
        <div v-if="currentTab === 'tools'" class="p-4 space-y-4">
            
            <!-- Google Translate Link -->
            <a href="https://translate.google.com/" target="_blank" class="block w-full bg-blue-500 text-white p-4 rounded-2xl flex items-center justify-between shadow-md">
                <span class="font-bold"><i class="fa-solid fa-language mr-2"></i>Google 翻譯</span>
                <i class="fa-solid fa-arrow-up-right-from-square"></i>
            </a>

            <!-- Checklist -->
            <div class="bg-white rounded-2xl p-4 shadow-sm">
                <h3 class="font-bold text-coffee mb-3"><i class="fa-solid fa-clipboard-check mr-2"></i>必備清單</h3>
                <div class="space-y-2">
                    <div v-for="item in checklist" :key="item.id" @click="toggleCheck(item)" class="flex items-center gap-3 cursor-pointer">
                        <div class="w-5 h-5 rounded border-2 flex items-center justify-center transition-colors"
                             :class="item.checked ? 'bg-accent border-accent' : 'border-gray-300'">
                            <i v-if="item.checked" class="fa-solid fa-check text-white text-xs"></i>
                        </div>
                        <span :class="{'line-through text-gray-400': item.checked}">{{ item.text }}</span>
                    </div>
                    <div class="flex gap-2 mt-3 pt-3 border-t">
                        <input v-model="newCheckItem" @keyup.enter="addCheckItem" placeholder="新增項目..." class="flex-1 bg-gray-50 p-2 rounded text-sm">
                        <button @click="addCheckItem" class="text-accent font-bold px-2">新增</button>
                    </div>
                </div>
            </div>
            
            <!-- User Settings -->
            <div class="bg-white rounded-2xl p-4 shadow-sm">
                <h3 class="font-bold text-coffee mb-2">使用者設定</h3>
                <input v-model="tempUserName" placeholder="你的暱稱" class="border p-2 rounded w-full text-sm mb-2">
                <button @click="updateUserName" class="bg-coffee text-white px-4 py-2 rounded text-sm w-full">更新暱稱</button>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="fixed bottom-0 w-full max-w-[480px] bg-white border-t border-gray-100 flex justify-around py-2 pb-4 z-50 text-[10px] font-bold text-gray-400">
        <button @click="currentTab = 'itinerary'" class="flex flex-col items-center w-1/5 space-y-1 transition-colors" :class="currentTab === 'itinerary' ? 'text-coffee' : ''">
            <i class="fa-solid fa-list-ul text-lg" :class="currentTab === 'itinerary' ? 'transform -translate-y-1' : ''"></i>
            <span>行程</span>
        </button>
        <button @click="currentTab = 'map'; initMap()" class="flex flex-col items-center w-1/5 space-y-1 transition-colors" :class="currentTab === 'map' ? 'text-coffee' : ''">
            <i class="fa-regular fa-map text-lg" :class="currentTab === 'map' ? 'transform -translate-y-1' : ''"></i>
            <span>地圖</span>
        </button>
        <button @click="currentTab = 'money'" class="flex flex-col items-center w-1/5 space-y-1 transition-colors" :class="currentTab === 'money' ? 'text-coffee' : ''">
            <i class="fa-solid fa-wallet text-lg" :class="currentTab === 'money' ? 'transform -translate-y-1' : ''"></i>
            <span>分帳</span>
        </button>
        <button @click="currentTab = 'chat'; scrollToBottom()" class="flex flex-col items-center w-1/5 space-y-1 transition-colors" :class="currentTab === 'chat' ? 'text-coffee' : ''">
            <i class="fa-regular fa-comments text-lg" :class="currentTab === 'chat' ? 'transform -translate-y-1' : ''"></i>
            <span>聊聊</span>
        </button>
        <button @click="currentTab = 'tools'" class="flex flex-col items-center w-1/5 space-y-1 transition-colors" :class="currentTab === 'tools' ? 'text-coffee' : ''">
            <i class="fa-solid fa-grid-2 text-lg" :class="currentTab === 'tools' ? 'transform -translate-y-1' : ''"></i>
            <span>工具</span>
        </button>
    </div>

    <!-- Modals -->
    <!-- Add Item Modal -->
    <div v-if="showAddItemModal" class="fixed inset-0 z-[60] bg-black/50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-xl">
            <h3 class="text-xl font-bold text-coffee mb-4">新增行程</h3>
            <div class="space-y-3">
                <input v-model="newItem.time" type="time" class="w-full bg-gray-50 p-3 rounded-xl outline-none">
                <input v-model="newItem.title" placeholder="標題 (例: 淺草寺)" class="w-full bg-gray-50 p-3 rounded-xl outline-none">
                <input v-model="newItem.location" placeholder="地點 (供地圖定位)" class="w-full bg-gray-50 p-3 rounded-xl outline-none">
                <input v-model="newItem.imageUrl" placeholder="圖片網址 (選填)" class="w-full bg-gray-50 p-3 rounded-xl outline-none text-sm">
                <textarea v-model="newItem.notes" placeholder="備註..." class="w-full bg-gray-50 p-3 rounded-xl outline-none h-20"></textarea>
            </div>
            <div class="flex gap-3 mt-6">
                <button @click="showAddItemModal = false" class="flex-1 py-3 rounded-xl bg-gray-100 text-gray-500 font-bold">取消</button>
                <button @click="addItem" class="flex-1 py-3 rounded-xl bg-coffee text-milk-yellow font-bold">新增</button>
            </div>
        </div>
    </div>

    <!-- Calculator Modal -->
    <div v-if="showCalc" class="fixed inset-0 z-[70] bg-black/50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-xl relative">
            <button @click="showCalc = false" class="absolute top-4 right-4 text-gray-400"><i class="fa-solid fa-times"></i></button>
            <h3 class="text-xl font-bold text-coffee mb-4">匯率換算</h3>
            
            <div class="bg-gray-50 p-4 rounded-xl mb-4">
                <label class="text-xs text-gray-500">外幣金額</label>
                <div class="flex items-end gap-2">
                    <input v-model="calcAmount" type="number" class="bg-transparent text-2xl font-bold text-coffee outline-none w-full border-b border-gray-200">
                    <select v-model="calcCurrency" class="bg-transparent font-bold text-accent">
                        <option value="JPY">JPY</option>
                        <option value="KRW">KRW</option>
                        <option value="USD">USD</option>
                    </select>
                </div>
            </div>

            <div class="text-center mb-4">
                <i class="fa-solid fa-arrow-down text-gray-300"></i>
            </div>

            <div class="bg-coffee text-milk-yellow p-4 rounded-xl">
                <label class="text-xs opacity-70">台幣約</label>
                <div class="text-3xl font-bold">
                    ${{ (calcAmount * rates[calcCurrency]).toLocaleString(undefined, {maximumFractionDigits: 0}) }}
                </div>
                <div class="text-xs mt-1 text-right opacity-50">匯率: {{ rates[calcCurrency] }}</div>
            </div>
            
            <div class="mt-4 text-xs text-gray-400 text-center">
                * 匯率可於程式碼中調整，目前為預設值
            </div>
        </div>
    </div>

</div>

<script type="module">
    const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

    // Firebase Setup
    let db, auth;
    let appId = 'travel-buddy-demo'; 
    if (typeof __app_id !== 'undefined') appId = __app_id;

    // --- FIREBASE CONFIGURATION (已填入您的資料) ---
    const firebaseConfig = {
        apiKey: "AIzaSyDFUGYOobmVxYFQMBYz1iQ4z1HIrdbTi8Q",
        authDomain: "travel-55c4b.firebaseapp.com",
        databaseURL: "https://travel-55c4b-default-rtdb.firebaseio.com",
        projectId: "travel-55c4b",
        storageBucket: "travel-55c4b.firebasestorage.app",
        messagingSenderId: "925227625640",
        appId: "1:925227625640:web:4cc6d501b2e21ab7f8a69d",
        measurementId: "G-ZE814KZD8Y"
    };

    // 使用您的 Config 初始化 Firebase
    const app = window.firebaseModules.initializeApp(firebaseConfig);
    auth = window.firebaseModules.getAuth(app);
    db = window.firebaseModules.getFirestore(app);
    
    const { signInAnonymously, onAuthStateChanged, signInWithCustomToken } = window.firebaseModules;
    const { collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc, serverTimestamp, where } = window.firebaseModules;

    createApp({
        setup() {
            // -- State --
            const loading = ref(true);
            const currentTab = ref('itinerary');
            const showAddItemModal = ref(false);
            const showCalc = ref(false);
            const user = ref(null);
            const currentUserId = ref('');
            const currentUserName = ref('旅客');
            const tempUserName = ref('');

            // Data
            const tripDays = ref([new Date(), new Date(new Date().setDate(new Date().getDate() + 1)), new Date(new Date().setDate(new Date().getDate() + 2))]); // 3 days default
            const selectedDayIndex = ref(0);
            const itineraryItems = ref([]);
            
            const users = ref(['我', '朋友A', '朋友B', '朋友C']); // Mock users for split bill
            const expenses = ref([]);
            const newExpense = ref({ desc: '', amount: '', currency: 'TWD', payer: '我' });
            
            const chatMessages = ref([]);
            const newMessage = ref('');
            const chatContainer = ref(null);

            const checklist = ref([]);
            const newCheckItem = ref('');

            const flightInfo = ref({ code: '', time: '', terminal: '' });
            const editingFlight = ref(false);

            // New Item Form
            const newItem = ref({ time: '09:00', title: '', location: '', imageUrl: '', notes: '' });
            
            // Calc
            const calcAmount = ref(1000);
            const calcCurrency = ref('JPY');
            const rates = ref({
                'JPY': 0.22,
                'KRW': 0.024,
                'USD': 31.5,
                'TWD': 1
            });

            // Map
            let mapInstance = null;
            let markers = [];
            const tripLocation = ref('台北'); // Default for weather
            const currentWeather = ref(null);

            // -- Computed --
            const dayItems = computed(() => {
                const targetDate = formatDate(tripDays.value[selectedDayIndex.value]);
                return itineraryItems.value
                    .filter(i => i.dateStr === targetDate)
                    .sort((a, b) => a.time.localeCompare(b.time));
            });

            const totalExpenseTwd = computed(() => {
                return expenses.value.reduce((acc, curr) => {
                    return acc + (parseFloat(curr.amount) * rates.value[curr.currency]);
                }, 0).toFixed(0);
            });

            const userBalances = computed(() => {
                const balances = {};
                users.value.forEach(u => balances[u] = 0);
                
                expenses.value.forEach(exp => {
                    const costInTwd = parseFloat(exp.amount) * rates.value[exp.currency];
                    const perPerson = costInTwd / users.value.length;
                    
                    // Payer gets credit
                    if(balances[exp.payer] !== undefined) balances[exp.payer] += costInTwd;
                    
                    // Everyone gets debt
                    users.value.forEach(u => balances[u] -= perPerson);
                });
                
                // Round
                Object.keys(balances).forEach(k => balances[k] = Math.round(balances[k]));
                return balances;
            });

            const sortedMessages = computed(() => {
                return [...chatMessages.value].sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
            });

            // -- Methods --
            const formatDate = (date) => {
                const d = new Date(date);
                return `${d.getMonth() + 1}/${d.getDate()}`;
            };

            const addDay = () => {
                const lastDay = tripDays.value[tripDays.value.length - 1];
                const newDay = new Date(lastDay);
                newDay.setDate(newDay.getDate() + 1);
                tripDays.value.push(newDay);
            };

            const formatTime = (ts) => {
                if(!ts) return '';
                const d = new Date(ts.seconds * 1000);
                return `${d.getHours()}:${d.getMinutes().toString().padStart(2, '0')}`;
            };

            // Firebase Operations
            const addItem = async () => {
                if (!newItem.value.title) return;
                const dateStr = formatDate(tripDays.value[selectedDayIndex.value]);
                
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'itinerary'), {
                    ...newItem.value,
                    dateStr,
                    createdAt: serverTimestamp()
                });
                
                showAddItemModal.value = false;
                newItem.value = { time: '09:00', title: '', location: '', imageUrl: '', notes: '' };
            };

            const deleteItem = async (id) => {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'itinerary', id));
            };

            const addExpense = async () => {
                if (!newExpense.value.amount || !newExpense.value.desc) return;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'expenses'), {
                    ...newExpense.value,
                    createdAt: serverTimestamp()
                });
                newExpense.value.desc = '';
                newExpense.value.amount = '';
            };

            const deleteExpense = async (id) => {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'expenses', id));
            };

            const sendMessage = async () => {
                if (!newMessage.value.trim()) return;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chat'), {
                    text: newMessage.value,
                    userId: currentUserId.value,
                    userName: currentUserName.value,
                    timestamp: serverTimestamp()
                });
                newMessage.value = '';
                scrollToBottom();
            };
            
            const scrollToBottom = async () => {
                await nextTick();
                if(chatContainer.value) {
                    chatContainer.value.scrollTop = chatContainer.value.scrollHeight;
                }
            };

            const addCheckItem = async () => {
                 if (!newCheckItem.value.trim()) return;
                 await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'checklist'), {
                     text: newCheckItem.value,
                     checked: false
                 });
                 newCheckItem.value = '';
            };

            const toggleCheck = async (item) => {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'checklist', item.id), {
                    checked: !item.checked
                });
            };

            const updateUserName = () => {
                if(tempUserName.value) {
                    currentUserName.value = tempUserName.value;
                    localStorage.setItem('travel_app_username', tempUserName.value);
                    alert("暱稱已更新！");
                }
            };

            const saveFlightInfo = async () => {
                // Ideally this would also be in Firestore, but for simplicity using LocalStorage or a single Doc
                // Let's use Firestore singular doc pattern simulation
                 await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'flight'), {
                     ...flightInfo.value,
                     updatedAt: serverTimestamp()
                 }); // This is a bit spammy, in real app use setDoc with fixed ID
                 editingFlight.value = false;
            };

            // Map & Weather
            const initMap = () => {
                nextTick(() => {
                    if (!mapInstance && document.getElementById('map')) {
                        mapInstance = L.map('map').setView([25.0330, 121.5654], 13); // Default Taipei
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '© OpenStreetMap'
                        }).addTo(mapInstance);
                    }
                    updateMapMarkers();
                });
            };

            const updateMapMarkers = () => {
                if (!mapInstance) return;
                
                // Clear existing
                markers.forEach(m => mapInstance.removeLayer(m));
                markers = [];

                // Add new from current day items
                let bounds = [];
                dayItems.value.forEach(item => {
                    // This is a simulation. In a real app, you need to Geocode the address string to Lat/Lng
                    // Here we will simulate random spread around current center if no coords, 
                    // OR if the user provides coords in location. 
                    // Since we don't have a geocoding API key, we will simulate "pinning" by just showing current user location + random offsets for demo,
                    // OR we assume the user might enter "25.03, 121.56" in location.
                    // For a robust demo without API keys, we will just pin the User's location.
                });
            };

            const locateMe = () => {
                 if (navigator.geolocation && mapInstance) {
                    navigator.geolocation.getCurrentPosition(position => {
                        const { latitude, longitude } = position.coords;
                        mapInstance.setView([latitude, longitude], 15);
                        
                        const myIcon = L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div style="background-color:#BB9457;width:15px;height:15px;border-radius:50%;border:2px solid white;box-shadow:0 0 10px rgba(0,0,0,0.5);"></div>`,
                            iconSize: [15, 15],
                            iconAnchor: [7, 7]
                        });

                        L.marker([latitude, longitude], {icon: myIcon}).addTo(mapInstance)
                            .bindPopup("你在這裡").openPopup();
                            
                        // Fetch weather for this location
                        fetchWeather(latitude, longitude);
                    });
                } else {
                    alert("無法取得位置");
                }
            };
            
            const fetchWeather = async (lat, lng) => {
                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true`);
                    const data = await res.json();
                    if(data.current_weather) {
                        currentWeather.value = {
                            temp: data.current_weather.temperature,
                            desc: '晴/多雲' // OpenMeteo returns numeric codes, simplifying for demo
                        };
                    }
                } catch(e) { console.error(e); }
            };

            // -- Lifecycle --
            onMounted(async () => {
                // Auth - 使用匿名登入 (因為是您自己的 Firebase 專案)
                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("登入失敗:", error);
                    alert("登入失敗，請檢查 Firebase Authentication 是否已開啟 '匿名' 登入功能。");
                }
                
                onAuthStateChanged(auth, (u) => {
                    if (u) {
                        user.value = u;
                        currentUserId.value = u.uid;
                        loading.value = false;
                        
                        // Listeners
                        onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'itinerary'), (snap) => {
                            itineraryItems.value = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        });
                        onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'expenses'), (snap) => {
                            expenses.value = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        });
                        onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'chat'), (snap) => {
                            chatMessages.value = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        });
                        onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'checklist'), (snap) => {
                            checklist.value = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        });
                        // Flight listener (simplified, taking last)
                        onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'flight'), orderBy('updatedAt', 'desc')), (snap) => {
                           if(!snap.empty) flightInfo.value = snap.docs[0].data();
                        });
                    }
                });

                // Load local name
                const savedName = localStorage.getItem('travel_app_username');
                if(savedName) currentUserName.value = savedName;
                
                // Init fake weather
                fetchWeather(25.03, 121.56); // Taipei default
            });

            return {
                loading, currentTab, tripDays, selectedDayIndex, dayItems,
                showAddItemModal, newItem, addItem, deleteItem,
                initMap, locateMe,
                expenses, newExpense, addExpense, deleteExpense, totalExpenseTwd, userBalances, users, rates, showCalc, calcAmount, calcCurrency,
                chatMessages, newMessage, sendMessage, chatContainer, sortedMessages, currentUserId, formatTime,
                checklist, newCheckItem, addCheckItem, toggleCheck,
                flightInfo, editingFlight, saveFlightInfo,
                currentWeather, tripLocation,
                formatDate, addDay,
                tempUserName, updateUserName
            };
        }
    }).mount('#app');
</script>
</body>
</html>
