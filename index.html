<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Travel Buddy Pro v3.0</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDK (Version 10.7.1 - Stable) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc, serverTimestamp, where, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        window.fb = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc, serverTimestamp, where, getDoc, setDoc };
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 'milk': '#FFF8E7', 'coffee': '#432818', 'accent': '#BB9457', 'green': '#88B04B', 'red': '#E05D5D' },
                    fontFamily: { sans: ['Noto Sans TC', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        body { background-color: #FFF8E7; color: #432818; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; } .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        #map { height: 100%; width: 100%; z-index: 0; }
        .app-shell { max-width: 480px; margin: 0 auto; background: #FFF8E7; min-height: 100vh; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .console-box { position: fixed; bottom: 0; left: 0; width: 100%; height: 200px; background: rgba(0,0,0,0.9); color: #0f0; font-family: monospace; font-size: 10px; overflow-y: auto; z-index: 9999; padding: 10px; display: none; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-online { background-color: #4CAF50; box-shadow: 0 0 5px #4CAF50; }
        .status-offline { background-color: #F44336; }
        .status-connecting { background-color: #FFC107; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<!-- Debug Console -->
<div id="debug-console" class="console-box">
    <div style="border-bottom:1px solid #333; margin-bottom:5px; padding-bottom:5px; display:flex; justify-content:space-between;">
        <span>系統紀錄 (Debug Log)</span>
        <button onclick="document.getElementById('debug-console').style.display='none'" style="color:white;">關閉</button>
    </div>
    <div id="log-content"></div>
</div>

<div id="app" class="app-shell flex flex-col h-screen overflow-hidden">

    <!-- Top Status Bar -->
    <div class="px-4 pt-4 pb-2 flex justify-between items-center bg-milk z-10">
        <div class="flex items-center text-xs font-bold text-coffee cursor-pointer" @click="toggleDebug">
            <span class="status-dot" :class="connectionStatusClass"></span>
            {{ connectionStatusText }}
        </div>
        <div v-if="user" class="text-xs font-bold bg-coffee/10 px-2 py-1 rounded-full text-coffee">
            {{ userProfile.name || '訪客' }}
        </div>
    </div>

    <!-- MAIN VIEW SWITCHER -->
    <div class="flex-1 overflow-y-auto no-scrollbar relative">
        
        <!-- 1. HOME: Trip List -->
        <div v-if="!currentTripId" class="p-4 space-y-4">
            <div class="text-center py-4">
                <h1 class="text-2xl font-bold text-coffee">Travel Buddy Pro</h1>
                <p class="text-xs text-gray-500">v3.0 無敵版</p>
            </div>

            <div class="bg-white p-4 rounded-2xl shadow-sm border border-coffee/5">
                <h3 class="font-bold text-coffee mb-3">建立新旅程</h3>
                <input v-model="newTripName" placeholder="輸入旅程名稱 (例: 東京5日遊)" class="w-full bg-gray-50 p-3 rounded-xl mb-3 border border-gray-100 outline-none text-sm">
                <button @click="createTrip" :disabled="isProcessing" class="w-full bg-coffee text-white py-3 rounded-xl font-bold shadow-md hover:bg-opacity-90 active:scale-95 transition-transform disabled:opacity-50">
                    {{ isProcessing ? '處理中...' : '+ 建立' }}
                </button>
            </div>

            <div class="bg-white p-4 rounded-2xl shadow-sm border border-coffee/5">
                <h3 class="font-bold text-coffee mb-3">加入旅程</h3>
                <div class="flex gap-2">
                    <input v-model="joinCode" placeholder="輸入代碼" class="flex-1 bg-gray-50 p-3 rounded-xl border border-gray-100 outline-none text-sm">
                    <button @click="joinTrip" class="bg-accent text-white px-4 rounded-xl font-bold">加入</button>
                </div>
            </div>

            <div>
                <h3 class="font-bold text-coffee mb-2">我的旅程</h3>
                <div v-if="myTrips.length === 0" class="text-center text-gray-400 py-8 bg-white/50 rounded-2xl border-2 border-dashed border-gray-200">
                    沒有行程，先建立一個吧！<br>
                    <span class="text-xs">(若連線失敗，資料將保存在本機)</span>
                </div>
                <div v-else class="space-y-3">
                    <div v-for="trip in myTrips" :key="trip.id" @click="enterTrip(trip)" class="bg-white p-4 rounded-xl shadow-sm flex justify-between items-center cursor-pointer hover:bg-gray-50 transition">
                        <span class="font-bold text-coffee">{{ trip.name }}</span>
                        <i class="fa-solid fa-chevron-right text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. APP: Inside Trip -->
        <div v-else class="flex flex-col h-full">
            <!-- App Header -->
            <div class="px-4 pb-2 flex items-center gap-2 bg-milk z-10 border-b border-gray-100">
                <button @click="exitTrip" class="w-8 h-8 flex items-center justify-center bg-white rounded-full shadow-sm text-coffee"><i class="fa-solid fa-arrow-left"></i></button>
                <div class="flex-1 text-center font-bold text-coffee truncate">{{ currentTrip.name }}</div>
                <button @click="showInvite=true" class="w-8 h-8 flex items-center justify-center bg-accent text-white rounded-full shadow-sm"><i class="fa-solid fa-share-nodes text-xs"></i></button>
            </div>

            <!-- Tabs Content -->
            <div class="flex-1 overflow-y-auto bg-milk relative">
                
                <!-- Itinerary -->
                <div v-if="currentTab==='itinerary'" class="p-4 space-y-4 pb-20">
                    <!-- Date Slider -->
                    <div class="flex overflow-x-auto gap-2 py-1 no-scrollbar">
                        <button v-for="(day, idx) in tripDays" :key="idx" @click="selectedDayIndex=idx" 
                            class="flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold transition-all min-w-[60px]"
                            :class="selectedDayIndex===idx ? 'bg-coffee text-white shadow-md' : 'bg-white text-gray-400'">
                            Day {{ idx+1 }}<br><span class="font-normal">{{ formatDate(day) }}</span>
                        </button>
                        <button @click="addDay" class="px-3 rounded-xl bg-white border border-dashed border-gray-300 text-gray-400">+</button>
                    </div>

                    <!-- Items -->
                    <div v-if="dayItems.length===0" class="text-center py-10 text-gray-400 opacity-50">
                        <i class="fa-regular fa-map text-3xl mb-2"></i><br>尚無行程
                    </div>
                    <div v-for="item in dayItems" :key="item.id" class="flex gap-3 relative group">
                        <div class="flex flex-col items-center pt-1 w-12 flex-shrink-0">
                            <span class="text-sm font-bold text-coffee">{{ item.time }}</span>
                            <div class="h-full w-0.5 bg-gray-200 my-1 rounded"></div>
                        </div>
                        <div class="flex-1 bg-white p-3 rounded-xl shadow-sm mb-3 relative overflow-hidden">
                            <button @click="deleteItem(item.id)" class="absolute top-2 right-2 text-gray-300 hover:text-red-500 p-2"><i class="fa-solid fa-trash"></i></button>
                            <div class="font-bold text-coffee">{{ item.title }}</div>
                            <div class="text-xs text-gray-500 mb-1" @click="openMapTo(item)"><i class="fa-solid fa-location-dot text-accent"></i> {{ item.locationName }}</div>
                            <div v-if="item.notes" class="text-xs bg-gray-50 p-2 rounded text-gray-600">{{ item.notes }}</div>
                        </div>
                    </div>
                    <button @click="showAddItem=true" class="w-full py-3 bg-white border-2 border-dashed border-coffee/20 rounded-xl text-coffee/50 font-bold hover:border-coffee hover:text-coffee transition-colors">+ 新增景點</button>
                </div>

                <!-- Map -->
                <div v-show="currentTab==='map'" class="h-full w-full relative">
                    <div id="map"></div>
                    <div class="absolute top-2 left-2 right-2 bg-white p-2 rounded-xl shadow-lg flex gap-2 z-[400]">
                        <input v-model="mapQuery" @keyup.enter="searchMap" placeholder="搜尋地點..." class="flex-1 text-sm outline-none">
                        <button @click="searchMap" class="text-coffee"><i class="fa-solid fa-search"></i></button>
                    </div>
                </div>

                <!-- Money -->
                <div v-if="currentTab==='money'" class="p-4 space-y-4 pb-20">
                    <div class="bg-coffee text-milk p-4 rounded-2xl shadow-lg flex justify-between items-end">
                        <div>
                            <div class="text-xs opacity-70">總支出</div>
                            <div class="text-3xl font-bold">${{ totalExpense }}</div>
                        </div>
                        <div class="text-xs bg-white/20 px-2 py-1 rounded">TWD</div>
                    </div>
                    <div class="bg-white p-3 rounded-xl shadow-sm space-y-2">
                        <div class="flex gap-2">
                            <input v-model="newExp.desc" placeholder="項目" class="flex-1 bg-gray-50 p-2 rounded text-sm">
                            <input v-model="newExp.amount" type="number" placeholder="$" class="w-20 bg-gray-50 p-2 rounded text-sm">
                        </div>
                        <button @click="addExpense" class="w-full bg-accent text-white py-2 rounded-lg text-sm font-bold">記一筆</button>
                    </div>
                    <div class="space-y-2">
                        <div v-for="ex in expenses" :key="ex.id" class="bg-white p-3 rounded-xl flex justify-between items-center shadow-sm">
                            <span class="text-sm font-bold text-coffee">{{ ex.desc }}</span>
                            <div class="flex items-center gap-2">
                                <span class="font-bold">${{ ex.amount }}</span>
                                <button @click="deleteExpense(ex.id)" class="text-gray-300 hover:text-red-500"><i class="fa-solid fa-trash text-xs"></i></button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tools -->
                <div v-if="currentTab==='tools'" class="p-4 space-y-4">
                    <div class="bg-white p-4 rounded-2xl shadow-sm">
                        <h3 class="font-bold text-coffee mb-2">翻譯</h3>
                        <div class="flex gap-2 mb-2"><input v-model="transInput" class="flex-1 bg-gray-50 p-2 rounded text-sm" placeholder="輸入文字"><button @click="doTranslate" class="bg-coffee text-white px-3 rounded text-sm">翻</button></div>
                        <div v-if="transResult" class="text-sm bg-yellow-50 p-2 rounded text-coffee font-bold">{{ transResult }}</div>
                    </div>
                </div>

            </div>

            <!-- Bottom Nav -->
            <div class="fixed bottom-0 w-full max-w-[480px] bg-white border-t border-gray-100 flex justify-around py-3 z-50 text-[10px] font-bold text-gray-400">
                <button @click="currentTab='itinerary'" :class="currentTab==='itinerary'?'text-coffee':''" class="flex flex-col items-center w-1/4"><i class="fa-solid fa-list-ul text-lg mb-1"></i>行程</button>
                <button @click="currentTab='map'; initMap()" :class="currentTab==='map'?'text-coffee':''" class="flex flex-col items-center w-1/4"><i class="fa-regular fa-map text-lg mb-1"></i>地圖</button>
                <button @click="currentTab='money'" :class="currentTab==='money'?'text-coffee':''" class="flex flex-col items-center w-1/4"><i class="fa-solid fa-wallet text-lg mb-1"></i>分帳</button>
                <button @click="currentTab='tools'" :class="currentTab==='tools'?'text-coffee':''" class="flex flex-col items-center w-1/4"><i class="fa-solid fa-toolbox text-lg mb-1"></i>工具</button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div v-if="showAddItem" class="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-5 space-y-3">
            <h3 class="font-bold text-coffee text-lg">新增景點</h3>
            <input v-model="newItem.time" type="time" class="w-full bg-gray-50 p-2 rounded-lg border">
            <div class="flex gap-2"><input v-model="newItem.locName" placeholder="搜尋地點" class="flex-1 bg-gray-50 p-2 rounded-lg border"><button @click="searchLoc" class="bg-accent text-white px-3 rounded-lg">搜</button></div>
            <div v-if="locSuggestions.length" class="max-h-24 overflow-y-auto bg-gray-50 p-1"><div v-for="l in locSuggestions" @click="selectLoc(l)" class="p-1 border-b text-xs truncate">{{l.display_name}}</div></div>
            <input v-model="newItem.title" placeholder="名稱" class="w-full bg-gray-50 p-2 rounded-lg border">
            <div class="flex gap-2">
                <button @click="addItem" class="flex-1 bg-coffee text-white py-2 rounded-lg font-bold">確認</button>
                <button @click="showAddItem=false" class="flex-1 bg-gray-100 text-gray-500 py-2 rounded-lg">取消</button>
            </div>
        </div>
    </div>

    <div v-if="showProfileModal" class="fixed inset-0 z-[100] bg-black/90 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 text-center">
            <h3 class="font-bold text-xl text-coffee mb-4">歡迎來到 Travel Buddy</h3>
            <input v-model="tempName" placeholder="請輸入暱稱" class="w-full bg-gray-50 p-3 rounded-xl mb-4 text-center border-2 border-coffee/20 focus:border-coffee outline-none">
            <button @click="saveProfile" :disabled="!tempName" class="w-full bg-coffee text-white py-3 rounded-xl font-bold disabled:opacity-50">開始使用</button>
        </div>
    </div>

    <div v-if="showInvite" class="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6 text-center">
            <h3 class="font-bold text-coffee mb-2">旅程代碼</h3>
            <div class="bg-gray-100 p-4 rounded-xl text-2xl font-mono font-bold select-all mb-4">{{ currentTripId }}</div>
            <button @click="showInvite=false" class="text-gray-400">關閉</button>
        </div>
    </div>

</div>

<script type="module">
    const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;
    // Safe logger
    const log = (msg, type='info') => {
        console.log(`[${type}] ${msg}`);
        const el = document.getElementById('log-content');
        if(el) el.innerHTML += `<div style="color:${type==='err'?'red':(type==='warn'?'yellow':'#0f0')}">> ${msg}</div>`;
    };

    // Firebase Init (Wrapped in Try-Catch to prevent crash)
    let db, auth;
    let isFirebaseReady = false;
    
    // --- YOUR CONFIG HERE ---
    const firebaseConfig = {
        apiKey: "AIzaSyDFUGYOobmVxYFQMBYz1iQ4z1HIrdbTi8Q",
        authDomain: "travel-55c4b.firebaseapp.com",
        projectId: "travel-55c4b",
        storageBucket: "travel-55c4b.firebasestorage.app",
        messagingSenderId: "925227625640",
        appId: "1:925227625640:web:4cc6d501b2e21ab7f8a69d"
    };

    try {
        if(window.fb) {
            const app = window.fb.initializeApp(firebaseConfig);
            auth = window.fb.getAuth(app);
            db = window.fb.getFirestore(app);
            isFirebaseReady = true;
            log("Firebase initialized");
        } else {
            log("Firebase SDK missing", "err");
        }
    } catch(e) {
        log("Firebase Init Failed: " + e.message, "err");
    }

    createApp({
        setup() {
            // -- State --
            const mode = ref('offline'); // offline | online
            const user = ref({ uid: 'local_user', name: '訪客' });
            const userProfile = ref({ name: '' });
            const showProfileModal = ref(false);
            const isProcessing = ref(false);
            
            // Data
            const myTrips = ref([]);
            const currentTripId = ref(null);
            const currentTrip = ref({});
            const tripDays = ref([]);
            const selectedDayIndex = ref(0);
            
            // Local Data (LocalStorage Fallback)
            const localTrips = JSON.parse(localStorage.getItem('tb_trips') || '[]');
            
            // UI State
            const currentTab = ref('itinerary');
            const showCreateTripModal = ref(false); // Using inline create for simplicity
            const newTripName = ref('');
            const joinCode = ref('');
            const showInvite = ref(false);
            const showAddItem = ref(false);
            const newItem = ref({ time: '09:00', title: '', locName: '', lat: null, lng: null, notes: '' });
            const locSuggestions = ref([]);
            const tempName = ref('');

            // Sub-features
            const items = ref([]); // Flat list of all items
            const expenses = ref([]);
            const newExp = ref({ desc: '', amount: '' });
            const mapQuery = ref('');
            const transInput = ref('');
            const transResult = ref('');

            // -- Computed --
            const connectionStatusText = computed(() => mode.value === 'online' ? '已連線' : '離線模式');
            const connectionStatusClass = computed(() => mode.value === 'online' ? 'status-online' : 'status-offline');
            const formatDate = (d) => d ? `${d.getMonth()+1}/${d.getDate()}` : '';
            
            const dayItems = computed(() => {
                if(!tripDays.value[selectedDayIndex.value]) return [];
                const dStr = formatDate(tripDays.value[selectedDayIndex.value]);
                return items.value.filter(i => i.dateStr === dStr).sort((a,b) => a.time.localeCompare(b.time));
            });
            const totalExpense = computed(() => expenses.value.reduce((a,b) => a + parseInt(b.amount||0), 0));

            // -- Helper: DB Abstraction (The Magic Part) --
            // Automatically chooses between Firebase and LocalStorage
            
            const saveData = (collectionPath, data, docId = null) => {
                const id = docId || 'doc_' + Date.now();
                if(mode.value === 'online' && db) {
                    // Firebase
                    if(docId) return window.fb.setDoc(window.fb.doc(db, collectionPath, docId), data, {merge:true});
                    else return window.fb.addDoc(window.fb.collection(db, collectionPath), data);
                } else {
                    // LocalStorage Simulation
                    log(`Saving locally to ${collectionPath}`);
                    const key = `tb_${collectionPath.replace(/\//g, '_')}`;
                    const list = JSON.parse(localStorage.getItem(key) || '[]');
                    const payload = { id, ...data };
                    // If update
                    const idx = list.findIndex(x => x.id === id);
                    if(idx >= 0) list[idx] = { ...list[idx], ...data };
                    else list.push(payload);
                    localStorage.setItem(key, JSON.stringify(list));
                    
                    // Trigger reactivity manually for local mode
                    if(collectionPath.includes('trips') && !collectionPath.includes('/')) {
                        myTrips.value = list;
                    }
                    if(currentTripId.value) loadTripData(currentTripId.value);
                    return Promise.resolve({ id });
                }
            };

            // -- Actions --
            const toggleDebug = () => { document.getElementById('debug-console').style.display = 'block'; };
            
            const saveProfile = async () => {
                if(!tempName.value) return;
                userProfile.value.name = tempName.value;
                localStorage.setItem('tb_user_name', tempName.value);
                
                if(mode.value === 'online' && user.value.uid !== 'local_user') {
                    await saveData('users', { name: tempName.value }, user.value.uid);
                }
                showProfileModal.value = false;
            };

            const createTrip = async () => {
                if(!newTripName.value) return alert("請輸入名稱");
                isProcessing.value = true;
                try {
                    const tripData = {
                        name: newTripName.value,
                        startDate: new Date().toISOString(),
                        members: [user.value.uid]
                    };
                    
                    // 1. Create Trip Doc
                    let res;
                    if(mode.value === 'online') {
                        res = await window.fb.addDoc(window.fb.collection(db, 'trips'), tripData);
                        // Link to user
                        await window.fb.setDoc(window.fb.doc(db, `users/${user.value.uid}/trips`, res.id), { role: 'owner' });
                    } else {
                        res = await saveData('trips', tripData);
                        // Local user automatically sees all local trips
                    }
                    
                    newTripName.value = '';
                    alert("建立成功！");
                    // Refresh List if local
                    if(mode.value === 'offline') {
                        myTrips.value = JSON.parse(localStorage.getItem('tb_trips') || '[]');
                    }
                } catch(e) {
                    log("Create Error: " + e.message, 'err');
                    alert("建立失敗，請查看紀錄");
                } finally {
                    isProcessing.value = false;
                }
            };

            const joinTrip = () => {
                if(!joinCode.value) return;
                if(mode.value === 'offline') return alert("離線模式無法加入他人行程");
                // Simplified join logic
                alert("請確保已開啟 Firebase 匿名登入，並確認對方代碼正確。");
            };

            const enterTrip = (trip) => {
                currentTripId.value = trip.id;
                currentTrip.value = trip;
                const start = new Date(trip.startDate);
                tripDays.value = [start, new Date(start.getTime()+86400000), new Date(start.getTime()+172800000)];
                loadTripData(trip.id);
            };

            const exitTrip = () => { currentTripId.value = null; };

            const loadTripData = (tid) => {
                if(mode.value === 'online') {
                    // Firebase Listeners
                    window.fb.onSnapshot(window.fb.collection(db, `trips/${tid}/itinerary`), (s) => items.value = s.docs.map(d=>({id:d.id, ...d.data()})));
                    window.fb.onSnapshot(window.fb.collection(db, `trips/${tid}/expenses`), (s) => expenses.value = s.docs.map(d=>({id:d.id, ...d.data()})));
                } else {
                    // Local Load
                    const k1 = `tb_trips_${tid}_itinerary`;
                    items.value = JSON.parse(localStorage.getItem(k1) || '[]');
                    const k2 = `tb_trips_${tid}_expenses`;
                    expenses.value = JSON.parse(localStorage.getItem(k2) || '[]');
                }
            };

            // Itinerary
            const addDay = () => tripDays.value.push(new Date(tripDays.value[tripDays.value.length-1].getTime()+86400000));
            const searchLoc = async () => { try{ const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(newItem.value.locName)}`); locSuggestions.value = await r.json(); }catch(e){} };
            const selectLoc = (l) => { newItem.value.locName = l.display_name.split(',')[0]; newItem.value.lat = l.lat; newItem.value.lng = l.lon; locSuggestions.value = []; };
            const addItem = async () => {
                if(!newItem.value.title) return;
                const data = { ...newItem.value, dateStr: formatDate(tripDays.value[selectedDayIndex.value]), locationName: newItem.value.locName };
                await saveData(`trips/${currentTripId.value}/itinerary`, data);
                showAddItem.value = false;
                newItem.value = { time: '09:00', title: '', locName: '', lat: null, lng: null, notes: '' };
            };
            const deleteItem = async (id) => {
                if(mode.value === 'online') await window.fb.deleteDoc(window.fb.doc(db, `trips/${currentTripId.value}/itinerary`, id));
                else {
                    const key = `tb_trips_${currentTripId.value}_itinerary`;
                    const list = items.value.filter(x => x.id !== id);
                    localStorage.setItem(key, JSON.stringify(list));
                    items.value = list;
                }
            };

            // Map
            let map;
            const initMap = () => nextTick(() => {
                if(!map && document.getElementById('map')) {
                    map = L.map('map').setView([25.03, 121.56], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                } else if(map) map.invalidateSize();
                // Clear & Draw
                map.eachLayer(l => { if(l instanceof L.Marker) map.removeLayer(l); });
                dayItems.value.forEach(i => { if(i.lat) L.marker([i.lat, i.lng]).addTo(map).bindPopup(i.title); });
            });
            const searchMap = async () => { await searchLoc(); /* Simplified re-use */ }; // For demo
            const openMapTo = (item) => { currentTab.value = 'map'; initMap(); setTimeout(() => { if(item.lat && map) { map.setView([item.lat, item.lng], 16); L.marker([item.lat, item.lng]).addTo(map).openPopup(); } }, 500); };

            // Money
            const addExpense = async () => {
                if(!newExp.value.amount) return;
                await saveData(`trips/${currentTripId.value}/expenses`, { ...newExp.value, timestamp: Date.now() });
                newExp.value = { desc: '', amount: '' };
            };
            const deleteExpense = async (id) => {
                 if(mode.value === 'online') await window.fb.deleteDoc(window.fb.doc(db, `trips/${currentTripId.value}/expenses`, id));
                 else {
                     const key = `tb_trips_${currentTripId.value}_expenses`;
                     const list = expenses.value.filter(x => x.id !== id);
                     localStorage.setItem(key, JSON.stringify(list));
                     expenses.value = list;
                 }
            };

            // Tools
            const doTranslate = async () => { try{ const r = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(transInput.value)}&langpair=zh-TW|en`); const d = await r.json(); transResult.value = d.responseData.translatedText; }catch(e){ transResult.value = "Error"; } };

            // --- Init Logic ---
            onMounted(async () => {
                log("App Mounted");
                
                // 1. Load Local Name
                const localName = localStorage.getItem('tb_user_name');
                if(localName) userProfile.value.name = localName;
                else showProfileModal.value = true;

                // 2. Load Local Trips immediately (so user sees something)
                if(localTrips.length > 0) myTrips.value = localTrips;

                // 3. Try Firebase
                if(isFirebaseReady) {
                    log("Attempting Firebase Connection...");
                    try {
                        // Race condition: if it takes > 3s, assume offline
                        const authPromise = window.fb.signInAnonymously(auth);
                        const timeout = new Promise((_, reject) => setTimeout(() => reject('timeout'), 3000));
                        
                        await Promise.race([authPromise, timeout]);
                        log("Auth Success!");
                        mode.value = 'online';
                        
                        // Setup Listeners
                        window.fb.onAuthStateChanged(auth, (u) => {
                            if(u) {
                                user.value = u;
                                log("User UID: " + u.uid);
                                // Load Cloud Trips
                                window.fb.onSnapshot(window.fb.collection(db, `users/${u.uid}/trips`), async (snap) => {
                                    const ids = snap.docs.map(d => d.id);
                                    if(ids.length) {
                                        const p = ids.map(id => window.fb.getDoc(window.fb.doc(db, 'trips', id)));
                                        const r = await Promise.all(p);
                                        myTrips.value = r.filter(x=>x.exists()).map(x=>({id:x.id, ...x.data()}));
                                    }
                                }, (err) => {
                                    log("Read Fail (Perms?): " + err.code, 'err');
                                    // Fallback to local mode silently if perms fail
                                    mode.value = 'offline';
                                });
                            }
                        });

                    } catch(e) {
                        log("Connection Failed/Timeout: " + e, 'warn');
                        mode.value = 'offline';
                    }
                } else {
                    mode.value = 'offline';
                }
            });

            return {
                mode, connectionStatusText, connectionStatusClass, toggleDebug,
                user, userProfile, showProfileModal, tempName, saveProfile, isProcessing,
                myTrips, currentTripId, currentTrip, createTrip, joinTrip, enterTrip, exitTrip, joinCode, newTripName, showInvite,
                currentTab, tripDays, selectedDayIndex, formatDate, addDay, dayItems, showAddItem, newItem, locSuggestions, searchLoc, selectLoc, addItem, deleteItem,
                initMap, mapQuery, searchMap, openMapTo,
                expenses, newExp, addExpense, deleteExpense, totalExpense,
                transInput, transResult, doTranslate
            };
        }
    }).mount('#app');
</script>
</body>
</html>
