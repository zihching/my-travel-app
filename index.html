<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Travel Buddy Pro - å°ˆæ¥­æ—…éŠä¼´ä¾¶</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Leaflet (Map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- FontAwesome (Icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase (Modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc, serverTimestamp, where, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose to window for Vue setup
        window.firebaseModules = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc, serverTimestamp, where, getDoc, setDoc };
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'milk-yellow': '#FFF8E7',
                        'milk-yellow-dark': '#FDF0D0',
                        'coffee': '#432818',
                        'coffee-light': '#A89F91',
                        'accent': '#BB9457',
                        'khaki': '#C2B280'
                    },
                    fontFamily: {
                        sans: ['Noto Sans TC', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        body { background-color: #FFF8E7; color: #432818; -webkit-tap-highlight-color: transparent; }
        #map { height: 100%; width: 100%; z-index: 0; }
        .app-container { max-width: 480px; margin: 0 auto; background-color: #FFF8E7; min-height: 100vh; position: relative; box-shadow: 0 0 20px rgba(67, 40, 24, 0.1); }
        .transport-icon.active { color: #A89F91; transform: scale(1.1); }
        .calc-btn { @apply text-xl font-bold rounded-lg p-4 shadow-sm active:scale-95 transition-transform flex items-center justify-center; }
        /* Modal Animation */
        .modal-enter-active, .modal-leave-active { transition: opacity 0.3s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; }
    </style>
</head>
<body>

<div id="app" class="app-container flex flex-col h-screen overflow-hidden">

    <!-- Loading -->
    <div v-if="loading" class="absolute inset-0 z-[500] flex items-center justify-center bg-milk-yellow flex-col text-center p-4">
        <i class="fa-solid fa-plane fa-bounce text-4xl text-coffee mb-4"></i>
        <p class="text-coffee font-bold mb-2">è¼‰å…¥ä¸­...</p>
        <p v-if="showSlowLoadingHint" class="text-xs text-gray-500 animate-pulse">
            é€£ç·šæœ‰é»æ…¢ï¼Œæ­£åœ¨å˜—è©¦é€£ç·š Firebase...<br>
            å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡é–‹å•Ÿï¼Œè«‹ç¢ºèª GitHub ç¶²å€å·²åŠ å…¥æˆæ¬Šç™½åå–®ã€‚
        </p>
    </div>

    <!-- VIEW: Trip List (Home) -->
    <div v-if="!currentTripId && !loading" class="flex-1 flex flex-col p-6 space-y-6 overflow-y-auto">
        <!-- User Profile Header -->
        <div class="flex items-center gap-4 mb-4">
            <div @click="openProfileEdit" class="w-16 h-16 rounded-full bg-gray-200 overflow-hidden border-2 border-coffee cursor-pointer relative group flex-shrink-0 shadow-md">
                <img v-if="userProfile.avatar" :src="userProfile.avatar" class="w-full h-full object-cover">
                <div v-else class="w-full h-full flex items-center justify-center text-gray-400"><i class="fa-solid fa-user"></i></div>
                <div class="absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 group-hover:opacity-100 text-white text-xs">ç·¨è¼¯</div>
            </div>
            <div class="flex-1 min-w-0">
                <h1 class="text-2xl font-bold text-coffee truncate">ä½ å¥½ï¼Œ{{ userProfile.name }}</h1>
                <p class="text-sm text-gray-500">æº–å‚™å¥½è¦å»å“ªäº†å—ï¼Ÿ</p>
            </div>
        </div>

        <!-- Create Trip -->
        <button @click="showCreateTripModal = true" class="bg-coffee text-milk-yellow p-4 rounded-2xl shadow-lg flex items-center justify-center gap-2 font-bold transform transition active:scale-95 hover:shadow-xl">
            <i class="fa-solid fa-plus-circle text-xl"></i>
            å»ºç«‹æ–°æ—…ç¨‹
        </button>

        <!-- Join Trip -->
        <div class="flex gap-2">
            <input v-model="joinCode" placeholder="è¼¸å…¥æœ‹å‹çš„é‚€è«‹ç¢¼" class="flex-1 bg-white p-3 rounded-xl border border-gray-200 outline-none text-sm shadow-sm focus:border-accent">
            <button @click="joinTrip" class="bg-accent text-white px-4 rounded-xl font-bold whitespace-nowrap shadow-sm hover:bg-opacity-90">åŠ å…¥</button>
        </div>

        <!-- Trip List -->
        <div>
            <h2 class="font-bold text-coffee mb-3 border-b border-coffee/10 pb-2">æˆ‘çš„æ—…ç¨‹</h2>
            <div v-if="myTrips.length === 0" class="text-center text-gray-400 py-10 bg-white/50 rounded-2xl border-2 border-dashed border-gray-200">
                <i class="fa-solid fa-suitcase-rolling text-2xl mb-2 opacity-50"></i>
                <p>é‚„æ²’æœ‰è¡Œç¨‹ï¼Œå¿«å»ºç«‹ä¸€å€‹å§ï¼</p>
            </div>
            <div v-else class="space-y-3">
                <div v-for="trip in myTrips" :key="trip.id" @click="enterTrip(trip)" class="bg-white p-4 rounded-xl shadow-sm flex justify-between items-center cursor-pointer hover:bg-gray-50 transition border border-transparent hover:border-coffee/10">
                    <div class="flex-1 min-w-0 mr-2">
                        <div class="font-bold text-lg text-coffee truncate">{{ trip.name }}</div>
                        <div class="text-xs text-gray-400 flex items-center gap-1">
                            <i class="fa-solid fa-users text-[10px]"></i>
                            {{ trip.members ? trip.members.length : 1 }} äººåƒåŠ 
                        </div>
                    </div>
                    <i class="fa-solid fa-chevron-right text-gray-300"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- VIEW: Single Trip (The App) -->
    <div v-if="currentTripId" class="flex flex-col h-full">
        <!-- Top Bar -->
        <div class="px-4 pt-4 pb-2 bg-milk-yellow z-10 shadow-sm" v-if="currentTab !== 'map'">
            <div class="flex justify-between items-center mb-2">
                <button @click="exitTrip" class="text-coffee flex items-center gap-1 font-bold text-sm"><i class="fa-solid fa-chevron-left"></i> è¿”å›</button>
                <div class="flex items-center gap-2 flex-1 justify-center min-w-0 px-2" @click="openTripSettings">
                    <h1 class="text-lg font-bold text-coffee cursor-pointer truncate">{{ currentTrip.name }} <i class="fa-solid fa-pen text-xs opacity-50"></i></h1>
                </div>
                <div class="flex gap-2">
                    <button @click="showInvite = true" class="w-8 h-8 rounded-full bg-accent text-white flex items-center justify-center shadow-sm"><i class="fa-solid fa-user-plus text-xs"></i></button>
                </div>
            </div>
            
            <!-- Date Slider (Itinerary Only) -->
            <div v-if="currentTab === 'itinerary'" class="flex overflow-x-auto no-scrollbar gap-2 py-2">
                <button 
                    v-for="(day, index) in tripDays" 
                    :key="index"
                    @click="selectedDayIndex = index"
                    class="flex-shrink-0 px-4 py-2 rounded-xl transition-all duration-300 flex flex-col items-center min-w-[70px]"
                    :class="selectedDayIndex === index ? 'bg-coffee text-milk-yellow shadow-md transform scale-105' : 'bg-milk-yellow-dark text-coffee-light'"
                >
                    <span class="text-xs font-bold">Day {{ index + 1 }}</span>
                    <span class="text-sm">{{ formatDate(day) }}</span>
                </button>
                <button @click="addDay" class="flex-shrink-0 px-3 py-2 rounded-xl bg-white border border-dashed border-coffee text-coffee">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 overflow-y-auto overflow-x-hidden relative bg-milk-yellow pb-20 no-scrollbar">
            
            <!-- TAB: Itinerary -->
            <div v-if="currentTab === 'itinerary'" class="p-4 space-y-4">
                <!-- Weather -->
                <div class="bg-gradient-to-r from-blue-100 to-blue-50 rounded-2xl p-4 flex items-center justify-between shadow-sm text-coffee">
                     <div>
                        <div class="text-xs opacity-70">ç•¶åœ°å¤©æ°£</div>
                        <div class="text-2xl font-bold">{{ weather.temp ? weather.temp + 'Â°C' : '--' }} <i class="fa-solid fa-cloud-sun text-orange-400"></i></div>
                     </div>
                     <div class="text-right text-xs">
                         <div class="font-bold text-sm">{{ weather.city || 'åµæ¸¬ä¸­...' }}</div>
                         <div @click="refreshWeather" class="cursor-pointer underline opacity-70 hover:opacity-100">é‡æ–°æ•´ç†</div>
                     </div>
                </div>

                <!-- Items -->
                <div v-if="dayItems.length === 0" class="text-center py-10 text-gray-400">
                    <i class="fa-regular fa-map text-4xl mb-2 opacity-50"></i>
                    <p>æŒ‰ + æ–°å¢æ‚¨çš„ç¬¬ä¸€å€‹æ™¯é»</p>
                </div>

                <div v-for="item in dayItems" :key="item.id" class="bg-white rounded-2xl p-3 shadow-sm flex gap-3 relative group border border-transparent hover:border-coffee/10 transition">
                    <!-- Delete (Top Right) -->
                    <button @click="deleteItem(item.id)" class="absolute top-2 right-2 text-gray-300 hover:text-red-500 p-2 z-10 transition-colors">
                        <i class="fa-solid fa-trash"></i>
                    </button>

                    <!-- Time -->
                    <div class="flex flex-col items-center justify-start pt-1 min-w-[50px]">
                        <span class="font-bold text-coffee text-lg">{{ item.time }}</span>
                        <!-- Transport Icon -->
                        <div v-if="item.transport" class="mt-2 text-coffee-light text-sm">
                            <i :class="getTransportIcon(item.transport)"></i>
                        </div>
                    </div>

                    <!-- Content -->
                    <div class="flex-1 pb-2 pr-6">
                        <div class="font-bold text-lg text-coffee mb-1">{{ item.title }}</div>
                        <div class="text-sm text-gray-500 mb-2 flex items-center cursor-pointer hover:text-accent transition-colors" @click="openMapTo(item)">
                            <i class="fa-solid fa-location-dot mr-1 text-accent"></i> {{ item.locationName || item.location }}
                        </div>
                        <div v-if="item.imageUrl" class="mb-2 rounded-lg overflow-hidden h-32 w-full shadow-inner">
                            <img :src="item.imageUrl" class="w-full h-full object-cover">
                        </div>
                        <div v-if="item.notes" class="text-xs text-gray-600 bg-gray-50 p-2 rounded border border-gray-100">{{ item.notes }}</div>
                    </div>
                </div>

                <button @click="openAddItemModal" class="w-full py-3 rounded-2xl border-2 border-dashed border-coffee/30 text-coffee/50 font-bold hover:bg-white hover:text-coffee transition-all hover:shadow-md hover:border-coffee/50">
                    + æ–°å¢è¡Œç¨‹
                </button>
            </div>

            <!-- TAB: Map -->
            <div v-show="currentTab === 'map'" class="h-full w-full relative">
                <div id="map"></div>
                <!-- Location Search on Map -->
                <div class="absolute top-4 left-4 right-4 z-[400]">
                    <div class="bg-white rounded-xl shadow-lg p-2 flex gap-2">
                        <input v-model="mapSearchQuery" @keyup.enter="searchMapLocation" placeholder="æœå°‹åœ°åœ–åœ°é»..." class="flex-1 outline-none px-2 text-sm bg-transparent">
                        <button @click="searchMapLocation" class="text-coffee px-2 hover:text-accent"><i class="fa-solid fa-search"></i></button>
                    </div>
                </div>
            </div>

            <!-- TAB: Money & Calculator -->
            <div v-if="currentTab === 'money'" class="p-4 space-y-4">
                <div class="bg-coffee text-milk-yellow rounded-2xl p-4 shadow-lg">
                    <h3 class="font-bold mb-2 text-sm opacity-80">ç¸½æ”¯å‡º (TWD)</h3>
                    <div class="text-3xl font-bold mb-4">${{ totalExpenseTwd }}</div>
                    <div class="flex gap-2 overflow-x-auto no-scrollbar">
                         <div v-for="(balance, uid) in userBalances" :key="uid" class="bg-white/10 px-3 py-1 rounded-lg text-xs whitespace-nowrap flex items-center gap-1 backdrop-blur-sm">
                            <img :src="getUserAvatar(uid)" class="w-4 h-4 rounded-full bg-gray-300 object-cover">
                            <span>{{ getUserName(uid) }}:</span>
                            <span :class="balance >= 0 ? 'text-green-300' : 'text-red-300'">{{ balance >= 0 ? '+' : '' }}{{ balance }}</span>
                        </div>
                    </div>
                </div>

                <!-- Expense Form -->
                <div class="bg-white rounded-xl p-3 shadow-sm space-y-3">
                    <div class="flex gap-2">
                        <input v-model="newExpense.desc" placeholder="æ¶ˆè²»é …ç›®" class="flex-1 bg-gray-50 p-2 rounded text-sm outline-none border border-gray-100 focus:border-coffee/30">
                        <select v-model="newExpense.payer" class="w-24 bg-gray-50 p-2 rounded text-sm text-xs border border-gray-100 outline-none">
                            <option value="" disabled>ä»˜æ¬¾äºº</option>
                            <option v-for="m in currentTripMembers" :value="m.uid">{{ m.name }}</option>
                        </select>
                    </div>
                    <div class="flex gap-2">
                        <div class="flex-1 relative">
                            <input v-model="newExpense.amount" type="number" placeholder="é‡‘é¡" class="w-full bg-gray-50 p-2 rounded text-sm outline-none border border-gray-100 focus:border-coffee/30">
                            <button @click="openCalculator" class="absolute right-1 top-1 bg-khaki text-white p-1 rounded px-2 text-xs shadow-sm hover:bg-accent"><i class="fa-solid fa-calculator"></i> è¨ˆç®—</button>
                        </div>
                        <select v-model="newExpense.currency" class="w-20 bg-gray-50 p-2 rounded text-sm font-bold border border-gray-100">
                            <option value="TWD">TWD</option>
                            <option value="JPY">JPY</option>
                            <option value="KRW">KRW</option>
                            <option value="USD">USD</option>
                        </select>
                    </div>
                    <!-- Custom Rate -->
                    <div v-if="newExpense.currency !== 'TWD'" class="flex items-center gap-2 text-xs text-gray-500 bg-gray-50 p-2 rounded border border-gray-100">
                        <span>åŒ¯ç‡: 1 {{newExpense.currency}} = </span>
                        <input v-model="customRates[newExpense.currency]" type="number" class="w-16 border-b border-gray-300 bg-transparent text-center text-coffee font-bold">
                        <span>TWD</span>
                    </div>

                    <button @click="addExpense" class="w-full bg-accent text-white py-2 rounded-lg font-bold text-sm shadow-md hover:bg-opacity-90 transform active:scale-95 transition-all">è¨˜ä¸€ç­†</button>
                </div>

                <!-- Expense List -->
                <div class="space-y-2 pb-10">
                    <div v-for="exp in expenses" :key="exp.id" class="bg-white p-3 rounded-xl flex justify-between items-center shadow-sm">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-xs font-bold text-coffee border border-coffee/20 overflow-hidden">
                                <img v-if="getUserAvatar(exp.payer)" :src="getUserAvatar(exp.payer)" class="w-full h-full object-cover">
                                <span v-else>{{ getUserName(exp.payer).charAt(0) }}</span>
                            </div>
                            <div>
                                <div class="font-bold text-coffee text-sm">{{ exp.desc }}</div>
                                <div class="text-xs text-gray-400">{{ getUserName(exp.payer) }} ä»˜æ¬¾</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-coffee">{{ exp.amount }} <span class="text-xs">{{ exp.currency }}</span></div>
                            <div class="text-xs text-gray-400" v-if="exp.currency !== 'TWD'">â‰ˆ {{ Math.round(exp.amount * (exp.rate || 1)) }} TWD</div>
                        </div>
                        <button @click="deleteExpense(exp.id)" class="text-red-300 ml-2 px-2 hover:text-red-500"><i class="fa-solid fa-trash text-xs"></i></button>
                    </div>
                </div>
            </div>

            <!-- TAB: Chat -->
            <div v-if="currentTab === 'chat'" class="flex flex-col h-full bg-white">
                <div class="flex-1 p-4 space-y-4 overflow-y-auto" ref="chatContainer">
                    <div v-for="msg in sortedMessages" :key="msg.id" class="flex flex-col" :class="msg.senderId === user.uid ? 'items-end' : 'items-start'">
                        <div class="flex items-end gap-2" :class="msg.senderId === user.uid ? 'flex-row-reverse' : 'flex-row'">
                            <!-- Avatar -->
                            <img :src="getUserAvatar(msg.senderId)" class="w-8 h-8 rounded-full border border-gray-200 object-cover bg-gray-100 flex-shrink-0">
                            
                            <!-- Bubble -->
                            <div class="max-w-[75%]">
                                <div class="text-[10px] text-gray-400 mb-1 px-1" :class="msg.senderId === user.uid ? 'text-right' : 'text-left'">{{ getUserName(msg.senderId) }}</div>
                                <div class="rounded-2xl px-3 py-2 text-sm shadow-sm" 
                                     :class="msg.senderId === user.uid ? 'bg-coffee text-milk-yellow rounded-tr-none' : 'bg-gray-100 text-coffee rounded-tl-none'">
                                    
                                    <div v-if="msg.type === 'image'">
                                        <img :src="msg.content" class="rounded-lg max-w-full border border-black/10" @click="viewImage(msg.content)">
                                    </div>
                                    <div v-else>{{ msg.content }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Chat Input -->
                <div class="p-3 border-t border-gray-100 flex items-center gap-2 bg-white">
                    <label class="cursor-pointer text-gray-400 p-2 hover:text-coffee transition">
                        <i class="fa-solid fa-image text-lg"></i>
                        <input type="file" accept="image/*" class="hidden" @change="handleChatImage">
                    </label>
                    <input v-model="newMessage" @keyup.enter="sendMessage" placeholder="è¼¸å…¥è¨Šæ¯..." class="flex-1 bg-gray-100 rounded-full px-4 py-2 text-sm outline-none text-coffee focus:ring-2 focus:ring-coffee/20">
                    <button @click="sendMessage" class="bg-coffee text-white w-10 h-10 rounded-full flex items-center justify-center shadow-md hover:bg-accent transition-colors">
                        <i class="fa-solid fa-paper-plane text-xs"></i>
                    </button>
                </div>
            </div>

            <!-- TAB: Tools (Translator & Favorites) -->
            <div v-if="currentTab === 'tools'" class="p-4 space-y-6">
                
                <!-- Translator -->
                <div class="bg-white rounded-2xl p-4 shadow-sm">
                    <h3 class="font-bold text-coffee mb-3"><i class="fa-solid fa-language mr-2"></i>å³æ™‚ç¿»è­¯</h3>
                    <div class="flex gap-2 mb-2">
                        <select v-model="transSource" class="bg-gray-50 p-2 rounded text-xs flex-1 border border-gray-100"><option value="zh-TW">ç¹é«”ä¸­æ–‡</option><option value="en">English</option></select>
                        <i class="fa-solid fa-arrow-right text-gray-400 self-center"></i>
                        <select v-model="transTarget" class="bg-gray-50 p-2 rounded text-xs flex-1 border border-gray-100"><option value="en">English</option><option value="ja">æ—¥æœ¬èª</option><option value="ko">í•œêµ­ì–´</option><option value="vi">Tiáº¿ng Viá»‡t</option><option value="th">à¹„à¸—à¸¢</option></select>
                    </div>
                    <textarea v-model="transInput" placeholder="è¼¸å…¥æ–‡å­—..." class="w-full bg-gray-50 p-3 rounded-xl text-sm h-20 outline-none mb-2 border border-gray-100 focus:border-coffee/30"></textarea>
                    <button @click="doTranslate" class="w-full bg-coffee text-milk-yellow py-2 rounded-lg text-sm font-bold mb-3 shadow-sm hover:bg-opacity-90">ç¿»è­¯</button>
                    <div v-if="transResult" class="bg-milk-yellow-dark p-3 rounded-xl text-coffee font-bold relative animate-pulse">
                        {{ transResult }}
                        <button @click="transResult=''" class="absolute top-1 right-2 text-gray-400 text-xs"><i class="fa-solid fa-times"></i></button>
                    </div>
                </div>

                <!-- Favorites -->
                <div class="bg-white rounded-2xl p-4 shadow-sm">
                    <h3 class="font-bold text-coffee mb-3"><i class="fa-solid fa-heart mr-2 text-red-400"></i>æˆ‘çš„æ”¶è—</h3>
                    <div class="flex gap-2 mb-3">
                        <input v-model="favSearch" @keyup.enter="searchFavLocation" placeholder="æœå°‹ä¸¦åŠ å…¥æ”¶è— (ä¾‹: æ±äº¬éµå¡”)" class="flex-1 bg-gray-50 p-2 rounded text-sm outline-none border border-gray-100">
                        <button @click="searchFavLocation" class="bg-accent text-white px-3 rounded-lg text-sm shadow-sm hover:bg-opacity-90">æœå°‹</button>
                    </div>
                    
                    <!-- Search Results for Favorites -->
                    <div v-if="favSearchResults.length > 0" class="mb-4 bg-gray-50 p-2 rounded-xl border border-gray-100">
                        <div v-for="res in favSearchResults" :key="res.place_id" @click="addFavorite(res)" class="p-2 border-b last:border-0 border-gray-100 cursor-pointer hover:bg-gray-100 flex justify-between items-center">
                            <span class="truncate text-sm w-4/5">{{ res.display_name }}</span>
                            <i class="fa-solid fa-plus text-accent"></i>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <div v-for="fav in favorites" :key="fav.id" class="flex justify-between items-center bg-gray-50 p-2 rounded-lg border border-transparent hover:border-coffee/10 transition">
                            <span class="text-sm text-coffee font-bold truncate flex-1 cursor-pointer" @click="openMapTo(fav)">{{ fav.name }}</span>
                            <button @click="deleteFavorite(fav.id)" class="text-red-300 ml-2 hover:text-red-500"><i class="fa-solid fa-times"></i></button>
                        </div>
                        <div v-if="favorites.length === 0" class="text-center text-xs text-gray-400">æš«ç„¡æ”¶è—</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="fixed bottom-0 w-full max-w-[480px] bg-white border-t border-gray-100 flex justify-around py-2 pb-4 z-50 text-[10px] font-bold text-gray-400">
            <button @click="currentTab = 'itinerary'" :class="currentTab === 'itinerary' ? 'text-coffee' : ''" class="flex flex-col items-center w-1/5 space-y-1 transition-colors">
                <i class="fa-solid fa-list-ul text-lg" :class="currentTab === 'itinerary' ? 'transform -translate-y-1' : ''"></i><span>è¡Œç¨‹</span>
            </button>
            <button @click="currentTab = 'map'; initMap()" :class="currentTab === 'map' ? 'text-coffee' : ''" class="flex flex-col items-center w-1/5 space-y-1 transition-colors">
                <i class="fa-regular fa-map text-lg" :class="currentTab === 'map' ? 'transform -translate-y-1' : ''"></i><span>åœ°åœ–</span>
            </button>
            <button @click="currentTab = 'money'" :class="currentTab === 'money' ? 'text-coffee' : ''" class="flex flex-col items-center w-1/5 space-y-1 transition-colors">
                <i class="fa-solid fa-wallet text-lg" :class="currentTab === 'money' ? 'transform -translate-y-1' : ''"></i><span>åˆ†å¸³</span>
            </button>
            <button @click="currentTab = 'chat'; scrollToBottom()" :class="currentTab === 'chat' ? 'text-coffee' : ''" class="flex flex-col items-center w-1/5 space-y-1 transition-colors">
                <i class="fa-regular fa-comments text-lg" :class="currentTab === 'chat' ? 'transform -translate-y-1' : ''"></i><span>èŠèŠ</span>
            </button>
            <button @click="currentTab = 'tools'" :class="currentTab === 'tools' ? 'text-coffee' : ''" class="flex flex-col items-center w-1/5 space-y-1 transition-colors">
                <i class="fa-solid fa-toolbox text-lg" :class="currentTab === 'tools' ? 'transform -translate-y-1' : ''"></i><span>å·¥å…·</span>
            </button>
        </div>
    </div>

    <!-- MODALS -->

    <!-- Create/Edit Trip Modal -->
    <div v-if="showCreateTripModal" class="fixed inset-0 z-[200] bg-black/50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-xl">
            <h3 class="text-xl font-bold text-coffee mb-4">å»ºç«‹æ–°æ—…ç¨‹</h3>
            <input v-model="newTripName" placeholder="æ—…ç¨‹åç¨± (ä¾‹: æ—¥æœ¬è³æ«»)" class="w-full bg-gray-50 p-3 rounded-xl outline-none mb-4 border focus:border-coffee/50">
            <div class="flex gap-3">
                <button @click="showCreateTripModal = false" class="flex-1 py-3 bg-gray-100 text-gray-500 rounded-xl hover:bg-gray-200" type="button">å–æ¶ˆ</button>
                <button @click="createTrip" :disabled="isProcessing" class="flex-1 py-3 bg-coffee text-milk-yellow rounded-xl font-bold disabled:opacity-50 hover:bg-opacity-90 transition-all" type="button">
                    {{ isProcessing ? 'å»ºç«‹ä¸­...' : 'å»ºç«‹' }}
                </button>
            </div>
        </div>
    </div>
    
    <!-- Force Profile Modal (New User) -->
    <div v-if="showForceProfileModal" class="fixed inset-0 z-[300] bg-black/90 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl text-center">
            <i class="fa-solid fa-passport text-4xl text-coffee mb-3"></i>
            <h3 class="font-bold text-coffee text-xl mb-2">æ­¡è¿ä¾†åˆ° Travel Buddy!</h3>
            <p class="text-sm text-gray-500 mb-6">ç‚ºäº†è®“æœ‹å‹èªå¾—ä½ ï¼Œè«‹å…ˆè¨­å®šæ‚¨çš„ç¨±å‘¼ã€‚</p>
            
            <div class="flex flex-col items-center mb-4">
                <div class="w-24 h-24 rounded-full bg-gray-200 overflow-hidden mb-2 relative border-4 border-white shadow-lg">
                    <img v-if="tempProfile.avatar" :src="tempProfile.avatar" class="w-full h-full object-cover">
                    <i v-else class="fa-solid fa-user text-3xl text-gray-400 absolute inset-0 flex items-center justify-center"></i>
                </div>
                <label class="text-xs text-accent cursor-pointer font-bold hover:underline">
                    ä¸Šå‚³é ­è²¼ (é¸å¡«)
                    <input type="file" accept="image/*" class="hidden" @change="handleAvatarUpload">
                </label>
            </div>
            
            <input v-model="tempProfile.name" placeholder="è«‹è¼¸å…¥æš±ç¨± (å¿…å¡«)" class="w-full bg-gray-50 p-4 rounded-xl mb-6 text-center font-bold text-lg border-2 focus:border-coffee outline-none transition-colors" :class="{'border-red-300': !tempProfile.name}">
            
            <button @click="saveProfile" :disabled="isProcessing || !tempProfile.name" class="w-full bg-coffee text-milk-yellow py-3 rounded-xl font-bold disabled:opacity-50 disabled:cursor-not-allowed shadow-md hover:transform hover:scale-105 transition-all" type="button">
                {{ isProcessing ? 'å„²å­˜ä¸­...' : 'é–‹å§‹æ—…ç¨‹ ğŸš€' }}
            </button>
        </div>
    </div>

    <!-- Add/Edit Itinerary Modal -->
    <div v-if="showAddItemModal" class="fixed inset-0 z-[60] bg-black/50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-xl h-[80vh] overflow-y-auto">
            <h3 class="text-xl font-bold text-coffee mb-4">æ–°å¢æ™¯é»</h3>
            
            <label class="text-xs text-gray-400">æ™‚é–“</label>
            <input v-model="newItem.time" type="time" class="w-full bg-gray-50 p-2 rounded-xl mb-3 border focus:border-coffee/30">
            
            <label class="text-xs text-gray-400">åœ°é»æœå°‹ (æ™ºæ…§æ‰¾é»)</label>
            <div class="relative mb-3">
                <div class="flex gap-2">
                    <input v-model="newItem.searchQuery" placeholder="è¼¸å…¥åç¨± (å¦‚: å°åŒ—101)" class="flex-1 bg-gray-50 p-2 rounded-xl outline-none text-sm border focus:border-coffee/30">
                    <button @click="searchLocation(newItem.searchQuery)" class="bg-accent text-white px-3 rounded-xl text-xs shadow-sm hover:bg-opacity-90" type="button">æœ</button>
                </div>
                <!-- Search Suggestions -->
                <div v-if="locationSuggestions.length > 0" class="absolute w-full bg-white border border-gray-100 shadow-lg rounded-xl mt-1 z-10 max-h-40 overflow-y-auto">
                    <div v-for="loc in locationSuggestions" :key="loc.place_id" @click="selectLocation(loc)" class="p-2 border-b border-gray-100 text-xs hover:bg-gray-50 cursor-pointer">
                        {{ loc.display_name }}
                    </div>
                </div>
            </div>

            <label class="text-xs text-gray-400">é¡¯ç¤ºåç¨±</label>
            <input v-model="newItem.title" class="w-full bg-gray-50 p-2 rounded-xl mb-3 font-bold border focus:border-coffee/30">

            <label class="text-xs text-gray-400">äº¤é€šæ–¹å¼</label>
            <div class="flex gap-4 justify-center py-2 mb-3 bg-gray-50 rounded-xl">
                <i @click="newItem.transport='car'" class="fa-solid fa-car text-xl cursor-pointer transport-icon transition p-2" :class="newItem.transport==='car' ? 'active' : 'text-gray-300'"></i>
                <i @click="newItem.transport='train'" class="fa-solid fa-train-subway text-xl cursor-pointer transport-icon transition p-2" :class="newItem.transport==='train' ? 'active' : 'text-gray-300'"></i>
                <i @click="newItem.transport='walking'" class="fa-solid fa-person-walking text-xl cursor-pointer transport-icon transition p-2" :class="newItem.transport==='walking' ? 'active' : 'text-gray-300'"></i>
            </div>

            <label class="text-xs text-gray-400">å‚™è¨»</label>
            <textarea v-model="newItem.notes" class="w-full bg-gray-50 p-2 rounded-xl mb-4 h-16 border focus:border-coffee/30"></textarea>
            
            <div class="flex gap-3">
                <button @click="showAddItemModal = false" class="flex-1 py-3 bg-gray-100 text-gray-500 rounded-xl hover:bg-gray-200" type="button">å–æ¶ˆ</button>
                <button @click="addItem" class="flex-1 py-3 bg-coffee text-milk-yellow rounded-xl font-bold hover:bg-opacity-90" type="button">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <!-- Calculator Modal -->
    <div v-if="showCalculator" class="fixed inset-0 z-[70] bg-black/50 flex items-end justify-center sm:items-center">
        <div class="bg-white rounded-t-3xl sm:rounded-3xl w-full max-w-sm p-4 shadow-xl pb-10 sm:pb-4 animate-slide-up">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-coffee">è¨ˆç®—æ©Ÿ</h3>
                <button @click="showCalculator = false"><i class="fa-solid fa-times text-gray-400 hover:text-coffee"></i></button>
            </div>
            
            <!-- Display -->
            <div class="bg-gray-100 p-4 rounded-xl mb-4 text-right shadow-inner">
                <div class="text-gray-400 text-sm h-5">{{ calcFormula || '' }}</div>
                <div class="text-3xl font-bold text-coffee truncate">{{ calcDisplay }}</div>
            </div>

            <!-- Keypad -->
            <div class="grid grid-cols-4 gap-2">
                <button @click="calcAppend('+')" class="calc-btn bg-milk-yellow text-coffee hover:bg-milk-yellow-dark">+</button>
                <button @click="calcAppend('-')" class="calc-btn bg-milk-yellow text-coffee hover:bg-milk-yellow-dark">-</button>
                <button @click="calcAppend('*')" class="calc-btn bg-milk-yellow text-coffee hover:bg-milk-yellow-dark">Ã—</button>
                <button @click="calcAppend('/')" class="calc-btn bg-milk-yellow text-coffee hover:bg-milk-yellow-dark">Ã·</button>

                <button @click="calcAppend('7')" class="calc-btn bg-khaki text-white hover:bg-accent">7</button>
                <button @click="calcAppend('8')" class="calc-btn bg-khaki text-white hover:bg-accent">8</button>
                <button @click="calcAppend('9')" class="calc-btn bg-khaki text-white hover:bg-accent">9</button>
                <button @click="calcBackspace" class="calc-btn bg-red-100 text-red-500 hover:bg-red-200"><i class="fa-solid fa-backspace"></i></button>

                <button @click="calcAppend('4')" class="calc-btn bg-khaki text-white hover:bg-accent">4</button>
                <button @click="calcAppend('5')" class="calc-btn bg-khaki text-white hover:bg-accent">5</button>
                <button @click="calcAppend('6')" class="calc-btn bg-khaki text-white hover:bg-accent">6</button>
                <button @click="calcClear" class="calc-btn bg-gray-200 hover:bg-gray-300">C</button>

                <button @click="calcAppend('1')" class="calc-btn bg-khaki text-white hover:bg-accent">1</button>
                <button @click="calcAppend('2')" class="calc-btn bg-khaki text-white hover:bg-accent">2</button>
                <button @click="calcAppend('3')" class="calc-btn bg-khaki text-white hover:bg-accent">3</button>
                <button @click="calcEqual" class="calc-btn bg-coffee text-milk-yellow row-span-2 rounded-2xl hover:bg-opacity-90 shadow-md">=</button>

                <button @click="calcAppend('0')" class="calc-btn bg-khaki text-white col-span-2 hover:bg-accent">0</button>
                <button @click="calcAppend('.')" class="calc-btn bg-khaki text-white hover:bg-accent">.</button>
            </div>
            
            <button @click="confirmCalc" class="w-full mt-4 bg-accent text-white py-3 rounded-xl font-bold shadow-md hover:bg-opacity-90" type="button">å¡«å…¥é‡‘é¡</button>
        </div>
    </div>

    <!-- Profile Edit Modal (Manual Trigger) -->
    <div v-if="editingProfile && !showForceProfileModal" class="fixed inset-0 z-[80] bg-black/50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6">
            <h3 class="font-bold text-coffee mb-4">ç·¨è¼¯å€‹äººæª”æ¡ˆ</h3>
            <div class="flex flex-col items-center mb-4">
                <div class="w-20 h-20 rounded-full bg-gray-200 overflow-hidden mb-2 relative shadow-md">
                    <img v-if="tempProfile.avatar" :src="tempProfile.avatar" class="w-full h-full object-cover">
                    <i v-else class="fa-solid fa-user text-2xl text-gray-400 absolute inset-0 flex items-center justify-center"></i>
                </div>
                <label class="text-xs text-accent cursor-pointer font-bold hover:underline">
                    æ›´æ›é ­è²¼
                    <input type="file" accept="image/*" class="hidden" @change="handleAvatarUpload">
                </label>
            </div>
            <input v-model="tempProfile.name" placeholder="ä½ çš„æš±ç¨±" class="w-full bg-gray-50 p-3 rounded-xl mb-4 border focus:border-coffee/50">
            <button @click="saveProfile" :disabled="isProcessing" class="w-full bg-coffee text-milk-yellow py-3 rounded-xl font-bold disabled:opacity-50 hover:bg-opacity-90" type="button">
                {{ isProcessing ? 'å„²å­˜ä¸­...' : 'å„²å­˜' }}
            </button>
            <button @click="editingProfile = false" class="w-full text-gray-400 py-3 mt-1 hover:text-gray-600" type="button">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- Invite Modal -->
    <div v-if="showInvite" class="fixed inset-0 z-[80] bg-black/50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 text-center shadow-2xl">
            <h3 class="font-bold text-coffee mb-2">é‚€è«‹æœ‹å‹</h3>
            <p class="text-sm text-gray-500 mb-4">è«‹æœ‹å‹åœ¨é¦–é è¼¸å…¥æ­¤ä»£ç¢¼ï¼š</p>
            <div class="bg-gray-100 p-4 rounded-xl text-2xl font-mono font-bold tracking-widest text-coffee mb-4 select-all border border-dashed border-coffee/30">
                {{ currentTripId }}
            </div>
            <button @click="showInvite = false" class="text-gray-400 hover:text-gray-600" type="button">é—œé–‰</button>
        </div>
    </div>

    <!-- Trip Settings (Rename) -->
    <div v-if="showTripSettings" class="fixed inset-0 z-[80] bg-black/50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-xl">
            <h3 class="font-bold text-coffee mb-4">è¡Œç¨‹è¨­å®š</h3>
            <input v-model="tempTripName" placeholder="è¡Œç¨‹åç¨±" class="w-full bg-gray-50 p-3 rounded-xl mb-4 font-bold text-coffee border focus:border-coffee/50">
            <button @click="updateTripName" class="w-full bg-accent text-white py-3 rounded-xl font-bold mb-2 shadow-sm hover:bg-opacity-90" type="button">æ›´æ–°åç¨±</button>
            <button @click="showTripSettings = false" class="w-full text-gray-400 py-2 hover:text-gray-600" type="button">å–æ¶ˆ</button>
        </div>
    </div>

</div>

<script type="module">
    const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;
    const { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc, serverTimestamp, where, getDoc, setDoc } = window.firebaseModules;

    // --- Config ---
    const firebaseConfig = {
        apiKey: "AIzaSyDFUGYOobmVxYFQMBYz1iQ4z1HIrdbTi8Q",
        authDomain: "travel-55c4b.firebaseapp.com",
        databaseURL: "https://travel-55c4b-default-rtdb.firebaseio.com",
        projectId: "travel-55c4b",
        storageBucket: "travel-55c4b.firebasestorage.app",
        messagingSenderId: "925227625640",
        appId: "1:925227625640:web:4cc6d501b2e21ab7f8a69d"
    };

    let app, auth, db;
    try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
    } catch(e) {
        console.error("Firebase Init Error", e);
    }

    // Timeout Utility for Firebase Operations
    const withTimeout = (promise, ms = 5000) => {
        return Promise.race([
            promise,
            new Promise((_, reject) => setTimeout(() => reject(new Error("é€£ç·šé€¾æ™‚ï¼šè«‹æª¢æŸ¥ç¶²è·¯æˆ– Firebase æ¬Šé™")), ms))
        ]);
    };

    createApp({
        setup() {
            // State
            const loading = ref(true);
            const showSlowLoadingHint = ref(false);
            const isProcessing = ref(false);
            const user = ref(null);
            const userProfile = ref({ name: 'æ–°ç”¨æˆ¶', avatar: '' });
            const editingProfile = ref(false);
            const showForceProfileModal = ref(false);
            const tempProfile = ref({});

            // Trip Management
            const myTrips = ref([]);
            const currentTripId = ref(null);
            const currentTrip = ref({});
            const tempTripName = ref('');
            const currentTripMembers = ref([]);
            const showCreateTripModal = ref(false);
            const newTripName = ref('');
            const joinCode = ref('');
            const showInvite = ref(false);
            const showTripSettings = ref(false);

            // App State
            const currentTab = ref('itinerary');
            const tripDays = ref([]);
            const selectedDayIndex = ref(0);
            const allItineraryItems = ref([]);
            const showAddItemModal = ref(false);
            const newItem = ref({ time: '09:00', title: '', searchQuery: '', locationLat: null, locationLng: null, transport: 'walking', notes: '' });
            const locationSuggestions = ref([]);

            // Money & Chat & Tools
            const expenses = ref([]);
            const newExpense = ref({ desc: '', amount: '', currency: 'TWD', payer: '', rate: 1 });
            const customRates = ref({ 'JPY': 0.22, 'KRW': 0.024, 'USD': 32.5 });
            const showCalculator = ref(false);
            const calcDisplay = ref('0');
            const calcFormula = ref('');
            const chatMessages = ref([]);
            const newMessage = ref('');
            const chatContainer = ref(null);
            const transSource = ref('zh-TW');
            const transTarget = ref('en');
            const transInput = ref('');
            const transResult = ref('');
            const favorites = ref([]);
            const favSearch = ref('');
            const favSearchResults = ref([]);
            const weather = ref({ temp: null, city: '' });

            // Listeners
            let itemsUnsub = null, expensesUnsub = null, chatUnsub = null, favUnsub = null, membersUnsub = null;

            // --- Computed ---
            const formatDate = (d) => d ? `${d.getMonth()+1}/${d.getDate()}` : '';
            const dayItems = computed(() => {
                if(!tripDays.value[selectedDayIndex.value]) return [];
                const target = formatDate(tripDays.value[selectedDayIndex.value]);
                return allItineraryItems.value.filter(i => i.dateStr === target).sort((a,b) => a.time.localeCompare(b.time));
            });
            const userBalances = computed(() => {
                if(!currentTripMembers.value.length) return {};
                const bal = {};
                currentTripMembers.value.forEach(m => bal[m.uid] = 0);
                expenses.value.forEach(e => {
                    const rate = e.currency === 'TWD' ? 1 : (e.rate || customRates.value[e.currency] || 1);
                    const amountTWD = e.amount * rate;
                    const split = amountTWD / currentTripMembers.value.length;
                    if(bal[e.payer] !== undefined) bal[e.payer] += amountTWD;
                    currentTripMembers.value.forEach(m => bal[m.uid] -= split);
                });
                Object.keys(bal).forEach(k => bal[k] = Math.round(bal[k]));
                return bal;
            });
            const totalExpenseTwd = computed(() => expenses.value.reduce((acc, e) => {
                const rate = e.currency === 'TWD' ? 1 : (e.rate || customRates.value[e.currency] || 1);
                return acc + (e.amount * rate);
            }, 0).toFixed(0));
            const sortedMessages = computed(() => [...chatMessages.value].sort((a,b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0)));

            // --- Methods ---

            // 1. Auth & Profile
            const openProfileEdit = () => {
                tempProfile.value = { ...userProfile.value };
                editingProfile.value = true;
            };

            const saveProfile = async () => {
                if(!user.value || !tempProfile.value.name) {
                    alert("è«‹è¼¸å…¥æš±ç¨±");
                    return;
                }
                if(isProcessing.value) return;
                isProcessing.value = true;

                try {
                    await withTimeout(setDoc(doc(db, 'users', user.value.uid), tempProfile.value, { merge: true }));
                    userProfile.value = { ...tempProfile.value };
                    editingProfile.value = false;
                    showForceProfileModal.value = false; 
                } catch(e) {
                    console.error("Save Profile Error", e);
                    alert("å„²å­˜å¤±æ•—ï¼šè«‹æª¢æŸ¥ç¶²è·¯æˆ– Firebase æ¬Šé™ã€‚\néŒ¯èª¤è¨Šæ¯: " + e.message);
                } finally {
                    isProcessing.value = false;
                }
            };

            const handleAvatarUpload = (e) => {
                const file = e.target.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            let width = img.width;
                            let height = img.height;
                            const MAX_WIDTH = 200;
                            if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                            canvas.width = width;
                            canvas.height = height;
                            ctx.drawImage(img, 0, 0, width, height);
                            tempProfile.value.avatar = canvas.toDataURL('image/jpeg', 0.7);
                        }
                        img.src = event.target.result;
                    }
                    reader.readAsDataURL(file);
                }
            };

            const getUserName = (uid) => {
                const m = currentTripMembers.value.find(u => u.uid === uid);
                return m ? m.name : 'æœªçŸ¥';
            };
            const getUserAvatar = (uid) => {
                const m = currentTripMembers.value.find(u => u.uid === uid);
                return m && m.avatar ? m.avatar : 'https://cdn-icons-png.flaticon.com/512/847/847969.png';
            };

            // 2. Trip Logic
            const createTrip = async () => {
                if(!newTripName.value) {
                    alert("è«‹è¼¸å…¥æ—…ç¨‹åç¨±");
                    return;
                }
                if(!user.value) {
                    alert("è«‹å…ˆç™»å…¥");
                    return;
                }
                if(isProcessing.value) return;
                isProcessing.value = true;

                try {
                    const tripRef = await withTimeout(addDoc(collection(db, 'trips'), {
                        name: newTripName.value,
                        createdBy: user.value.uid,
                        members: [user.value.uid],
                        createdAt: serverTimestamp(),
                        startDate: new Date().toISOString()
                    }));
                    await withTimeout(setDoc(doc(db, `users/${user.value.uid}/trips`, tripRef.id), { 
                        role: 'owner', joinedAt: serverTimestamp() 
                    }));
                    showCreateTripModal.value = false;
                    newTripName.value = '';
                    alert("è¡Œç¨‹å»ºç«‹æˆåŠŸï¼");
                } catch(e) { 
                    console.error("Create Trip Error", e); 
                    alert("å»ºç«‹å¤±æ•—ï¼šè«‹æª¢æŸ¥ Firebase æ¬Šé™ (Rules æ˜¯å¦ç‚º true) æˆ–ç¶²è·¯é€£ç·šã€‚\nè©³ç´°éŒ¯èª¤: " + e.message); 
                } finally {
                    isProcessing.value = false;
                }
            };

            const joinTrip = async () => {
                if(!joinCode.value) return;
                try {
                    const tripRef = doc(db, 'trips', joinCode.value);
                    const tripSnap = await withTimeout(getDoc(tripRef));
                    if(tripSnap.exists()) {
                        const data = tripSnap.data();
                        if(!data.members.includes(user.value.uid)) {
                            await updateDoc(tripRef, { members: [...data.members, user.value.uid] });
                            await setDoc(doc(db, `users/${user.value.uid}/trips`, joinCode.value), { 
                                role: 'member', joinedAt: serverTimestamp() 
                            });
                            alert('æˆåŠŸåŠ å…¥è¡Œç¨‹ï¼');
                        } else {
                            alert('ä½ å·²ç¶“åœ¨é€™å€‹è¡Œç¨‹è£¡äº†');
                        }
                    } else {
                        alert('æ‰¾ä¸åˆ°æ­¤è¡Œç¨‹ä»£ç¢¼');
                    }
                } catch(e) { console.error(e); alert('åŠ å…¥å¤±æ•—ï¼šè«‹ç¢ºèªä»£ç¢¼æ­£ç¢ºæˆ–æ¬Šé™è¨­å®š'); }
            };

            const enterTrip = async (trip) => {
                currentTripId.value = trip.id;
                currentTrip.value = trip;
                const start = new Date(trip.startDate);
                tripDays.value = [new Date(start), new Date(start.getTime() + 86400000), new Date(start.getTime() + 172800000)]; 
                loadTripData(trip.id);
            };
            
            const exitTrip = () => {
                currentTripId.value = null;
                if(itemsUnsub) itemsUnsub();
                if(expensesUnsub) expensesUnsub();
                if(chatUnsub) chatUnsub();
                if(favUnsub) favUnsub();
                if(membersUnsub) membersUnsub();
            };

            // Rename Trip Fix
            const openTripSettings = () => {
                tempTripName.value = currentTrip.value.name;
                showTripSettings.value = true;
            };

            const updateTripName = async () => {
                if (!tempTripName.value) { alert("è«‹è¼¸å…¥åç¨±"); return; }
                try {
                    await withTimeout(updateDoc(doc(db, 'trips', currentTripId.value), { name: tempTripName.value }));
                    currentTrip.value.name = tempTripName.value; 
                    showTripSettings.value = false;
                    alert("æ›´æ–°æˆåŠŸ");
                } catch(e) { alert("æ›´æ–°å¤±æ•—ï¼š" + e.message); }
            };

            const loadTripData = (tid) => {
                membersUnsub = onSnapshot(doc(db, 'trips', tid), async (snap) => {
                    if(snap.exists()) {
                        const mIds = snap.data().members;
                        const promises = mIds.map(uid => getDoc(doc(db, 'users', uid)));
                        const uSnaps = await Promise.all(promises);
                        currentTripMembers.value = uSnaps.map(s => s.exists() ? {uid: s.id, ...s.data()} : {uid: s.id, name: 'æœªçŸ¥'});
                    }
                });
                itemsUnsub = onSnapshot(collection(db, `trips/${tid}/itinerary`), (snap) => {
                    allItineraryItems.value = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    refreshWeather();
                });
                expensesUnsub = onSnapshot(collection(db, `trips/${tid}/expenses`), (snap) => expenses.value = snap.docs.map(d => ({id: d.id, ...d.data()})));
                chatUnsub = onSnapshot(collection(db, `trips/${tid}/chat`), (snap) => chatMessages.value = snap.docs.map(d => ({id: d.id, ...d.data()})));
                favUnsub = onSnapshot(collection(db, `users/${user.value.uid}/favorites`), (snap) => favorites.value = snap.docs.map(d => ({id: d.id, ...d.data()})));
            };

            // 3. Features
            const addDay = () => { const last = tripDays.value[tripDays.value.length-1]; tripDays.value.push(new Date(last.getTime()+86400000)); };
            const openAddItemModal = () => { newItem.value = { time: '09:00', title: '', searchQuery: '', transport: 'walking', notes: '' }; locationSuggestions.value = []; showAddItemModal.value = true; };
            const searchLocation = async (q) => {
                if(!q) return;
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&addressdetails=1&limit=5`, { headers: { "User-Agent": "TravelBuddyApp/1.0" } });
                    locationSuggestions.value = await res.json();
                } catch(e) { alert("æœå°‹å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯"); }
            };
            const selectLocation = (loc) => { newItem.value.searchQuery = loc.display_name; newItem.value.title = loc.name || loc.display_name.split(',')[0]; newItem.value.locationLat = loc.lat; newItem.value.locationLng = loc.lon; locationSuggestions.value = []; };
            const addItem = async () => { if(!newItem.value.title) return; await withTimeout(addDoc(collection(db, `trips/${currentTripId.value}/itinerary`), { ...newItem.value, dateStr: formatDate(tripDays.value[selectedDayIndex.value]), locationName: newItem.value.searchQuery })); showAddItemModal.value = false; };
            const deleteItem = async (id) => await deleteDoc(doc(db, `trips/${currentTripId.value}/itinerary`, id));
            const getTransportIcon = (type) => ({ 'car': 'fa-solid fa-car', 'train': 'fa-solid fa-train-subway', 'walking': 'fa-solid fa-person-walking' }[type] || '');
            
            // Map
            let map;
            const initMap = () => { nextTick(() => { if(!map && document.getElementById('map')) { map = L.map('map').setView([25.0330, 121.5654], 13); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'OSM' }).addTo(map); } else if (map) { map.invalidateSize(); } dayItems.value.forEach(item => { if(item.locationLat) { L.marker([item.locationLat, item.locationLng]).addTo(map).bindPopup(`<b>${item.title}</b><br>${item.time}`); } }); }); };
            const mapSearchQuery = ref('');
            const searchMapLocation = async () => { await searchLocation(mapSearchQuery.value); if(locationSuggestions.value.length > 0) { const loc = locationSuggestions.value[0]; map.setView([loc.lat, loc.lon], 16); L.marker([loc.lat, loc.lon]).addTo(map).bindPopup(loc.display_name).openPopup(); } };
            const openMapTo = (item) => { currentTab.value = 'map'; initMap(); setTimeout(() => { if(item.locationLat && map) { map.setView([item.locationLat, item.locationLng], 16); L.marker([item.locationLat, item.locationLng]).addTo(map).bindPopup(item.title || item.name).openPopup(); } }, 500); };

            // Calc & Money
            const openCalculator = () => { showCalculator.value = true; calcDisplay.value = '0'; calcFormula.value = ''; };
            const calcAppend = (char) => { if(calcDisplay.value === '0' && !['+','-','*','/'].includes(char)) calcDisplay.value = ''; calcDisplay.value += char; };
            const calcBackspace = () => calcDisplay.value = calcDisplay.value.slice(0, -1) || '0';
            const calcClear = () => { calcDisplay.value = '0'; calcFormula.value = ''; };
            const calcEqual = () => { try { calcFormula.value = calcDisplay.value + ' ='; calcDisplay.value = Function('"use strict";return (' + calcDisplay.value + ')')().toString(); } catch(e) { calcDisplay.value = 'Error'; } };
            const confirmCalc = () => { newExpense.value.amount = calcDisplay.value; showCalculator.value = false; };
            const addExpense = async () => { if(!newExpense.value.amount || !newExpense.value.payer) return; await addDoc(collection(db, `trips/${currentTripId.value}/expenses`), { ...newExpense.value, rate: customRates.value[newExpense.value.currency], timestamp: serverTimestamp() }); newExpense.value.amount = ''; newExpense.value.desc = ''; };
            const deleteExpense = async (id) => await deleteDoc(doc(db, `trips/${currentTripId.value}/expenses`, id));

            // Chat & Tools
            const handleChatImage = (e) => { const file = e.target.files[0]; if(file) { const reader = new FileReader(); reader.onload = async (evt) => { const img = new Image(); img.onload = async () => { const cvs = document.createElement('canvas'); const ctx = cvs.getContext('2d'); let w = img.width, h = img.height; if(w > 600) { h *= 600/w; w=600; } cvs.width=w; cvs.height=h; ctx.drawImage(img,0,0,w,h); const base64 = cvs.toDataURL('image/jpeg', 0.6); await addDoc(collection(db, `trips/${currentTripId.value}/chat`), { type: 'image', content: base64, senderId: user.value.uid, timestamp: serverTimestamp() }); }; img.src = evt.target.result; }; reader.readAsDataURL(file); } };
            const sendMessage = async () => { if(!newMessage.value.trim()) return; await addDoc(collection(db, `trips/${currentTripId.value}/chat`), { type: 'text', content: newMessage.value, senderId: user.value.uid, timestamp: serverTimestamp() }); newMessage.value = ''; scrollToBottom(); };
            const scrollToBottom = async () => { await nextTick(); if(chatContainer.value) chatContainer.value.scrollTop = chatContainer.value.scrollHeight; };
            const viewImage = (src) => { const w = window.open(""); w.document.write(`<img src="${src}" style="width:100%">`); };
            const doTranslate = async () => { if(!transInput.value) return; transResult.value = 'ç¿»è­¯ä¸­...'; try { const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(transInput.value)}&langpair=${transSource.value}|${transTarget.value}`); const data = await res.json(); transResult.value = data.responseData.translatedText; } catch(e) { transResult.value = "ç¿»è­¯æœå‹™å¿™ç¢Œä¸­"; } };
            const searchFavLocation = async () => { await searchLocation(favSearch.value); favSearchResults.value = locationSuggestions.value; };
            const addFavorite = async (loc) => { await addDoc(collection(db, `users/${user.value.uid}/favorites`), { name: loc.display_name.split(',')[0], address: loc.display_name, locationLat: loc.lat, locationLng: loc.lon }); favSearchResults.value = []; favSearch.value = ''; alert('å·²åŠ å…¥æ”¶è—'); };
            const deleteFavorite = async (id) => await deleteDoc(doc(db, `users/${user.value.uid}/favorites`, id));
            const refreshWeather = async () => { const lat = dayItems.value[0]?.locationLat || 25.0330; const lng = dayItems.value[0]?.locationLng || 121.5654; try { const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true`); const data = await res.json(); weather.value.temp = data.current_weather.temperature; weather.value.city = dayItems.value[0]?.title || 'ç›®å‰ä½ç½®'; } catch(e) {} };

            // --- Init ---
            onMounted(async () => {
                setTimeout(() => { if (loading.value) { showSlowLoadingHint.value = true; setTimeout(() => { loading.value = false; }, 3000); } }, 5000);
                try { await signInAnonymously(auth); } catch(e) { console.error("Auth Error", e); loading.value = false; return; }

                onAuthStateChanged(auth, async (u) => {
                    if(u) {
                        user.value = u;
                        try {
                            const pDoc = await getDoc(doc(db, 'users', u.uid));
                            if(pDoc.exists()) {
                                userProfile.value = pDoc.data();
                                // Force name if default or empty
                                if(!userProfile.value.name || userProfile.value.name === 'æ–°ç”¨æˆ¶') {
                                    tempProfile.value = { ...userProfile.value };
                                    showForceProfileModal.value = true;
                                }
                            } else {
                                tempProfile.value = {name: '', avatar: ''};
                                showForceProfileModal.value = true; 
                            }
                        } catch(e) { console.error("Profile Load Error", e); }

                        onSnapshot(collection(db, `users/${u.uid}/trips`), async (snap) => {
                            const tripIds = snap.docs.map(d => d.id);
                            if(tripIds.length > 0) {
                                const promises = tripIds.map(tid => getDoc(doc(db, 'trips', tid)));
                                const results = await Promise.all(promises);
                                myTrips.value = results.filter(r => r.exists()).map(r => ({id: r.id, ...r.data()}));
                            } else {
                                myTrips.value = [];
                            }
                            loading.value = false;
                        }, (error) => { console.error(error); loading.value = false; });
                    } else { loading.value = false; }
                });
            });

            return {
                loading, showSlowLoadingHint, isProcessing, user, userProfile, editingProfile, tempProfile, openProfileEdit, saveProfile, handleAvatarUpload, getUserName, getUserAvatar, showForceProfileModal,
                myTrips, currentTripId, currentTrip, createTrip, joinTrip, enterTrip, exitTrip, showCreateTripModal, newTripName, joinCode, showInvite, showTripSettings, openTripSettings, updateTripName, tempTripName, currentTripMembers,
                currentTab, tripDays, selectedDayIndex, formatDate, addDay, dayItems, showAddItemModal, newItem, openAddItemModal, locationSuggestions, searchLocation, selectLocation, addItem, deleteItem, getTransportIcon,
                mapSearchQuery, searchMapLocation, initMap, openMapTo, expenses, newExpense, addExpense, deleteExpense, userBalances, totalExpenseTwd, customRates, showCalculator, calcDisplay, calcFormula, openCalculator, calcAppend, calcBackspace, calcClear, calcEqual, confirmCalc,
                chatMessages, newMessage, sendMessage, chatContainer, sortedMessages, handleChatImage, viewImage, transSource, transTarget, transInput, transResult, doTranslate, favorites, favSearch, favSearchResults, searchFavLocation, addFavorite, deleteFavorite, weather, refreshWeather
            };
        }
    }).mount('#app');
</script>
</body>
</html>
