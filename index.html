<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Travel Buddy V19</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Zen+Maru+Gothic:wght@500;700&display=swap" rel="stylesheet">

    <style>
        /* iOS Safe Area & Full Height Fix */
        html, body { height: 100%; overscroll-behavior: none; }
        body { 
            background-color: #FFFBE6; /* æ·¡å¥¶é»ƒ */
            height: 100dvh; 
            display: flex;
            flex-direction: column;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        #map-container { height: 100%; width: 100%; position: absolute; top: 0; left: 0; z-index: 0; }
        #modal-map { height: 200px; width: 100%; z-index: 1; }
        
        .calc-btn { @apply bg-[#E6DDC3] rounded-2xl p-4 text-xl font-bold text-[#5C4B43] active:scale-95 transition-transform shadow-[0_2px_0_#D1C7B7] border border-[#D1C7B7]; }
        .calc-btn-op { @apply bg-[#D4A373] text-white border-[#B08968] shadow-[0_2px_0_#B08968]; }
        .calc-btn-action { @apply bg-[#A98467] text-white border-[#8B6B52] shadow-[0_2px_0_#8B6B52]; }
        .custom-input { @apply w-full bg-white border-2 border-[#E6DDC3] rounded-xl p-3 text-coffee font-bold outline-none focus:border-[#D4A373] transition-colors; }
        
        /* Transport Icon Selection (æ·ºå’–å•¡è‰²) */
        .transport-opt { @apply w-10 h-10 rounded-full flex items-center justify-center border-2 border-transparent text-gray-400 transition-all; }
        .transport-opt.active { @apply bg-[#D4A373] text-white border-[#B08968] shadow-sm; }
    </style>

    <!-- Firebase SDKs -->
    <script type="module">
        import { createApp, ref, computed, onMounted, nextTick, watch } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getDatabase, ref as dbRef, set, onValue, update, push } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';

        // -----------------------------------------------------------
        // âœ… å·²ç¶“å¹«ä½ å¡«å¥½ Key äº†ï¼ç›´æ¥è¤‡è£½ä½¿ç”¨å³å¯
        // -----------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyDFUGYOobmVxYfQMBYz1iq4z1HlrdbTi8Q",
            authDomain: "travel-55c4b.firebaseapp.com",
            databaseURL: "https://travel-55c4b-default-rtdb.firebaseio.com",
            projectId: "travel-55c4b",
            storageBucket: "travel-55c4b.firebasestorage.app",
            messagingSenderId: "925227625640",
            appId: "1:925227625640:web:bdc242cbddf8e1d6f8a69d",
            measurementId: "G-K1B4N26V1T"
        };
        // -----------------------------------------------------------

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        tailwind.config = {
            theme: {
                extend: {
                    colors: { milk: '#FFFBE6', coffee: '#4A3B32', latte: '#D4A373', mocha: '#9C6644', cream: '#FFF9DB', khaki: '#E6DDC3' }
                }
            }
        }

        const CITY_DB = {
            'tokyo': { c: 'JPY', l: 'ja', f: 'ğŸ‡¯ğŸ‡µ' }, 'japan': { c: 'JPY', l: 'ja', f: 'ğŸ‡¯ğŸ‡µ' },
            'seoul': { c: 'KRW', l: 'ko', f: 'ğŸ‡°ğŸ‡·' }, 'korea': { c: 'KRW', l: 'ko', f: 'ğŸ‡°ğŸ‡·' },
            'london': { c: 'GBP', l: 'en', f: 'ğŸ‡¬ğŸ‡§' }, 'uk': { c: 'GBP', l: 'en', f: 'ğŸ‡¬ğŸ‡§' },
            'bangkok': { c: 'THB', l: 'th', f: 'ğŸ‡¹ğŸ‡­' }, 'thailand': { c: 'THB', l: 'th', f: 'ğŸ‡¹ğŸ‡­' },
            'vietnam': { c: 'VND', l: 'vi', f: 'ğŸ‡»ğŸ‡³' }, 'hanoi': { c: 'VND', l: 'vi', f: 'ğŸ‡»ğŸ‡³' },
            'new zealand': { c: 'NZD', l: 'en', f: 'ğŸ‡³ğŸ‡¿' }, 'nz': { c: 'NZD', l: 'en', f: 'ğŸ‡³ğŸ‡¿' },
            'usa': { c: 'USD', l: 'en', f: 'ğŸ‡ºğŸ‡¸' }, 'taiwan': { c: 'TWD', l: 'zh-TW', f: 'ğŸ‡¹ğŸ‡¼' }
        };

        const DEFAULT_CHECKLIST = [{ id: 1, text: 'è­·ç…§', checked: false }, { id: 2, text: 'ç¶²å¡/Wi-Fi', checked: false }];

        const TRANSPORT_TYPES = [
            { id: 'walk', icon: 'fa-person-walking', label: 'æ­¥è¡Œ', speed: 5 }, // km/h
            { id: 'train', icon: 'fa-train-subway', label: 'åœ°éµ', speed: 40 },
            { id: 'bus', icon: 'fa-bus', label: 'å…¬è»Š', speed: 20 },
            { id: 'car', icon: 'fa-car', label: 'é–‹è»Š', speed: 40 },
            { id: 'ship', icon: 'fa-ship', label: 'èˆ¹', speed: 30 },
            { id: 'plane', icon: 'fa-plane', label: 'é£›æ©Ÿ', speed: 800 }
        ];

        createApp({
            setup() {
                // UI & State
                const pageState = ref('landing'); 
                const savedTrips = ref([]);
                const activeTab = ref('itinerary');
                const viewMode = ref('list');
                const showMenu = ref(false); 
                const showSettings = ref(false);
                const isLoading = ref(false);
                const isSyncing = ref(true);
                const tripId = ref('');
                const wizardStep = ref(1);
                const wizardData = ref({ destination: '', currency: 'TWD', rate: 1, lang: 'en', flag: 'âœˆï¸' });

                // Data
                const days = ref([{ activities: [] }, { activities: [] }]); 
                const currentDayIndex = ref(0);
                const people = ref(['æˆ‘']);
                const expenses = ref([]);
                const savedSpots = ref([]);
                const exchangeRate = ref(1);
                const targetLang = ref('en');
                const targetCurrency = ref('USD');
                const tripTitle = ref('My Trip');
                const checklist = ref([]);
                const chatMessages = ref([]);
                const flightInfo = ref({ code: '', time: '' });
                
                // Forms
                const newPersonName = ref('');
                const useForeignCurrency = ref(false);
                const showActivityModal = ref(false);
                const showExpenseModal = ref(false);
                const showTranslateModal = ref(false);
                const showCalculatorModal = ref(false);
                const showImagePreview = ref(null);
                
                const isEditing = ref(false);
                const formActivity = ref({ id: null, time: '10:00', title: '', location: '', notes: '', weather: null, lat: null, lng: null, image: null, transport: 'walk', travelTime: '' });
                const locationMode = ref('auto'); 
                const searchResultAddress = ref('');
                const searchResults = ref([]); // å¤šå€‹æœå°‹çµæœ
                
                const formExpense = ref({ title: '', inputAmount: '', payer: '' }); 
                const formChat = ref('');
                const chatImage = ref(null);
                const translateText = ref('');
                const translatedResult = ref('');
                const isTranslating = ref(false);
                
                // Calculator State
                const calcExpression = ref(''); 
                const calcMode = ref('foreign'); 
                const calculatorTarget = ref(null);
                const newItemText = ref('');
                const joinIdInput = ref('');

                let map = null;
                let modalMap = null;
                let modalMarker = null;
                let markers = [];
                let userMarker = null;

                onMounted(() => {
                    try {
                        const localTrips = localStorage.getItem('mySavedTrips');
                        if (localTrips) {
                            savedTrips.value = JSON.parse(localTrips);
                            savedTrips.value = savedTrips.value.filter(t => t.id && t.title);
                        }
                    } catch(e) { savedTrips.value = []; }

                    const urlParams = new URLSearchParams(window.location.search);
                    const id = urlParams.get('id');
                    if (id) loadTrip(id);
                    else pageState.value = 'landing';
                });

                // Logic
                const saveTripToLocal = (id, title) => {
                    if(!id) return;
                    const existing = savedTrips.value.findIndex(t => t.id === id);
                    if (existing !== -1) savedTrips.value[existing].title = title || 'æœªå‘½å';
                    else savedTrips.value.unshift({ id, title: title || 'æœªå‘½å' });
                    localStorage.setItem('mySavedTrips', JSON.stringify(savedTrips.value));
                };

                const loadTrip = (id) => {
                    tripId.value = id;
                    const newUrl = `${window.location.pathname}?id=${id}`;
                    window.history.pushState({ path: newUrl }, '', newUrl);
                    pageState.value = 'app'; 
                    initSync(id);
                };

                const initSync = (id) => {
                    isSyncing.value = true;
                    const tripRef = dbRef(db, 'trips/' + id);
                    onValue(tripRef, (snapshot) => {
                        isSyncing.value = false;
                        const data = snapshot.val();
                        if (data) {
                            days.value = data.days || [{ activities: [] }];
                            people.value = data.people || ['æˆ‘'];
                            expenses.value = data.expenses || [];
                            savedSpots.value = data.savedSpots || [];
                            exchangeRate.value = data.exchangeRate || 1;
                            targetLang.value = data.targetLang || 'en';
                            targetCurrency.value = data.targetCurrency || 'USD';
                            tripTitle.value = data.title || 'New Trip';
                            checklist.value = data.checklist || [...DEFAULT_CHECKLIST];
                            chatMessages.value = data.chatMessages ? Object.values(data.chatMessages) : [];
                            flightInfo.value = data.flightInfo || { code: '', time: '' };
                            saveTripToLocal(id, tripTitle.value);
                            if (viewMode.value === 'map' && activeTab.value === 'itinerary') setTimeout(() => { initMap(); updateMapMarkers(); }, 500);
                        } else {
                            if(pageState.value === 'app') { alert("æ‰¾ä¸åˆ°è¡Œç¨‹"); pageState.value = 'landing'; }
                        }
                    });
                };

                const saveToCloud = () => {
                    update(dbRef(db, 'trips/' + tripId.value), {
                        days: days.value, people: people.value, expenses: expenses.value, savedSpots: savedSpots.value,
                        exchangeRate: exchangeRate.value, title: tripTitle.value, targetLang: targetLang.value,
                        targetCurrency: targetCurrency.value, checklist: checklist.value, flightInfo: flightInfo.value
                    });
                    saveTripToLocal(tripId.value, tripTitle.value);
                };

                // Calculator
                const appendCalc = (val) => {
                    if ((calcExpression.value === '0' || calcExpression.value === '') && !['+','-','*','/','.'].includes(val)) {
                        calcExpression.value = val; return;
                    }
                    const lastChar = calcExpression.value.slice(-1);
                    if (['+','-','*','/','.'].includes(val) && ['+','-','*','/','.'].includes(lastChar)) { calcExpression.value = calcExpression.value.slice(0, -1) + val; return; }
                    calcExpression.value += val;
                };
                const clearCalc = () => calcExpression.value = '';
                const backspaceCalc = () => calcExpression.value = calcExpression.value.slice(0, -1);
                const calcResultValue = computed(() => {
                    try { if (!calcExpression.value || /[^0-9+\-*/.]/.test(calcExpression.value)) return 0; return eval(calcExpression.value) || 0; } catch (e) { return 0; }
                });
                const updateExchangeRate = () => saveToCloud();
                
                const openCalculatorForExpense = () => {
                    calculatorTarget.value = 'expense';
                    calcExpression.value = formExpense.value.inputAmount ? String(formExpense.value.inputAmount) : '';
                    showCalculatorModal.value = true;
                };
                const openCalculatorNormal = () => { calculatorTarget.value = null; calcExpression.value = ''; showCalculatorModal.value = true; };
                const applyCalculatorResult = () => {
                    if (calculatorTarget.value === 'expense') formExpense.value.inputAmount = calcResultValue.value;
                    showCalculatorModal.value = false; calculatorTarget.value = null;
                };
                const formatNumber = (n) => {
                    if (n === null || n === undefined || isNaN(n) || !isFinite(n)) return '0';
                    return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                };

                // Map
                const initMap = () => {
                    const container = document.getElementById('map');
                    if (!container) return;
                    if (map) { map.invalidateSize(); return; }
                    map = L.map('map', {zoomControl: false}).setView([35,139], 13);
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);
                    L.control.zoom({ position: 'bottomright' }).addTo(map);
                };
                const updateMapMarkers = () => {
                    if(!map) return;
                    map.invalidateSize(); markers.forEach(m=>map.removeLayer(m)); markers=[];
                    const acts = sortedActivities.value; const bounds = [];
                    acts.forEach(item => {
                        if(item.lat && item.lng){
                            const icon = L.divIcon({className: 'custom-div-icon', html: `<div style="background:#4A3B32;color:#fff;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;border:2px solid #fff;box-shadow:0 2px 5px rgba(0,0,0,0.3);">${item.time.split(':')[0]}</div>`, iconSize:[32,32], iconAnchor:[16,16]});
                            markers.push(L.marker([item.lat, item.lng], {icon}).addTo(map).bindPopup(item.title)); bounds.push([item.lat, item.lng]);
                        }
                    });
                    if(bounds.length>0) map.fitBounds(bounds, {padding:[50,50]});
                };
                watch(viewMode, (v) => { if (v === 'map') nextTick(() => { setTimeout(() => { initMap(); updateMapMarkers(); }, 100); }); });

                // Core Logic
                const createTrip = async () => {
                    const newId = Math.random().toString(36).substring(2, 8).toUpperCase();
                    const rate = parseFloat(wizardData.value.rate) || 1;
                    const initialData = { days: [{activities:[]},{activities:[]}], people: ['æˆ‘'], expenses: [], savedSpots: [], exchangeRate: rate, targetCurrency: wizardData.value.currency.toUpperCase(), targetLang: wizardData.value.lang, title: tripTitle.value, checklist: [...DEFAULT_CHECKLIST], createdAt: Date.now() };
                    saveTripToLocal(newId, tripTitle.value);
                    await set(dbRef(db, 'trips/' + newId), initialData);
                    loadTrip(newId);
                };
                const deleteLocalTrip = (idx) => { if(confirm("ç¢ºå®šç§»é™¤ï¼Ÿ")) { savedTrips.value.splice(idx, 1); localStorage.setItem('mySavedTrips', JSON.stringify(savedTrips.value)); } };
                const performTranslation = async () => {
                    if (!translateText.value) return; isTranslating.value = true; translatedResult.value = '';
                    try { const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(translateText.value)}&langpair=zh-TW|${targetLang.value}`); const data = await res.json(); translatedResult.value = data.responseData ? data.responseData.translatedText : "ç¿»è­¯å¤±æ•—"; } 
                    catch (e) { translatedResult.value = "é€£ç·šéŒ¯èª¤"; } finally { isTranslating.value = false; }
                };
                const processImage = (file, cb) => { if(!file)return; const r=new FileReader(); r.onload=(e)=>{const i=new Image();i.onload=()=>{const c=document.createElement('canvas');const ctx=c.getContext('2d');const s=Math.min(1,800/i.width);c.width=i.width*s;c.height=i.height*s;ctx.drawImage(i,0,0,c.width,c.height);cb(c.toDataURL('image/jpeg',0.7));};i.src=e.target.result;};r.readAsDataURL(file); };
                const handleChatImageUpload=(e)=>processImage(e.target.files[0],(b)=>chatImage.value=b);
                const handleActivityImageUpload=(e)=>processImage(e.target.files[0],(b)=>formActivity.value.image=b);
                const locateUser = () => { if (!map) return; navigator.geolocation.getCurrentPosition(p=>{ if(userMarker) map.removeLayer(userMarker); userMarker = L.circleMarker([p.coords.latitude, p.coords.longitude], {radius:8, fillColor:"#3B82F6", color:"#fff", weight:2, fillOpacity:1}).addTo(map); map.setView([p.coords.latitude, p.coords.longitude], 15); }); };
                
                // Improved Save Current Location & Estimator
                const saveCurrentLocation = () => { isLoading.value = true; navigator.geolocation.getCurrentPosition(async (p) => { 
                    formActivity.value.lat = p.coords.latitude; 
                    formActivity.value.lng = p.coords.longitude; 
                    locationMode.value = 'manual'; 
                    searchResultAddress.value = "å·²å®šä½"; 
                    estimateTime(p.coords.latitude, p.coords.longitude); // Auto estimate
                    try { const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${p.coords.latitude}&lon=${p.coords.longitude}`); const data = await res.json(); if(data && data.display_name) formActivity.value.location = data.display_name.split(',')[0]; } catch(e){} 
                    isLoading.value = false; 
                }, () => { alert("ç„¡æ³•å®šä½"); isLoading.value=false; }); };

                const startWizard = () => { pageState.value = 'wizard'; wizardStep.value = 1; };
                const detectDestination = async () => { if(!wizardData.value.destination) return; let key = wizardData.value.destination.toLowerCase(); if(key.includes('ç´è¥¿è˜­')) key='nz'; if(key.includes('æ±äº¬')) key='tokyo'; const info = CITY_DB[key] || { c:'USD', l:'en', f:'âœˆï¸' }; wizardData.value.currency=info.c; wizardData.value.lang=info.l; wizardData.value.flag=info.f; tripTitle.value = `${wizardData.value.destination}ä¹‹æ—…`; wizardStep.value=2; };
                
                const openAddModal = () => { 
                    if(activeTab.value==='itinerary') { 
                        isEditing.value=false; 
                        formActivity.value={id:Date.now(),time:'10:00',title:'',location:'',image:null,transport:'walk',travelTime:''}; 
                        locationMode.value='auto'; 
                        searchResults.value = [];
                        showActivityModal.value=true; 
                    } else if(activeTab.value==='expenses') { formExpense.value={title:'',inputAmount:'',payer:people.value[0]}; useForeignCurrency.value=false; showExpenseModal.value=true; } 
                };
                const saveActivity = () => { const targetDay = days.value[currentDayIndex.value]; if(isEditing.value) { const idx = targetDay.activities.findIndex(a=>a.id===formActivity.value.id); if(idx!==-1) targetDay.activities[idx]={...formActivity.value}; } else targetDay.activities.push({...formActivity.value}); showActivityModal.value=false; saveToCloud(); if(viewMode.value==='map') setTimeout(()=>updateMapMarkers(),500); };
                const saveExpense = () => { 
                    let amt = Number(formExpense.value.inputAmount); 
                    let orig = null; 
                    if(useForeignCurrency.value){ orig=`${amt} ${targetCurrency.value}`; amt=Math.round(amt*exchangeRate.value); } 
                    expenses.value.unshift({id:Date.now(), title:formExpense.value.title, amount:amt, originalAmount:orig, payer:formExpense.value.payer, date:new Date().toLocaleDateString()}); showExpenseModal.value=false; saveToCloud(); 
                };
                const deleteActivity = (id) => { days.value[currentDayIndex.value].activities = days.value[currentDayIndex.value].activities.filter(a=>a.id!==id); saveToCloud(); if(viewMode.value==='map') setTimeout(()=>updateMapMarkers(),500); };
                const deleteExpense = (id) => { expenses.value = expenses.value.filter(e=>e.id!==id); saveToCloud(); };
                const sendMessage = () => { if(!formChat.value.trim() && !chatImage.value) return; push(dbRef(db, 'trips/'+tripId.value+'/chatMessages'), {user:people.value[0], text:formChat.value, image:chatImage.value, time:new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}); formChat.value=''; chatImage.value=null; };
                const addCheckItem = () => { if(newItemText.value) { checklist.value.push({id:Date.now(), text:newItemText.value, checked:false}); newItemText.value=''; saveToCloud(); }};
                const toggleCheck = (id) => { const i = checklist.value.find(x=>x.id===id); if(i) i.checked=!i.checked; saveToCloud(); };
                const deleteCheckItem = (id) => { checklist.value=checklist.value.filter(x=>x.id!==id); saveToCloud(); };
                const backToLanding = () => { tripId.value = ''; window.history.pushState({ path: window.location.pathname }, '', window.location.pathname); pageState.value = 'landing'; };
                const joinTrip = () => { if(joinIdInput.value) loadTrip(joinIdInput.value); };
                
                const currentDayActivities = computed(() => days.value[currentDayIndex.value]?.activities || []);
                const sortedActivities = computed(() => [...currentDayActivities.value].sort((a, b) => a.time.localeCompare(b.time)));
                const totalExpense = computed(() => expenses.value.reduce((s,i)=>s+(i.amount||0),0));
                const perPersonShare = computed(() => people.value.length ? Math.round(totalExpense.value/people.value.length) : 0);
                const debts = computed(() => { if(!people.value.length) return []; const paid={}; people.value.forEach(p=>paid[p]=0); expenses.forEach(e=>{if(paid[e.payer]!==undefined) paid[e.payer]+=e.amount;}); const bals = people.value.map(p=>({name:p, bal:paid[p]-perPersonShare.value})); let res=[], d=bals.filter(b=>b.bal<-1).sort((a,b)=>a.bal-b.bal), c=bals.filter(b=>b.bal>1).sort((a,b)=>b.bal-a.bal); let i=0,j=0; while(i<d.length && j<c.length){ let amt=Math.min(Math.abs(d[i].bal), c[j].bal); amt=Math.floor(amt); if(amt>0) res.push({from:d[i].name, to:c[j].name, amount:amt}); d[i].bal+=amt; c[j].bal-=amt; if(Math.abs(d[i].bal)<1)i++; if(c[j].bal<1)j++; } return res; });
                const convertedValue = computed(() => {
                    const res = calcResultValue.value;
                    if (calcMode.value === 'foreign') return Math.round(res * exchangeRate.value);
                    else return (res / exchangeRate.value).toFixed(2);
                });

                // --- New Search & Estimate Logic ---
                const searchLocation = async () => {
                    if(!formActivity.value.location) return;
                    isLoading.value = true;
                    searchResults.value = []; // Clear previous
                    try {
                        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(formActivity.value.location)}&limit=5`);
                        const data = await res.json();
                        if (data && data.length > 0) {
                            searchResults.value = data;
                        } else {
                            searchResults.value = [];
                            alert("æ‰¾ä¸åˆ°åœ°é»");
                        }
                    } catch(e){ console.error(e); }
                    isLoading.value = false;
                };

                const selectLocation = (item) => {
                    formActivity.value.lat = parseFloat(item.lat);
                    formActivity.value.lng = parseFloat(item.lon);
                    formActivity.value.location = item.display_name.split(',')[0];
                    searchResults.value = []; // Hide list
                    
                    // Auto estimate
                    estimateTime(formActivity.value.lat, formActivity.value.lng);
                    
                    // Fetch weather
                    fetch(`https://api.open-meteo.com/v1/forecast?latitude=${formActivity.value.lat}&longitude=${formActivity.value.lng}&current_weather=true`)
                        .then(r=>r.json()).then(d=>{
                            formActivity.value.weather = { temp: Math.round(d.current_weather.temperature), code: d.current_weather.weathercode };
                        });
                };
                
                // Haversine Distance Calculation
                const getDistanceFromLatLonInKm = (lat1,lon1,lat2,lon2) => {
                    var R = 6371; 
                    var dLat = deg2rad(lat2-lat1); 
                    var dLon = deg2rad(lon2-lon1); 
                    var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
                    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
                    var d = R * c; 
                    return d;
                }
                const deg2rad = (deg) => deg * (Math.PI/180);

                const estimateTime = (toLat, toLng) => {
                    // Try to find previous activity in current day
                    const dayActs = days.value[currentDayIndex.value].activities;
                    if (!dayActs || dayActs.length === 0) return; // No previous point
                    
                    // In edit mode, find the one before current; In add mode, find the last one
                    let prevActivity = null;
                    if (isEditing.value) {
                        const idx = dayActs.findIndex(a => a.id === formActivity.value.id);
                        if (idx > 0) prevActivity = dayActs[idx - 1];
                    } else {
                        prevActivity = dayActs[dayActs.length - 1];
                    }
                    
                    if (prevActivity && prevActivity.lat && prevActivity.lng) {
                        const dist = getDistanceFromLatLonInKm(prevActivity.lat, prevActivity.lng, toLat, toLng);
                        
                        // Get speed based on selected transport
                        const mode = formActivity.value.transport || 'walk';
                        const transportType = TRANSPORT_TYPES.find(t => t.id === mode);
                        const speed = transportType ? transportType.speed : 5; // Default 5km/h
                        
                        const hours = dist / speed;
                        const minutes = Math.round(hours * 60);
                        
                        if (minutes < 60) {
                            formActivity.value.travelTime = `${minutes} åˆ†é˜`;
                        } else {
                            const h = Math.floor(minutes / 60);
                            const m = minutes % 60;
                            formActivity.value.travelTime = `${h}å°æ™‚${m}åˆ†`;
                        }
                    }
                };
                
                // Re-estimate if transport changes
                watch(() => formActivity.value.transport, () => {
                   if(formActivity.value.lat && formActivity.value.lng) {
                       estimateTime(formActivity.value.lat, formActivity.value.lng);
                   }
                });

                return {
                    pageState, wizardStep, wizardData, tripTitle, savedTrips,
                    activeTab, viewMode, showSettings, showMenu, isSyncing, tripId, joinIdInput,
                    days, currentDayIndex, currentDayActivities, sortedActivities,
                    people, expenses, newPersonName, exchangeRate, targetCurrency, targetLang,
                    showActivityModal, showExpenseModal, showTranslateModal, showCalculatorModal, showImagePreview,
                    isEditing, formActivity, formExpense, formChat, chatImage, translateText, translatedResult, isTranslating,
                    calcExpression, calcResultValue, calcMode, convertedValue, savedSpots,
                    newItemText, totalExpense, perPersonShare, debts, useForeignCurrency, checklist, chatMessages, flightInfo,
                    locationMode, searchResultAddress, isLoading, TRANSPORT_TYPES, searchResults,
                    startWizard, detectDestination, createTrip, loadTrip, deleteLocalTrip, backToLanding, joinTrip,
                    changeDay: (i)=>currentDayIndex.value=i, addDay: ()=>{days.value.push({activities:[]});currentDayIndex.value=days.value.length-1;saveToCloud();}, 
                    openAddModal, editActivity: (item)=>{isEditing.value=true; formActivity.value=JSON.parse(JSON.stringify(item)); locationMode.value=formActivity.value.lat?'manual':'auto'; showActivityModal.value=true;},
                    saveActivity, deleteActivity, saveExpense, deleteExpense,
                    addPerson: ()=>{if(newPersonName.value){people.value.push(newPersonName.value);newPersonName.value='';saveToCloud();}}, 
                    removePerson: (i)=>{people.value.splice(i,1);saveToCloud();}, 
                    resetData: ()=>{if(confirm('æ¸…ç©ºï¼Ÿ')){days.value=[{activities:[]}];expenses.value=[];saveToCloud();}},
                    updateTripSettings: ()=>{saveToCloud();showSettings.value=false;},
                    shareLink: ()=>navigator.clipboard.writeText(window.location.href).then(()=>alert('Copied!')),
                    toggleCheck, addCheckItem, deleteCheckItem, sendMessage, saveFlight: ()=>saveToCloud(),
                    handleChatImageUpload, removeChatImage: ()=>chatImage.value=null, handleActivityImageUpload, removeActivityImage: ()=>formActivity.value.image=null,
                    searchLocation, selectLocation, // New
                    saveCurrentLocation, performTranslation, appendCalc, clearCalc, backspaceCalc, updateExchangeRate,
                    openCalculatorForExpense, openCalculatorNormal: ()=>{calculatorTarget.value=null; calcExpression.value=''; showCalculatorModal.value=true;}, applyCalculatorResult,
                    locateUser, getWeatherIcon: (c)=>{if(c===undefined)return'ğŸŒ¤ï¸';if(c<=3)return'â˜ï¸';if(c<=60)return'ğŸŒ§ï¸';return'â›ˆï¸';},
                    formatNumber: (n)=>n.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")
                };
            }
        }).mount('#app');
    </script>
</head>
<body>
    <div id="app" class="w-full h-full relative">
        
        <!-- 1. Landing -->
        <div v-if="pageState === 'landing'" class="h-full flex flex-col p-6 overflow-y-auto bg-milk">
            <div class="mt-8 mb-6 text-center"><h1 class="text-4xl font-bold text-coffee mb-1">Travel Buddy</h1><p class="text-latte font-bold text-sm tracking-widest">MOBILE V19</p></div>
            <button @click="startWizard" class="bg-coffee text-white p-5 rounded-2xl shadow-xl flex items-center justify-between mb-6 group active:scale-95 transition flex-shrink-0"><div class="flex items-center gap-4"><div class="bg-white/10 w-12 h-12 rounded-full flex items-center justify-center text-2xl">âœˆï¸</div><div class="text-left"><h3 class="font-bold text-lg">å»ºç«‹æ–°è¡Œç¨‹</h3></div></div><i class="fa-solid fa-arrow-right"></i></button>
            <div class="bg-white p-2 rounded-2xl border border-stone-100 flex gap-2 mb-8 shadow-sm flex-shrink-0"><input v-model="joinIdInput" placeholder="è¼¸å…¥è¡Œç¨‹ ID..." class="flex-1 bg-transparent p-3 outline-none font-bold text-coffee"><button @click="joinTrip" class="bg-latte text-white px-4 rounded-xl font-bold">åŠ å…¥</button></div>
            <h3 class="font-bold text-gray-400 text-sm mb-3 px-2">æˆ‘çš„è¡Œç¨‹</h3>
            <div class="space-y-3 pb-10"><div v-for="(trip, idx) in savedTrips" :key="trip.id" class="bg-white p-4 rounded-2xl border border-stone-100 shadow-sm flex justify-between items-center"><div @click="loadTrip(trip.id)" class="flex-1 cursor-pointer"><h4 class="font-bold text-coffee text-lg">{{ trip.title }}</h4></div><button @click="deleteLocalTrip(idx)" class="w-8 h-8 flex items-center justify-center text-gray-300"><i class="fa-solid fa-trash"></i></button></div></div>
        </div>

        <!-- 2. Wizard -->
        <div v-if="pageState === 'wizard'" class="h-full flex flex-col p-8 bg-milk">
            <div v-if="wizardStep === 1" class="flex-1 flex flex-col justify-center"><button @click="pageState='landing'" class="absolute top-6 left-6 text-gray-400"><i class="fa-solid fa-arrow-left"></i></button><h2 class="text-3xl font-bold text-coffee mb-2">å»å“ªè£¡?</h2><input v-model="wizardData.destination" @keyup.enter="detectDestination" placeholder="è¼¸å…¥åœ°é»..." class="custom-input text-xl mb-4"><button @click="detectDestination" class="bg-latte text-white w-full py-4 rounded-2xl font-bold shadow-lg">ä¸‹ä¸€æ­¥</button></div>
            <div v-if="wizardStep === 2" class="flex-1 flex flex-col justify-center text-center"><button @click="wizardStep=1" class="absolute top-6 left-6 text-gray-400"><i class="fa-solid fa-arrow-left"></i></button><div class="text-6xl mb-4">{{ wizardData.flag }}</div><div class="w-full mb-4 text-left"><label class="text-xs font-bold text-gray-400 uppercase ml-1">è¡Œç¨‹åç¨±</label><input v-model="tripTitle" class="custom-input mb-4"></div><div class="flex gap-4 mb-8 text-left"><div class="flex-1"><label class="text-xs font-bold text-gray-400 uppercase ml-1">å¹£åˆ¥</label><input v-model="wizardData.currency" class="custom-input uppercase"></div><div class="flex-1"><label class="text-xs font-bold text-gray-400 uppercase ml-1">åŒ¯ç‡</label><input v-model="wizardData.rate" type="number" step="0.01" class="custom-input text-green-600"></div></div><button @click="createTrip" class="bg-coffee text-white w-full py-4 rounded-2xl font-bold shadow-xl">å»ºç«‹è¡Œç¨‹</button></div>
        </div>

        <!-- 3. App -->
        <div v-if="pageState === 'app'" class="h-full flex flex-col bg-milk">
            <header class="flex-shrink-0 px-4 h-16 flex justify-between items-center bg-milk/95 backdrop-blur z-20 border-b border-gray-100/50">
                <button @click="backToLanding" class="w-10 h-10 flex items-center justify-center text-gray-500"><i class="fa-solid fa-chevron-left"></i></button>
                <div class="text-center"><h1 class="text-lg font-bold text-coffee truncate max-w-[150px]">{{ tripTitle }}</h1><div class="flex items-center justify-center gap-1"><span class="w-1.5 h-1.5 rounded-full" :class="isSyncing ? 'bg-orange-400 animate-pulse' : 'bg-green-500'"></span><span class="text-[10px] text-gray-400 font-bold tracking-wider">ONLINE</span></div></div>
                <button @click="showMenu = !showMenu" class="w-10 h-10 flex items-center justify-center text-coffee"><i class="fa-solid fa-bars text-xl"></i></button>
                <div v-if="showMenu" class="absolute top-14 right-4 w-48 bg-cream rounded-2xl shadow-xl border border-[#EBE5D9] overflow-hidden py-1 z-50"><button @click="showCalculatorModal=true;showMenu=false" class="w-full text-left px-4 py-3 hover:bg-khaki flex items-center gap-3 text-sm font-bold text-coffee"><i class="fa-solid fa-calculator w-5"></i>åŒ¯ç‡è¨ˆç®—</button><button @click="showTranslateModal=true;showMenu=false" class="w-full text-left px-4 py-3 hover:bg-khaki flex items-center gap-3 text-sm font-bold text-coffee"><i class="fa-solid fa-language w-5"></i>ç¿»è­¯åŠ©æ‰‹</button><div class="h-px bg-[#EBE5D9] my-1"></div><button @click="showSettings=true;showMenu=false" class="w-full text-left px-4 py-3 hover:bg-khaki flex items-center gap-3 text-sm font-bold text-coffee"><i class="fa-solid fa-gear w-5"></i>è¨­å®š</button></div>
            </header>

            <main class="flex-1 overflow-y-auto relative pt-20 pb-24 hide-scrollbar">
                <!-- Itinerary -->
                <div v-if="activeTab === 'itinerary'" class="min-h-full pb-24">
                    <div class="sticky top-0 z-10 bg-milk/95 backdrop-blur px-4 py-2 flex gap-2 overflow-x-auto hide-scrollbar border-b border-gray-100/50">
                        <button v-for="(day, idx) in days" :key="idx" @click="changeDay(idx)" class="flex-shrink-0 flex flex-col items-center justify-center w-14 h-16 rounded-xl border transition-all" :class="currentDayIndex === idx ? 'bg-coffee border-coffee text-white shadow-md scale-105' : 'bg-white border-[#EBE5D9] text-gray-400'"><span class="text-[9px] font-bold opacity-70">DAY</span><span class="text-lg font-bold">{{ idx + 1 }}</span></button>
                        <button @click="addDay" class="flex-shrink-0 w-14 h-16 rounded-xl border border-dashed border-latte/30 text-latte flex items-center justify-center"><i class="fa-solid fa-plus"></i></button>
                    </div>
                    <div class="px-6 py-2 flex justify-end" v-if="currentDayActivities.length > 0"><div class="bg-[#EBE5D9] rounded-lg p-1 flex"><button @click="viewMode='list'" class="px-3 py-1 rounded-md text-xs font-bold transition-all" :class="viewMode==='list'?'bg-white shadow text-coffee':'text-gray-400'">åˆ—è¡¨</button><button @click="viewMode='map'" class="px-3 py-1 rounded-md text-xs font-bold transition-all" :class="viewMode==='map'?'bg-white shadow text-coffee':'text-gray-400'">åœ°åœ–</button></div></div>
                    <div class="px-4">
                        <div v-show="viewMode === 'list'" class="space-y-4">
                            <div class="bg-white rounded-2xl p-4 border border-[#EBE5D9] shadow-sm"><div class="flex justify-between mb-2"><span class="text-xs font-bold text-gray-400">FLIGHT</span><button @click="saveFlight" class="text-xs text-latte font-bold">Save</button></div><div class="flex gap-2"><input v-model="flightInfo.code" placeholder="BR198" class="flex-1 bg-gray-50 rounded p-2 text-sm font-bold uppercase"><input v-model="flightInfo.time" type="time" class="w-20 bg-gray-50 rounded p-2 text-sm"></div></div>
                            <div v-if="currentDayActivities.length === 0" class="text-center py-10 opacity-40"><i class="fa-solid fa-route text-4xl mb-2 text-latte"></i><p class="text-xs font-bold">NO PLAN</p></div>
                            <div v-for="item in sortedActivities" :key="item.id" class="flex gap-3 relative"><div class="flex flex-col items-center pt-2 w-10"><div class="w-8 h-8 rounded-full bg-[#E6DDC3] flex items-center justify-center text-coffee mb-1"><i class="fa-solid" :class="TRANSPORT_TYPES.find(t=>t.id===item.transport)?.icon||'fa-person-walking'"></i></div><span class="text-xs font-bold text-coffee">{{ item.time }}</span><div class="w-px h-full bg-[#EBE5D9] my-1"></div></div><div class="flex-1 bg-white p-3 rounded-2xl border border-[#EBE5D9] shadow-sm mb-2" @click="editActivity(item)"><div class="flex justify-between items-start"><h3 class="font-bold text-coffee text-base">{{ item.title }}</h3><div v-if="item.weather" class="text-[10px] bg-sky-50 text-sky-600 px-1.5 py-0.5 rounded">{{ getWeatherIcon(item.weather.code) }} {{ item.weather.temp }}Â°</div></div><div class="flex items-center gap-1 text-xs text-gray-400 mt-1 mb-2"><i class="fa-solid fa-location-dot"></i> {{ item.location || 'Location' }}</div>
                            <div class="flex items-center gap-2 text-xs text-latte mb-2" v-if="item.travelTime"><i class="fa-solid fa-clock"></i> é ä¼°: {{ item.travelTime }}</div>
                            <div v-if="item.image" class="h-24 w-full rounded-lg overflow-hidden mb-2 bg-gray-100"><img :src="item.image" class="w-full h-full object-cover"></div><div v-if="item.notes" class="bg-khaki/30 p-2 rounded-lg text-xs text-gray-600">{{ item.notes }}</div></div></div>
                        </div>
                        <div v-show="viewMode === 'map'" class="relative w-full h-[65vh] bg-gray-100 rounded-3xl overflow-hidden shadow-inner border border-[#EBE5D9]"><div id="map-container"><div id="map" style="width: 100%; height: 100%;"></div></div><button @click="locateUser" class="absolute bottom-4 right-4 bg-white w-10 h-10 rounded-xl shadow-lg flex items-center justify-center text-blue-500 z-[400]"><i class="fa-solid fa-location-crosshairs"></i></button></div>
                    </div>
                </div>

                <!-- Chat -->
                <div v-if="activeTab === 'chat'" class="h-full flex flex-col">
                    <div class="flex-1 overflow-y-auto py-4 px-4 space-y-3">
                        <div v-for="(msg,i) in chatMessages" :key="i" class="flex flex-col" :class="msg.user===people[0]?'items-end':'items-start'"><div class="p-3 rounded-2xl max-w-[85%] text-sm shadow-sm" :class="msg.user===people[0]?'bg-coffee text-white rounded-tr-none':'bg-white border border-[#EBE5D9] text-coffee rounded-tl-none'"><img v-if="msg.image" :src="msg.image" class="rounded mb-1 max-w-full" @click="showImagePreview=msg.image">{{ msg.text }}</div><span class="text-[10px] text-gray-300 mt-1">{{ msg.user }}</span></div>
                    </div>
                    <div class="bg-white p-3 border-t border-[#EBE5D9] flex gap-2 items-center flex-shrink-0">
                        <div v-if="chatImage" class="absolute bottom-20 left-4 p-1 bg-white shadow rounded z-50"><img :src="chatImage" class="h-24"><button @click="removeChatImage" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center">Ã—</button></div>
                        <label class="text-gray-400 p-2 flex-shrink-0 cursor-pointer"><i class="fa-solid fa-camera text-xl"></i><input type="file" @change="handleChatImageUpload" class="hidden" accept="image/*,video/*"></label>
                        <input v-model="formChat" class="flex-1 bg-gray-50 rounded-xl px-4 py-2 text-sm outline-none" style="min-width:0;" placeholder="è¨Šæ¯...">
                        <button @click="sendMessage" class="bg-latte text-white w-10 h-10 rounded-xl flex items-center justify-center flex-shrink-0 shadow-md"><i class="fa-solid fa-paper-plane"></i></button>
                    </div>
                </div>

                <!-- Traffic -->
                <div v-if="activeTab === 'traffic'" class="px-4 pb-24 flex flex-col items-center justify-center h-full opacity-50"><i class="fa-solid fa-train text-6xl mb-4 text-latte"></i><p class="text-coffee font-bold">äº¤é€šè³‡è¨Š (é–‹ç™¼ä¸­)</p></div>

                <!-- Collection -->
                <div v-if="activeTab === 'collection'" class="px-4 pb-24"><h2 class="font-bold text-coffee mb-4 mt-2">æˆ‘çš„æ”¶è—</h2><div v-if="savedSpots.length===0" class="text-center opacity-50 py-10"><i class="fa-solid fa-bookmark text-4xl mb-2 text-latte"></i><p class="text-xs">å°šç„¡æ”¶è—åœ°é»</p></div></div>

                <!-- Checklist -->
                <div v-if="activeTab === 'checklist'" class="px-4 pb-24"><h2 class="font-bold text-coffee mb-4 mt-2">æ¸…å–®</h2><div class="space-y-2 mb-4"><div v-for="item in checklist" :key="item.id" @click="toggleCheck(item.id)" class="bg-white p-3 rounded-xl border border-[#EBE5D9] flex items-center gap-3 shadow-sm" :class="item.checked?'opacity-50':''"><div class="w-5 h-5 rounded-full border flex items-center justify-center" :class="item.checked?'bg-green-500 border-green-500 text-white':'border-gray-200'"><i class="fa-solid fa-check text-xs"></i></div><span class="flex-1 font-bold text-sm text-coffee">{{ item.text }}</span><button @click.stop="deleteCheckItem(item.id)" class="text-red-200"><i class="fa-solid fa-times"></i></button></div></div><div class="flex gap-2"><input v-model="newItemText" placeholder="æ–°å¢..." class="flex-1 bg-white border border-[#EBE5D9] rounded-xl p-3 shadow-sm text-coffee font-bold"><button @click="addCheckItem" class="bg-coffee text-white px-4 rounded-xl"><i class="fa-solid fa-plus"></i></button></div></div>
                
                <!-- Expenses -->
                <div v-if="activeTab === 'expenses'" class="px-4 pb-24"><div class="bg-coffee rounded-3xl p-6 text-white shadow-xl mb-6 mt-2"><p class="text-xs opacity-60">TOTAL</p><h2 class="text-3xl font-bold mb-2">{{ formatNumber(totalExpense) }}</h2><div class="flex justify-between text-xs opacity-80 pt-4 border-t border-white/10"><span>æ¯äºº ${{ formatNumber(perPersonShare) }}</span><span>{{ people.length }} äºº</span></div></div><div class="space-y-2 mb-20"><div v-for="exp in expenses" :key="exp.id" class="bg-white p-3 rounded-xl flex justify-between items-center shadow-sm border border-[#EBE5D9]"><div class="flex gap-3"><div class="w-8 h-8 rounded-full bg-khaki flex items-center justify-center text-xs font-bold text-coffee">{{ exp.payer[0] }}</div><div><p class="font-bold text-sm text-coffee">{{ exp.title }}</p><p class="text-[10px] text-gray-400">{{ exp.date }} <span v-if="exp.originalAmount" class="text-latte">({{ exp.originalAmount }})</span></p></div></div><div class="text-right"><p class="font-bold text-sm text-coffee">${{ formatNumber(exp.amount) }}</p><button @click="deleteExpense(exp.id)" class="text-red-200 text-xs">åˆªé™¤</button></div></div></div></div>
            </main>

            <!-- Bottom Navigation (5 Items) -->
            <nav class="flex-shrink-0 bg-white/95 backdrop-blur border-t border-gray-100 flex justify-between px-2 pt-2 pb-safe z-30 text-[10px] font-bold text-gray-400">
                <button @click="activeTab='itinerary'" class="flex-1 flex flex-col items-center gap-1" :class="activeTab==='itinerary'?'text-coffee':''"><i class="fa-solid fa-map text-xl"></i>è¡Œç¨‹</button>
                <button @click="activeTab='traffic'" class="flex-1 flex flex-col items-center gap-1" :class="activeTab==='traffic'?'text-coffee':''"><i class="fa-solid fa-train text-xl"></i>äº¤é€š</button>
                <button @click="activeTab='collection'" class="flex-1 flex flex-col items-center gap-1 pt-6" :class="activeTab==='collection'?'text-coffee':''"><i class="fa-solid fa-bookmark text-xl"></i>æ”¶è—</button>
                <button @click="activeTab='chat'" class="flex-1 flex flex-col items-center gap-1" :class="activeTab==='chat'?'text-coffee':''"><i class="fa-solid fa-comments text-xl"></i>èŠå¤©</button>
                <button @click="activeTab='expenses'" class="flex-1 flex flex-col items-center gap-1" :class="activeTab==='expenses'?'text-coffee':''"><i class="fa-solid fa-wallet text-xl"></i>åˆ†å¸³</button>
            </nav>
            <!-- FAB (Elevated & Positioned Right) -->
            <button v-if="activeTab!=='chat' && activeTab!=='checklist'" @click="openAddModal" class="absolute bottom-20 right-6 w-14 h-14 bg-coffee text-white rounded-full shadow-2xl flex items-center justify-center text-xl z-40 mb-safe active:scale-90 transition-transform"><i class="fa-solid fa-plus"></i></button>

            <!-- Modals -->
            <!-- Calculator (With Toggle) -->
            <div v-if="showCalculatorModal" class="fixed inset-0 bg-black/50 z-[80] flex items-center justify-center p-6"><div class="bg-milk w-full rounded-2xl p-6 shadow-2xl border border-[#EBE5D9]"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-coffee">è¨ˆç®—æ©Ÿ</h3><button @click="showCalculatorModal=false"><i class="fa-solid fa-times text-gray-400"></i></button></div>
                <!-- Rate & Toggle -->
                <div class="bg-white p-2 rounded-xl mb-2 flex justify-between items-center border border-[#EBE5D9] shadow-sm">
                    <button @click="calcMode = calcMode === 'foreign' ? 'twd' : 'foreign'" class="bg-khaki px-3 py-1 rounded-lg text-xs font-bold text-coffee">è¼¸å…¥: {{ calcMode==='foreign' ? targetCurrency : 'TWD' }}</button>
                    <div class="flex items-center gap-2"><span class="text-xs text-gray-400">åŒ¯ç‡</span><input v-model="exchangeRate" @change="updateExchangeRate" type="number" class="text-right font-bold text-green-600 w-16 outline-none bg-transparent" placeholder="åŒ¯ç‡"></div>
                </div>
                <!-- Screen -->
                <div class="bg-white p-4 rounded-xl mb-4 text-right border-2 border-[#EBE5D9] shadow-inner">
                    <div class="text-sm text-gray-400 h-5 mb-1">{{ calcExpression || '' }}</div>
                    <div class="text-3xl font-bold text-coffee break-all mb-2">{{ calcExpression || '0' }}</div>
                    <div class="text-sm text-gray-400 font-bold text-right border-t border-gray-100 pt-1">
                        = {{ calcMode==='foreign' ? 'TWD' : targetCurrency }} {{ formatNumber(convertedValue) }} ({{ calcMode==='foreign' ? 'åŸå§‹' : 'æ›ç®—' }}: {{ formatNumber(calcResultValue) }})
                    </div>
                </div>
                <!-- Keypad -->
                <div class="grid grid-cols-4 gap-2">
                    <button @click="clearCalc" class="calc-btn text-red-400">C</button><button @click="appendCalc('/')" class="calc-btn calc-btn-op">Ã·</button><button @click="appendCalc('*')" class="calc-btn calc-btn-op">Ã—</button><button @click="backspaceCalc" class="calc-btn"><i class="fa-solid fa-delete-left"></i></button>
                    <button @click="appendCalc('7')" class="calc-btn">7</button><button @click="appendCalc('8')" class="calc-btn">8</button><button @click="appendCalc('9')" class="calc-btn">9</button><button @click="appendCalc('-')" class="calc-btn calc-btn-op">-</button>
                    <button @click="appendCalc('4')" class="calc-btn">4</button><button @click="appendCalc('5')" class="calc-btn">5</button><button @click="appendCalc('6')" class="calc-btn">6</button><button @click="appendCalc('+')" class="calc-btn calc-btn-op">+</button>
                    <button @click="appendCalc('1')" class="calc-btn">1</button><button @click="appendCalc('2')" class="calc-btn">2</button><button @click="appendCalc('3')" class="calc-btn">3</button>
                    <!-- Confirm Button (Dynamic) -->
                    <button class="calc-btn row-span-2 calc-btn-action flex items-center justify-center" @click="applyCalculatorResult">
                        <i class="fa-solid" :class="calculatorTarget === 'expense' ? 'fa-check' : 'fa-check'"></i>
                    </button>
                    
                    <button @click="appendCalc('0')" class="calc-btn col-span-2">0</button><button @click="appendCalc('.')" class="calc-btn">.</button>
                </div></div></div>

            <!-- Other Modals -->
            <div v-if="showTranslateModal" class="fixed inset-0 bg-black/50 z-[80] flex items-center justify-center p-6"><div class="bg-milk w-full rounded-2xl p-6 shadow-2xl"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-coffee">ç¿»è­¯</h3><button @click="showTranslateModal=false"><i class="fa-solid fa-times text-gray-400"></i></button></div><textarea v-model="translateText" class="w-full border-2 border-[#EBE5D9] rounded-xl p-3 mb-4 h-24 text-coffee font-bold" placeholder="è¼¸å…¥æ–‡å­—..."></textarea><div v-if="translatedResult" class="bg-blue-50 p-3 rounded-xl mb-4 text-blue-800 font-bold text-lg">{{ translatedResult }}</div><button @click="performTranslation" class="w-full bg-coffee text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2"><i v-if="isTranslating" class="fa-solid fa-circle-notch animate-spin"></i>{{ isTranslating ? 'ç¿»è­¯ä¸­...' : 'ç¿»è­¯' }}</button></div></div>
            <div v-if="showActivityModal" class="fixed inset-0 bg-black/50 z-[60] flex items-end justify-center"><div class="bg-milk w-full rounded-t-[2rem] p-6 shadow-2xl max-h-[85vh] overflow-y-auto pb-safe"><h3 class="text-lg font-bold mb-4 text-coffee">{{ isEditing ? 'ç·¨è¼¯' : 'æ–°å¢' }}è¡Œç¨‹</h3><div class="space-y-4"><div class="flex gap-3"><input v-model="formActivity.time" type="time" class="w-1/3 custom-input"><input v-model="formActivity.title" placeholder="æ¨™é¡Œ" class="flex-1 custom-input"></div>
            <!-- Transport -->
            <div class="bg-white border-2 border-[#E6DDC3] rounded-xl p-3"><p class="text-xs font-bold text-gray-400 mb-2">äº¤é€š & æ™‚é–“</p><div class="flex justify-between mb-3"><button v-for="t in TRANSPORT_TYPES" :key="t.id" @click="formActivity.transport = t.id" class="transport-opt" :class="{ 'active': formActivity.transport === t.id }"><i class="fa-solid" :class="t.icon"></i></button></div><input v-model="formActivity.travelTime" placeholder="é ä¼°æ™‚é–“ (è‡ªå‹•è¨ˆç®—)" class="w-full bg-gray-50 rounded-lg p-2 text-sm text-coffee font-bold"></div>
            <!-- Location -->
            <div class="bg-white border-2 border-[#EBE5D9] rounded-xl p-2"><div class="flex gap-1 mb-2"><button @click="locationMode='auto'" class="flex-1 py-1.5 rounded-lg text-xs font-bold transition-colors" :class="locationMode==='auto'?'bg-khaki text-coffee':'text-gray-400'">æœå°‹</button><button @click="locationMode='manual'" class="flex-1 py-1.5 rounded-lg text-xs font-bold transition-colors" :class="locationMode==='manual'?'bg-khaki text-coffee':'text-gray-400'">åœ°åœ–</button></div><button @click="saveCurrentLocation" class="w-full bg-blue-50 text-blue-600 py-2 rounded-lg text-xs font-bold mb-2 flex items-center justify-center gap-2"><i class="fa-solid fa-location-crosshairs"></i> {{ isLoading ? 'å®šä½ä¸­...' : 'ğŸ“ å®šä½ç›®å‰ä½ç½®' }}</button>
            <div v-show="locationMode==='auto'" class="flex flex-col gap-2">
                <div class="flex gap-2"><input v-model="formActivity.location" placeholder="è¼¸å…¥åœ°é» (å¦‚: å°åŒ—è»Šç«™)" class="flex-1 bg-gray-50 rounded-lg p-2 text-sm text-coffee font-bold"><button @click="searchLocation" class="bg-coffee text-white px-3 rounded-lg text-xs font-bold">æœ</button></div>
                <!-- Search Results List -->
                <div v-if="searchResults.length > 0" class="bg-white border border-gray-200 rounded-lg max-h-40 overflow-y-auto shadow-sm"><div v-for="(res, idx) in searchResults" :key="idx" @click="selectLocation(res)" class="p-2 text-xs border-b last:border-0 hover:bg-gray-50 cursor-pointer text-coffee truncate">{{ res.display_name }}</div></div>
            </div>
            <div v-show="locationMode==='manual'"><div id="modal-map"></div><p class="text-[10px] text-center text-gray-400 mt-1">æ‹–æ›³åœ°åœ–ä»¥å®šä½</p></div></div><textarea v-model="formActivity.notes" rows="2" placeholder="å‚™è¨»" class="custom-input text-sm"></textarea><label class="block w-full border-2 border-dashed border-[#D1C7B7] rounded-xl p-3 text-center text-gray-400 text-xs"><span v-if="!formActivity.image"><i class="fa-solid fa-camera mr-1"></i>ä¸Šå‚³ç…§ç‰‡</span><span v-else class="text-coffee">å·²é¸æ“‡ç…§ç‰‡ (é»æ“Šæ›´æ›)</span><input type="file" @change="handleActivityImageUpload" class="hidden" accept="image/*"></label></div><div class="flex gap-3 mt-6"><button @click="showActivityModal=false" class="flex-1 py-3 bg-khaki rounded-xl font-bold text-coffee">å–æ¶ˆ</button><button @click="saveActivity" class="flex-1 py-3 bg-coffee text-white rounded-xl font-bold">å„²å­˜</button></div></div></div>

            <!-- Other Modals (Expense, Settings...) kept minimal -->
            <div v-if="showExpenseModal" class="fixed inset-0 bg-black/50 z-[60] flex items-end justify-center"><div class="bg-milk w-full rounded-t-3xl p-6 pb-safe"><h3 class="font-bold mb-4 text-coffee">è¨˜å¸³</h3><div class="flex bg-khaki p-1 rounded-xl mb-4"><button @click="useForeignCurrency=false" class="flex-1 py-2 rounded-lg text-xs font-bold" :class="!useForeignCurrency?'bg-white shadow text-coffee':'text-gray-400'">TWD</button><button @click="useForeignCurrency=true" class="flex-1 py-2 rounded-lg text-xs font-bold" :class="useForeignCurrency?'bg-white shadow text-coffee':'text-gray-400'">{{ targetCurrency }}</button></div><input v-model="formExpense.title" placeholder="é …ç›®" class="custom-input mb-2"><div class="flex gap-2 mb-4"><div class="flex-1 relative"><input v-model.number="formExpense.inputAmount" type="number" placeholder="é‡‘é¡" class="custom-input w-full pr-10"><button @click="openCalculatorForExpense" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-coffee p-1"><i class="fa-solid fa-calculator"></i></button></div><select v-model="formExpense.payer" class="w-1/3 custom-input"><option v-for="p in people" :value="p">{{p}}</option></select></div><button @click="saveExpense" class="w-full bg-coffee text-white py-3 rounded-xl font-bold">å„²å­˜</button><button @click="showExpenseModal=false" class="w-full mt-2 text-gray-400 py-2 font-bold">å–æ¶ˆ</button></div></div>
            <div v-if="showSettings" class="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-6"><div class="bg-milk w-full max-w-sm rounded-2xl p-6 border border-[#EBE5D9]"><h3 class="font-bold mb-4 text-coffee">è¨­å®š</h3><div class="space-y-3 mb-4"><input v-model="tripTitle" class="custom-input" placeholder="è¡Œç¨‹åç¨±"><input v-model="exchangeRate" type="number" class="custom-input text-green-600" placeholder="åŒ¯ç‡"></div><div class="space-y-2"><div v-for="(p,i) in people" :key="i" class="flex justify-between bg-white border-2 border-[#EBE5D9] p-2 rounded-xl"><span>{{p}}</span><button @click="removePerson(i)" class="text-red-300">Ã—</button></div><div class="flex gap-2"><input v-model="newPersonName" placeholder="æ–°æˆå“¡" class="flex-1 custom-input py-2 text-sm"><button @click="addPerson" class="bg-coffee text-white px-3 rounded-xl">+</button></div></div><div class="flex gap-2 mt-6"><button @click="updateTripSettings" class="flex-1 bg-coffee text-white py-2 rounded-xl font-bold">å„²å­˜</button><button @click="showSettings=false" class="flex-1 bg-khaki text-coffee py-2 rounded-xl font-bold">å–æ¶ˆ</button></div></div></div>
            <div v-if="showImagePreview" class="fixed inset-0 bg-black/95 z-[90] flex items-center justify-center" @click="showImagePreview=null"><img :src="showImagePreview" class="max-w-full max-h-full"></div>
        </div>
    </div>
</body>
</html>