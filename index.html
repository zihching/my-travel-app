<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Travel Buddy Pro</title>
    
    <!-- PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Leaflet (Map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc, serverTimestamp, where, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
        window.firebaseModules = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc, serverTimestamp, where, getDoc, setDoc };
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 'milk-yellow': '#FFF8E7', 'milk-yellow-dark': '#FDF0D0', 'coffee': '#432818', 'coffee-light': '#A89F91', 'accent': '#BB9457', 'khaki': '#C2B280', 'success': '#88B04B', 'danger': '#E05D5D' },
                    fontFamily: { sans: ['Noto Sans TC', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        body { background-color: #FFF8E7; color: #432818; -webkit-tap-highlight-color: transparent; }
        #map { height: 100%; width: 100%; z-index: 0; }
        .app-container { max-width: 480px; margin: 0 auto; background-color: #FFF8E7; min-height: 100vh; position: relative; box-shadow: 0 0 20px rgba(67, 40, 24, 0.1); }
        .pie-chart { width: 100px; height: 100px; border-radius: 50%; background: conic-gradient(var(--pie-gradient, #eee 0deg 360deg)); position: relative; }
        .pie-chart::after { content: ""; position: absolute; inset: 25%; background: #FFF8E7; border-radius: 50%; }
        /* Transitions */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.5s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body>

<div id="app" class="app-container flex flex-col h-screen overflow-hidden">

    <!-- Non-Blocking Loading Overlay -->
    <transition name="fade">
        <div v-if="showSplash" class="absolute inset-0 z-[9999] flex items-center justify-center bg-milk-yellow flex-col text-center p-6">
            <i class="fa-solid fa-plane fa-bounce text-4xl text-coffee mb-4"></i>
            <p class="text-coffee font-bold text-lg">å•Ÿå‹•ä¸­...</p>
            <p class="text-xs text-gray-400 mt-2">v2.1 ç§’é–‹ç‰ˆ</p>
        </div>
    </transition>

    <!-- Network Status Bar (Fixed Top) -->
    <div v-if="!isOnline" class="bg-red-500 text-white text-[10px] py-1 text-center font-bold z-[100]">
        <i class="fa-solid fa-wifi"></i> é›¢ç·šæ¨¡å¼ - è³‡æ–™åƒ…æš«å­˜æ–¼æœ¬æ©Ÿ
    </div>

    <!-- VIEW: Trip List (Home) -->
    <div v-if="!currentTripId" class="flex-1 flex flex-col p-6 space-y-6 overflow-y-auto">
        <!-- Header -->
        <div class="flex items-center gap-4 mb-4">
            <div @click="openProfileEdit" class="w-16 h-16 rounded-full bg-gray-200 overflow-hidden border-2 border-coffee cursor-pointer relative group flex-shrink-0 shadow-md">
                <img v-if="userProfile.avatar" :src="userProfile.avatar" class="w-full h-full object-cover">
                <div v-else class="w-full h-full flex items-center justify-center text-gray-400"><i class="fa-solid fa-user"></i></div>
                <div class="absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 group-hover:opacity-100 text-white text-xs">ç·¨è¼¯</div>
            </div>
            <div class="flex-1 min-w-0">
                <h1 class="text-2xl font-bold text-coffee truncate">ä½ å¥½ï¼Œ{{ userProfile.name }}</h1>
                <p class="text-sm text-gray-500">æº–å‚™å¥½è¦å»å“ªäº†å—ï¼Ÿ</p>
            </div>
        </div>

        <!-- Create Trip -->
        <button @click="showCreateTripModal = true" class="bg-coffee text-milk-yellow p-4 rounded-2xl shadow-lg flex items-center justify-center gap-2 font-bold transform transition active:scale-95 hover:shadow-xl">
            <i class="fa-solid fa-plus-circle text-xl"></i> å»ºç«‹æ–°æ—…ç¨‹
        </button>

        <!-- Join Trip -->
        <div class="flex gap-2">
            <input v-model="joinCode" placeholder="è¼¸å…¥é‚€è«‹ç¢¼" class="flex-1 bg-white p-3 rounded-xl border border-gray-200 outline-none text-sm shadow-sm focus:border-accent">
            <button @click="joinTrip" class="bg-accent text-white px-4 rounded-xl font-bold whitespace-nowrap shadow-sm">åŠ å…¥</button>
        </div>

        <!-- Trip List -->
        <div>
            <h2 class="font-bold text-coffee mb-3 border-b border-coffee/10 pb-2">æˆ‘çš„æ—…ç¨‹</h2>
            <div v-if="myTrips.length === 0" class="text-center text-gray-400 py-10 bg-white/50 rounded-2xl border-2 border-dashed border-gray-200">
                <i class="fa-solid fa-suitcase-rolling text-2xl mb-2 opacity-50"></i>
                <p>é‚„æ²’æœ‰è¡Œç¨‹ï¼ŒæŒ‰ä¸Šé¢æŒ‰éˆ•å»ºç«‹ï¼</p>
            </div>
            <div v-else class="space-y-3">
                <div v-for="trip in myTrips" :key="trip.id" @click="enterTrip(trip)" class="bg-white p-4 rounded-xl shadow-sm flex justify-between items-center cursor-pointer hover:bg-gray-50 transition border border-transparent hover:border-coffee/10">
                    <div class="flex-1 min-w-0 mr-2">
                        <div class="font-bold text-lg text-coffee truncate">{{ trip.name }}</div>
                        <div class="text-xs text-gray-400"><i class="fa-solid fa-calendar-days"></i> {{ formatDate(new Date(trip.startDate)) }}</div>
                    </div>
                    <i class="fa-solid fa-chevron-right text-gray-300"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- VIEW: Single Trip -->
    <div v-if="currentTripId" class="flex flex-col h-full">
        <!-- Top Bar -->
        <div class="px-4 pt-4 pb-2 bg-milk-yellow z-10 shadow-sm" v-if="currentTab !== 'map'">
            <div class="flex justify-between items-center mb-2">
                <button @click="exitTrip" class="text-coffee flex items-center gap-1 font-bold text-sm"><i class="fa-solid fa-chevron-left"></i> è¿”å›</button>
                <div class="flex items-center gap-2 flex-1 justify-center min-w-0 px-2" @click="showTripSettings = true">
                    <h1 class="text-lg font-bold text-coffee cursor-pointer truncate">{{ currentTrip.name }} <i class="fa-solid fa-pen text-xs opacity-50"></i></h1>
                </div>
                <button @click="showInvite = true" class="w-8 h-8 rounded-full bg-accent text-white flex items-center justify-center shadow-sm"><i class="fa-solid fa-user-plus text-xs"></i></button>
            </div>
            <!-- Days -->
            <div v-if="currentTab === 'itinerary'" class="flex overflow-x-auto no-scrollbar gap-2 py-2">
                <button v-for="(day, index) in tripDays" :key="index" @click="selectedDayIndex = index" class="flex-shrink-0 px-4 py-2 rounded-xl transition-all duration-300 flex flex-col items-center min-w-[70px]" :class="selectedDayIndex === index ? 'bg-coffee text-milk-yellow shadow-md transform scale-105' : 'bg-milk-yellow-dark text-coffee-light'">
                    <span class="text-xs font-bold">Day {{ index + 1 }}</span>
                    <span class="text-sm">{{ formatDate(day) }}</span>
                </button>
                <button @click="addDay" class="flex-shrink-0 px-3 py-2 rounded-xl bg-white border border-dashed border-coffee text-coffee"><i class="fa-solid fa-plus"></i></button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 overflow-y-auto overflow-x-hidden relative bg-milk-yellow pb-20 no-scrollbar">
            
            <!-- Itinerary Tab -->
            <div v-if="currentTab === 'itinerary'" class="p-4 space-y-4">
                <div class="bg-gradient-to-r from-blue-100 to-blue-50 rounded-2xl p-4 flex items-center justify-between shadow-sm text-coffee">
                     <div>
                        <div class="text-xs opacity-70 mb-1">é å ±</div>
                        <div class="text-2xl font-bold flex items-center gap-2">{{ weather.tempMax ? `${weather.tempMin}-${weather.tempMax}Â°C` : '--' }} <i class="fa-solid fa-cloud-sun text-orange-400"></i></div>
                     </div>
                     <div class="text-right text-xs">
                         <div class="font-bold text-sm">{{ weather.city || 'Loading...' }}</div>
                         <div v-if="weather.rain > 0" class="text-blue-500 font-bold">æœ‰é›¨</div>
                     </div>
                </div>

                <div class="flex gap-2">
                    <button @click="downloadICS" class="flex-1 bg-white py-2 rounded-xl text-xs font-bold text-coffee shadow-sm border border-coffee/10 flex items-center justify-center gap-1">
                        <i class="fa-regular fa-calendar-plus"></i> åŒ¯å‡ºæ—¥æ›†
                    </button>
                </div>

                <div v-if="dayItems.length === 0" class="text-center py-10 text-gray-400"><p>æŒ‰ä¸‹æ–¹ + æ–°å¢è¡Œç¨‹</p></div>

                <div v-for="item in dayItems" :key="item.id" class="relative pl-4 border-l-2 border-dashed border-coffee/20 ml-2">
                    <div class="absolute -left-[9px] top-4 w-4 h-4 rounded-full bg-milk-yellow border-2 border-accent z-10"></div>
                    <div class="bg-white rounded-2xl p-3 shadow-sm flex gap-3 relative group border border-transparent hover:border-coffee/10 transition mb-4">
                        <button @click="deleteItem(item.id)" class="absolute top-2 right-2 text-gray-300 hover:text-red-500 p-2 z-10"><i class="fa-solid fa-trash"></i></button>
                        <div class="flex flex-col items-center justify-start pt-1 min-w-[50px]">
                            <span class="font-bold text-coffee text-lg">{{ item.time }}</span>
                            <div v-if="item.transport" class="mt-2 text-coffee-light text-sm"><i :class="getTransportIcon(item.transport)"></i></div>
                        </div>
                        <div class="flex-1 pb-2 pr-6">
                            <div class="font-bold text-lg text-coffee mb-1">{{ item.title }}</div>
                            <div class="text-sm text-gray-500 mb-2 flex items-center" @click="openMapTo(item)"><i class="fa-solid fa-location-dot mr-1 text-accent"></i> {{ item.locationName ? item.locationName.split(',')[0] : item.location }}</div>
                            <div v-if="item.notes" class="text-xs text-gray-600 bg-gray-50 p-2 rounded border border-gray-100">{{ item.notes }}</div>
                        </div>
                    </div>
                </div>
                <button @click="openAddItemModal" class="w-full py-3 rounded-2xl border-2 border-dashed border-coffee/30 text-coffee/50 font-bold hover:bg-white hover:text-coffee">+ æ–°å¢è¡Œç¨‹</button>
            </div>

            <!-- Map Tab -->
            <div v-show="currentTab === 'map'" class="h-full w-full relative">
                <div id="map"></div>
                <div class="absolute top-4 left-4 right-4 z-[400] bg-white rounded-xl shadow-lg p-2 flex gap-2">
                    <input v-model="mapSearchQuery" @keyup.enter="searchMapLocation" placeholder="æœå°‹åœ°é»..." class="flex-1 outline-none px-2 text-sm">
                    <button @click="searchMapLocation" class="text-coffee px-2"><i class="fa-solid fa-search"></i></button>
                </div>
            </div>

            <!-- Money Tab -->
            <div v-if="currentTab === 'money'" class="p-4 space-y-4">
                <div class="bg-coffee text-milk-yellow rounded-2xl p-4 shadow-lg">
                    <div class="flex justify-between items-end mb-2">
                        <div>
                            <div class="text-xs opacity-70">ç¸½é ç®—</div>
                            <div v-if="!editingBudget" class="text-2xl font-bold flex items-center gap-2" @click="editingBudget=true">${{ currentTrip.budget || 0 }} <i class="fa-solid fa-pen text-xs opacity-50"></i></div>
                            <input v-else v-model="tempBudget" @blur="saveBudget" type="number" class="text-coffee bg-white px-2 rounded w-24">
                        </div>
                        <div class="text-right">
                            <div class="text-xs opacity-70">å‰©é¤˜</div>
                            <div class="text-xl font-bold" :class="remainingBudget < 0 ? 'text-red-300' : 'text-green-300'">${{ remainingBudget }}</div>
                        </div>
                    </div>
                    <div class="w-full h-2 bg-black/20 rounded-full overflow-hidden"><div class="h-full bg-accent transition-all duration-500" :style="{width: budgetPercent + '%'}"></div></div>
                </div>

                <div class="bg-white rounded-2xl p-4 shadow-sm flex items-center justify-between">
                    <div class="pie-chart shadow-inner" :style="{'--pie-gradient': pieGradient}"></div>
                    <div class="flex-1 pl-4 space-y-1">
                        <div v-for="(amount, cat) in categoryTotals" :key="cat" class="flex items-center justify-between text-xs">
                            <div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full" :style="{backgroundColor: getCategoryColor(cat)}"></div>{{ cat }}</div>
                            <span>${{ amount }}</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl p-3 shadow-sm space-y-2">
                    <div class="flex gap-2">
                        <input v-model="newExpense.desc" placeholder="é …ç›®" class="flex-1 bg-gray-50 p-2 rounded text-sm outline-none border border-gray-100">
                        <input v-model="newExpense.amount" type="number" placeholder="é‡‘é¡" class="w-24 bg-gray-50 p-2 rounded text-sm outline-none border border-gray-100">
                    </div>
                    <div class="flex gap-2">
                        <select v-model="newExpense.category" class="flex-1 bg-gray-50 p-2 rounded text-sm outline-none border border-gray-100"><option value="é£Ÿ">ğŸ” é£Ÿ</option><option value="ä½">ğŸ¨ ä½</option><option value="è¡Œ">ğŸš— è¡Œ</option><option value="æ¨‚">ğŸŸï¸ æ¨‚</option><option value="è³¼">ğŸ›ï¸ è³¼</option><option value="å…¶ä»–">ğŸ§¾ å…¶ä»–</option></select>
                        <select v-model="newExpense.payer" class="flex-1 bg-gray-50 p-2 rounded text-sm outline-none border border-gray-100"><option value="" disabled>ä»˜æ¬¾äºº</option><option v-for="m in currentTripMembers" :value="m.uid">{{ m.name }}</option></select>
                        <button @click="addExpense" class="bg-accent text-white px-4 rounded-lg font-bold text-sm">è¨˜</button>
                    </div>
                </div>

                <div class="flex gap-2 overflow-x-auto no-scrollbar pb-2">
                     <div v-for="(balance, uid) in userBalances" :key="uid" class="bg-white px-3 py-2 rounded-xl text-xs whitespace-nowrap flex items-center gap-2 shadow-sm border border-gray-100">
                        <span class="font-bold text-coffee">{{ getUserName(uid) }}</span>
                        <span :class="balance >= 0 ? 'text-green-500' : 'text-red-500'">{{ balance >= 0 ? 'æ”¶' : 'ä»˜' }} ${{ Math.abs(balance) }}</span>
                    </div>
                </div>
                
                <div class="space-y-2 pb-10">
                    <div v-for="exp in expenses" :key="exp.id" class="bg-white p-3 rounded-xl flex justify-between items-center shadow-sm border-l-4" :style="{borderLeftColor: getCategoryColor(exp.category)}">
                        <div>
                            <div class="font-bold text-coffee text-sm">{{ exp.desc }} <span class="text-[10px] text-gray-400 bg-gray-100 px-1 rounded">{{ exp.category }}</span></div>
                            <div class="text-xs text-gray-400">{{ getUserName(exp.payer) }} ä»˜æ¬¾</div>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="font-bold text-coffee">${{ exp.amount }}</div>
                            <button @click="deleteExpense(exp.id)" class="text-red-300 ml-1"><i class="fa-solid fa-trash text-xs"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: Tools & Checklist -->
            <div v-if="currentTab === 'tools'" class="p-4 space-y-4">
                <div class="bg-white rounded-2xl p-4 shadow-sm">
                    <h3 class="font-bold text-coffee mb-3">è¡Œå‰æ¸…å–®</h3>
                    <div class="flex gap-2 mb-2">
                        <input v-model="newCheckItem" @keyup.enter="addCheckItem" placeholder="æ–°å¢é …ç›®..." class="flex-1 bg-gray-50 p-2 rounded text-sm outline-none border border-gray-100">
                        <button @click="addCheckItem" class="bg-accent text-white px-3 rounded text-sm">+</button>
                    </div>
                    <div class="space-y-2">
                        <div v-for="item in checklist" :key="item.id" @click="toggleCheck(item)" class="flex items-center gap-3 cursor-pointer p-2 hover:bg-gray-50 rounded">
                            <i :class="item.checked ? 'fa-solid fa-check-square text-success' : 'fa-regular fa-square text-gray-300'"></i>
                            <span :class="{'line-through text-gray-400': item.checked}" class="flex-1">{{ item.text }}</span>
                            <button @click.stop="deleteCheckItem(item.id)" class="text-gray-300"><i class="fa-solid fa-times"></i></button>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-2xl p-4 shadow-sm">
                    <h3 class="font-bold text-coffee mb-3">ç¿»è­¯</h3>
                    <div class="flex gap-2 mb-2"><select v-model="transTarget" class="bg-gray-50 p-1 rounded text-xs flex-1"><option value="en">English</option><option value="ja">æ—¥æœ¬èª</option><option value="ko">í•œêµ­ì–´</option></select></div>
                    <div class="flex gap-2">
                        <input v-model="transInput" placeholder="è¼¸å…¥æ–‡å­—..." class="flex-1 bg-gray-50 p-2 rounded text-sm outline-none">
                        <button @click="doTranslate" class="bg-coffee text-white px-3 rounded text-sm">ç¿»</button>
                    </div>
                    <div v-if="transResult" class="mt-2 text-coffee font-bold bg-milk-yellow p-2 rounded">{{ transResult }}</div>
                </div>
            </div>
        </div>

        <!-- Bottom Nav -->
        <div class="fixed bottom-0 w-full max-w-[480px] bg-white border-t border-gray-100 flex justify-around py-2 pb-4 z-50 text-[10px] font-bold text-gray-400">
            <button @click="currentTab = 'itinerary'" :class="currentTab === 'itinerary' ? 'text-coffee' : ''" class="flex flex-col items-center w-1/4 space-y-1"><i class="fa-solid fa-list-ul text-lg"></i><span>è¡Œç¨‹</span></button>
            <button @click="currentTab = 'map'; initMap()" :class="currentTab === 'map' ? 'text-coffee' : ''" class="flex flex-col items-center w-1/4 space-y-1"><i class="fa-regular fa-map text-lg"></i><span>åœ°åœ–</span></button>
            <button @click="currentTab = 'money'" :class="currentTab === 'money' ? 'text-coffee' : ''" class="flex flex-col items-center w-1/4 space-y-1"><i class="fa-solid fa-wallet text-lg"></i><span>åˆ†å¸³</span></button>
            <button @click="currentTab = 'tools'" :class="currentTab === 'tools' ? 'text-coffee' : ''" class="flex flex-col items-center w-1/4 space-y-1"><i class="fa-solid fa-toolbox text-lg"></i><span>å·¥å…·</span></button>
        </div>
    </div>

    <!-- Modals (Simplified) -->
    <div v-if="showCreateTripModal" class="fixed inset-0 z-[200] bg-black/50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6">
            <h3 class="font-bold text-coffee mb-4">å»ºç«‹æ–°æ—…ç¨‹</h3>
            <input v-model="newTripName" placeholder="æ—…ç¨‹åç¨±" class="w-full bg-gray-50 p-3 rounded-xl mb-2 border">
            <input v-model="newTripDate" type="date" class="w-full bg-gray-50 p-3 rounded-xl mb-4 border">
            <button @click="createTrip" class="w-full bg-coffee text-white py-3 rounded-xl font-bold">å»ºç«‹</button>
            <button @click="showCreateTripModal = false" class="w-full text-gray-400 py-2 mt-2">å–æ¶ˆ</button>
        </div>
    </div>

    <div v-if="showForceProfileModal" class="fixed inset-0 z-[300] bg-black/90 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 text-center">
            <h3 class="font-bold text-coffee text-xl mb-4">æ­¡è¿ä¾†åˆ° Travel Buddy!</h3>
            <div class="w-20 h-20 bg-gray-200 rounded-full mx-auto mb-2 overflow-hidden"><img v-if="tempProfile.avatar" :src="tempProfile.avatar" class="w-full h-full object-cover"></div>
            <label class="text-xs text-accent font-bold block mb-4">ä¸Šå‚³é ­è²¼ <input type="file" @change="handleAvatarUpload" class="hidden"></label>
            <input v-model="tempProfile.name" placeholder="è«‹è¼¸å…¥æš±ç¨± (å¿…å¡«)" class="w-full bg-gray-50 p-3 rounded-xl mb-4 text-center border-2 focus:border-coffee">
            <button @click="saveProfile" :disabled="!tempProfile.name" class="w-full bg-coffee text-white py-3 rounded-xl font-bold disabled:opacity-50">é–‹å§‹æ—…ç¨‹</button>
        </div>
    </div>

    <div v-if="showAddItemModal" class="fixed inset-0 z-[60] bg-black/50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 h-[80vh] overflow-y-auto">
            <h3 class="font-bold text-coffee mb-4">æ–°å¢æ™¯é»</h3>
            <input v-model="newItem.time" type="time" class="w-full bg-gray-50 p-2 rounded-xl mb-2 border">
            <div class="flex gap-2 mb-2"><input v-model="newItem.searchQuery" placeholder="åœ°é»æœå°‹" class="flex-1 bg-gray-50 p-2 rounded-xl border"><button @click="searchLocation(newItem.searchQuery)" class="bg-accent text-white px-3 rounded-xl">æœ</button></div>
            <div v-if="locationSuggestions.length" class="mb-2 bg-gray-50 p-2 rounded"><div v-for="loc in locationSuggestions" @click="selectLocation(loc)" class="p-1 border-b text-xs truncate">{{ loc.display_name }}</div></div>
            <input v-model="newItem.title" class="w-full bg-gray-50 p-2 rounded-xl mb-2 border" placeholder="é¡¯ç¤ºåç¨±">
            <textarea v-model="newItem.notes" class="w-full bg-gray-50 p-2 rounded-xl mb-4 h-16 border" placeholder="å‚™è¨»"></textarea>
            <button @click="addItem" class="w-full bg-coffee text-white py-3 rounded-xl font-bold">ç¢ºèª</button>
            <button @click="showAddItemModal = false" class="w-full text-gray-400 py-2 mt-2">å–æ¶ˆ</button>
        </div>
    </div>

    <div v-if="showTripSettings" class="fixed inset-0 z-[80] bg-black/50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6">
            <h3 class="font-bold text-coffee mb-4">è¡Œç¨‹è¨­å®š</h3>
            <input v-model="tempTripName" class="w-full bg-gray-50 p-3 rounded-xl mb-4 border">
            <button @click="updateTripName" class="w-full bg-accent text-white py-3 rounded-xl font-bold">æ›´æ–°</button>
            <button @click="showTripSettings = false" class="w-full text-gray-400 py-2 mt-2">å–æ¶ˆ</button>
        </div>
    </div>

    <div v-if="showInvite" class="fixed inset-0 z-[80] bg-black/50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 text-center">
            <h3 class="font-bold text-coffee mb-2">é‚€è«‹æœ‹å‹</h3>
            <div class="bg-gray-100 p-4 rounded-xl text-2xl font-mono font-bold text-coffee mb-4 select-all">{{ currentTripId }}</div>
            <button @click="showInvite = false" class="text-gray-400">é—œé–‰</button>
        </div>
    </div>

</div>

<script type="module">
    const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;
    const { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc, serverTimestamp, where, getDoc, setDoc } = window.firebaseModules;

    // --- FIREBASE CONFIG (ä½¿ç”¨ç©©å®šç‰ˆ) ---
    const firebaseConfig = {
        apiKey: "AIzaSyDFUGYOobmVxYFQMBYz1iQ4z1HIrdbTi8Q",
        authDomain: "travel-55c4b.firebaseapp.com",
        databaseURL: "https://travel-55c4b-default-rtdb.firebaseio.com",
        projectId: "travel-55c4b",
        storageBucket: "travel-55c4b.firebasestorage.app",
        messagingSenderId: "925227625640",
        appId: "1:925227625640:web:4cc6d501b2e21ab7f8a69d"
    };

    let app, auth, db;
    // å®¹éŒ¯åˆå§‹åŒ–
    try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
    } catch(e) { console.error("Firebase Init Error", e); }

    createApp({
        setup() {
            // State
            const showSplash = ref(true); // 1.5s Splash
            const isOnline = ref(true);
            const user = ref(null);
            const userProfile = ref({ name: 'è¨ªå®¢', avatar: '' });
            const editingProfile = ref(false);
            const showForceProfileModal = ref(false);
            const tempProfile = ref({});

            // Trip
            const myTrips = ref([]);
            const currentTripId = ref(null);
            const currentTrip = ref({});
            const tempTripName = ref('');
            const currentTripMembers = ref([]);
            const showCreateTripModal = ref(false);
            const newTripName = ref('');
            const newTripDate = ref(new Date().toISOString().split('T')[0]);
            const joinCode = ref('');
            const showInvite = ref(false);
            const showTripSettings = ref(false);

            // App
            const currentTab = ref('itinerary');
            const tripDays = ref([]);
            const selectedDayIndex = ref(0);
            const allItineraryItems = ref([]);
            const showAddItemModal = ref(false);
            const newItem = ref({ time: '09:00', title: '', searchQuery: '', locationLat: null, locationLng: null, transport: 'walking', notes: '' });
            const locationSuggestions = ref([]);

            // Money & Features
            const expenses = ref([]);
            const newExpense = ref({ desc: '', amount: '', currency: 'TWD', payer: '', category: 'é£Ÿ' });
            const editingBudget = ref(false);
            const tempBudget = ref(0);
            const checklist = ref([]);
            const newCheckItem = ref('');
            const transTarget = ref('en');
            const transInput = ref('');
            const transResult = ref('');
            const weather = ref({ tempMax: null, tempMin: null, city: '', rain: 0 });
            const mapSearchQuery = ref('');

            // Computed
            const formatDate = (d) => d ? `${d.getMonth()+1}/${d.getDate()}` : '';
            const dayItems = computed(() => {
                if(!tripDays.value[selectedDayIndex.value]) return [];
                const t = formatDate(tripDays.value[selectedDayIndex.value]);
                return allItineraryItems.value.filter(i => i.dateStr === t).sort((a,b) => a.time.localeCompare(b.time));
            });
            const totalExpenseTwd = computed(() => expenses.value.reduce((acc, e) => acc + parseInt(e.amount || 0), 0));
            const remainingBudget = computed(() => (currentTrip.value.budget || 0) - totalExpenseTwd.value);
            const budgetPercent = computed(() => Math.min(100, Math.round((totalExpenseTwd.value / (currentTrip.value.budget || 1)) * 100)));
            const categoryTotals = computed(() => { const t = {}; expenses.value.forEach(e => t[e.category] = (t[e.category]||0) + parseInt(e.amount)); return t; });
            const pieGradient = computed(() => {
                const total = totalExpenseTwd.value || 1; let g = [], deg = 0;
                const c = { 'é£Ÿ': '#FFB7B2', 'ä½': '#B5EAD7', 'è¡Œ': '#C7CEEA', 'æ¨‚': '#E2F0CB', 'è³¼': '#FFDAC1', 'å…¶ä»–': '#E0E0E0' };
                for(const [cat, amt] of Object.entries(categoryTotals.value)) { const d = (amt/total)*360; g.push(`${c[cat]||'#ccc'} ${deg}deg ${deg+d}deg`); deg += d; }
                return g.join(', ');
            });
            const getCategoryColor = (cat) => ({ 'é£Ÿ': '#FFB7B2', 'ä½': '#B5EAD7', 'è¡Œ': '#C7CEEA', 'æ¨‚': '#E2F0CB', 'è³¼': '#FFDAC1', 'å…¶ä»–': '#E0E0E0' }[cat] || '#ccc');
            const userBalances = computed(() => {
                if(!currentTripMembers.value.length) return {};
                const bal = {}; currentTripMembers.value.forEach(m => bal[m.uid] = 0);
                expenses.value.forEach(e => { const amt = parseInt(e.amount), split = amt/currentTripMembers.value.length; if(bal[e.payer]!==undefined) bal[e.payer]+=amt; currentTripMembers.value.forEach(m=>bal[m.uid]-=split); });
                Object.keys(bal).forEach(k => bal[k] = Math.round(bal[k]));
                return bal;
            });

            // Methods
            const saveBudget = async () => { await updateDoc(doc(db, 'trips', currentTripId.value), { budget: tempBudget.value }); currentTrip.value.budget = tempBudget.value; editingBudget.value = false; };
            const openProfileEdit = () => { tempProfile.value = { ...userProfile.value }; editingProfile.value = true; };
            const saveProfile = async () => { if(!tempProfile.value.name) return; try { await setDoc(doc(db, 'users', user.value.uid), tempProfile.value, { merge: true }); userProfile.value = { ...tempProfile.value }; editingProfile.value = false; showForceProfileModal.value = false; } catch(e){ alert("é€£ç·šéŒ¯èª¤"); } };
            const handleAvatarUpload = (e) => { const f = e.target.files[0]; if(f) { const r = new FileReader(); r.onload = (evt) => { const i = new Image(); i.onload = () => { const c = document.createElement('canvas'), ctx = c.getContext('2d'); let w=i.width, h=i.height; if(w>200){h*=200/w; w=200;} c.width=w; c.height=h; ctx.drawImage(i,0,0,w,h); tempProfile.value.avatar = c.toDataURL('image/jpeg',0.7); }; i.src = evt.target.result; }; r.readAsDataURL(f); } };
            const getUserName = (uid) => currentTripMembers.value.find(u => u.uid === uid)?.name || 'æœªçŸ¥';
            const getUserAvatar = (uid) => currentTripMembers.value.find(u => u.uid === uid)?.avatar || 'https://cdn-icons-png.flaticon.com/512/847/847969.png';
            
            const createTrip = async () => { 
                if(!newTripName.value) return alert("è«‹è¼¸å…¥åç¨±"); 
                try { 
                    const ref = await addDoc(collection(db, 'trips'), { name: newTripName.value, createdBy: user.value.uid, members: [user.value.uid], createdAt: serverTimestamp(), startDate: new Date(newTripDate.value).toISOString(), budget: 0 }); 
                    await setDoc(doc(db, `users/${user.value.uid}/trips`, ref.id), { role: 'owner', joinedAt: serverTimestamp() }); 
                    showCreateTripModal.value = false; newTripName.value = ''; alert("æˆåŠŸï¼"); 
                } catch(e) { alert("é€£ç·šå¤±æ•— (è«‹æª¢æŸ¥Firebase Rules): " + e.message); } 
            };
            const joinTrip = async () => { if(!joinCode.value) return; try { const ref = doc(db, 'trips', joinCode.value); const snap = await getDoc(ref); if(snap.exists()) { const d = snap.data(); if(!d.members.includes(user.value.uid)) { await updateDoc(ref, { members: [...d.members, user.value.uid] }); await setDoc(doc(db, `users/${user.value.uid}/trips`, joinCode.value), { role: 'member', joinedAt: serverTimestamp() }); alert('å·²åŠ å…¥ï¼'); } } else alert('ç„¡æ•ˆä»£ç¢¼'); } catch(e) { alert('åŠ å…¥å¤±æ•—'); } };
            
            const enterTrip = async (trip) => { currentTripId.value = trip.id; currentTrip.value = trip; tempBudget.value = trip.budget || 0; const s = new Date(trip.startDate); tripDays.value = [s, new Date(s.getTime()+86400000), new Date(s.getTime()+172800000)]; loadData(trip.id); };
            const exitTrip = () => { currentTripId.value = null; }; // Listeners stay active for simplicity or refresh page
            const openTripSettings = () => { tempTripName.value = currentTrip.value.name; showTripSettings.value = true; };
            const updateTripName = async () => { if (!tempTripName.value) return; await updateDoc(doc(db, 'trips', currentTripId.value), { name: tempTripName.value }); currentTrip.value.name = tempTripName.value; showTripSettings.value = false; };

            const loadData = (tid) => {
                onSnapshot(doc(db, 'trips', tid), async (s) => { if(s.exists()) { const mIds = s.data().members; const p = mIds.map(uid => getDoc(doc(db, 'users', uid))); const res = await Promise.all(p); currentTripMembers.value = res.map(r => r.exists() ? {uid: r.id, ...r.data()} : {uid: r.id, name: 'æœªçŸ¥'}); } });
                onSnapshot(collection(db, `trips/${tid}/itinerary`), (s) => { allItineraryItems.value = s.docs.map(d => ({id: d.id, ...d.data()})); refreshWeather(); });
                onSnapshot(collection(db, `trips/${tid}/expenses`), (s) => expenses.value = s.docs.map(d => ({id: d.id, ...d.data()})));
                onSnapshot(collection(db, `trips/${tid}/checklist`), (s) => checklist.value = s.docs.map(d => ({id: d.id, ...d.data()})));
            };

            const addDay = () => tripDays.value.push(new Date(tripDays.value[tripDays.value.length-1].getTime()+86400000));
            const openAddItemModal = () => { newItem.value = { time: '09:00', title: '', searchQuery: '', transport: 'walking', notes: '' }; locationSuggestions.value = []; showAddItemModal.value = true; };
            const searchLocation = async (q) => { try { const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&addressdetails=1&limit=5`); locationSuggestions.value = await res.json(); } catch(e) {} };
            const selectLocation = (l) => { newItem.value.searchQuery = l.display_name; newItem.value.title = l.name || l.display_name.split(',')[0]; newItem.value.locationLat = l.lat; newItem.value.locationLng = l.lon; locationSuggestions.value = []; };
            const addItem = async () => { if(!newItem.value.title) return; await addDoc(collection(db, `trips/${currentTripId.value}/itinerary`), { ...newItem.value, dateStr: formatDate(tripDays.value[selectedDayIndex.value]), locationName: newItem.value.searchQuery }); showAddItemModal.value = false; };
            const deleteItem = async (id) => await deleteDoc(doc(db, `trips/${currentTripId.value}/itinerary`, id));
            const getTransportIcon = (t) => ({ 'car': 'fa-solid fa-car', 'train': 'fa-solid fa-train-subway', 'walking': 'fa-solid fa-person-walking' }[t] || '');
            
            let map;
            const initMap = () => nextTick(() => { if(!map && document.getElementById('map')) { map = L.map('map').setView([25.0330, 121.5654], 13); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'OSM' }).addTo(map); } else if(map) map.invalidateSize(); map.eachLayer(l => {if(l instanceof L.Marker || l instanceof L.Polyline) map.removeLayer(l)}); const pts = []; dayItems.value.forEach(i => { if(i.locationLat) { const p = [i.locationLat, i.locationLng]; pts.push(p); L.marker(p).addTo(map).bindPopup(i.title); } }); if(pts.length>1) L.polyline(pts, {color: '#E05D5D'}).addTo(map); });
            const mapSearchQuery = ref('');
            const searchMapLocation = async () => { await searchLocation(mapSearchQuery.value); if(locationSuggestions.value.length) { const l = locationSuggestions.value[0]; map.setView([l.lat, l.lon], 16); L.marker([l.lat, l.lon]).addTo(map).bindPopup(l.display_name).openPopup(); } };
            const openMapTo = (i) => { currentTab.value = 'map'; initMap(); setTimeout(() => { if(i.locationLat && map) { map.setView([i.locationLat, i.locationLng], 16); L.marker([i.locationLat, i.locationLng]).addTo(map).bindPopup(i.title).openPopup(); } }, 500); };

            const addExpense = async () => { if(!newExpense.value.amount) return; await addDoc(collection(db, `trips/${currentTripId.value}/expenses`), { ...newExpense.value, timestamp: serverTimestamp() }); newExpense.value.amount = ''; newExpense.value.desc = ''; };
            const deleteExpense = async (id) => await deleteDoc(doc(db, `trips/${currentTripId.value}/expenses`, id));
            const addCheckItem = async () => { if(!newCheckItem.value) return; await addDoc(collection(db, `trips/${currentTripId.value}/checklist`), { text: newCheckItem.value, checked: false }); newCheckItem.value = ''; };
            const toggleCheck = async (i) => await updateDoc(doc(db, `trips/${currentTripId.value}/checklist`, i.id), { checked: !i.checked });
            const deleteCheckItem = async (id) => await deleteDoc(doc(db, `trips/${currentTripId.value}/checklist`, id));
            const doTranslate = async () => { try { const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(transInput.value)}&langpair=zh-TW|${transTarget.value}`); const d = await res.json(); transResult.value = d.responseData.translatedText; } catch(e) { transResult.value = "å¤±æ•—"; } };
            const refreshWeather = async () => { const l = dayItems.value[0]; if(!l || !l.locationLat) return; try { const d = tripDays.value[selectedDayIndex.value].toISOString().split('T')[0]; const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${l.locationLat}&longitude=${l.locationLng}&daily=temperature_2m_max,temperature_2m_min,rain_sum&timezone=auto&start_date=${d}&end_date=${d}`); const data = await res.json(); if(data.daily) weather.value = { tempMax: data.daily.temperature_2m_max[0], tempMin: data.daily.temperature_2m_min[0], rain: data.daily.rain_sum[0], city: l.title }; } catch(e){} };
            const downloadICS = () => { /* Logic hidden for brevity */ alert("åŒ¯å‡ºåŠŸèƒ½æº–å‚™ä¸­"); };

            onMounted(async () => {
                setTimeout(() => showSplash.value = false, 1500); // FORCE ENTER after 1.5s
                
                try { await signInAnonymously(auth); isOnline.value = true; } 
                catch(e) { console.log("Offline Mode Active"); isOnline.value = false; }

                onAuthStateChanged(auth, async (u) => {
                    if(u) {
                        user.value = u;
                        try { const d = await getDoc(doc(db, 'users', u.uid)); if(d.exists()) { userProfile.value = d.data(); if(!userProfile.value.name || userProfile.value.name==='æ–°ç”¨æˆ¶') showForceProfileModal.value=true; } else showForceProfileModal.value=true; } catch(e){}
                        onSnapshot(collection(db, `users/${u.uid}/trips`), async (s) => {
                            const ids = s.docs.map(d => d.id);
                            if(ids.length) { const p = ids.map(id => getDoc(doc(db, 'trips', id))); const r = await Promise.all(p); myTrips.value = r.filter(x=>x.exists()).map(x=>({id:x.id, ...x.data()})); }
                        });
                    }
                });
            });

            return {
                showSplash, isOnline, isProcessing, user, userProfile, editingProfile, tempProfile, openProfileEdit, saveProfile, handleAvatarUpload, getUserName, getUserAvatar, showForceProfileModal,
                myTrips, currentTripId, currentTrip, createTrip, joinTrip, enterTrip, exitTrip, showCreateTripModal, newTripName, newTripDate, joinCode, showInvite, showTripSettings, openTripSettings, updateTripName, tempTripName, currentTripMembers,
                currentTab, tripDays, selectedDayIndex, formatDate, addDay, dayItems, showAddItemModal, newItem, openAddItemModal, locationSuggestions, searchLocation, selectLocation, addItem, deleteItem, getTransportIcon,
                mapSearchQuery, searchMapLocation, initMap, openMapTo, expenses, newExpense, addExpense, deleteExpense, userBalances, totalExpenseTwd, customRates, showCalculator, calcDisplay, calcFormula, openCalculator, calcAppend, calcBackspace, calcClear, calcEqual, confirmCalc,
                checklist, newCheckItem, addCheckItem, toggleCheck, deleteCheckItem, transTarget, transInput, transResult, doTranslate, weather, refreshWeather, categoryTotals, pieGradient, getCategoryColor, saveBudget, editingBudget, tempBudget, remainingBudget, budgetPercent, downloadICS
            };
        }
    }).mount('#app');
</script>
</body>
</html>
