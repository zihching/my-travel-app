<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Travel Buddy Pro</title>
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiVHJhdmVsIEJ1ZGR5IiwiYmFja2dyb3VuZF9jb2xvciI6IiNGRkY4RTciLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsInRoZW1lX2NvbG9yIjoiIzQzMjgxOCIsImljb25zIjpbeyJzcmMiOiJodHRwczovL2Nkbi1pY29ucy1wbmcuZmxhdGljb24uY29tLzUxMi84MjkvODI5MDg1LnBuZyIsInNpemVzIjoiMTkyeDE5MiIsInR5cGUiOiJpbWFnZS9wbmciHSwie3sic3JjIjoiaHR0cHM6Ly9jZG4taWNvbnMtcG5nLmZsYXRpY29uLmNvbS81MTIvODI5LzgyOTA4NS5wbmciLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIn1dfQ==">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Leaflet (Map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- FontAwesome (Icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase (Modular) - Using Stable Version 10.13.1 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc, serverTimestamp, where, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

        window.firebaseModules = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc, serverTimestamp, where, getDoc, setDoc };
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'milk-yellow': '#FFF8E7',
                        'milk-yellow-dark': '#FDF0D0',
                        'coffee': '#432818',
                        'coffee-light': '#A89F91',
                        'accent': '#BB9457',
                        'khaki': '#C2B280',
                        'success': '#88B04B',
                        'danger': '#E05D5D'
                    },
                    fontFamily: {
                        sans: ['Noto Sans TC', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        body { background-color: #FFF8E7; color: #432818; -webkit-tap-highlight-color: transparent; }
        #map { height: 100%; width: 100%; z-index: 0; }
        .app-container { max-width: 480px; margin: 0 auto; background-color: #FFF8E7; min-height: 100vh; position: relative; box-shadow: 0 0 20px rgba(67, 40, 24, 0.1); }
        .transport-icon.active { color: #A89F91; transform: scale(1.1); }
        .calc-btn { @apply text-xl font-bold rounded-lg p-4 shadow-sm active:scale-95 transition-transform flex items-center justify-center; }
        .pie-chart {
            width: 120px; height: 120px; border-radius: 50%;
            background: conic-gradient(var(--pie-gradient));
            position: relative;
        }
        .pie-chart::after {
            content: ""; position: absolute; inset: 25%; background: #FFF8E7; border-radius: 50%;
        }
    </style>
</head>
<body>

<div id="app" class="app-container flex flex-col h-screen overflow-hidden">

    <!-- Loading Screen with Diagnostics -->
    <div v-if="loading" class="absolute inset-0 z-[500] flex items-center justify-center bg-milk-yellow flex-col text-center p-4">
        <i class="fa-solid fa-plane fa-bounce text-4xl text-coffee mb-4"></i>
        <p class="text-coffee font-bold mb-2">{{ loadingStatus }}</p>
        
        <!-- Slow Loading Hint -->
        <div v-if="showSlowLoadingHint" class="mt-4 bg-white/50 p-4 rounded-xl max-w-xs animate-pulse">
            <p class="text-xs text-red-500 font-bold mb-1">é€£ç·šä¼¼ä¹æœ‰é»æ…¢...</p>
            <p class="text-[10px] text-gray-500 mb-3">è«‹ç¢ºèªç¶²è·¯é€£ç·šï¼Œæˆ– Firebase å®‰å…¨è¦å‰‡æ˜¯å¦å·²è¨­ç‚ºå…¬é–‹ (Test Mode)ã€‚</p>
            <button @click="loading = false" class="bg-coffee text-white px-4 py-2 rounded-lg text-xs font-bold shadow-md">
                ç•¥éé€£ç·šï¼Œç›´æ¥é€²å…¥ (é›¢ç·šæ¨¡å¼)
            </button>
        </div>
        <div v-if="errorMsg" class="mt-4 text-red-500 text-xs font-bold max-w-xs bg-red-50 p-2 rounded">{{ errorMsg }}</div>
    </div>

    <!-- VIEW: Trip List (Home) -->
    <div v-if="!currentTripId && !loading" class="flex-1 flex flex-col p-6 space-y-6 overflow-y-auto">
        <!-- User Profile Header -->
        <div class="flex items-center gap-4 mb-4">
            <div @click="openProfileEdit" class="w-16 h-16 rounded-full bg-gray-200 overflow-hidden border-2 border-coffee cursor-pointer relative group flex-shrink-0 shadow-md">
                <img v-if="userProfile.avatar" :src="userProfile.avatar" class="w-full h-full object-cover">
                <div v-else class="w-full h-full flex items-center justify-center text-gray-400"><i class="fa-solid fa-user"></i></div>
                <div class="absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 group-hover:opacity-100 text-white text-xs">ç·¨è¼¯</div>
            </div>
            <div class="flex-1 min-w-0">
                <h1 class="text-2xl font-bold text-coffee truncate">ä½ å¥½ï¼Œ{{ userProfile.name }}</h1>
                <p class="text-sm text-gray-500">Travel Buddy Pro</p>
            </div>
        </div>

        <!-- Create Trip -->
        <button @click="showCreateTripModal = true" class="bg-coffee text-milk-yellow p-4 rounded-2xl shadow-lg flex items-center justify-center gap-2 font-bold transform transition active:scale-95 hover:shadow-xl">
            <i class="fa-solid fa-plus-circle text-xl"></i>
            å»ºç«‹æ–°æ—…ç¨‹
        </button>

        <!-- Join Trip -->
        <div class="flex gap-2">
            <input v-model="joinCode" placeholder="è¼¸å…¥æœ‹å‹çš„é‚€è«‹ç¢¼" class="flex-1 bg-white p-3 rounded-xl border border-gray-200 outline-none text-sm shadow-sm focus:border-accent">
            <button @click="joinTrip" class="bg-accent text-white px-4 rounded-xl font-bold whitespace-nowrap shadow-sm hover:bg-opacity-90">åŠ å…¥</button>
        </div>

        <!-- Trip List -->
        <div>
            <h2 class="font-bold text-coffee mb-3 border-b border-coffee/10 pb-2">æˆ‘çš„æ—…ç¨‹</h2>
            <div v-if="myTrips.length === 0" class="text-center text-gray-400 py-10 bg-white/50 rounded-2xl border-2 border-dashed border-gray-200">
                <i class="fa-solid fa-suitcase-rolling text-2xl mb-2 opacity-50"></i>
                <p>é‚„æ²’æœ‰è¡Œç¨‹ï¼Œå¿«å»ºç«‹ä¸€å€‹å§ï¼</p>
            </div>
            <div v-else class="space-y-3">
                <div v-for="trip in myTrips" :key="trip.id" @click="enterTrip(trip)" class="bg-white p-4 rounded-xl shadow-sm flex justify-between items-center cursor-pointer hover:bg-gray-50 transition border border-transparent hover:border-coffee/10">
                    <div class="flex-1 min-w-0 mr-2">
                        <div class="font-bold text-lg text-coffee truncate">{{ trip.name }}</div>
                        <div class="text-xs text-gray-400 flex items-center gap-1">
                            <i class="fa-solid fa-calendar-days"></i> {{ formatDate(new Date(trip.startDate)) }}
                            <span class="mx-1">|</span>
                            <i class="fa-solid fa-users"></i> {{ trip.members ? trip.members.length : 1 }}
                        </div>
                    </div>
                    <i class="fa-solid fa-chevron-right text-gray-300"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- VIEW: Single Trip (The App) -->
    <div v-if="currentTripId" class="flex flex-col h-full">
        <!-- Top Bar -->
        <div class="px-4 pt-4 pb-2 bg-milk-yellow z-10 shadow-sm" v-if="currentTab !== 'map'">
            <div class="flex justify-between items-center mb-2">
                <button @click="exitTrip" class="text-coffee flex items-center gap-1 font-bold text-sm"><i class="fa-solid fa-chevron-left"></i> è¿”å›</button>
                <div class="flex items-center gap-2 flex-1 justify-center min-w-0 px-2" @click="openTripSettings">
                    <h1 class="text-lg font-bold text-coffee cursor-pointer truncate">{{ currentTrip.name }} <i class="fa-solid fa-pen text-xs opacity-50"></i></h1>
                </div>
                <div class="flex gap-2">
                    <button @click="showInvite = true" class="w-8 h-8 rounded-full bg-accent text-white flex items-center justify-center shadow-sm"><i class="fa-solid fa-user-plus text-xs"></i></button>
                </div>
            </div>
            
            <!-- Date Slider (Itinerary Only) -->
            <div v-if="currentTab === 'itinerary'" class="flex overflow-x-auto no-scrollbar gap-2 py-2">
                <button 
                    v-for="(day, index) in tripDays" 
                    :key="index"
                    @click="selectedDayIndex = index"
                    class="flex-shrink-0 px-4 py-2 rounded-xl transition-all duration-300 flex flex-col items-center min-w-[70px]"
                    :class="selectedDayIndex === index ? 'bg-coffee text-milk-yellow shadow-md transform scale-105' : 'bg-milk-yellow-dark text-coffee-light'"
                >
                    <span class="text-xs font-bold">Day {{ index + 1 }}</span>
                    <span class="text-sm">{{ formatDate(day) }}</span>
                </button>
                <button @click="addDay" class="flex-shrink-0 px-3 py-2 rounded-xl bg-white border border-dashed border-coffee text-coffee">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 overflow-y-auto overflow-x-hidden relative bg-milk-yellow pb-20 no-scrollbar">
            
            <!-- TAB: Itinerary -->
            <div v-if="currentTab === 'itinerary'" class="p-4 space-y-4">
                <!-- Weather -->
                <div class="bg-gradient-to-r from-blue-100 to-blue-50 rounded-2xl p-4 flex items-center justify-between shadow-sm text-coffee">
                     <div>
                        <div class="text-xs opacity-70 mb-1"><i class="fa-solid fa-calendar-day mr-1"></i>{{ formatDate(tripDays[selectedDayIndex]) }} é å ±</div>
                        <div class="text-2xl font-bold flex items-center gap-2">
                            {{ weather.tempMax ? `${weather.tempMin}-${weather.tempMax}Â°C` : 'è¼‰å…¥ä¸­...' }} 
                            <i class="fa-solid fa-cloud-sun text-orange-400"></i>
                        </div>
                     </div>
                     <div class="text-right text-xs">
                         <div class="font-bold text-sm">{{ weather.city || 'è¡Œç¨‹åœ°é»' }}</div>
                         <div v-if="weather.rain > 0" class="text-blue-500 font-bold"><i class="fa-solid fa-umbrella"></i> é™é›¨æ©Ÿç‡é«˜</div>
                         <div v-else class="text-green-600">é©åˆå‡ºéŠ</div>
                     </div>
                </div>

                <!-- Tools Row -->
                <div class="flex gap-2">
                    <button @click="downloadICS" class="flex-1 bg-white py-2 rounded-xl text-xs font-bold text-coffee shadow-sm border border-coffee/10 flex items-center justify-center gap-1">
                        <i class="fa-regular fa-calendar-plus"></i> åŒ¯å‡ºåˆ°æ—¥æ›†
                    </button>
                </div>

                <!-- Items -->
                <div v-if="dayItems.length === 0" class="text-center py-10 text-gray-400">
                    <i class="fa-regular fa-map text-4xl mb-2 opacity-50"></i>
                    <p>æŒ‰ + æ–°å¢æ‚¨çš„ç¬¬ä¸€å€‹æ™¯é»</p>
                </div>

                <div v-for="(item, idx) in dayItems" :key="item.id" class="relative pl-4 border-l-2 border-dashed border-coffee/20 ml-2">
                    <!-- Connector Dot -->
                    <div class="absolute -left-[9px] top-4 w-4 h-4 rounded-full bg-milk-yellow border-2 border-accent z-10"></div>
                    
                    <div class="bg-white rounded-2xl p-3 shadow-sm flex gap-3 relative group border border-transparent hover:border-coffee/10 transition mb-4">
                        <button @click="deleteItem(item.id)" class="absolute top-2 right-2 text-gray-300 hover:text-red-500 p-2 z-10 transition-colors">
                            <i class="fa-solid fa-trash"></i>
                        </button>

                        <div class="flex flex-col items-center justify-start pt-1 min-w-[50px]">
                            <span class="font-bold text-coffee text-lg">{{ item.time }}</span>
                            <div v-if="item.transport" class="mt-2 text-coffee-light text-sm">
                                <i :class="getTransportIcon(item.transport)"></i>
                            </div>
                        </div>

                        <div class="flex-1 pb-2 pr-6">
                            <div class="font-bold text-lg text-coffee mb-1">{{ item.title }}</div>
                            <div class="text-sm text-gray-500 mb-2 flex items-center cursor-pointer hover:text-accent transition-colors" @click="openMapTo(item)">
                                <i class="fa-solid fa-location-dot mr-1 text-accent"></i> {{ item.locationName ? item.locationName.split(',')[0] : item.location }}
                            </div>
                            <div v-if="item.imageUrl" class="mb-2 rounded-lg overflow-hidden h-32 w-full shadow-inner">
                                <img :src="item.imageUrl" class="w-full h-full object-cover">
                            </div>
                            <div v-if="item.notes" class="text-xs text-gray-600 bg-gray-50 p-2 rounded border border-gray-100">{{ item.notes }}</div>
                        </div>
                    </div>
                </div>

                <button @click="openAddItemModal" class="w-full py-3 rounded-2xl border-2 border-dashed border-coffee/30 text-coffee/50 font-bold hover:bg-white hover:text-coffee transition-all hover:shadow-md hover:border-coffee/50">
                    + æ–°å¢è¡Œç¨‹
                </button>
            </div>

            <!-- TAB: Map -->
            <div v-show="currentTab === 'map'" class="h-full w-full relative">
                <div id="map"></div>
                <div class="absolute top-4 left-4 right-4 z-[400]">
                    <div class="bg-white rounded-xl shadow-lg p-2 flex gap-2">
                        <input v-model="mapSearchQuery" @keyup.enter="searchMapLocation" placeholder="æœå°‹åœ°åœ–åœ°é»..." class="flex-1 outline-none px-2 text-sm bg-transparent">
                        <button @click="searchMapLocation" class="text-coffee px-2 hover:text-accent"><i class="fa-solid fa-search"></i></button>
                    </div>
                </div>
                <div class="absolute bottom-20 left-4 z-[400] bg-white/90 p-2 rounded-lg text-xs shadow text-coffee">
                    <div class="flex items-center gap-2"><div class="w-4 h-1 bg-red-500"></div> è¡Œç¨‹è·¯å¾‘ ({{ dayItems.length }} é»)</div>
                </div>
            </div>

            <!-- TAB: Money -->
            <div v-if="currentTab === 'money'" class="p-4 space-y-4">
                <div class="bg-coffee text-milk-yellow rounded-2xl p-4 shadow-lg relative overflow-hidden">
                    <div class="flex justify-between items-end mb-2 relative z-10">
                        <div>
                            <div class="text-xs opacity-70">ç¸½é ç®—</div>
                            <div v-if="!editingBudget" class="text-2xl font-bold flex items-center gap-2" @click="editingBudget=true">
                                ${{ currentTrip.budget || 0 }} <i class="fa-solid fa-pen text-xs opacity-50"></i>
                            </div>
                            <input v-else v-model="tempBudget" @blur="saveBudget" type="number" class="text-coffee bg-white px-2 rounded w-24">
                        </div>
                        <div class="text-right">
                            <div class="text-xs opacity-70">å‰©é¤˜</div>
                            <div class="text-xl font-bold" :class="remainingBudget < 0 ? 'text-red-300' : 'text-green-300'">
                                ${{ remainingBudget }}
                            </div>
                        </div>
                    </div>
                    <div class="w-full h-2 bg-black/20 rounded-full overflow-hidden relative z-10">
                        <div class="h-full bg-accent transition-all duration-500" :style="{width: budgetPercent + '%'}"></div>
                    </div>
                    <div class="text-[10px] mt-1 text-right opacity-60 relative z-10">å·²ä½¿ç”¨ {{ budgetPercent }}%</div>
                    <i class="fa-solid fa-wallet absolute -bottom-4 -right-4 text-8xl opacity-10 rotate-12"></i>
                </div>

                <div class="bg-white rounded-2xl p-4 shadow-sm flex items-center justify-between">
                    <div class="pie-chart shadow-inner" :style="{'--pie-gradient': pieGradient}"></div>
                    <div class="flex-1 pl-4">
                        <div class="text-sm font-bold text-coffee mb-2">æ¶ˆè²»åˆ†æ</div>
                        <div class="space-y-1">
                            <div v-for="(amount, cat) in categoryTotals" :key="cat" class="flex items-center justify-between text-xs">
                                <div class="flex items-center gap-1">
                                    <div class="w-2 h-2 rounded-full" :style="{backgroundColor: getCategoryColor(cat)}"></div>
                                    {{ cat }}
                                </div>
                                <span>${{ amount }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl p-3 shadow-sm space-y-2">
                    <div class="flex gap-2">
                        <input v-model="newExpense.desc" placeholder="æ¶ˆè²»é …ç›®" class="flex-1 bg-gray-50 p-2 rounded text-sm outline-none border border-gray-100">
                        <select v-model="newExpense.category" class="bg-gray-50 p-2 rounded text-sm outline-none border border-gray-100">
                            <option value="é£Ÿ">ğŸ” é£Ÿ</option>
                            <option value="ä½">ğŸ¨ ä½</option>
                            <option value="è¡Œ">ğŸš— è¡Œ</option>
                            <option value="æ¨‚">ğŸŸï¸ æ¨‚</option>
                            <option value="è³¼">ğŸ›ï¸ è³¼</option>
                            <option value="å…¶ä»–">ğŸ§¾ å…¶ä»–</option>
                        </select>
                    </div>
                    <div class="flex gap-2">
                        <div class="flex-1 relative">
                            <input v-model="newExpense.amount" type="number" placeholder="é‡‘é¡" class="w-full bg-gray-50 p-2 rounded text-sm outline-none border border-gray-100">
                            <button @click="openCalculator" class="absolute right-1 top-1 bg-khaki text-white p-1 rounded px-2 text-xs"><i class="fa-solid fa-calculator"></i></button>
                        </div>
                        <select v-model="newExpense.payer" class="w-24 bg-gray-50 p-2 rounded text-sm text-xs border border-gray-100">
                            <option value="" disabled>ä»˜æ¬¾äºº</option>
                            <option v-for="m in currentTripMembers" :value="m.uid">{{ m.name }}</option>
                        </select>
                    </div>
                    <button @click="addExpense" class="w-full bg-accent text-white py-2 rounded-lg font-bold text-sm shadow-sm hover:bg-opacity-90">è¨˜ä¸€ç­†</button>
                </div>

                <div class="flex gap-2 overflow-x-auto no-scrollbar pb-2">
                     <div v-for="(balance, uid) in userBalances" :key="uid" class="bg-white px-3 py-2 rounded-xl text-xs whitespace-nowrap flex items-center gap-2 shadow-sm border border-gray-100">
                        <img :src="getUserAvatar(uid)" class="w-5 h-5 rounded-full bg-gray-300 object-cover">
                        <div class="flex flex-col">
                            <span class="font-bold text-coffee">{{ getUserName(uid) }}</span>
                            <span :class="balance >= 0 ? 'text-green-500' : 'text-red-500'">{{ balance >= 0 ? 'æ”¶' : 'ä»˜' }} ${{ Math.abs(balance) }}</span>
                        </div>
                    </div>
                </div>
                
                <div class="space-y-2 pb-10">
                    <div v-for="exp in expenses" :key="exp.id" class="bg-white p-3 rounded-xl flex justify-between items-center shadow-sm border-l-4" :style="{borderLeftColor: getCategoryColor(exp.category)}">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-xs font-bold text-coffee overflow-hidden">
                                <img v-if="getUserAvatar(exp.payer)" :src="getUserAvatar(exp.payer)" class="w-full h-full object-cover">
                                <span v-else>{{ getUserName(exp.payer).charAt(0) }}</span>
                            </div>
                            <div>
                                <div class="font-bold text-coffee text-sm">{{ exp.desc }} <span class="text-[10px] text-gray-400 bg-gray-100 px-1 rounded">{{ exp.category }}</span></div>
                                <div class="text-xs text-gray-400">{{ getUserName(exp.payer) }} ä»˜æ¬¾</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-coffee">{{ exp.amount }}</div>
                            <button @click="deleteExpense(exp.id)" class="text-red-300 ml-2 text-xs"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: Checklist -->
            <div v-if="currentTab === 'checklist'" class="p-4 space-y-4">
                <div class="bg-white rounded-2xl p-4 shadow-sm">
                    <h3 class="font-bold text-coffee mb-3"><i class="fa-solid fa-clipboard-check mr-2"></i>è¡Œå‰æ¸…å–®</h3>
                    <div class="flex gap-2 mb-4">
                        <input v-model="newCheckItem" @keyup.enter="addCheckItem" placeholder="æ–°å¢é …ç›® (å¦‚: è­·ç…§ã€å……é›»å™¨)" class="flex-1 bg-gray-50 p-2 rounded text-sm outline-none border border-gray-100">
                        <button @click="addCheckItem" class="bg-accent text-white px-3 rounded text-sm font-bold">+</button>
                    </div>
                    <div class="space-y-2">
                        <div v-for="item in checklist" :key="item.id" @click="toggleCheck(item)" class="flex items-center gap-3 cursor-pointer p-2 hover:bg-gray-50 rounded transition">
                            <div class="w-5 h-5 rounded border-2 flex items-center justify-center transition-colors"
                                 :class="item.checked ? 'bg-success border-success' : 'border-gray-300'">
                                <i v-if="item.checked" class="fa-solid fa-check text-white text-xs"></i>
                            </div>
                            <span :class="{'line-through text-gray-400': item.checked, 'text-coffee': !item.checked}" class="flex-1">{{ item.text }}</span>
                            <button @click.stop="deleteCheckItem(item.id)" class="text-gray-300 hover:text-red-300"><i class="fa-solid fa-times"></i></button>
                        </div>
                    </div>
                    <div v-if="checklist.length === 0" class="text-center text-gray-400 text-xs py-4">æ¸…å–®ç©ºç©ºçš„ï¼ŒåŠ é»æ±è¥¿å§ï¼</div>
                </div>
            </div>

            <!-- TAB: Tools -->
            <div v-if="currentTab === 'tools'" class="p-4 space-y-6">
                <div class="bg-white rounded-2xl p-4 shadow-sm">
                    <h3 class="font-bold text-coffee mb-3"><i class="fa-solid fa-language mr-2"></i>å³æ™‚ç¿»è­¯</h3>
                    <div class="flex gap-2 mb-2">
                        <select v-model="transSource" class="bg-gray-50 p-2 rounded text-xs flex-1 border border-gray-100"><option value="zh-TW">ç¹é«”ä¸­æ–‡</option><option value="en">English</option></select>
                        <i class="fa-solid fa-arrow-right text-gray-400 self-center"></i>
                        <select v-model="transTarget" class="bg-gray-50 p-2 rounded text-xs flex-1 border border-gray-100"><option value="en">English</option><option value="ja">æ—¥æœ¬èª</option><option value="ko">í•œêµ­ì–´</option><option value="th">à¹„à¸—à¸¢</option></select>
                    </div>
                    <textarea v-model="transInput" placeholder="è¼¸å…¥æ–‡å­—..." class="w-full bg-gray-50 p-3 rounded-xl text-sm h-20 outline-none mb-2 border border-gray-100"></textarea>
                    <button @click="doTranslate" class="w-full bg-coffee text-milk-yellow py-2 rounded-lg text-sm font-bold mb-3 shadow-sm">ç¿»è­¯</button>
                    <div v-if="transResult" class="bg-milk-yellow-dark p-3 rounded-xl text-coffee font-bold relative">
                        {{ transResult }}
                        <button @click="transResult=''" class="absolute top-1 right-2 text-gray-400 text-xs"><i class="fa-solid fa-times"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="fixed bottom-0 w-full max-w-[480px] bg-white border-t border-gray-100 flex justify-around py-2 pb-4 z-50 text-[10px] font-bold text-gray-400">
            <button @click="currentTab = 'itinerary'" :class="currentTab === 'itinerary' ? 'text-coffee' : ''" class="flex flex-col items-center w-1/6 space-y-1 transition-colors"><i class="fa-solid fa-list-ul text-lg"></i><span>è¡Œç¨‹</span></button>
            <button @click="currentTab = 'map'; initMap()" :class="currentTab === 'map' ? 'text-coffee' : ''" class="flex flex-col items-center w-1/6 space-y-1 transition-colors"><i class="fa-regular fa-map text-lg"></i><span>åœ°åœ–</span></button>
            <button @click="currentTab = 'money'" :class="currentTab === 'money' ? 'text-coffee' : ''" class="flex flex-col items-center w-1/6 space-y-1 transition-colors"><i class="fa-solid fa-wallet text-lg"></i><span>åˆ†å¸³</span></button>
            <button @click="currentTab = 'checklist'" :class="currentTab === 'checklist' ? 'text-coffee' : ''" class="flex flex-col items-center w-1/6 space-y-1 transition-colors"><i class="fa-solid fa-check-double text-lg"></i><span>æ¸…å–®</span></button>
            <button @click="currentTab = 'tools'" :class="currentTab === 'tools' ? 'text-coffee' : ''" class="flex flex-col items-center w-1/6 space-y-1 transition-colors"><i class="fa-solid fa-toolbox text-lg"></i><span>å·¥å…·</span></button>
        </div>
    </div>

    <!-- MODALS -->
    <div v-if="showCreateTripModal" class="fixed inset-0 z-[200] bg-black/50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-xl">
            <h3 class="text-xl font-bold text-coffee mb-4">å»ºç«‹æ–°æ—…ç¨‹</h3>
            <input v-model="newTripName" placeholder="æ—…ç¨‹åç¨±" class="w-full bg-gray-50 p-3 rounded-xl outline-none mb-2 border">
            <label class="text-xs text-gray-500 mb-1 block">å‡ºç™¼æ—¥æœŸ (ç”¨æ–¼å¤©æ°£é å ±)</label>
            <input v-model="newTripDate" type="date" class="w-full bg-gray-50 p-3 rounded-xl outline-none mb-4 border">
            <div class="flex gap-3">
                <button @click="showCreateTripModal = false" class="flex-1 py-3 bg-gray-100 text-gray-500 rounded-xl">å–æ¶ˆ</button>
                <button @click="createTrip" :disabled="isProcessing" class="flex-1 py-3 bg-coffee text-milk-yellow rounded-xl font-bold disabled:opacity-50">{{ isProcessing ? 'å»ºç«‹ä¸­...' : 'å»ºç«‹' }}</button>
            </div>
        </div>
    </div>
    
    <div v-if="showForceProfileModal" class="fixed inset-0 z-[300] bg-black/90 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl text-center">
            <i class="fa-solid fa-passport text-4xl text-coffee mb-3"></i>
            <h3 class="font-bold text-coffee text-xl mb-2">æ­¡è¿ä¾†åˆ° Travel Buddy!</h3>
            <div class="flex flex-col items-center mb-4">
                <div class="w-24 h-24 rounded-full bg-gray-200 overflow-hidden mb-2 relative border-4 border-white shadow-lg">
                    <img v-if="tempProfile.avatar" :src="tempProfile.avatar" class="w-full h-full object-cover">
                    <i v-else class="fa-solid fa-user text-3xl text-gray-400 absolute inset-0 flex items-center justify-center"></i>
                </div>
                <label class="text-xs text-accent cursor-pointer font-bold hover:underline">ä¸Šå‚³é ­è²¼<input type="file" accept="image/*" class="hidden" @change="handleAvatarUpload"></label>
            </div>
            <input v-model="tempProfile.name" placeholder="è«‹è¼¸å…¥æš±ç¨± (å¿…å¡«)" class="w-full bg-gray-50 p-4 rounded-xl mb-6 text-center font-bold text-lg border-2 focus:border-coffee outline-none transition-colors" :class="{'border-red-300': !tempProfile.name}">
            <button @click="saveProfile" :disabled="isProcessing || !tempProfile.name" class="w-full bg-coffee text-milk-yellow py-3 rounded-xl font-bold disabled:opacity-50 disabled:cursor-not-allowed shadow-md hover:transform hover:scale-105 transition-all">{{ isProcessing ? 'å„²å­˜ä¸­...' : 'é–‹å§‹æ—…ç¨‹ ğŸš€' }}</button>
        </div>
    </div>

    <!-- Add Item Modal -->
    <div v-if="showAddItemModal" class="fixed inset-0 z-[60] bg-black/50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-xl h-[80vh] overflow-y-auto">
            <h3 class="text-xl font-bold text-coffee mb-4">æ–°å¢æ™¯é»</h3>
            <label class="text-xs text-gray-400">æ™‚é–“</label>
            <input v-model="newItem.time" type="time" class="w-full bg-gray-50 p-2 rounded-xl mb-3 border">
            <label class="text-xs text-gray-400">åœ°é»æœå°‹</label>
            <div class="relative mb-3">
                <div class="flex gap-2">
                    <input v-model="newItem.searchQuery" placeholder="è¼¸å…¥åç¨± (å¦‚: å°åŒ—101)" class="flex-1 bg-gray-50 p-2 rounded-xl outline-none text-sm border">
                    <button @click="searchLocation(newItem.searchQuery)" class="bg-accent text-white px-3 rounded-xl text-xs">æœ</button>
                </div>
                <div v-if="locationSuggestions.length > 0" class="absolute w-full bg-white border border-gray-100 shadow-lg rounded-xl mt-1 z-10 max-h-40 overflow-y-auto">
                    <div v-for="loc in locationSuggestions" :key="loc.place_id" @click="selectLocation(loc)" class="p-2 border-b border-gray-100 text-xs hover:bg-gray-50 cursor-pointer">{{ loc.display_name }}</div>
                </div>
            </div>
            <label class="text-xs text-gray-400">é¡¯ç¤ºåç¨±</label>
            <input v-model="newItem.title" class="w-full bg-gray-50 p-2 rounded-xl mb-3 font-bold border">
            <label class="text-xs text-gray-400">äº¤é€šæ–¹å¼</label>
            <div class="flex gap-4 justify-center py-2 mb-3 bg-gray-50 rounded-xl">
                <i @click="newItem.transport='car'" class="fa-solid fa-car text-xl cursor-pointer transport-icon transition p-2" :class="newItem.transport==='car' ? 'active' : 'text-gray-300'"></i>
                <i @click="newItem.transport='train'" class="fa-solid fa-train-subway text-xl cursor-pointer transport-icon transition p-2" :class="newItem.transport==='train' ? 'active' : 'text-gray-300'"></i>
                <i @click="newItem.transport='walking'" class="fa-solid fa-person-walking text-xl cursor-pointer transport-icon transition p-2" :class="newItem.transport==='walking' ? 'active' : 'text-gray-300'"></i>
            </div>
            <label class="text-xs text-gray-400">å‚™è¨»</label>
            <textarea v-model="newItem.notes" class="w-full bg-gray-50 p-2 rounded-xl mb-4 h-16 border"></textarea>
            <div class="flex gap-3">
                <button @click="showAddItemModal = false" class="flex-1 py-3 bg-gray-100 text-gray-500 rounded-xl">å–æ¶ˆ</button>
                <button @click="addItem" class="flex-1 py-3 bg-coffee text-milk-yellow rounded-xl font-bold">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <!-- Calculator Modal -->
    <div v-if="showCalculator" class="fixed inset-0 z-[70] bg-black/50 flex items-end justify-center sm:items-center">
        <div class="bg-white rounded-t-3xl sm:rounded-3xl w-full max-w-sm p-4 shadow-xl pb-10 sm:pb-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-coffee">è¨ˆç®—æ©Ÿ</h3>
                <button @click="showCalculator = false"><i class="fa-solid fa-times text-gray-400 hover:text-coffee"></i></button>
            </div>
            <div class="bg-gray-100 p-4 rounded-xl mb-4 text-right shadow-inner">
                <div class="text-gray-400 text-sm h-5">{{ calcFormula || '' }}</div>
                <div class="text-3xl font-bold text-coffee truncate">{{ calcDisplay }}</div>
            </div>
            <div class="grid grid-cols-4 gap-2">
                <button @click="calcAppend('+')" class="calc-btn bg-milk-yellow text-coffee">+</button>
                <button @click="calcAppend('-')" class="calc-btn bg-milk-yellow text-coffee">-</button>
                <button @click="calcAppend('*')" class="calc-btn bg-milk-yellow text-coffee">Ã—</button>
                <button @click="calcAppend('/')" class="calc-btn bg-milk-yellow text-coffee">Ã·</button>
                <button @click="calcAppend('7')" class="calc-btn bg-khaki text-white">7</button>
                <button @click="calcAppend('8')" class="calc-btn bg-khaki text-white">8</button>
                <button @click="calcAppend('9')" class="calc-btn bg-khaki text-white">9</button>
                <button @click="calcBackspace" class="calc-btn bg-red-100 text-red-500"><i class="fa-solid fa-backspace"></i></button>
                <button @click="calcAppend('4')" class="calc-btn bg-khaki text-white">4</button>
                <button @click="calcAppend('5')" class="calc-btn bg-khaki text-white">5</button>
                <button @click="calcAppend('6')" class="calc-btn bg-khaki text-white">6</button>
                <button @click="calcClear" class="calc-btn bg-gray-200">C</button>
                <button @click="calcAppend('1')" class="calc-btn bg-khaki text-white">1</button>
                <button @click="calcAppend('2')" class="calc-btn bg-khaki text-white">2</button>
                <button @click="calcAppend('3')" class="calc-btn bg-khaki text-white">3</button>
                <button @click="calcEqual" class="calc-btn bg-coffee text-milk-yellow row-span-2 rounded-2xl">=</button>
                <button @click="calcAppend('0')" class="calc-btn bg-khaki text-white col-span-2">0</button>
                <button @click="calcAppend('.')" class="calc-btn bg-khaki text-white">.</button>
            </div>
            <button @click="confirmCalc" class="w-full mt-4 bg-accent text-white py-3 rounded-xl font-bold" type="button">å¡«å…¥é‡‘é¡</button>
        </div>
    </div>

    <div v-if="editingProfile && !showForceProfileModal" class="fixed inset-0 z-[80] bg-black/50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6">
            <h3 class="font-bold text-coffee mb-4">ç·¨è¼¯å€‹äººæª”æ¡ˆ</h3>
            <div class="flex flex-col items-center mb-4"><div class="w-20 h-20 rounded-full bg-gray-200 overflow-hidden mb-2 relative"><img v-if="tempProfile.avatar" :src="tempProfile.avatar" class="w-full h-full object-cover"><i v-else class="fa-solid fa-user text-2xl text-gray-400 absolute inset-0 flex items-center justify-center"></i></div><label class="text-xs text-accent cursor-pointer font-bold">æ›´æ›é ­è²¼<input type="file" accept="image/*" class="hidden" @change="handleAvatarUpload"></label></div>
            <input v-model="tempProfile.name" placeholder="ä½ çš„æš±ç¨±" class="w-full bg-gray-50 p-3 rounded-xl mb-4 border">
            <button @click="saveProfile" class="w-full bg-coffee text-milk-yellow py-3 rounded-xl font-bold">å„²å­˜</button>
            <button @click="editingProfile = false" class="w-full text-gray-400 py-3 mt-1">å–æ¶ˆ</button>
        </div>
    </div>
    
    <div v-if="showTripSettings" class="fixed inset-0 z-[80] bg-black/50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6">
            <h3 class="font-bold text-coffee mb-4">è¡Œç¨‹è¨­å®š</h3>
            <input v-model="tempTripName" placeholder="è¡Œç¨‹åç¨±" class="w-full bg-gray-50 p-3 rounded-xl mb-4 font-bold text-coffee border">
            <button @click="updateTripName" class="w-full bg-accent text-white py-3 rounded-xl font-bold mb-2">æ›´æ–°åç¨±</button>
            <button @click="showTripSettings = false" class="w-full text-gray-400 py-2">å–æ¶ˆ</button>
        </div>
    </div>

    <div v-if="showInvite" class="fixed inset-0 z-[80] bg-black/50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 text-center">
            <h3 class="font-bold text-coffee mb-2">é‚€è«‹æœ‹å‹</h3>
            <div class="bg-gray-100 p-4 rounded-xl text-2xl font-mono font-bold tracking-widest text-coffee mb-4 select-all border border-dashed border-coffee/30">{{ currentTripId }}</div>
            <button @click="showInvite = false" class="text-gray-400">é—œé–‰</button>
        </div>
    </div>

</div>

<script type="module">
    const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;
    const { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc, serverTimestamp, where, getDoc, setDoc } = window.firebaseModules;

    // --- Config ---
    const firebaseConfig = {
        apiKey: "AIzaSyDFUGYOobmVxYFQMBYz1iQ4z1HIrdbTi8Q",
        authDomain: "travel-55c4b.firebaseapp.com",
        databaseURL: "https://travel-55c4b-default-rtdb.firebaseio.com",
        projectId: "travel-55c4b",
        storageBucket: "travel-55c4b.firebasestorage.app",
        messagingSenderId: "925227625640",
        appId: "1:925227625640:web:4cc6d501b2e21ab7f8a69d"
    };

    let app, auth, db;
    try { app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app); } catch(e) { console.error("Firebase Init Error", e); }

    const withTimeout = (promise, ms = 5000) => Promise.race([promise, new Promise((_, reject) => setTimeout(() => reject(new Error("é€£ç·šé€¾æ™‚ (è«‹æª¢æŸ¥ç¶²è·¯æˆ–Firebaseè¦å‰‡)")), ms))]);

    createApp({
        setup() {
            // State
            const loading = ref(true);
            const loadingStatus = ref("åˆå§‹åŒ–ä¸­...");
            const errorMsg = ref("");
            const showSlowLoadingHint = ref(false);
            const isProcessing = ref(false);
            const user = ref(null);
            const userProfile = ref({ name: 'æ–°ç”¨æˆ¶', avatar: '' });
            const editingProfile = ref(false);
            const showForceProfileModal = ref(false);
            const tempProfile = ref({});

            // Trip Management
            const myTrips = ref([]);
            const currentTripId = ref(null);
            const currentTrip = ref({});
            const tempTripName = ref('');
            const currentTripMembers = ref([]);
            const showCreateTripModal = ref(false);
            const newTripName = ref('');
            const newTripDate = ref(new Date().toISOString().split('T')[0]);
            const joinCode = ref('');
            const showInvite = ref(false);
            const showTripSettings = ref(false);

            // App State
            const currentTab = ref('itinerary');
            const tripDays = ref([]);
            const selectedDayIndex = ref(0);
            const allItineraryItems = ref([]);
            const showAddItemModal = ref(false);
            const newItem = ref({ time: '09:00', title: '', searchQuery: '', locationLat: null, locationLng: null, transport: 'walking', notes: '' });
            const locationSuggestions = ref([]);

            // Money
            const expenses = ref([]);
            const newExpense = ref({ desc: '', amount: '', currency: 'TWD', payer: '', category: 'é£Ÿ' });
            const editingBudget = ref(false);
            const tempBudget = ref(0);
            const customRates = ref({ 'JPY': 0.22, 'KRW': 0.024, 'USD': 32.5 });
            const showCalculator = ref(false);
            const calcDisplay = ref('0');
            const calcFormula = ref('');

            // Features
            const checklist = ref([]);
            const newCheckItem = ref('');
            const transSource = ref('zh-TW');
            const transTarget = ref('en');
            const transInput = ref('');
            const transResult = ref('');
            const weather = ref({ tempMax: null, tempMin: null, city: '', rain: 0 });
            const mapSearchQuery = ref('');

            // Listeners
            let itemsUnsub = null, expensesUnsub = null, checkUnsub = null, membersUnsub = null;

            // --- Computed ---
            const formatDate = (d) => d ? `${d.getMonth()+1}/${d.getDate()}` : '';
            
            const dayItems = computed(() => {
                if(!tripDays.value[selectedDayIndex.value]) return [];
                const target = formatDate(tripDays.value[selectedDayIndex.value]);
                return allItineraryItems.value.filter(i => i.dateStr === target).sort((a,b) => a.time.localeCompare(b.time));
            });

            // Budget
            const totalExpenseTwd = computed(() => expenses.value.reduce((acc, e) => acc + (e.amount * 1), 0)); // Simplified TWD for demo
            const remainingBudget = computed(() => (currentTrip.value.budget || 0) - totalExpenseTwd.value);
            const budgetPercent = computed(() => {
                const b = currentTrip.value.budget || 1;
                return Math.min(100, Math.round((totalExpenseTwd.value / b) * 100));
            });

            // Pie Chart
            const categoryTotals = computed(() => {
                const totals = {};
                expenses.value.forEach(e => {
                    totals[e.category || 'å…¶ä»–'] = (totals[e.category || 'å…¶ä»–'] || 0) + parseInt(e.amount);
                });
                return totals;
            });
            const pieGradient = computed(() => {
                const total = totalExpenseTwd.value || 1;
                let gradient = [];
                let currentDeg = 0;
                const colors = { 'é£Ÿ': '#FFB7B2', 'ä½': '#B5EAD7', 'è¡Œ': '#C7CEEA', 'æ¨‚': '#E2F0CB', 'è³¼': '#FFDAC1', 'å…¶ä»–': '#E0E0E0' };
                
                for(const [cat, amount] of Object.entries(categoryTotals.value)) {
                    const deg = (amount / total) * 360;
                    gradient.push(`${colors[cat] || '#ccc'} ${currentDeg}deg ${currentDeg + deg}deg`);
                    currentDeg += deg;
                }
                return gradient.join(', ');
            });
            const getCategoryColor = (cat) => ({ 'é£Ÿ': '#FFB7B2', 'ä½': '#B5EAD7', 'è¡Œ': '#C7CEEA', 'æ¨‚': '#E2F0CB', 'è³¼': '#FFDAC1', 'å…¶ä»–': '#E0E0E0' }[cat] || '#ccc');

            const userBalances = computed(() => {
                if(!currentTripMembers.value.length) return {};
                const bal = {};
                currentTripMembers.value.forEach(m => bal[m.uid] = 0);
                expenses.value.forEach(e => {
                    const amount = parseInt(e.amount);
                    const split = amount / currentTripMembers.value.length;
                    if(bal[e.payer] !== undefined) bal[e.payer] += amount;
                    currentTripMembers.value.forEach(m => bal[m.uid] -= split);
                });
                Object.keys(bal).forEach(k => bal[k] = Math.round(bal[k]));
                return bal;
            });

            // --- Methods ---
            const saveBudget = async () => {
                await updateDoc(doc(db, 'trips', currentTripId.value), { budget: tempBudget.value });
                currentTrip.value.budget = tempBudget.value;
                editingBudget.value = false;
            };

            // Map Routing (Visual Polyline)
            let map, routeLine;
            const initMap = () => { 
                nextTick(() => { 
                    if(!map && document.getElementById('map')) { 
                        map = L.map('map').setView([25.0330, 121.5654], 13); 
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'OSM' }).addTo(map); 
                    } else if (map) { map.invalidateSize(); } 
                    
                    // Clear old layers
                    map.eachLayer(layer => { if(layer instanceof L.Marker || layer instanceof L.Polyline) map.removeLayer(layer); });

                    const points = [];
                    dayItems.value.forEach(item => { 
                        if(item.locationLat) { 
                            const pt = [item.locationLat, item.locationLng];
                            points.push(pt);
                            L.marker(pt).addTo(map).bindPopup(`<b>${item.title}</b><br>${item.time}`); 
                        } 
                    });
                    
                    // Draw Route
                    if(points.length > 1) {
                        routeLine = L.polyline(points, {color: '#E05D5D', weight: 4, opacity: 0.7, dashArray: '5, 10'}).addTo(map);
                        map.fitBounds(routeLine.getBounds(), {padding: [50, 50]});
                    } else if(points.length === 1) {
                        map.setView(points[0], 15);
                    }
                }); 
            };

            // Weather Forecast
            const refreshWeather = async () => {
                const lat = dayItems.value[0]?.locationLat || 25.0330;
                const lng = dayItems.value[0]?.locationLng || 121.5654;
                const date = tripDays.value[selectedDayIndex.value];
                if(!date) return;
                
                const dateStr = date.toISOString().split('T')[0];
                try {
                    // Fetch Forecast for specific date
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&daily=temperature_2m_max,temperature_2m_min,rain_sum,weathercode&timezone=auto&start_date=${dateStr}&end_date=${dateStr}`);
                    const data = await res.json();
                    if(data.daily) {
                        weather.value = {
                            tempMax: data.daily.temperature_2m_max[0],
                            tempMin: data.daily.temperature_2m_min[0],
                            rain: data.daily.rain_sum[0],
                            city: dayItems.value[0]?.title || 'è¡Œç¨‹åœ°é»'
                        };
                    }
                } catch(e) { console.log("Weather fetch fail", e); }
            };

            // Calendar Export
            const downloadICS = () => {
                let icsContent = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//TravelBuddy//Pro//EN\n";
                dayItems.value.forEach(item => {
                    const d = tripDays.value[selectedDayIndex.value];
                    const dateStr = d.toISOString().replace(/-|:|\.\d\d\d/g, "").substring(0,8);
                    const timeStr = item.time.replace(':', '') + '00';
                    const dtStart = `${dateStr}T${timeStr}`;
                    const dtEnd = `${dateStr}T${parseInt(timeStr.substring(0,2))+1}${timeStr.substring(2)}`; // Assume 1 hour
                    
                    icsContent += `BEGIN:VEVENT\nSUMMARY:${item.title}\nDTSTART:${dtStart}\nDTEND:${dtEnd}\nLOCATION:${item.locationName||''}\nDESCRIPTION:${item.notes||''}\nEND:VEVENT\n`;
                });
                icsContent += "END:VCALENDAR";
                
                const blob = new Blob([icsContent], { type: 'text/calendar' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'trip_itinerary.ics';
                a.click();
            };

            // Checklist
            const addCheckItem = async () => { if(!newCheckItem.value) return; await addDoc(collection(db, `trips/${currentTripId.value}/checklist`), { text: newCheckItem.value, checked: false }); newCheckItem.value = ''; };
            const toggleCheck = async (item) => { await updateDoc(doc(db, `trips/${currentTripId.value}/checklist`, item.id), { checked: !item.checked }); };
            const deleteCheckItem = async (id) => { await deleteDoc(doc(db, `trips/${currentTripId.value}/checklist`, id)); };

            // -- Standard Functions (Same as before) --
            const openProfileEdit = () => { tempProfile.value = { ...userProfile.value }; editingProfile.value = true; };
            const saveProfile = async () => { if(!user.value || !tempProfile.value.name) return alert("è«‹è¼¸å…¥æš±ç¨±"); isProcessing.value = true; try { await withTimeout(setDoc(doc(db, 'users', user.value.uid), tempProfile.value, { merge: true })); userProfile.value = { ...tempProfile.value }; editingProfile.value = false; showForceProfileModal.value = false; } catch(e) { alert("å„²å­˜å¤±æ•—: " + e.message); } finally { isProcessing.value = false; } };
            const handleAvatarUpload = (e) => { const file = e.target.files[0]; if(file) { const reader = new FileReader(); reader.onload = (evt) => { const img = new Image(); img.onload = () => { const cvs = document.createElement('canvas'); const ctx = cvs.getContext('2d'); let w = img.width, h = img.height; if(w > 200) { h *= 200/w; w=200; } cvs.width=w; cvs.height=h; ctx.drawImage(img,0,0,w,h); tempProfile.value.avatar = cvs.toDataURL('image/jpeg', 0.7); }; img.src = evt.target.result; }; reader.readAsDataURL(file); } };
            const getUserName = (uid) => currentTripMembers.value.find(u => u.uid === uid)?.name || 'æœªçŸ¥';
            const getUserAvatar = (uid) => currentTripMembers.value.find(u => u.uid === uid)?.avatar || 'https://cdn-icons-png.flaticon.com/512/847/847969.png';
            
            const createTrip = async () => { 
                if(!newTripName.value) return alert("è«‹è¼¸å…¥åç¨±"); 
                isProcessing.value = true; 
                try { 
                    const tripRef = await withTimeout(addDoc(collection(db, 'trips'), { name: newTripName.value, createdBy: user.value.uid, members: [user.value.uid], createdAt: serverTimestamp(), startDate: new Date(newTripDate.value).toISOString(), budget: 0 })); 
                    await withTimeout(setDoc(doc(db, `users/${user.value.uid}/trips`, tripRef.id), { role: 'owner', joinedAt: serverTimestamp() })); 
                    showCreateTripModal.value = false; newTripName.value = ''; alert("å»ºç«‹æˆåŠŸï¼"); 
                } catch(e) { alert("å»ºç«‹å¤±æ•— (è«‹ç¢ºèªFirebaseè¦å‰‡è¨­ç‚ºTest Mode): " + e.message); } finally { isProcessing.value = false; } 
            };
            const joinTrip = async () => { if(!joinCode.value) return; try { const tripRef = doc(db, 'trips', joinCode.value); const tripSnap = await withTimeout(getDoc(tripRef)); if(tripSnap.exists()) { const data = tripSnap.data(); if(!data.members.includes(user.value.uid)) { await updateDoc(tripRef, { members: [...data.members, user.value.uid] }); await setDoc(doc(db, `users/${user.value.uid}/trips`, joinCode.value), { role: 'member', joinedAt: serverTimestamp() }); alert('æˆåŠŸåŠ å…¥ï¼'); } else { alert('å·²åœ¨è¡Œç¨‹ä¸­'); } } else { alert('æ‰¾ä¸åˆ°ä»£ç¢¼'); } } catch(e) { alert('åŠ å…¥å¤±æ•—'); } };
            const enterTrip = async (trip) => { currentTripId.value = trip.id; currentTrip.value = trip; tempBudget.value = trip.budget || 0; const start = new Date(trip.startDate); tripDays.value = [start, new Date(start.getTime()+86400000), new Date(start.getTime()+172800000)]; loadTripData(trip.id); };
            const exitTrip = () => { currentTripId.value = null; if(itemsUnsub) itemsUnsub(); if(expensesUnsub) expensesUnsub(); if(checkUnsub) checkUnsub(); if(membersUnsub) membersUnsub(); };
            const openTripSettings = () => { tempTripName.value = currentTrip.value.name; showTripSettings.value = true; };
            const updateTripName = async () => { if (!tempTripName.value) return; await updateDoc(doc(db, 'trips', currentTripId.value), { name: tempTripName.value }); currentTrip.value.name = tempTripName.value; showTripSettings.value = false; };
            
            const loadTripData = (tid) => {
                membersUnsub = onSnapshot(doc(db, 'trips', tid), async (snap) => { if(snap.exists()) { const mIds = snap.data().members; const promises = mIds.map(uid => getDoc(doc(db, 'users', uid))); const uSnaps = await Promise.all(promises); currentTripMembers.value = uSnaps.map(s => s.exists() ? {uid: s.id, ...s.data()} : {uid: s.id, name: 'æœªçŸ¥'}); } });
                itemsUnsub = onSnapshot(collection(db, `trips/${tid}/itinerary`), (snap) => { allItineraryItems.value = snap.docs.map(d => ({id: d.id, ...d.data()})); refreshWeather(); });
                expensesUnsub = onSnapshot(collection(db, `trips/${tid}/expenses`), (snap) => expenses.value = snap.docs.map(d => ({id: d.id, ...d.data()})));
                checkUnsub = onSnapshot(collection(db, `trips/${tid}/checklist`), (snap) => checklist.value = snap.docs.map(d => ({id: d.id, ...d.data()})));
            };

            const addDay = () => { const last = tripDays.value[tripDays.value.length-1]; tripDays.value.push(new Date(last.getTime()+86400000)); };
            const openAddItemModal = () => { newItem.value = { time: '09:00', title: '', searchQuery: '', transport: 'walking', notes: '' }; locationSuggestions.value = []; showAddItemModal.value = true; };
            const searchLocation = async (q) => { try { const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&addressdetails=1&limit=5`); locationSuggestions.value = await res.json(); } catch(e) {} };
            const selectLocation = (loc) => { newItem.value.searchQuery = loc.display_name; newItem.value.title = loc.name || loc.display_name.split(',')[0]; newItem.value.locationLat = loc.lat; newItem.value.locationLng = loc.lon; locationSuggestions.value = []; };
            const addItem = async () => { if(!newItem.value.title) return; await withTimeout(addDoc(collection(db, `trips/${currentTripId.value}/itinerary`), { ...newItem.value, dateStr: formatDate(tripDays.value[selectedDayIndex.value]), locationName: newItem.value.searchQuery })); showAddItemModal.value = false; };
            const deleteItem = async (id) => await deleteDoc(doc(db, `trips/${currentTripId.value}/itinerary`, id));
            const getTransportIcon = (type) => ({ 'car': 'fa-solid fa-car', 'train': 'fa-solid fa-train-subway', 'walking': 'fa-solid fa-person-walking' }[type] || '');
            
            const mapSearchQuery = ref('');
            const searchMapLocation = async () => { await searchLocation(mapSearchQuery.value); if(locationSuggestions.value.length > 0) { const loc = locationSuggestions.value[0]; map.setView([loc.lat, loc.lon], 16); L.marker([loc.lat, loc.lon]).addTo(map).bindPopup(loc.display_name).openPopup(); } };
            const openMapTo = (item) => { currentTab.value = 'map'; initMap(); setTimeout(() => { if(item.locationLat && map) { map.setView([item.locationLat, item.locationLng], 16); L.marker([item.locationLat, item.locationLng]).addTo(map).bindPopup(item.title).openPopup(); } }, 500); };

            const openCalculator = () => { showCalculator.value = true; calcDisplay.value = '0'; calcFormula.value = ''; };
            const calcAppend = (char) => { if(calcDisplay.value === '0' && !['+','-','*','/'].includes(char)) calcDisplay.value = ''; calcDisplay.value += char; };
            const calcBackspace = () => calcDisplay.value = calcDisplay.value.slice(0, -1) || '0';
            const calcClear = () => { calcDisplay.value = '0'; calcFormula.value = ''; };
            const calcEqual = () => { try { calcFormula.value = calcDisplay.value + ' ='; calcDisplay.value = Function('"use strict";return (' + calcDisplay.value + ')')().toString(); } catch(e) { calcDisplay.value = 'Error'; } };
            const confirmCalc = () => { newExpense.value.amount = calcDisplay.value; showCalculator.value = false; };
            const addExpense = async () => { if(!newExpense.value.amount) return; await addDoc(collection(db, `trips/${currentTripId.value}/expenses`), { ...newExpense.value, timestamp: serverTimestamp() }); newExpense.value.amount = ''; newExpense.value.desc = ''; };
            const deleteExpense = async (id) => await deleteDoc(doc(db, `trips/${currentTripId.value}/expenses`, id));

            const doTranslate = async () => { if(!transInput.value) return; transResult.value = 'ç¿»è­¯ä¸­...'; try { const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(transInput.value)}&langpair=${transSource.value}|${transTarget.value}`); const data = await res.json(); transResult.value = data.responseData.translatedText; } catch(e) { transResult.value = "å¿™ç¢Œä¸­"; } };

            onMounted(async () => {
                setTimeout(() => { if (loading.value) { showSlowLoadingHint.value = true; setTimeout(() => loading.value = false, 3000); } }, 5000);
                try { 
                    loadingStatus.value = "æ­£åœ¨é€£ç·šä¼ºæœå™¨...";
                    await signInAnonymously(auth); 
                    loadingStatus.value = "é©—è­‰æˆåŠŸï¼Œè®€å–è³‡æ–™ä¸­...";
                } catch(e) { 
                    console.error("Auth", e); 
                    errorMsg.value = "ç™»å…¥å¤±æ•—: " + e.message;
                    loading.value = false; 
                }
                
                onAuthStateChanged(auth, async (u) => {
                    if(u) {
                        user.value = u;
                        try { const pDoc = await getDoc(doc(db, 'users', u.uid)); if(pDoc.exists()) { userProfile.value = pDoc.data(); if(!userProfile.value.name || userProfile.value.name === 'æ–°ç”¨æˆ¶') { tempProfile.value = { ...userProfile.value }; showForceProfileModal.value = true; } } else { tempProfile.value = {name: '', avatar: ''}; showForceProfileModal.value = true; } } catch(e) {}
                        onSnapshot(collection(db, `users/${u.uid}/trips`), async (snap) => {
                            const tripIds = snap.docs.map(d => d.id);
                            if(tripIds.length) { const promises = tripIds.map(tid => getDoc(doc(db, 'trips', tid))); const results = await Promise.all(promises); myTrips.value = results.filter(r => r.exists()).map(r => ({id: r.id, ...r.data()})); } else { myTrips.value = []; }
                            loading.value = false;
                        }, (err) => {
                            console.error(err);
                            errorMsg.value = "è³‡æ–™è®€å–å¤±æ•— (è«‹æª¢æŸ¥æ¬Šé™): " + err.code;
                            loading.value = false;
                        });
                    } else loading.value = false;
                });
            });

            return {
                loading, loadingStatus, errorMsg, showSlowLoadingHint, isProcessing, user, userProfile, editingProfile, tempProfile, openProfileEdit, saveProfile, handleAvatarUpload, getUserName, getUserAvatar, showForceProfileModal,
                myTrips, currentTripId, currentTrip, createTrip, joinTrip, enterTrip, exitTrip, showCreateTripModal, newTripName, newTripDate, joinCode, showInvite, showTripSettings, openTripSettings, updateTripName, tempTripName, currentTripMembers,
                currentTab, tripDays, selectedDayIndex, formatDate, addDay, dayItems, showAddItemModal, newItem, openAddItemModal, locationSuggestions, searchLocation, selectLocation, addItem, deleteItem, getTransportIcon,
                mapSearchQuery, searchMapLocation, initMap, openMapTo, expenses, newExpense, addExpense, deleteExpense, userBalances, totalExpenseTwd, customRates, showCalculator, calcDisplay, calcFormula, openCalculator, calcAppend, calcBackspace, calcClear, calcEqual, confirmCalc,
                checklist, newCheckItem, addCheckItem, toggleCheck, deleteCheckItem, transSource, transTarget, transInput, transResult, doTranslate, weather, refreshWeather, categoryTotals, pieGradient, getCategoryColor, saveBudget, editingBudget, tempBudget, remainingBudget, budgetPercent, downloadICS
            };
        }
    }).mount('#app');
</script>
</body>
</html>
