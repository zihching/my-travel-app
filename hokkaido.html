<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ—æµ·é“ âœˆï¸</title>
    <style>
        :root {
            --primary: #FF9AA2; /* æ«»èŠ±ç²‰ */
            --primary-dark: #FF808A;
            --secondary: #B5EAD7; /* æ·ºç¶  */
            --accent: #FFDAC1; /* æè‰² */
            --text: #4A4A4A;
            --bg: #FFF9F9;
            --white: #ffffff;
            --gray: #f5f5f5;
            --warning: #FFF4E5;
            --warning-text: #B45309;
            --danger: #FEE2E2;
            --danger-text: #991B1B;
            --cold: #E0F2FE; /* å†°è—è‰² */
            --cold-text: #0369A1;
            --love: #FFF0F5; /* æˆ€æ„›ç²‰ */
            --love-text: #D63384;
            --money: #F0FDF4; /* é‡‘éŒ¢ç¶  */
            --money-text: #166534;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            line-height: 1.6;
            padding-bottom: 80px; /* Space for bottom nav */
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: var(--white);
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            padding-bottom: 20px;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--primary), #FFB7B2);
            padding: 20px;
            color: white;
            text-align: center;
            border-bottom-left-radius: 25px;
            border-bottom-right-radius: 25px;
            margin-bottom: 15px;
            position: relative;
        }

        h1 { margin: 0; font-size: 1.4rem; font-weight: 700; }
        .subtitle { font-size: 0.85rem; opacity: 0.95; margin-top: 5px; font-weight: bold; background: rgba(255,255,255,0.2); display: inline-block; padding: 2px 10px; border-radius: 10px;}
        
        .share-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 0.8rem;
            background: rgba(255,255,255,0.3);
            color: white;
            border: 1px solid rgba(255,255,255,0.6);
            padding: 4px 10px;
            border-radius: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .share-btn:active { background: rgba(255,255,255,0.5); }

        /* Navigation Tabs (Bottom Fixed) */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            z-index: 1000;
        }

        .nav-btn {
            background: none;
            border: none;
            color: #999;
            font-size: 0.75rem;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            width: 33%;
            cursor: pointer;
        }

        .nav-btn span { font-size: 1.2rem; }
        
        .nav-btn.active {
            color: var(--primary);
        }

        /* Views */
        .view { display: none; padding: 0 20px; animation: fadeIn 0.3s ease; }
        .view.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Checklist Styles --- */
        .progress-container {
            background: #eee;
            border-radius: 10px;
            height: 12px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .progress-bar {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.4s ease;
        }
        .progress-text {
            text-align: right; font-size: 0.85rem; color: var(--primary);
            font-weight: bold; margin-bottom: 15px;
        }
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        input[type="text"], input[type="number"] {
            flex: 1; padding: 12px; border: 2px solid #eee; border-radius: 12px;
            font-size: 1rem; outline: none;
        }
        input:focus { border-color: var(--primary); }
        button.add-btn {
            background: var(--primary); color: white; border: none; width: 45px;
            border-radius: 12px; font-size: 1.5rem; cursor: pointer;
        }
        button.add-btn:disabled { background: #ccc; cursor: not-allowed; }

        ul { list-style: none; padding: 0; }
        li {
            background: white; border: 1px solid #f5f5f5; margin-bottom: 8px;
            padding: 12px 15px; border-radius: 12px; display: flex;
            align-items: center; justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            transition: opacity 0.3s;
        }
        li.completed .text { text-decoration: line-through; color: #bbb; }
        .check-area { display: flex; align-items: center; gap: 12px; flex: 1; cursor: pointer; }
        .custom-checkbox {
            width: 22px; height: 22px; border: 2px solid var(--primary);
            border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;
            transition: all 0.2s;
        }
        li.completed .custom-checkbox { background: var(--primary); }
        li.completed .custom-checkbox::after { content: 'âœ“'; color: white; font-size: 14px; }
        .tag { font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; background: #eee; color: #666; margin-bottom: 4px; display: inline-block; }
        .tag.urgent { background: #FFB7B2; color: #fff; font-weight: bold; }
        .tag.money { background: #D1FAE5; color: #065F46; font-weight: bold; }
        .item-text-wrapper { display: flex; flex-direction: column; }
        .delete-btn { background: none; border: none; color: #eee; font-size: 1.5rem; padding: 0 10px; cursor: pointer; }
        .delete-btn:hover { color: var(--primary); }

        /* --- Guide Styles --- */
        details {
            background: white; border: 1px solid #eee; border-radius: 15px;
            margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.03);
            overflow: hidden; transition: all 0.3s;
        }
        details[open] { border-color: var(--secondary); box-shadow: 0 4px 12px rgba(181, 234, 215, 0.4); }
        summary {
            padding: 15px; font-weight: bold; font-size: 1.1rem; cursor: pointer;
            list-style: none; display: flex; align-items: center; justify-content: space-between;
            background: #fff;
        }
        summary::-webkit-details-marker { display: none; }
        summary::after { content: '+'; font-size: 1.5rem; color: var(--primary); font-weight: 300; }
        details[open] summary::after { content: '-'; }
        
        .step-content { padding: 20px; background: #fff; }
        .guide-step { position: relative; padding-left: 20px; margin-bottom: 15px; border-left: 2px solid #eee; }
        .guide-step strong { display: block; color: #333; margin-bottom: 4px; }
        .guide-step p { margin: 0; font-size: 0.95rem; color: #666; }
        .highlight-box { background: #FFF5F5; border-left: 4px solid var(--primary); padding: 10px; margin: 10px 0; font-size: 0.9rem; color: #555; border-radius: 4px; }
        .vjw-guide { background: #F0F7FF; padding: 15px; border-radius: 10px; margin-top: 10px; border: 1px solid #BEE3F8; }
        .price-guide { background: var(--money); color: var(--money-text); padding: 15px; border-radius: 10px; margin-top: 10px; font-size: 0.95rem; border: 1px solid #86EFAC; }
        .love-tip { background: var(--love); color: var(--love-text); padding: 15px; border-radius: 10px; margin-top: 10px; font-size: 0.95rem; border: 1px solid #F8B4D9; }
        .uniqlo-tip { border: 2px solid #E60012; color: #E60012; background: #fff; padding: 10px; border-radius: 8px; margin-top: 10px; font-weight: bold; font-size: 0.9rem; }
        .laundry-tip { background: #F0FFF4; border: 1px solid #C6F6D5; color: #2F855A; padding: 12px; border-radius: 8px; margin-top: 12px; font-size: 0.9rem; }

        .location-tip {
            background: #E0F2FE;
            border: 1px solid #7DD3FC;
            color: #0C4A6E;
            padding: 12px;
            border-radius: 8px;
            margin-top: 8px;
            font-size: 0.9rem;
        }
        
        .distance-tip {
            background: #FFFBEB;
            border: 1px solid #FCD34D;
            color: #B45309;
            padding: 12px;
            border-radius: 8px;
            margin-top: 8px;
            font-size: 0.9rem;
        }
        
        .hotel-recommendation {
            margin-top: 10px;
            font-size: 0.9rem;
            border-top: 1px dashed #ccc;
            padding-top: 8px;
        }
        .hotel-recommendation li {
            border: none;
            padding: 4px 0;
            box-shadow: none;
        }

        /* --- Expense Styles --- */
        .expense-card {
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
            padding: 20px;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
            text-align: center;
        }
        .expense-result { font-size: 1.5rem; font-weight: bold; margin: 10px 0; }
        .expense-detail { font-size: 0.9rem; opacity: 0.9; display: flex; justify-content: space-around; margin-top: 10px; }
        
        .expense-form {
            background: white; border: 1px solid #eee; padding: 15px;
            border-radius: 15px; margin-bottom: 20px;
            display: flex; flex-direction: column; gap: 10px;
        }
        .form-row { display: flex; gap: 10px; }
        .payer-select {
            display: flex; gap: 10px;
        }
        .radio-label {
            flex: 1; text-align: center; padding: 10px;
            border: 1px solid #ddd; border-radius: 10px; cursor: pointer;
            font-weight: bold; color: #666; font-size: 0.9rem;
        }
        input[type="radio"] { display: none; }
        input[type="radio"]:checked + .radio-label {
            background: var(--primary); color: white; border-color: var(--primary);
        }

        .expense-list li {
            display: flex; justify-content: space-between; align-items: center;
        }
        .expense-info { flex: 1; }
        .expense-amt { font-weight: bold; color: #333; }
        .expense-payer { font-size: 0.8rem; padding: 2px 6px; border-radius: 4px; margin-right: 8px; }
        .payer-me { background: #FFB7B2; color: #fff; }
        .payer-sis { background: #B5EAD7; color: #065F46; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal { background: white; padding: 25px; border-radius: 15px; width: 80%; max-width: 320px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal h3 { color: var(--primary); margin-top: 0;}
        .modal-btns { display: flex; gap: 10px; margin-top: 20px; }
        .btn { padding: 10px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; flex: 1; }
        .btn-confirm { background: var(--primary); color: white; }
        .btn-cancel { background: #eee; color: #666; }

        .reset-btn { color: #999; background: none; border: 1px solid #ddd; padding: 8px 16px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; margin-top: 30px; display: block; margin-left: auto; margin-right: auto;}
        
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 3000;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            color: var(--primary);
        }

    </style>
</head>
<body>

<div id="loadingOverlay">
    <h2>â˜ï¸ é›²ç«¯åŒæ­¥ä¸­...</h2>
</div>

<!-- Trip Code Modal (First Load) -->
<div id="tripCodeModal" class="modal-overlay" style="display:flex;">
    <div class="modal">
        <h3>ğŸ”— å»ºç«‹æ—…ä¼´é€£ç·š</h3>
        <p style="font-size:0.9rem; color:#666; margin-bottom:15px;">é€™æ˜¯å¦³è·Ÿå¦¹å¦¹çš„å°ˆå±¬æˆ¿é–“ï¼Œä¸ç”¨è¨˜å¯†ç¢¼ï¼ŒæŠŠç¶²å€å‚³çµ¦å¥¹å°±å¥½ï¼</p>
        <input type="text" id="tripCodeInput" value="1025" style="width:100%; margin-bottom:15px; text-align:center; font-weight:bold; color: #4A4A4A; font-size: 1.2rem;">
        <button class="btn btn-confirm" onclick="setTripCode()">ğŸš€ é–‹å§‹è¦åŠƒ</button>
    </div>
</div>

<div class="container">
    <header>
        <h1>âœˆï¸ åŒ—æµ·é“ (å§Šå¦¹æ—…è¡Œ)</h1>
        <div class="subtitle">1/20 (ä¸€) ~ 1/25 (å…­) | 6å¤©5å¤œ</div>
        <button class="share-btn" onclick="shareLink()">
            ğŸ”— å‚³çµ¦å¦¹å¦¹
        </button>
    </header>

    <!-- View 1: Checklist -->
    <div id="view-checklist" class="view active">
        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        <div class="progress-text" id="progressText">æº–å‚™é€²åº¦ï¼š0%</div>

        <div class="input-group">
            <input type="text" id="itemInput" placeholder="æ–°å¢å¾…è¾¦äº‹é …...">
            <button class="add-btn" id="addBtn">+</button>
        </div>

        <ul id="itemList"></ul>
        <button class="reset-btn" onclick="showResetModal()">âš ï¸ é‡ç½®æ¸…å–®</button>
    </div>

    <!-- View 2: Guide -->
    <div id="view-guide" class="view">
        <p style="text-align: center; color: #666; font-size: 0.9rem; margin-bottom: 20px;">ğŸ‘‡ é»æ“Šæ¨™é¡Œå±•é–‹æ­¥é©Ÿ ğŸ‘‡</p>

        <!-- Stage 1 -->
        <details open>
            <summary>ç¬¬ 1 éšæ®µï¼šæ©Ÿç¥¨ & ä½å®¿ (å…¨éƒ¨æå®š!)</summary>
            <div class="step-content">
                <div class="guide-step">
                    <strong>1. æ©Ÿç¥¨å·²ç¢ºèªï¼(1/20å‡ºç™¼)</strong>
                    <p>å»ç¨‹é•·æ¦® + å›ç¨‹é…·èˆªã€‚</p>
                    <div class="price-guide">
                        <strong>ğŸ’° ç¸½é‡‘é¡è¨˜å¸³ï¼š</strong><br>
                        æ©Ÿç¥¨+ä½å®¿å¦³å…ˆåˆ·äº†ï¼š<br>
                        <span style="font-size:1.2rem; font-weight:bold; color:#059669;">$47,911</span><br>
                        ğŸ‘‰ å¦¹å¦¹æ¯äººæ‡‰ä»˜ï¼š$23,956
                    </div>
                </div>
                
                <div class="love-tip" style="background:#F0F9FF; border-color:#BAE6FD; color:#0369A1;">
                    <strong>ğŸ¨ ä½å®¿æ‹¼åœ– (å…¨ç ´é—œ!)</strong><br>
                    <div class="location-tip">
                        âœ… <strong>1/20ï¼šLivemax Sapporo Ekimae</strong><br>
                        (é›¢è»Šç«™èµ°è·¯ç´„ 10 åˆ†ï¼Œè¨˜å¾—èµ°åœ°ä¸‹é“)<br>
                        âœ… <strong>1/21~23ï¼šæ˜Ÿé‡ Resonare</strong> (èœ‚èœœè¨‚)<br>
                        âœ… <strong>1/23~25ï¼šSapporo Stripe Residence</strong><br>
                        (æ¢ç´‹ä½å®…é£¯åº—ï¼Œæˆ¿é–“å¤§ã€é©åˆæ•´ç†è¡Œæï¼)<br>
                    </div>
                </div>
                
                <div class="guide-step">
                    <strong>3. å¡«å¯« VJW (åœ°å€å‚™å¿˜éŒ„)</strong>
                    <ul style="padding-left:20px; font-size:0.9rem;">
                        <li><strong>ç¬¬ä¸€æ™šï¼š</strong>Hotel Livemax Sapporo Ekimae</li>
                        <li><strong>æœ€å¾Œå…©æ™šï¼š</strong>Sapporo Stripe Residence Hotel</li>
                    </ul>
                </div>
            </div>
        </details>

        <!-- Stage 2 -->
        <details>
            <summary>ç¬¬ 2 éšæ®µï¼šè¡Œæ (å§Šå¦¹æ¸›é‡ç‰ˆ)</summary>
            <div class="step-content">
                <div class="love-tip">
                    <strong>ğŸ’– èœ‚èœœè²·å–®ï¼è¡Œæç®±ç•™ç©ºï¼</strong><br>
                    å»ç¨‹ç©¿è‘—ã€ŒåŠ çµ¨æ£‰è¤²ã€æœ€èˆ’æœï¼
                </div>
                <div class="highlight-box">
                    ğŸ’¡ å‡ºç™¼ç©¿æ­ï¼šç™¼ç†±è¡£+è¡›è¡£+ç¾½çµ¨å¤–å¥—+æ£‰è¤²+é›ªé´ã€‚
                </div>
                <div class="guide-step">
                    <strong>å¿…å‚™è¡£ç‰©ï¼š</strong>
                    <p>é•·ç‰ˆç¾½çµ¨å¤–å¥—x1ã€é˜²æ»‘é›ªé´x1ã€æ¯›è¡£x2ã€äº®è‰²åœå·¾x1ã€æ¯›å¸½æ‰‹å¥—ã€‚</p>
                    <div class="uniqlo-tip">
                        ğŸ”¥ å¿…è²·ï¼šUniqloã€Œè¶…æ¥µæš– (Ultra Warm)ã€ç™¼ç†±è¡£+è¤²å„ä¸€ä»¶ï¼
                    </div>
                    <div class="laundry-tip">
                        ğŸ’¡ <strong>ä¸æ´—è¡£æœå¤§æ³•ï¼š</strong><br>
                        ç™¼ç†±è¤²å…§ç©¿ä¸€èˆ¬å…§è¤²ï¼Œ5å¤©ä¸ç”¨æ´—ã€‚
                    </div>
                </div>
            </div>
        </details>

        <!-- Stage 3-5 -->
        <details>
            <summary>ç¬¬ 3-5 éšæ®µï¼šå‡ºç™¼èˆ‡å›ç¨‹</summary>
            <div class="step-content">
                <div class="guide-step">
                    <strong>1/20 å‡ºç™¼ (09:30 èµ·é£›)</strong>
                    <p>å»ºè­° 07:00 åˆ°æ¡ƒåœ’æ©Ÿå ´ã€‚</p>
                </div>
                <div class="guide-step">
                    <strong>1/25 å›ç¨‹ (é…·èˆª)</strong>
                    <p>è¨˜å¾—è¨—é‹é¡åº¦è¦è²·å¤ è£æˆ°åˆ©å“ï¼</p>
                </div>
            </div>
        </details>
    </div>

    <!-- View 3: Expenses -->
    <div id="view-expenses" class="view">
        <div class="expense-card">
            <div>ç›®å‰çš„çµç®—</div>
            <div class="expense-result" id="settlementText">è¨ˆç®—ä¸­...</div>
            <div class="expense-detail">
                <span>æˆ‘ä»˜äº†: $<span id="totalMe">0</span></span>
                <span>å¦¹ä»˜äº†: $<span id="totalSis">0</span></span>
            </div>
        </div>

        <div class="expense-form">
            <input type="text" id="expName" placeholder="é …ç›® (ä¾‹å¦‚: æ©Ÿç¥¨ã€æ™šé¤)">
            <input type="number" id="expCost" placeholder="é‡‘é¡ (NTD)">
            <div class="payer-select">
                <input type="radio" name="payer" id="payMe" value="me" checked>
                <label class="radio-label" for="payMe">æˆ‘å…ˆä»˜</label>
                
                <input type="radio" name="payer" id="paySis" value="sis">
                <label class="radio-label" for="paySis">å¦¹å¦¹å…ˆä»˜</label>
            </div>
            <button class="add-btn" onclick="addExpense()" style="width:100%; font-size:1rem; padding:10px;">ï¼‹ æ–°å¢æ”¯å‡º</button>
        </div>

        <ul id="expenseList" class="expense-list">
            <!-- Expenses injected here -->
        </ul>
    </div>

    <!-- Bottom Nav -->
    <div class="bottom-nav">
        <button class="nav-btn active" onclick="switchTab('checklist')">
            <span>âœ…</span> æ¸…å–®
        </button>
        <button class="nav-btn" onclick="switchTab('guide')">
            <span>ğŸ“˜</span> æ”»ç•¥
        </button>
        <button class="nav-btn" onclick="switchTab('expenses')">
            <span>ğŸ’¸</span> åˆ†å¸³
        </button>
    </div>

</div>

<!-- Reset Modal -->
<div id="confirmModal" class="modal-overlay">
    <div class="modal">
        <h3>âš ï¸ ç¢ºå®šé‡ç½®ï¼Ÿ</h3>
        <p style="color:#666; font-size: 0.9rem; margin-bottom: 20px;">é€™æœƒåˆªé™¤æ‰€æœ‰ç´€éŒ„ (åŒ…å«åˆ†å¸³)ï¼</p>
        <div class="modal-btns">
            <button class="btn btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
            <button class="btn btn-confirm" onclick="confirmReset()">ç¢ºå®šé‡ç½®</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDFUGYOobmVxYFQMBYz1iQ4z1HIrdbTi8Q",
        authDomain: "travel-55c4b.firebaseapp.com",
        databaseURL: "https://travel-55c4b-default-rtdb.firebaseio.com",
        projectId: "travel-55c4b",
        storageBucket: "travel-55c4b.firebasestorage.app",
        messagingSenderId: "925227625640",
        appId: "1:925227625640:web:7966e45422a9979ff8a69d",
        measurementId: "G-N5V8NBGEHZ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let tripId = null;
    let currentUser = null;

    // Check for ID in URL
    const urlParams = new URLSearchParams(window.location.search);
    const idFromUrl = urlParams.get('id');

    // DOM Elements
    const views = {
        checklist: document.getElementById('view-checklist'),
        guide: document.getElementById('view-guide'),
        expenses: document.getElementById('view-expenses')
    };
    const navBtns = document.querySelectorAll('.nav-btn');
    const itemList = document.getElementById('itemList');
    const expenseList = document.getElementById('expenseList');
    const itemInput = document.getElementById('itemInput');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const tripCodeModal = document.getElementById('tripCodeModal');
    const tripCodeInput = document.getElementById('tripCodeInput');

    // Default Items
    const defaultData = [
        { text: "è·Ÿå¦¹å¦¹æ”¶éŒ¢ (æ©Ÿ+é…’å…± $23,956)", done: false, cat: "è¨˜å¸³", class: "money" },
        { text: "1/20 ä½å®¿å·²è¨‚ (Livemax)", done: true, cat: "æœ€å„ªå…ˆ" },
        { text: "1/23~25 ä½å®¿å·²è¨‚ (Stripe)", done: true, cat: "æœ€å„ªå…ˆ" },
        { text: "ä¿®æ”¹ VJW è³‡æ–™ (å¦¹å¦¹ä¹Ÿè¦å¡«)", done: false, cat: "å¿…å‚™" },
        { text: "æª¢æŸ¥è­·ç…§æ•ˆæœŸ (2æœ¬)", done: false, cat: "å¿…å‚™" },
        { text: "å…æ´—å…§è¤²/ä¸€èˆ¬å…§è¤²", done: false, cat: "å¿…å‚™" },
        { text: "æˆªåœ–ï¼šæ©Ÿç¥¨ã€é£¯åº—", done: false, cat: "å¿…å‚™" },
        { text: "è²·ç¶²å¡ (2äººä»½)", done: false, cat: "ç¶²è·¯" },
        { text: "ç™¼ç†±è¤² (Uniqloè¶…æ¥µæš–)", done: false, cat: "è¡£ç‰©" },
        { text: "ç™¼ç†±è¡£ (Uniqloè¶…æ¥µæš–)", done: false, cat: "è¡£ç‰©" },
        { text: "åŠ çµ¨æ£‰è¤² (ç©¿è‘—å»)", done: false, cat: "è¡£ç‰©" },
        { text: "äº®è‰²åœå·¾", done: false, cat: "è¡£ç‰©" },
        { text: "ç¾½çµ¨å¤–å¥—", done: false, cat: "è¡£ç‰©" },
        { text: "é˜²æ°´é›ªé´", done: false, cat: "è¡£ç‰©" },
        { text: "æ¯›å¸½ã€æ‰‹å¥—", done: false, cat: "è¡£ç‰©" },
        { text: "èº«é«”ä¹³æ¶²ã€è­·å”‡è†", done: false, cat: "ä¿é¤Š" },
        { text: "è¡Œå‹•é›»æº", done: false, cat: "éš¨èº«" },
        { text: "æ„Ÿå†’è—¥/æ­¢ç—›è—¥", done: false, cat: "éš¨èº«" }
    ];

    // Auth & Init
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            
            // Priority: URL > LocalStorage > Modal
            if (idFromUrl) {
                // If URL has ID, use it and save it
                localStorage.setItem('hokkaidoTripId', idFromUrl);
                initTrip(idFromUrl);
            } else {
                const storedId = localStorage.getItem('hokkaidoTripId');
                if (storedId) {
                    initTrip(storedId);
                } else {
                    // No ID found, show modal to create/enter one
                    loadingOverlay.style.display = 'none';
                    tripCodeModal.style.display = 'flex';
                }
            }
        } else {
            signInAnonymously(auth).catch(e => alert("é€£ç·šå¤±æ•—: " + e.message));
        }
    });

    window.setTripCode = function() {
        const code = tripCodeInput.value.trim();
        if(!code) return alert("è«‹è¼¸å…¥é€£ç·šç¢¼");
        localStorage.setItem('hokkaidoTripId', code);
        
        // Update URL safely with try-catch for sandbox environments
        try {
            const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?id=' + code;
            window.history.pushState({path:newUrl},'',newUrl);
        } catch (e) {
            console.log("History API not supported in this environment");
        }
        
        tripCodeModal.style.display = 'none';
        loadingOverlay.style.display = 'flex';
        initTrip(code);
    }
    
    window.shareLink = function() {
        if(!tripId) return;
        const url = window.location.href.split('?')[0] + '?id=' + tripId; // Construct URL manually
        
        // Try native share
        if (navigator.share) {
            navigator.share({
                title: 'åŒ—æµ·é“ä¹‹æ—…',
                text: 'é€™æ˜¯æˆ‘æ•´ç†çš„æ¸…å–®è·Ÿè¨˜å¸³ï¼Œé»é–‹å°±å¯ä»¥çœ‹å›‰ï¼',
                url: url
            }).catch(console.error);
        } else {
            // Fallback to clipboard
            const tempInput = document.createElement("input");
            tempInput.value = url;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand("copy");
            document.body.removeChild(tempInput);
            alert("ç¶²å€å·²è¤‡è£½ï¼è²¼çµ¦å¦¹å¦¹å°±å¯ä»¥å›‰ â¤ï¸");
        }
    }

    function initTrip(id) {
        tripId = id;
        
        // Try to update URL history if possible, silence error if blocked
        try {
            if (!window.location.search.includes(id)) {
                 const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?id=' + id;
                 window.history.replaceState({path:newUrl},'',newUrl);
            }
        } catch(e) {
            console.log("History API not supported in this environment");
        }

        // Checklist Listener
        const qCheck = query(collection(db, 'trips', id, 'checklist'), orderBy('createdAt', 'desc'));
        onSnapshot(qCheck, (snapshot) => {
            const items = [];
            snapshot.forEach(doc => items.push({id: doc.id, ...doc.data()}));
            if (items.length === 0 && !snapshot.metadata.hasPendingWrites) {
                loadDefaults(id);
            } else {
                renderList(items);
                loadingOverlay.style.display = 'none';
                tripCodeModal.style.display = 'none';
            }
        });

        // Expense Listener
        const qExp = query(collection(db, 'trips', id, 'expenses'), orderBy('createdAt', 'desc'));
        onSnapshot(qExp, (snapshot) => {
            const exps = [];
            snapshot.forEach(doc => exps.push({id: doc.id, ...doc.data()}));
            renderExpenses(exps);
        });
    }

    async function loadDefaults(id) {
        const batch = writeBatch(db);
        defaultData.forEach(item => {
            const docRef = doc(collection(db, 'trips', id, 'checklist'));
            batch.set(docRef, { ...item, createdAt: serverTimestamp() });
        });
        
        // Expenses
        const expRef1 = doc(collection(db, 'trips', id, 'expenses'));
        batch.set(expRef1, {
            name: "æ©Ÿç¥¨ (2äººä»½)",
            cost: 41042,
            payer: "me",
            createdAt: serverTimestamp()
        });
        const expRef2 = doc(collection(db, 'trips', id, 'expenses'));
        batch.set(expRef2, {
            name: "ä½å®¿ (Livemax 1/20)",
            cost: 1714,
            payer: "me",
            createdAt: serverTimestamp()
        });
        const expRef3 = doc(collection(db, 'trips', id, 'expenses'));
        batch.set(expRef3, {
            name: "ä½å®¿ (Stripe 1/23-25)",
            cost: 5155,
            payer: "me",
            createdAt: serverTimestamp()
        });

        await batch.commit();
    }

    // --- Checklist Logic ---
    function renderList(items) {
        itemList.innerHTML = '';
        let completed = 0;
        items.forEach(item => {
            if(item.done) completed++;
            const li = document.createElement('li');
            li.className = item.done ? 'completed' : '';
            
            // Check for special class
            const tagClass = item.class ? item.class : (item.cat === 'æœ€å„ªå…ˆ' ? 'urgent' : '');
            
            li.innerHTML = `
                <div class="check-area" onclick="toggleItem('${item.id}', ${item.done})">
                    <div class="custom-checkbox"></div>
                    <div class="item-text-wrapper">
                        ${item.cat ? `<span class="tag ${tagClass}">${item.cat}</span>` : ''}
                        <span class="text">${item.text}</span>
                    </div>
                </div>
                <button class="delete-btn" onclick="deleteItem('${item.id}', 'checklist')">Ã—</button>
            `;
            itemList.appendChild(li);
        });
        const percent = items.length ? Math.round((completed/items.length)*100) : 0;
        document.getElementById('progressBar').style.width = percent + '%';
        document.getElementById('progressText').innerText = `æº–å‚™é€²åº¦ï¼š${percent}%`;
    }

    // --- Expense Logic ---
    function renderExpenses(exps) {
        expenseList.innerHTML = '';
        let totalMe = 0;
        let totalSis = 0;

        exps.forEach(exp => {
            const cost = parseFloat(exp.cost);
            if(exp.payer === 'me') totalMe += cost;
            else totalSis += cost;

            const li = document.createElement('li');
            li.innerHTML = `
                <div class="expense-info">
                    <span class="expense-payer ${exp.payer==='me'?'payer-me':'payer-sis'}">${exp.payer==='me'?'æˆ‘':'å¦¹'}</span>
                    <span>${exp.name}</span>
                </div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <span class="expense-amt">$${cost.toLocaleString()}</span>
                    <button class="delete-btn" style="color:#ccc; font-size:1.2rem;" onclick="deleteItem('${exp.id}', 'expenses')">Ã—</button>
                </div>
            `;
            expenseList.appendChild(li);
        });

        document.getElementById('totalMe').innerText = totalMe.toLocaleString();
        document.getElementById('totalSis').innerText = totalSis.toLocaleString();

        const total = totalMe + totalSis;
        const half = total / 2;
        const diff = totalMe - half; // If positive, Sister owes Me.

        const resultEl = document.getElementById('settlementText');
        if (Math.abs(diff) < 1) {
            resultEl.innerText = "ç›®å‰å¹³æ‰‹ï¼";
        } else if (diff > 0) {
            resultEl.innerText = `å¦¹ â” çµ¦å¦³ $${Math.floor(diff).toLocaleString()}`;
        } else {
            resultEl.innerText = `å¦³ â” çµ¦å¦¹ $${Math.floor(Math.abs(diff)).toLocaleString()}`;
        }
    }

    window.addExpense = async () => {
        const name = document.getElementById('expName').value.trim();
        const cost = parseFloat(document.getElementById('expCost').value);
        const payer = document.querySelector('input[name="payer"]:checked').value;

        if(name && cost) {
            await addDoc(collection(db, 'trips', tripId, 'expenses'), {
                name, cost, payer, createdAt: serverTimestamp()
            });
            document.getElementById('expName').value = '';
            document.getElementById('expCost').value = '';
        } else {
            alert("è«‹è¼¸å…¥é …ç›®å’Œé‡‘é¡");
        }
    }

    // --- Shared Actions ---
    window.toggleItem = async (id, status) => {
        await updateDoc(doc(db, 'trips', tripId, 'checklist', id), { done: !status });
    }

    window.deleteItem = async (id, col) => {
        if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) {
            await deleteDoc(doc(db, 'trips', tripId, col, id));
        }
    }

    document.getElementById('addBtn').addEventListener('click', async () => {
        const text = itemInput.value.trim();
        if(text) {
            await addDoc(collection(db, 'trips', tripId, 'checklist'), {
                text, done: false, cat: 'æ–°å¢', createdAt: serverTimestamp()
            });
            itemInput.value = '';
        }
    });

    // --- UI Logic ---
    window.switchTab = function(tabName) {
        Object.values(views).forEach(el => el.classList.remove('active'));
        navBtns.forEach(el => el.classList.remove('active'));
        
        views[tabName].classList.add('active');
        // Find index
        const idx = ['checklist', 'guide', 'expenses'].indexOf(tabName);
        if(idx !== -1) navBtns[idx].classList.add('active');
    }

    window.showResetModal = () => document.getElementById('confirmModal').style.display = 'flex';
    window.closeModal = () => document.getElementById('confirmModal').style.display = 'none';
    
    window.confirmReset = async () => {
        closeModal();
        loadingOverlay.style.display = 'flex';
        // Delete checklist
        const q1 = await getDocs(collection(db, 'trips', tripId, 'checklist'));
        q1.forEach(d => deleteDoc(d.ref));
        // Delete expenses
        const q2 = await getDocs(collection(db, 'trips', tripId, 'expenses'));
        q2.forEach(d => deleteDoc(d.ref));
        
        // Reload will happen via snapshot listener (empty array -> load defaults)
    }

    // Enter key for inputs
    itemInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') document.getElementById('addBtn').click(); });

</script>
</body>
</html>
