<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>åŒ—æµ·é“ âœˆï¸ (å§Šå¦¹æ‹¿éµç‰ˆ)</title>
    
    <!-- å¼•å…¥å¯æ„›åœ“æ½¤å­—é«” -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            /* â˜•ï¸ æ·ºæ‹¿éµé…è‰²ç›¤ */
            --primary: #BCAAA4;       /* æ·ºæ‹¿éµ */
            --primary-dark: #8D6E63;  /* æ‘©å¡æ£• */
            --accent: #E6D8CC;        /* ç‡•éº¥å¥¶ */
            --text: #5D4037;          /* æ¿ƒç¸®å’–å•¡æ–‡å­— */
            --bg: #FDFBF7;            /* ç‡•éº¥å¥¶èƒŒæ™¯ */
            --white: #ffffff;
            --border: #EFEBE9;
            
            /* åŠŸèƒ½æ¨™ç±¤è‰² */
            --tag-urgent: #FFEBEE; --text-urgent: #C62828;
            --tag-money: #E8F5E9; --text-money: #2E7D32;
            --tag-shop: #FFF8E1; --text-shop: #F57F17;
            --tag-info: #E3F2FD; --text-info: #1565C0;
            --tag-gift: #F3E5F5; --text-gift: #7B1FA2;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: "æ–‡é¼DCé¦™è•‰äººé«”", "Zen Maru Gothic", "Microsoft JhengHei", sans-serif;
            background-color: var(--bg);
            background-image: 
                linear-gradient(rgba(141, 110, 99, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(141, 110, 99, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            color: var(--text);
            margin: 0;
            padding: 0;
            line-height: 1.6;
            padding-bottom: 100px;
            font-weight: 500;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            min-height: 100vh;
        }

        /* --- Header --- */
        header {
            background: linear-gradient(135deg, #D7CCC8 0%, #F5F5F5 100%);
            padding: 30px 25px 40px;
            border-bottom-left-radius: 40px;
            border-bottom-right-radius: 40px;
            box-shadow: 0 10px 20px rgba(141, 110, 99, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 10;
        }

        .header-left h1 { 
            margin: 0; font-size: 1.5rem; font-weight: 900; color: var(--text); letter-spacing: 1px;
            text-shadow: 2px 2px 0px rgba(255,255,255,0.8);
        }
        .header-left .subtitle { 
            font-size: 0.85rem; color: #8D6E63; margin-top: 5px; font-weight: 700;
            background: rgba(255,255,255,0.6); padding: 4px 12px; border-radius: 20px; display: inline-block;
        }
        
        .share-btn {
            font-size: 0.85rem;
            background: var(--white);
            color: var(--primary-dark);
            border: 2px solid rgba(141, 110, 99, 0.1);
            padding: 8px 16px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 800;
            box-shadow: 0 4px 10px rgba(141, 110, 99, 0.1);
            font-family: inherit;
        }

        /* --- Navigation Tabs --- */
        .bottom-nav {
            position: fixed;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 500px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-between;
            padding: 10px 25px;
            border-radius: 60px;
            box-shadow: 0 10px 40px rgba(93, 64, 55, 0.15);
            z-index: 1000;
            border: 1px solid #EFEBE9;
        }

        .nav-btn {
            background: none;
            border: none;
            color: #D7CCC8;
            font-size: 0.75rem;
            font-family: inherit;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            cursor: pointer;
            width: 50px;
            transition: all 0.3s;
            font-weight: 700;
        }

        .nav-btn span { font-size: 1.4rem; transition: transform 0.2s; }
        .nav-btn.active { color: var(--primary-dark); }
        .nav-btn.active span { transform: translateY(-4px); }
        .nav-btn.active::after {
            content: ''; display: block; width: 6px; height: 6px; background: var(--primary-dark); border-radius: 50%; margin-top: 2px;
        }

        /* --- Views --- */
        .view { display: none; padding: 20px; animation: fadeIn 0.5s ease; }
        .view.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Common Components --- */
        .card, details, .expense-card {
            background: var(--white);
            border-radius: 24px;
            padding: 20px;
            margin-bottom: 20px;
            border: none;
            box-shadow: 0 8px 20px rgba(141, 110, 99, 0.06);
        }

        .tip-card {
            background: white; border-radius: 16px; padding: 15px; margin-bottom: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.03); border: 1px solid #EFEBE9;
            position: relative; overflow: hidden;
        }
        .tip-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 5px; }
        .tip-card.info::before { background: var(--text-info); }
        .tip-card.shop::before { background: var(--text-shop); }
        .tip-card.gift::before { background: var(--text-gift); }
        .tip-card.money::before { background: var(--text-money); }
        
        .tip-title { font-weight: 800; font-size: 1rem; margin-bottom: 5px; display: block; }
        .tip-content { font-size: 0.9rem; color: #666; }

        /* --- Tab 1: Checklist --- */
        .progress-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 10px; padding: 0 5px; }
        .progress-title { font-size: 1.2rem; font-weight: 800; color: var(--text); }
        .progress-text { font-size: 0.9rem; color: var(--primary-dark); font-weight: 800; }
        .progress-bar-bg { background: #EFEBE9; height: 12px; border-radius: 6px; overflow: hidden; margin-bottom: 25px; }
        .progress-bar { height: 100%; background: var(--primary-dark); width: 0%; transition: width 0.6s ease-out; border-radius: 6px; }
        
        .input-group { display: flex; gap: 10px; margin-bottom: 25px; }
        input { 
            flex: 1; padding: 14px 20px; border: 2px solid #EFEBE9; border-radius: 50px; 
            font-size: 1rem; outline: none; background: #FFF; transition: all 0.3s;
            color: var(--text); font-family: inherit; font-weight: 600;
        }
        input:focus { border-color: var(--primary); background: white; box-shadow: 0 4px 10px rgba(188, 170, 164, 0.15); }
        
        button.add-btn { 
            background: var(--primary-dark); color: white; border: none; width: 52px; height: 52px; 
            border-radius: 50%; font-size: 1.6rem; cursor: pointer; 
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 6px 15px rgba(141, 110, 99, 0.3);
        }
        
        ul { list-style: none; padding: 0; }
        li.todo-item {
            background: var(--white); border-radius: 20px; padding: 16px 20px; margin-bottom: 12px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 4px 10px rgba(141, 110, 99, 0.03); transition: all 0.2s;
            border: 2px solid transparent;
        }
        .check-area { display: flex; align-items: center; gap: 15px; flex: 1; cursor: pointer; }
        .checkbox {
            width: 24px; height: 24px; border: 2px solid #D7CCC8;
            border-radius: 8px; display: flex; align-items: center; justify-content: center;
            flex-shrink: 0; background: white; transition: all 0.2s;
        }
        li.todo-item.completed .checkbox { background: var(--primary-dark); border-color: var(--primary-dark); }
        li.todo-item.completed .checkbox::after { content: 'âœ”'; color: white; font-size: 14px; }
        li.todo-item.completed span { color: #D7CCC8; text-decoration: line-through; }
        .delete-btn { background: none; border: none; color: #E0E0E0; font-size: 1.4rem; cursor: pointer; }
        
        .tag { font-size: 0.75rem; padding: 4px 12px; border-radius: 12px; margin-bottom: 4px; display: inline-block; font-weight: 800; letter-spacing: 0.5px; }
        .tag.urgent { background: var(--tag-urgent); color: var(--text-urgent); }
        .tag.money { background: var(--tag-money); color: var(--text-money); }
        .tag.gift { background: var(--tag-gift); color: var(--text-gift); }
        .tag.gear { background: #F5F5F5; color: #616161; }

        /* --- Memo Section --- */
        .memo-section {
            background: white; border: 2px dashed #EFEBE9; border-radius: 20px; padding: 20px; margin-top: 20px;
        }
        .memo-area {
            width: 100%; height: 100px; border: none; background: #FAFAFA; border-radius: 15px; padding: 15px;
            font-size: 0.95rem; line-height: 1.5; color: #666; resize: none; outline: none; font-family: inherit;
        }

        /* --- Accordion (Guide) --- */
        details { 
            background: white; border: 2px solid #FFF0F3; border-radius: 18px;
            margin-bottom: 15px; overflow: hidden; transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
        }
        details[open] { border-color: var(--primary); }
        summary {
            padding: 20px; font-weight: 700; cursor: pointer; list-style: none;
            display: flex; justify-content: space-between; align-items: center;
            font-size: 1.1rem; color: var(--text);
        }
        summary::after { content: 'ğŸŒ¸'; transition: transform 0.3s; font-size: 1.2rem; opacity: 0.5; }
        details[open] summary::after { transform: rotate(45deg); opacity: 1; }
        .details-content { padding: 0 20px 25px; color: #6D4C41; font-size: 0.95rem; line-height: 1.8; border-top: 2px dashed #EFEBE9; white-space: pre-line;}

        /* --- Timeline (Itinerary) --- */
        .timeline { padding-left: 25px; border-left: 3px solid #EFEBE9; margin-left: 10px; margin-top: 20px; }
        .timeline-item { margin-bottom: 35px; position: relative; }
        .timeline-item::before {
            content: 'â„ï¸'; position: absolute; left: -34px; top: 6px; background: var(--bg);
            width: 16px; height: 16px; border-radius: 50%; border: 2px solid var(--primary-dark);
            display: flex; align-items: center; justify-content: center; font-size: 10px; color: transparent;
            z-index: 2;
        }
        .time { font-size: 0.9rem; color: #A1887F; margin-bottom: 6px; display: block; font-weight: 800; letter-spacing: 1px; }
        .event-card {
            background: white; border-radius: 16px; padding: 18px; margin-top: 5px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.03); border: 1px solid #f0f0f0;
        }
        .event-title { font-weight: 700; color: var(--text); font-size: 1.1rem; margin-bottom: 5px; }
        .event-desc { font-size: 0.95rem; color: #795548; line-height: 1.6; }
        .price-tag {
            display: inline-block; background: var(--tag-money); color: var(--text-money);
            font-size: 0.8rem; padding: 4px 12px; border-radius: 20px; margin-top: 10px; font-weight: 800;
        }

        /* --- Budget Table --- */
        .budget-table { width: 100%; font-size: 0.95rem; border-collapse: separate; border-spacing: 0 8px; margin-top: 10px; }
        .budget-table td { padding: 12px 10px; background: #FAFAFA; border-bottom: 1px solid #eee; }
        .budget-table tr:last-child td { font-weight: 800; color: var(--primary-dark); background: #EFEBE9; border-radius: 10px; }

        /* --- Wishlist --- */
        .wishlist-title { 
            font-weight: 800; color: var(--text); margin: 40px 0 15px; font-size: 1.3rem; 
            display: flex; align-items: center; gap: 10px; padding-left: 10px;
            border-left: 6px solid var(--primary);
        }
        .wish-item {
            background: white; border: 2px solid #F5F5F5; padding: 18px;
            border-radius: 20px; margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between;
        }
        .wish-name { font-weight: 800; color: #5D4037; font-size: 1.05rem; }
        .wish-desc { font-size: 0.9rem; color: #A1887F; margin-top: 4px; display: block;}
        .wish-check {
            width: 30px; height: 30px; border: 2px solid #D7CCC8; border-radius: 50%;
            margin-right: 15px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: white; background: white; transition: all 0.2s; flex-shrink: 0;
        }
        .wish-check.checked { background: var(--primary); border-color: var(--primary); }
        .tag.spot { background: var(--tag-spot); color: var(--text-info); font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin-left: 6px; vertical-align: middle; }
        .tag.food { background: var(--tag-shop); color: var(--text-shop); font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin-left: 6px; vertical-align: middle; }

        /* --- Tab 4: Expense (FIXED) --- */
        .expense-card {
            background: linear-gradient(135deg, #BCAAA4, #8D6E63);
            color: white; padding: 30px; border-radius: 30px; text-align: center; margin-bottom: 25px;
            box-shadow: 0 10px 25px rgba(141, 110, 99, 0.3); border: none;
        }
        .expense-result { font-size: 2.2rem; font-weight: 900; margin: 10px 0; letter-spacing: 1px; }
        .expense-detail { font-size: 1rem; opacity: 0.9; margin-top: 10px; font-weight: 600; }
        
        .radio-group { display: flex; gap: 12px; margin-bottom: 20px; width: 100%; }
        
        /* éš±è—åŸç”Ÿ radio */
        input[type="radio"] { display: none; }
        
        /* é è¨­æ¨£å¼ */
        .radio-label {
            flex: 1; text-align: center; padding: 10px 5px; cursor: pointer; font-size: 0.95rem;
            background: #FAFAFA; color: #999; border-radius: 50px; transition: all 0.3s; font-weight: 700;
            border: 2px solid transparent; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        /* é¸ä¸­æ¨£å¼ */
        input[name="currency"]:checked + .radio-label { 
            background: var(--tag-money); color: var(--text-money); border-color: var(--text-money); transform: translateY(-1px);
        }
        input[name="payer"]:checked + .radio-label { 
            background: var(--tag-info); color: var(--text-info); border-color: var(--text-info); transform: translateY(-1px);
        }

        .expense-form, .guide-form {
            background: white; border: 2px solid #FFF0F3; padding: 20px; border-radius: 20px; margin-bottom: 20px;
        }
        
        .expense-item {
            padding: 18px; margin-bottom: 12px; background: white; border-radius: 20px;
            display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.03); border: 1px solid #f5f5f5;
        }
        
        /* é‡‘é¡é å³å°é½Š CSS */
        .expense-info-left { flex: 1; display: flex; flex-direction: column; align-items: flex-start; overflow: hidden; margin-right: 10px; }
        .expense-amt-right { text-align: right; flex-shrink: 0; }
        
        .expense-who-tag { font-size: 0.75rem; padding: 3px 8px; border-radius: 10px; display: inline-block; width: fit-content; margin-bottom: 4px; font-weight: 800; }
        .tag-me { background: #EFEBE9; color: #5D4037; }
        .tag-sis { background: #E3F2FD; color: #1565C0; }

        /* VJW Data Block */
        .vjw-data { background: #F5F5F5; padding: 15px; border-radius: 12px; font-family: monospace; font-size: 1rem; color: #333; margin-bottom: 10px; user-select: all; border: 2px dashed #D7CCC8; line-height: 1.8; word-break: break-all; }
        .vjw-label { font-size: 0.8rem; color: #A1887F; display: block; margin-bottom: 2px; letter-spacing: 0.5px; font-weight: bold; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.7); backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal { background: white; padding: 35px; border-radius: 35px; width: 85%; max-width: 320px; text-align: center; box-shadow: 0 20px 60px rgba(141, 110, 99, 0.15); border: 2px solid #EFEBE9; }
        .btn-confirm { background: var(--primary-dark); color: white; width: 100%; padding: 12px; margin-top: 15px; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; font-size: 1rem; box-shadow: 0 5px 15px rgba(141, 110, 99, 0.3); }
        .reset-btn { width: 100%; padding: 12px; margin-top: 25px; background: #FAFAFA; border: 1px solid #EEE; color: #BBB; border-radius: 15px; cursor: pointer; font-size: 0.85rem; font-weight: bold; }
        
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text); font-weight: bold; letter-spacing: 1px;}
        
        /* Map */
        .map-card { text-align: center; padding: 20px; border: 2px solid #EFEBE9; border-radius: 20px; margin-bottom: 20px; background: white;}
        .map-title { font-size: 1.1rem; font-weight: 800; color: var(--primary-dark); margin-bottom: 10px; }
        .map-container { display: flex; flex-direction: column; align-items: center; position: relative; gap: 15px; }
        .map-node { background: var(--tag-info); color: var(--text-info); padding: 6px 12px; border-radius: 50px; font-weight: 800; font-size: 0.9rem; z-index: 2; position: relative; }
        .map-node.base { background: #FFF3E0; color: #E65100; transform: scale(1.1); border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .map-line { position: absolute; width: 2px; background: #D7CCC8; top: 15px; bottom: 15px; left: 50%; transform: translateX(-50%); z-index: 1; border-left: 2px dashed #D7CCC8; }
        .map-branch { display: flex; gap: 20px; width: 100%; justify-content: center; }

    </style>
</head>
<body>

<div id="loadingOverlay">
    <h2>â˜•ï¸ æ²–æ³¡é€£ç·šä¸­...</h2>
</div>

<!-- Trip Code Modal -->
<div id="tripCodeModal" class="modal-overlay" style="display:flex;">
    <div class="modal">
        <h3 style="margin-top:0; color:var(--text);">ğŸ”— å§Šå¦¹é€£ç·š</h3>
        <p style="margin-bottom:20px; color:#999; font-size:0.9rem;">è¼¸å…¥æˆ¿é–“è™Ÿç¢¼ 1025</p>
        <input type="text" id="tripCodeInput" value="1025" style="width:100%; text-align:center; border:2px solid #EFEBE9; padding:15px; border-radius:20px; outline:none; font-size:1.3rem; color:var(--text); font-weight:800; background: #FAFAFA;">
        <button class="btn-confirm" onclick="setTripCode()">é–‹å§‹æ—…ç¨‹</button>
    </div>
</div>

<div class="container">
    <header>
        <div class="header-left">
            <h1>HOKKAIDO</h1>
            <div class="subtitle">1/20 (ä¸€) ~ 1/25 (å…­) | 6å¤©5å¤œ</div>
        </div>
        <button class="share-btn" onclick="shareLink()">â¤ï¸ å‚³çµ¦å¦¹å¦¹</button>
    </header>

    <!-- TAB 1: Checklist -->
    <div id="view-checklist" class="view active">
        <div class="progress-header">
            <span class="progress-title">å¾…è¾¦æ¸…å–®</span>
            <span class="progress-text" id="progressText">0%</span>
        </div>
        <div class="progress-bar-bg"><div class="progress-bar" id="progressBar"></div></div>
        
        <div class="input-group" style="margin-top:20px;">
            <input type="text" id="itemInput" placeholder="âœ¨ é‚„æœ‰ä»€éº¼è¦å¸¶ï¼Ÿ">
            <button class="add-btn" id="addBtn">ï¼‹</button>
        </div>
        <ul id="itemList"></ul>
        
        <div class="memo-section" style="margin-top: 30px; background: white; border-radius: 20px; padding: 20px; border: 2px dashed #EFEBE9;">
            <div style="font-size: 1rem; font-weight: 800; color: var(--text); margin-bottom: 10px;">âœï¸ éš¨æ‰‹ç­†è¨˜ (Memo)</div>
            <textarea id="memoText" placeholder="è²¼ä¸Šç¶²å€ã€ç­†è¨˜ã€æƒ³åˆ°çš„äº‹æƒ…..." style="width: 100%; height: 100px; border: none; background: #FAFAFA; border-radius: 15px; padding: 15px; font-size: 0.95rem; line-height: 1.5; color: #666; resize: none; outline: none; font-family: inherit;"></textarea>
            <button onclick="saveMemo()" style="float: right; background: #B5C9C3; color: white; border: none; padding: 8px 15px; border-radius: 20px; font-size: 0.9rem; font-weight: bold; cursor: pointer; margin-top: 10px;">ä¿å­˜</button>
            <div style="clear:both;"></div>
        </div>

        <button class="reset-btn" onclick="showResetModal()">âš ï¸ é‡ç½®æ‰€æœ‰è³‡æ–™</button>
    </div>

    <!-- TAB 2: Itinerary -->
    <div id="view-itinerary" class="view">
        
        <!-- Map -->
        <div class="map-card">
            <div class="map-title">ğŸ—ºï¸ æ—…è¡Œåœ°åœ–</div>
            <div class="map-container">
                <div class="map-line"></div>
                <div class="map-node">âœˆï¸ æ–°åƒæ­²æ©Ÿå ´</div>
                <div class="map-node base">ğŸ™ï¸ æœ­å¹Œ (ä¸­å¿ƒ)</div>
                <div class="map-branch">
                    <div class="map-node">ğŸ§ æ—­å·</div>
                    <div class="map-node">ğŸ”ï¸ Tomamu</div>
                </div>
            </div>
        </div>

        <div class="tip-card gift">
            <span class="tip-title">ğŸ’– è¡Œç¨‹é‡é»ï¼š</span>
            <span class="tip-content">
                Day 1ï¼šè²·ç¦®ç‰© (Yodobashi) + å£½å¸<br>
                Day 2ï¼šé€ç¦®ç‰© + ç²¾éˆéœ²å°<br>
                Day 6ï¼šå®Œç¾è¡Œå–è²¨ + æ©Ÿå ´ä¼´æ‰‹ç¦®
            </span>
        </div>

        <!-- Day 1 -->
        <details open>
            <summary>ğŸ“… 1/20 (ä¸€) å‡ºç™¼ & å£½å¸ & è²·ç¦®ç‰©</summary>
            <div class="details-content">
                <div class="timeline">
                    <div class="timeline-item">
                        <span class="time">07:00 æ©Ÿå ´å ±åˆ°</span>
                        <div class="event-card">
                            <div class="event-title">æ¡ƒåœ’æ©Ÿå ´å ±åˆ°</div>
                            <div class="event-desc">æ¡ƒæ©ŸäºŒèˆªå»ˆï¼Œé•·æ¦®æ«ƒå°ã€‚</div>
                            <div class="price-tag">ğŸ’° æ©Ÿå ´æ·é‹ï¼šç´„ $160/äºº</div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <span class="time">14:05 æŠµé”</span>
                        <div class="event-card">
                            <div class="event-title">æŠµé”æ–°åƒæ­²</div>
                            <div class="event-desc">éVJWæµ·é—œï¼Œæ­JRå»æœ­å¹Œã€‚</div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <span class="time">16:00 ç¾é£Ÿ</span>
                        <div class="event-card" style="background:#FFF8E1;">
                            <div class="event-title">ğŸ£ æ ¹å®¤èŠ±ä¸¸ (å¿…åƒ!)</div>
                            <div class="event-desc">å…ˆå»è»Šç«™ Stellar Place 6F æŠ½è™Ÿç¢¼ç‰Œï¼</div>
                            <div class="price-tag">ğŸ’° å£½å¸é ç®—ï¼šç´„ 3,000å††</div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <span class="time">18:00 è²·ç¦®ç‰©</span>
                        <div class="event-card" style="background:#F3E5F5;">
                            <div class="event-title">ğŸ å‹éƒ½å…«å–œ (Yodobashi)</div>
                            <div class="event-desc"><strong>ä»»å‹™ï¼š</strong>è²· Brita æ¿¾æ°´å£ºçµ¦èœ‚èœœï¼(åŒ—å£å°é¢)</div>
                            <div class="price-tag">ğŸ’° ç¦®ç‰©é ç®—ï¼šç´„ 4,000å††</div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <span class="time">19:30 é£¯åº—</span>
                        <div class="event-card">
                            <div class="event-title">Check-in Livemax</div>
                            <div class="event-desc">èµ°è·¯å»é£¯åº—æ”¾è¡Œæè·Ÿæˆ°åˆ©å“ï¼Œä¼‘æ¯ã€‚</div>
                        </div>
                    </div>
                </div>
            </div>
        </details>
        
        <!-- Day 2 -->
        <details>
            <summary>ğŸ“… 1/21 (äºŒ) å‰å¾€ Tomamu</summary>
            <div class="details-content">
                <div class="timeline">
                    <div class="timeline-item">
                        <span class="time">09:30 é€€æˆ¿</span>
                        <div class="event-card">
                            <div class="event-title">é€€æˆ¿ & å¯„è¡Œæ</div>
                            <div class="event-desc">è¡Œæé–åœ¨æœ­å¹Œè»Šç«™ç½®ç‰©æ«ƒ (700å††)ã€‚</div>
                            <div class="price-tag">ğŸ’° 700å††</div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <span class="time">11:00 æ­è»Š</span>
                        <div class="event-card">
                            <div class="event-title">æ­ JR ç‰¹æ€¥</div>
                            <div class="event-desc">å¾€ Tomamu æ‰¾èœ‚èœœ (1.5hr)ã€‚</div>
                            <div class="price-tag">ğŸ’° è»Šè³‡ï¼š5,500å††</div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <span class="time">13:30 é©šå–œ</span>
                        <div class="event-card">
                            <div class="event-title">ğŸ’– æ‰¾èœ‚èœœï¼</div>
                            <div class="event-desc">é€ç¦®ç‰©æ™‚é–“ï¼ğŸ</div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <span class="time">æ™šä¸Š</span>
                        <div class="event-card" style="background:#E3F2FD;">
                            <div class="event-title">ğŸŒ² ç²¾éˆéœ²å°</div>
                            <div class="event-desc">å¯Œè‰¯é‡æµªæ¼«é»ç‡ˆ (å…é–€ç¥¨)ã€‚</div>
                        </div>
                    </div>
                </div>
            </div>
        </details>

        <details><summary>ğŸ“… 1/22 (ä¸‰) æ»‘é›ª & å¸ç‹èŸ¹</summary>
            <div class="details-content">
                <div class="timeline">
                    <div class="timeline-item">
                        <span class="time">ç™½å¤©</span>
                        <div class="event-card">
                            <div class="event-title">â›·ï¸ æ»‘é›ªé«”é©—</div>
                            <div class="event-desc">çœ‹èœ‚èœœå¸¥æ°£æ•™å­¸ï¼</div>
                            <div class="tip-box">ğŸ’¡ <strong>æ€•å†·ï¼š</strong>å»å¾®ç¬‘æµ·ç˜æº«æ°´æ³³æ± ã€‚</div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <span class="time">17:00 æ™šé¤</span>
                        <div class="event-card" style="background:#FFF8E1;">
                            <div class="event-title">ğŸ¦€ Buffet Dining hal</div>
                            <div class="event-desc">å¸ç‹èŸ¹åƒåˆ°é£½ (å·²è¨‚ä½)ã€‚</div>
                            <div class="price-tag">ğŸ’° æ™šé¤ï¼šç´„ 5,500å††</div>
                        </div>
                    </div>
                     <div class="timeline-item">
                        <span class="time">20:00</span>
                        <div class="event-card">
                            <div class="event-title">â„ï¸ æ„›çµ²å†°åŸ</div>
                            <div class="event-desc">çœ‹å†°å±‹ã€çƒ¤æ£‰èŠ±ç³–ã€‚</div>
                            <div class="price-tag">ğŸ’° é–€ç¥¨ï¼š600å††</div>
                        </div>
                    </div>
                </div>
            </div>
        </details>

        <details><summary>ğŸ“… 1/23 (å››) å›æœ­å¹Œ & é€›è¡—</summary>
            <div class="details-content">
                <div class="timeline">
                    <div class="timeline-item">
                        <span class="time">11:00</span>
                        <div class="event-card">
                            <div class="event-title">é€€æˆ¿ & æ­ JR å›æœ­å¹Œ</div>
                            <div class="price-tag">ğŸ’° è»Šè³‡ï¼š5,500å††</div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <span class="time">14:00</span>
                        <div class="event-card">
                            <div class="event-title">Check-in Stripe Hotel</div>
                            <div class="event-desc">å…ˆæ”¾è¡Œæã€‚</div>
                            <div class="price-tag">ğŸ’° è¨ˆç¨‹è»Šå»é£¯åº—ï¼šç´„ 600å††/äºº</div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <span class="time">15:00</span>
                        <div class="event-card">
                            <div class="event-title">ç‹¸å°è·¯æ¡è³¼</div>
                            <div class="event-desc">æ­è¨ˆç¨‹è»Šå»ï¼é€›å”å‰è¨¶å¾·ã€è—¥å¦ã€‚</div>
                            <div class="price-tag">ğŸ’° è¨ˆç¨‹è»Šå»é€›è¡—ï¼šç´„ 600å††/äºº</div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <span class="time">19:00</span>
                        <div class="event-card">
                            <div class="event-title">æ™šé¤ï¼šæ¹¯å’–å“©</div>
                            <div class="event-desc">Suage+ æˆ– GARAKUã€‚</div>
                            <div class="price-tag">ğŸ’° é¤è²»ï¼šç´„ 1,800å††</div>
                        </div>
                    </div>
                </div>
            </div>
        </details>

        <details><summary>ğŸ“… 1/24 (äº”) ä¼éµæ•£æ­¥</summary>
            <div class="details-content">
                <div class="timeline">
                    <div class="timeline-item">
                        <span class="time">08:00</span>
                        <div class="event-card">
                            <div class="event-title">å·´å£«ä¸€æ—¥éŠé›†åˆ</div>
                            <div class="price-tag">ğŸ’° åœ˜è²» $1,800 (å·²é è¨‚)</div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <span class="time">11:00</span>
                        <div class="event-card" style="background:#E3F2FD;">
                            <div class="event-title">ğŸ§ æ—­å±±å‹•ç‰©åœ’</div>
                            <div class="event-desc">å¿…çœ‹ä¼éµæ•£æ­¥ï¼</div>
                            <div class="tip-box">ğŸ’¡ <strong>ä¿æš–ï¼š</strong>å±±ä¸Šå¾ˆå†·ï¼Œè²¼æš–æš–åŒ…ï¼</div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <span class="time">18:00</span>
                        <div class="event-card">
                            <div class="event-title">å›æœ­å¹Œè£œè²¨</div>
                            <div class="event-desc">å”å‰è¨¶å¾·æœ€å¾Œè¡åˆºã€‚</div>
                        </div>
                    </div>
                </div>
            </div>
        </details>

        <details><summary>ğŸ“… 1/25 (å…­) å›å®¶ & æ©Ÿå ´</summary>
            <div class="details-content">
                <div class="timeline">
                    <div class="timeline-item">
                        <span class="time">10:30</span>
                        <div class="event-card">
                            <div class="event-title">å‰å¾€æ©Ÿå ´</div>
                            <div class="event-desc">æ­è¨ˆç¨‹è»Šå»è»Šç«™è½‰ JRã€‚</div>
                            <div class="price-tag">ğŸ’° äº¤é€šï¼šç´„ 1,800å††</div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <span class="time">11:30</span>
                        <div class="event-card" style="background:#FFEBEE;">
                            <div class="event-title">ğŸ å®Œç¾è¡Œå–è²¨</div>
                            <div class="event-desc"><strong>âš ï¸ é‡è¦ï¼š</strong>é ˜å®Œè²¨æŠŠæ¶²é«”å¡é€²å¤§è¡Œæç®±è¨—é‹ï¼</div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <span class="time">12:00</span>
                        <div class="event-card">
                            <div class="event-title">æ©Ÿå ´ 2F ä¼´æ‰‹ç¦®</div>
                            <div class="event-desc">è²·ç”œé»ä¼´æ‰‹ç¦® (Kinotoya/åŒ—è“æ¨“)ã€‚</div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <span class="time">13:00</span>
                        <div class="event-card">
                            <div class="event-title">âœˆï¸ é…·èˆªæ«ƒå°å ±åˆ°</div>
                        </div>
                    </div>
                </div>
            </div>
        </details>

        <!-- Wishlist (Add Feature) -->
        <div class="wishlist-title">âœ¨ é¡˜æœ›æ¸…å–® (å¿…åƒå¿…å»)</div>
        
        <div class="guide-form" style="background:#FFF; padding:15px; border-radius:15px; box-shadow:0 2px 8px rgba(0,0,0,0.05); margin-bottom:15px;">
             <div class="input-group" style="margin-bottom:10px;">
                <input type="text" id="wishName" placeholder="æ–°å¢é¡˜æœ›...">
            </div>
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <label style="flex:1; text-align:center; padding:8px; background:#f9f9f9; border-radius:20px; cursor:pointer;"><input type="radio" name="wishType" value="food" checked> ğŸ½ï¸ åƒ</label>
                <label style="flex:1; text-align:center; padding:8px; background:#f9f9f9; border-radius:20px; cursor:pointer;"><input type="radio" name="wishType" value="spot"> ğŸ“¸ ç©</label>
            </div>
            <button class="add-btn" style="width:100%; border-radius:10px; font-size:0.9rem; height:35px;" onclick="addWish()">åŠ å…¥æ¸…å–®</button>
        </div>

        <ul id="wishlist-container" style="padding:0; list-style:none;"></ul>
    </div>

    <!-- TAB 3: æ”»ç•¥ Guide -->
    <div id="view-guide" class="view">
        
        <!-- Add Guide Section -->
        <div class="guide-form" style="margin-bottom:20px;">
            <strong style="display:block; margin-bottom:10px; color:var(--text);">âœ¨ æ–°å¢æˆ‘çš„æ”»ç•¥</strong>
            <input type="text" id="guideTitle" placeholder="æ¨™é¡Œ (å¦‚: å¿…è²·è—¥å¦)" style="width:100%; margin-bottom:10px; padding:10px; border:2px solid #EFEBE9; border-radius:10px;">
            <textarea id="guideContent" placeholder="å…§å®¹..." style="width:100%; height:80px; padding:10px; border:2px solid #EFEBE9; border-radius:10px; resize:none; font-family:inherit;"></textarea>
            <button onclick="addGuide()" style="width:100%; background:var(--secondary); color:white; border:none; padding:10px; border-radius:10px; font-weight:bold; margin-top:10px; cursor:pointer;">æ–°å¢</button>
        </div>

        <div id="custom-guides-container"></div>
        
        <details>
            <summary>â„ï¸ é›ªè¡£è£å‚™ (å«é ç®—)</summary>
            <div class="details-content">
                <div class="tip-card info">
                    <span class="tip-title">ğŸ’¡ çµè«–ï¼šå»è¿ªå¡å„‚æˆ–å¤§æœ‰è²·ï¼</span>
                    <span class="tip-content">æ•´å¥—ç´„ $6,000~$7,000ï¼Œæ¯”ç§Ÿåˆ’ç®—ã€‚</span>
                </div>
                
                <div style="margin-bottom:15px;">
                    <strong style="color:var(--text); display:block; margin-bottom:5px;">ğŸ›’ è¿ªå¡å„‚ vs å¤§æœ‰é‹å‹•ï¼šè²·ä»€éº¼ï¼Ÿ</strong>
                    <ul style="font-size:0.9rem; color:#666; padding-left:20px;">
                        <li><strong>è¿ªå¡å„‚è²·ï¼š</strong>é›ªè¥ªã€å…§å±¤è¡£ã€é›ªè¤² (ä¾¿å®œå¥½ç©¿)ã€‚</li>
                        <li><strong>å¤§æœ‰è²·ï¼š</strong>é›ªè¡£å¤–å¥—ã€æ‰‹å¥—ã€è­·å…· (æ¬¾å¼å¤šã€è¼ƒå¸¥)ã€‚</li>
                    </ul>
                </div>

                <table class="budget-table">
                    <tr><td>é›ªè¡£ (æœ‰é›ªè£™)</td><td style="text-align:right;">$2,500</td></tr>
                    <tr><td>é›ªè¤² (é»‘è‰²)</td><td style="text-align:right;">$1,500</td></tr>
                    <tr><td>æ‰‹å¥— (é˜²æ°´)</td><td style="text-align:right;">$600</td></tr>
                    <tr><td>å…§æ‰‹å¥— (è§¸æ§)</td><td style="text-align:right;">$200</td></tr>
                    <tr><td>é›ªè¥ª (é•·ç­’)</td><td style="text-align:right;">$300</td></tr>
                    <tr><td>è„–åœ</td><td style="text-align:right;">$150</td></tr>
                    <tr><td>ç™¼ç†±è¡£è¤²x2</td><td style="text-align:right;">$2,000</td></tr>
                    <tr><td><strong>ç¸½è¨ˆ</strong></td><td style="text-align:right; color:var(--primary-dark);"><strong>ç´„ $7,250</strong></td></tr>
                </table>
                <p style="font-size:0.85rem; color:#999; margin-top:15px;">
                    æ¨è–¦ï¼šè¿ªå¡å„‚ (WEDZEç³»åˆ—)ã€å¤§æœ‰é‹å‹• (æ±æ­¢)ã€Montbell (äº¬ç«™)ã€‚
                </p>
            </div>
        </details>

        <details>
            <summary>ğŸ ç¦®ç‰©æ”»ç•¥</summary>
            <div class="details-content">
                <div class="tip-card gift">
                    <span class="tip-title">é€çµ¦èœ‚èœœçš„ï¼š</span>
                    <span class="tip-content">
                        1. <strong>Brita æ¿¾æ°´å£º</strong> (æœ­å¹Œ Yodobashi è²·)<br>
                        2. <strong>å°ç£é›¶é£Ÿ</strong> (ç¾©ç¾æ³¡èŠ™/é»‘ç³–è–‘èŒ¶)<br>
                        3. <strong>è§¸æ§å…§æ‰‹å¥—</strong> (è¿ªå¡å„‚è²·)<br>
                        4. <strong>è¶³æŒ‡é™¤è‡­éœœ</strong> (æ—¥æœ¬è—¥å¦åº—è²·)
                    </span>
                </div>
            </div>
        </details>

        <details>
            <summary>ğŸ“‹ VJW å¡«å¯«è³‡æ–™ (ç¬¬ä¸€æ™š)</summary>
            <div class="details-content">
                <div class="vjw-data">
                    <span class="vjw-label">éƒµéå€è™Ÿ</span> 060-0806<br>
                    <span class="vjw-label">éƒ½é“åºœç¸£</span> HOKKAIDO<br>
                    <span class="vjw-label">å¸‚å€ç”ºæ‘</span> SAPPORO SHI KITA KU<br>
                    <span class="vjw-label">ç”ºåç•ªåœ°</span> 10-7, Kita 6 Jonishi<br>
                    <span class="vjw-label">é£¯åº—åç¨±</span> Hotel Livemax Sapporo Ekimae<br>
                    <span class="vjw-label">é›»è©±</span> 0117371000
                </div>
            </div>
        </details>

        <details>
            <summary>ğŸŒ™ æ·±å¤œ & è³¼ç‰©æŒ‡å—</summary>
            <div class="details-content">
                <div class="tip-card shop">
                    <span class="tip-title">ğŸ›ï¸ å“ªè£¡è²·ï¼Ÿ</span>
                    <span class="tip-content">
                        <strong>å”å‰è¨¶å¾· (ç‹¸å°è·¯)ï¼š</strong> 24Hï¼Œè²·é›œè²¨é›¶é£Ÿã€‚<br>
                        <strong>è–©æ‘©è—¥å¦ (Satudora)ï¼š</strong> è—è‰²æ‹›ç‰Œï¼Œåº—å¤§å¥½é€›ã€‚<br>
                        <strong>3COINS (APIA/Pole Town)ï¼š</strong> 300å††è³ªæ„Ÿé›œè²¨ã€‚<br>
                        <strong>å®Œç¾è¡Œ (WAmazing)ï¼š</strong> é‡ç‰©/æ¶²é«”ç”¨ App è²·ï¼Œæ©Ÿå ´é ˜ã€‚<br>
                        <hr style="border:0; border-top:1px dashed #eee; margin:10px 0;">
                        <strong>æ·±å¤œç¾é£Ÿï¼š</strong> çµå°¾è–ä»£ (Parfaiteria PaL)ã€‚
                    </span>
                </div>
            </div>
        </details>
        
        <details>
            <summary>ğŸš† JR æ­è»Š & è²·ç¥¨æ•™å­¸</summary>
            <div class="details-content">
                <div class="tip-card info">
                    <span class="tip-title">1. æ©Ÿå ´ â†” æœ­å¹Œ (çŸ­ç¨‹)</span>
                    <span class="tip-content">
                        ğŸ’³ <strong>åˆ·å¡ï¼š</strong>è¥¿ç“œå¡ (Suica)ã€ICOCA éƒ½å¯ä»¥ï¼<br>
                        ğŸ« <strong>è²·ç¥¨ï¼š</strong>å”®ç¥¨æ©Ÿé¸ 1150 å††ã€‚<br>
                        ğŸš… <strong>è»Šç¨®ï¼š</strong>æ­ã€Œå¿«é€Ÿ Airportã€ï¼Œæ¯ 12 åˆ†ä¸€ç­ã€‚<br>
                        ğŸ’° <strong>å„²å€¼ï¼š</strong>å…ˆå­˜ 5,000å†† å°±å¤ ç”¨ã€‚
                    </span>
                </div>
                <div class="tip-card money">
                    <span class="tip-title">2. æœ­å¹Œ â†” Tomamu (é•·ç¨‹)</span>
                    <span class="tip-content">
                        âš ï¸ <strong>ä¸èƒ½åˆ·è¥¿ç“œå¡ï¼</strong><br>
                        ğŸ« <strong>è²·ç¥¨ï¼š</strong>å»ã€Œç¶ è‰²çª—å£ã€è²·å¯¦é«”ç¥¨ã€‚<br>
                        ğŸ“ <strong>å£è¨£ï¼š</strong>æˆ‘è¦è²·ã€Œä¹˜è»Šåˆ¸ + ç‰¹æ€¥åˆ¸ã€ã€‚<br>
                        ğŸš… <strong>è»Šç¨®ï¼š</strong>ç‰¹æ€¥ Tokachi (åå‹) æˆ– Ozora (å¤§ç©º)ã€‚
                    </span>
                </div>
            </div>
        </details>
    </div>

    <!-- TAB 4: è¨˜å¸³ Expenses -->
    <div id="view-expenses" class="view">
        <div class="expense-card">
            <div style="font-size:0.9rem; opacity:0.8;">ç›®å‰çš„çµç®—</div>
            <div class="expense-result" id="settlementText">è¨ˆç®—ä¸­...</div>
            <div style="font-size:0.9rem; background:rgba(255,255,255,0.2); padding:5px 15px; border-radius:15px; display:inline-block;">
                æˆ‘ä»˜ $<span id="totalMe">0</span> ï½œ å¦¹ä»˜ $<span id="totalSis">0</span>
            </div>
        </div>

        <div class="expense-form">
            <div class="input-group" style="margin-bottom:15px;">
                <input type="text" id="expName" placeholder="ğŸ° é …ç›® (å¦‚: æ™šé¤)" style="flex:2;">
                <input type="number" id="expCost" placeholder="$ é‡‘é¡">
            </div>
            
            <div class="radio-group">
                <input type="radio" name="currency" id="currTWD" value="TWD" checked onchange="toggleRateTip()">
                <label class="radio-label" for="currTWD">ğŸ‡¹ğŸ‡¼ å°å¹£</label>
                
                <input type="radio" name="currency" id="currJPY" value="JPY" onchange="toggleRateTip()">
                <label class="radio-label" for="currJPY">ğŸ‡¯ğŸ‡µ æ—¥å¹£</label>
            </div>
            <div id="rateTip" style="font-size:0.75rem; color:#aaa; margin-bottom:15px; text-align:center; display:none;">* è‡ªå‹• x 0.22 æ›ç®—</div>

            <div class="radio-group">
                <input type="radio" name="payer" id="payMe" value="me" checked>
                <label class="radio-label" for="payMe">ğŸ™‹â€â™€ï¸ æˆ‘ä»˜</label>
                
                <input type="radio" name="payer" id="paySis" value="sis">
                <label class="radio-label" for="paySis">ğŸ™‹â€â™€ï¸ å¦¹ä»˜</label>
            </div>
            
            <button class="add-btn" style="width:100%; border-radius:50px; font-size:1.1rem; height:50px;" onclick="addExpense()">æ–°å¢æ”¯å‡º</button>
        </div>
        <ul id="expenseList" style="padding:0;"></ul>
    </div>

    <!-- Bottom Nav -->
    <div class="bottom-nav">
        <button class="nav-btn active" onclick="switchTab('checklist')">
            <span>ğŸ“</span> æ¸…å–®
        </button>
        <button class="nav-btn" onclick="switchTab('itinerary')">
            <span>ğŸ—“ï¸</span> è¡Œç¨‹
        </button>
        <button class="nav-btn" onclick="switchTab('guide')">
            <span>ğŸ“˜</span> æ”»ç•¥
        </button>
        <button class="nav-btn" onclick="switchTab('expenses')">
            <span>ğŸ’°</span> è¨˜å¸³
        </button>
    </div>

</div>

<!-- Reset Modal -->
<div id="confirmModal" class="modal-overlay">
    <div class="modal">
        <h3>âš ï¸ ç¢ºå®šé‡ç½®ï¼Ÿ</h3>
        <p style="margin-bottom:20px; color:#999;">è³‡æ–™æœƒå…¨éƒ¨ä¸è¦‹å–”ï¼</p>
        <div class="modal-btns">
            <button class="reset-btn" style="margin:0; width:auto; border:none; color:#999;" onclick="closeModal()">å–æ¶ˆ</button>
            <button class="btn-confirm" style="width:auto; padding:10px 30px;" onclick="confirmReset()">ç¢ºå®š</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDFUGYOobmVxYFQMBYz1iQ4z1HIrdbTi8Q",
        authDomain: "travel-55c4b.firebaseapp.com",
        databaseURL: "https://travel-55c4b-default-rtdb.firebaseio.com",
        projectId: "travel-55c4b",
        storageBucket: "travel-55c4b.firebasestorage.app",
        messagingSenderId: "925227625640",
        appId: "1:925227625640:web:7966e45422a9979ff8a69d",
        measurementId: "G-N5V8NBGEHZ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let tripId = null;

    // Default Data
    const defaultData = [
        { text: "æº–å‚™ç¦®ç‰©ï¼šBritaæ¿¾æ°´å£º (å»æ—¥æœ¬è²·)", done: false, cat: "ç¦®ç‰©", class: "gift" },
        { text: "æº–å‚™ç¦®ç‰©ï¼šè§¸æ§å…§æ‰‹å¥—", done: false, cat: "ç¦®ç‰©", class: "gift" },
        { text: "æº–å‚™ç¦®ç‰©ï¼šå°ç£é›¶é£Ÿ", done: false, cat: "ç¦®ç‰©", class: "gift" },
        { text: "ç¢ºèª 1/22 hal é¤å»³è¨‚ä½", done: false, cat: "å¿…å‚™" },
        { text: "æˆªåœ–ï¼šVJW QR Code", done: true, cat: "æœ€å„ªå…ˆ" },
        { text: "ä¸‹è¼‰å®Œç¾è¡Œè³¼ç‰© App", done: false, cat: "å¿…å‚™" },
        { text: "é è¨‚æ—­å·å‹•ç‰©åœ’ä¸€æ—¥éŠ", done: false, cat: "å¿…å‚™" },
        { text: "è·Ÿå¦¹å¦¹æ”¶éŒ¢ (æ©Ÿ+é…’ $23,956)", done: false, cat: "è¨˜å¸³", class: "money" },
        { text: "1/20 ä½å®¿å·²è¨‚ (Livemax)", done: true, cat: "æœ€å„ªå…ˆ" },
        { text: "1/23 ä½å®¿å·²è¨‚ (Stripe)", done: true, cat: "æœ€å„ªå…ˆ" },
        { text: "æ©Ÿç¥¨å·²è¨‚ (1/20å‡ºç™¼)", done: true, cat: "æœ€å„ªå…ˆ" },
        { text: "è²·ç¶²å¡ (2äººä»½)", done: false, cat: "ç¶²è·¯" },
        { text: "è³¼è²·é›ªè¡£/é›ªè¤²/æ‰‹å¥—", done: false, cat: "è£å‚™", class: "gear" },
        { text: "å‡ºç™¼å‰24Hï¼šæ‰‹æ©Ÿå……é£½", done: false, cat: "æœ€å¾Œç¢ºèª" }
    ];

    const defaultWishlist = [
        { name: "æˆå‰æ€æ±—çƒ¤è‚‰ (é”æ‘©)", desc: "å¿…åƒç¾Šè‚‰", type: "food" },
        { name: "æµ·é®®ä¸¼ (äºŒæ¢å¸‚å ´)", desc: "æ—©é¤åƒæµ·è†½", type: "food" },
        { name: "å‘³å™Œæ‹‰éºµ (ä¿¡ç„)", desc: "æš–èƒƒé¦–é¸", type: "food" },
        { name: "çµå°¾è–ä»£ (PaL)", desc: "é£¯å¾Œç”œé»", type: "food" },
        { name: "æ—­å·æ‹‰éºµ (é’è‘‰)", desc: "é†¬æ²¹å£å‘³", type: "food" },
        { name: "å“ˆå£«å¥‡é›ªæ©‡ (Tomamu)", desc: "éœ€é ç´„", type: "spot" },
        { name: "å¯Œè‰¯é‡èµ·å¸å·¥åŠ", desc: "åƒæŠ«è–©", type: "spot" },
        { name: "é›ªåœ°æ‘©æ‰˜è»Š (å¯Œè‰¯é‡)", desc: "éœ€é ç´„", type: "spot" },
        { name: "3COINS (APIAåº—)", desc: "300å††é›œè²¨", type: "spot" }
    ];

    // Auth
    const urlParams = new URLSearchParams(window.location.search);
    const idFromUrl = urlParams.get('id');

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            if (idFromUrl) {
                localStorage.setItem('hokkaidoTripId', idFromUrl);
                initTrip(idFromUrl);
            } else {
                const storedId = localStorage.getItem('hokkaidoTripId');
                if (storedId) {
                    initTrip(storedId);
                } else {
                    document.getElementById('loadingOverlay').style.display = 'none';
                    document.getElementById('tripCodeModal').style.display = 'flex';
                }
            }
        } else {
            signInAnonymously(auth).catch(console.error);
        }
    });

    window.setTripCode = function() {
        const code = document.getElementById('tripCodeInput').value.trim();
        if(!code) return;
        localStorage.setItem('hokkaidoTripId', code);
        try {
            const newUrl = window.location.pathname + '?id=' + code;
            window.history.pushState({path:newUrl},'',newUrl);
        } catch(e) {}
        document.getElementById('tripCodeModal').style.display = 'none';
        document.getElementById('loadingOverlay').style.display = 'flex';
        initTrip(code);
    }
    
    window.shareLink = function() {
        if(!tripId) return;
        const url = window.location.href.split('?')[0] + '?id=' + tripId;
        if (navigator.share) {
            navigator.share({ title: 'åŒ—æµ·é“ä¹‹æ—…', url: url }).catch(console.error);
        } else {
            const temp = document.createElement("input");
            temp.value = url;
            document.body.appendChild(temp);
            temp.select();
            document.execCommand("copy");
            document.body.removeChild(temp);
            alert("ç¶²å€å·²è¤‡è£½ï¼");
        }
    }

    window.toggleRateTip = function() {
        const isJPY = document.querySelector('input[name="currency"]:checked').value === 'JPY';
        document.getElementById('rateTip').style.display = isJPY ? 'block' : 'none';
    }

    // Memo Function
    window.saveMemo = async () => {
        const text = document.getElementById('memoText').value;
        if(tripId) {
            await addDoc(collection(db, 'trips', tripId, 'memo'), {
                text: text, createdAt: serverTimestamp()
            });
            alert('ç­†è¨˜å·²å„²å­˜ï¼');
        }
    }

    // Add Wish
    window.addWish = async () => {
        const name = document.getElementById('wishName').value.trim();
        const type = document.querySelector('input[name="wishType"]:checked').value;
        
        if(name) {
            await addDoc(collection(db, 'trips', tripId, 'wishlist'), {
                name: name, desc: "è‡ªè¨‚è¡Œç¨‹", type: type, done: false, createdAt: serverTimestamp()
            });
            document.getElementById('wishName').value = '';
        }
    }
    
    // Add Guide
    window.addGuide = async () => {
        const title = document.getElementById('guideTitle').value.trim();
        const content = document.getElementById('guideContent').value.trim();
        
        if(title && content) {
             await addDoc(collection(db, 'trips', tripId, 'guides'), {
                title: title, content: content, createdAt: serverTimestamp()
            });
            document.getElementById('guideTitle').value = '';
            document.getElementById('guideContent').value = '';
        }
    }

    function initTrip(id) {
        tripId = id;
        
        // Checklist
        onSnapshot(query(collection(db, 'trips', id, 'checklist'), orderBy('createdAt', 'desc')), (snap) => {
            const items = [];
            snap.forEach(doc => items.push({id: doc.id, ...doc.data()}));
            if (items.length === 0 && !snap.metadata.hasPendingWrites) {
                loadDefaults(id);
            } else {
                renderList(items);
                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('tripCodeModal').style.display = 'none';
            }
        });

        // Wishlist
        onSnapshot(query(collection(db, 'trips', id, 'wishlist')), (snap) => {
            const items = [];
            snap.forEach(doc => items.push({id: doc.id, ...doc.data()}));
            if (items.length === 0 && !snap.metadata.hasPendingWrites) {
                loadWishlistDefaults(id);
            } else {
                renderWishlist(items);
            }
        });
        
        // Guides (Custom)
        onSnapshot(query(collection(db, 'trips', id, 'guides'), orderBy('createdAt', 'desc')), (snap) => {
            const items = [];
            snap.forEach(doc => items.push({id: doc.id, ...doc.data()}));
            renderGuides(items);
        });

        // Expenses
        onSnapshot(query(collection(db, 'trips', id, 'expenses'), orderBy('createdAt', 'desc')), (snap) => {
            const exps = [];
            snap.forEach(doc => exps.push({id: doc.id, ...doc.data()}));
            renderExpenses(exps);
        });

        // Load Memo (Latest)
        onSnapshot(query(collection(db, 'trips', id, 'memo'), orderBy('createdAt', 'desc')), (snap) => {
             if(!snap.empty) {
                 document.getElementById('memoText').value = snap.docs[0].data().text;
             }
        });
    }

    async function loadDefaults(id) {
        const batch = writeBatch(db);
        defaultData.forEach(item => {
            const docRef = doc(collection(db, 'trips', id, 'checklist'));
            batch.set(docRef, { ...item, createdAt: serverTimestamp() });
        });
        const expRef1 = doc(collection(db, 'trips', id, 'expenses'));
        batch.set(expRef1, { name: "æ©Ÿç¥¨+ä½å®¿ä»£å¢Š", cost: 47911, currency: "TWD", payer: "me", createdAt: serverTimestamp() });
        await batch.commit();
    }

    async function loadWishlistDefaults(id) {
        const batch = writeBatch(db);
        defaultWishlist.forEach(item => {
            const docRef = doc(collection(db, 'trips', id, 'wishlist'));
            batch.set(docRef, { ...item, done: false });
        });
        await batch.commit();
    }

    // Render Checklist
    function renderList(items) {
        const list = document.getElementById('itemList');
        list.innerHTML = '';
        let completed = 0;
        
        items.forEach(item => {
            if(item.done) completed++;
            const li = document.createElement('li');
            li.className = `todo-item ${item.done ? 'completed' : ''}`;
            const tagClass = item.class ? item.class : (item.cat === 'æœ€å„ªå…ˆ' ? 'urgent' : (item.cat === 'å¿…å‚™' ? 'tag-info' : ''));
            
            li.innerHTML = `
                <div class="check-area" onclick="toggleItem('${item.id}', ${item.done})">
                    <div class="checkbox"></div>
                    <div class="item-text-wrapper">
                        ${item.cat ? `<span class="tag ${tagClass}">${item.cat}</span>` : ''}
                        <span class="text">${item.text}</span>
                    </div>
                </div>
                <button class="delete-btn" onclick="deleteItem('${item.id}', 'checklist')">Ã—</button>
            `;
            list.appendChild(li);
        });
        
        const percent = items.length ? Math.round((completed/items.length)*100) : 0;
        document.getElementById('progressBar').style.width = percent + '%';
        document.getElementById('progressText').innerText = `å®Œæˆåº¦ï¼š${percent}%`;
    }

    // Render Wishlist
    function renderWishlist(items) {
        const container = document.getElementById('wishlist-container');
        if(!container) return;
        container.innerHTML = '';
        items.forEach(item => {
            const li = document.createElement('div');
            li.className = 'wish-item';
            li.innerHTML = `
                <div class="wish-content">
                    <span class="wish-name" style="${item.done ? 'text-decoration:line-through; color:#aaa;' : ''}">
                        ${item.name} <span class="tag ${item.type === 'food' ? 'tag-food' : 'tag-spot'}">${item.type==='food'?'é£Ÿ':'ç©'}</span>
                    </span>
                    <span class="wish-desc">${item.desc}</span>
                </div>
                <div class="wish-check ${item.done ? 'checked' : ''}" onclick="toggleWishItem('${item.id}', ${item.done})">
                    ${item.done ? 'âœ“' : ''}
                </div>
                <button class="delete-btn" style="margin-left:10px; font-size:1.1rem;" onclick="deleteItem('${item.id}', 'wishlist')">Ã—</button>
            `;
            container.appendChild(li);
        });
    }
    
    // Render Custom Guides
    function renderGuides(items) {
        const container = document.getElementById('custom-guides-container');
        if(!container) return;
        container.innerHTML = '';
        items.forEach(item => {
            const details = document.createElement('details');
            details.innerHTML = `
                <summary>
                    ${item.title} 
                    <button onclick="event.preventDefault(); deleteItem('${item.id}', 'guides')" style="background:none; border:none; color:#FF8A80; font-weight:bold; cursor:pointer;">Ã—</button>
                </summary>
                <div class="details-content">${item.content.replace(/\n/g, '<br>')}</div>
            `;
            container.appendChild(details);
        });
    }

    // Render Expenses
    function renderExpenses(exps) {
        const list = document.getElementById('expenseList');
        list.innerHTML = '';
        let totalMe = 0, totalSis = 0;

        exps.forEach(exp => {
            const cost = parseFloat(exp.cost);
            let finalCost = cost;
            if(exp.currency === 'JPY') finalCost = Math.round(cost * 0.22);

            if(exp.payer === 'me') totalMe += finalCost; else totalSis += finalCost;

            const div = document.createElement('div');
            div.className = 'expense-item';
            div.innerHTML = `
                <div class="expense-info-left">
                    <span class="expense-who-tag ${exp.payer==='me'?'tag-me':'tag-sis'}">${exp.payer==='me'?'æˆ‘ä»˜':'å¦¹ä»˜'}</span>
                    <span>${exp.name}</span>
                </div>
                <div class="expense-amt-right">
                    <div class="expense-main-price">$${finalCost.toLocaleString()}</div>
                    ${exp.currency === 'JPY' ? `<div class="expense-sub-price">${cost.toLocaleString()}å††</div>` : ''}
                </div>
                <button class="delete-btn" style="margin-left:10px;" onclick="deleteItem('${exp.id}', 'expenses')">Ã—</button>
            `;
            list.appendChild(div);
        });

        document.getElementById('totalMe').innerText = totalMe.toLocaleString();
        document.getElementById('totalSis').innerText = totalSis.toLocaleString();
        
        const diff = totalMe - (totalMe + totalSis)/2;
        const res = document.getElementById('settlementText');
        if(Math.abs(diff) < 1) res.innerText = "ç›®å‰å¹³æ‰‹ï¼ğŸ’–";
        else if(diff > 0) res.innerText = `å¦¹çµ¦å¦³ $${Math.floor(diff).toLocaleString()}`;
        else res.innerText = `å¦³çµ¦å¦¹ $${Math.floor(Math.abs(diff)).toLocaleString()}`;
    }

    // Actions
    window.addExpense = async () => {
        const name = document.getElementById('expName').value.trim();
        const cost = document.getElementById('expCost').value;
        const currency = document.querySelector('input[name="currency"]:checked').value;
        const payer = document.querySelector('input[name="payer"]:checked').value;
        
        if(name && cost) {
            await addDoc(collection(db, 'trips', tripId, 'expenses'), {
                name, cost, currency, payer, createdAt: serverTimestamp()
            });
            document.getElementById('expName').value = '';
            document.getElementById('expCost').value = '';
        }
    }

    window.toggleItem = (id, status) => updateDoc(doc(db, 'trips', tripId, 'checklist', id), { done: !status });
    window.toggleWishItem = (id, status) => updateDoc(doc(db, 'trips', tripId, 'wishlist', id), { done: !status });
    window.deleteItem = (id, col) => { if(confirm('åˆªé™¤ï¼Ÿ')) deleteDoc(doc(db, 'trips', tripId, col, id)); }

    document.getElementById('addBtn').addEventListener('click', async () => {
        const text = document.getElementById('itemInput').value.trim();
        if(text) {
            await addDoc(collection(db, 'trips', tripId, 'checklist'), {
                text, done: false, cat: 'æ–°å¢', createdAt: serverTimestamp()
            });
            document.getElementById('itemInput').value = '';
        }
    });

    // Navigation
    window.switchTab = (tab) => {
        document.querySelectorAll('.view').forEach(el => { if(el) el.classList.remove('active'); });
        document.querySelectorAll('.nav-btn').forEach(el => { if(el) el.classList.remove('active'); });
        
        const view = document.getElementById(`view-${tab}`);
        if (view) view.classList.add('active');
        
        const tabs = ['checklist', 'itinerary', 'guide', 'expenses'];
        const idx = tabs.indexOf(tab);
        if(idx >= 0) document.querySelectorAll('.nav-btn')[idx].classList.add('active');
    }

    // Reset
    window.showResetModal = () => document.getElementById('confirmModal').style.display = 'flex';
    window.closeModal = () => document.getElementById('confirmModal').style.display = 'none';
    window.confirmReset = async () => {
        closeModal();
        document.getElementById('loadingOverlay').style.display = 'flex';
        const cols = ['checklist', 'expenses', 'wishlist', 'guides'];
        for(let col of cols) {
            const q = await getDocs(collection(db, 'trips', tripId, col));
            q.forEach(d => deleteDoc(d.ref));
        }
    }

    // Enter key
    document.addEventListener('keypress', (e) => { 
        if (e.key === 'Enter' && e.target.id === 'itemInput') document.getElementById('addBtn').click(); 
    });

</script>
</body>
</html>
