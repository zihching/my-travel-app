<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ—æµ·é“è¿½æ„›ï¼šé›²ç«¯åŒæ­¥ç‰ˆ â˜ï¸</title>
    <style>
        :root {
            --primary: #FF9AA2; /* æ«»èŠ±ç²‰ */
            --primary-dark: #FF808A;
            --secondary: #B5EAD7; /* æ·ºç¶  */
            --accent: #FFDAC1; /* æè‰² */
            --text: #4A4A4A;
            --bg: #FFF9F9;
            --white: #ffffff;
            --gray: #f5f5f5;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            line-height: 1.6;
            padding-bottom: 60px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: var(--white);
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--primary), #FFB7B2);
            padding: 25px 20px;
            color: white;
            text-align: center;
            border-bottom-left-radius: 25px;
            border-bottom-right-radius: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(255, 154, 162, 0.3);
            position: relative;
        }

        h1 { margin: 0; font-size: 1.5rem; font-weight: 700; }
        .subtitle { font-size: 0.9rem; opacity: 0.95; margin-top: 5px; }
        
        .cloud-status {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 0.8rem;
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 10px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            padding: 0 15px;
            gap: 10px;
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--white);
            padding-top: 10px;
            padding-bottom: 10px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: var(--gray);
            border-radius: 12px;
            font-size: 1rem;
            color: #888;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 10px rgba(255, 154, 162, 0.4);
        }

        /* Views */
        .view { display: none; padding: 0 20px; animation: fadeIn 0.3s ease; }
        .view.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Checklist Styles --- */
        .progress-container {
            background: #eee;
            border-radius: 10px;
            height: 12px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .progress-bar {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.4s ease;
        }
        .progress-text {
            text-align: right; font-size: 0.85rem; color: var(--primary);
            font-weight: bold; margin-bottom: 15px;
        }
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        input[type="text"] {
            flex: 1; padding: 12px; border: 2px solid #eee; border-radius: 12px;
            font-size: 1rem; outline: none;
        }
        input[type="text"]:focus { border-color: var(--primary); }
        button.add-btn {
            background: var(--primary); color: white; border: none; width: 45px;
            border-radius: 12px; font-size: 1.5rem; cursor: pointer;
        }
        button.add-btn:disabled { background: #ccc; cursor: not-allowed; }

        ul { list-style: none; padding: 0; }
        li {
            background: white; border: 1px solid #f5f5f5; margin-bottom: 8px;
            padding: 12px 15px; border-radius: 12px; display: flex;
            align-items: center; justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            transition: opacity 0.3s;
        }
        li.completed .text { text-decoration: line-through; color: #bbb; }
        .check-area { display: flex; align-items: center; gap: 12px; flex: 1; cursor: pointer; }
        .custom-checkbox {
            width: 22px; height: 22px; border: 2px solid var(--primary);
            border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;
            transition: all 0.2s;
        }
        li.completed .custom-checkbox { background: var(--primary); }
        li.completed .custom-checkbox::after { content: 'âœ“'; color: white; font-size: 14px; }
        .tag { font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; background: #eee; color: #666; margin-bottom: 4px; display: inline-block; }
        .item-text-wrapper { display: flex; flex-direction: column; }
        .delete-btn { background: none; border: none; color: #eee; font-size: 1.5rem; padding: 0 10px; cursor: pointer; }
        .delete-btn:hover { color: var(--primary); }

        /* --- Accordion Guide Styles --- */
        details {
            background: white;
            border: 1px solid #eee;
            border-radius: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
            overflow: hidden;
            transition: all 0.3s;
        }

        details[open] {
            border-color: var(--secondary);
            box-shadow: 0 4px 12px rgba(181, 234, 215, 0.4);
        }

        summary {
            padding: 15px;
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
            list-style: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #fff;
        }

        summary::-webkit-details-marker { display: none; }
        summary::after { content: '+'; font-size: 1.5rem; color: var(--primary); font-weight: 300; }
        details[open] summary::after { content: '-'; }
        details[open] summary { border-bottom: 1px solid #f0f0f0; background: #fafafa;}

        .step-content { padding: 20px; background: #fff; }
        .guide-step { position: relative; padding-left: 20px; margin-bottom: 15px; border-left: 2px solid #eee; }
        .guide-step strong { display: block; color: #333; margin-bottom: 4px; }
        .guide-step p { margin: 0; font-size: 0.95rem; color: #666; }
        
        .highlight-box {
            background: #FFF5F5;
            border-left: 4px solid var(--primary);
            padding: 10px;
            margin: 10px 0;
            font-size: 0.9rem;
            color: #555;
            border-radius: 4px;
        }

        .vjw-guide {
            background: #F0F7FF;
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
            border: 1px solid #BEE3F8;
        }

        .reset-btn { color: #999; background: none; border: 1px solid #ddd; padding: 8px 16px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; margin-top: 30px; display: block; margin-left: auto; margin-right: auto;}
        
        /* Loading Overlay */
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 2000;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            color: var(--primary);
        }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 200; }
        .modal { background: white; padding: 25px; border-radius: 15px; width: 80%; max-width: 320px; text-align: center; }
        .modal-btns { display: flex; gap: 10px; margin-top: 20px; }
        .btn { padding: 10px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; flex: 1; }
        .btn-confirm { background: var(--primary); color: white; }
        .btn-cancel { background: #eee; color: #666; }

    </style>
</head>
<body>

<div id="loadingOverlay">
    <h2>â˜ï¸ é€£ç·šä¸­...</h2>
    <p>æ­£åœ¨åŒæ­¥é›²ç«¯è³‡æ–™åº«</p>
</div>

<div class="container">
    <header>
        <h1>âœˆï¸ åŒ—æµ·é“è¿½æ„›ï¼šé›²ç«¯ç‰ˆ</h1>
        <div class="subtitle">è³‡æ–™è‡ªå‹•å‚™ä»½ï¼Œæ›æ‰‹æ©Ÿä¹Ÿèƒ½çœ‹ï¼</div>
        <div class="cloud-status" id="cloudStatus">é€£ç·šä¸­...</div>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('checklist')">âœ… æº–å‚™æ¸…å–®</button>
        <button class="tab-btn" onclick="switchTab('guide')">ğŸ“˜ å…¨ç¨‹æ”»ç•¥</button>
    </div>

    <!-- View 1: Checklist -->
    <div id="view-checklist" class="view active">
        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        <div class="progress-text" id="progressText">æº–å‚™é€²åº¦ï¼š0%</div>

        <div class="input-group">
            <input type="text" id="itemInput" placeholder="æ–°å¢å¾…è¾¦äº‹é …...">
            <button class="add-btn" id="addBtn" disabled>+</button>
        </div>

        <ul id="itemList">
            <!-- Items injected by JS -->
        </ul>

        <button class="reset-btn" onclick="showResetModal()">âš ï¸ æ¢å¾©é è¨­æ¸…å–®</button>
    </div>

    <!-- View 2: Full Guide -->
    <div id="view-guide" class="view">
        <p style="text-align: center; color: #666; font-size: 0.9rem; margin-bottom: 20px;">ğŸ‘‡ é»æ“Šæ¨™é¡Œå±•é–‹æ­¥é©Ÿ ğŸ‘‡</p>

        <!-- Stage 1 -->
        <details open>
            <summary>ç¬¬ 1 éšæ®µï¼šå‡ºç™¼å‰æº–å‚™</summary>
            <div class="step-content">
                <div class="guide-step">
                    <strong>1. æª¢æŸ¥è­·ç…§</strong>
                    <p>ç¢ºèªæ•ˆæœŸé‚„æœ‰ 6 å€‹æœˆä»¥ä¸Šã€‚</p>
                </div>
                <div class="guide-step">
                    <strong>2. å¡«å¯« Visit Japan Web (VJW)</strong>
                    <p>é€™æœ€é‡è¦ï¼å‡ºç™¼å‰å¹¾å¤©ä¸€å®šè¦åšã€‚</p>
                    <div class="vjw-guide">
                        <strong>ğŸ“Œ VJW å¡«å¯«é‡é» (ä½ç”·å‹å®¶)ï¼š</strong><br>
                        <ul>
                            <li><strong>éƒµéå€è™Ÿï¼š</strong>å•ç”·å‹ (å¦‚ 060-0001)</li>
                            <li><strong>åœ°å€ï¼š</strong>å¡«å®Œæ•´è‹±æ–‡åœ°å€</li>
                            <li><strong>ä½å®¿åç¨±ï¼š</strong>å¡«ç”·å‹åå­— (Mr. XXX's House)</li>
                            <li><strong>é›»è©±ï¼š</strong>å¡«ç”·å‹æ‰‹æ©Ÿ</li>
                        </ul>
                        <br>
                        <strong>ğŸ‘‰ æœ€å¾Œä¸€å®šè¦æˆªåœ–é‚£å€‹é»ƒ/è—è‰²çš„ QR Codeï¼</strong>
                    </div>
                </div>
                <div class="guide-step">
                    <strong>3. å‚™ä»½è³‡æ–™</strong>
                    <p>æŠŠç”·å‹é›»è©±ã€åœ°å€ã€å›ç¨‹æ©Ÿç¥¨è³‡è¨Šéƒ½æˆªåœ–å­˜æ‰‹æ©Ÿã€‚</p>
                </div>
            </div>
        </details>

        <!-- Stage 2 -->
        <details>
            <summary>ç¬¬ 2 éšæ®µï¼šæ•´ç†è¡Œæ (å†¬å¤©ç‰ˆ)</summary>
            <div class="step-content">
                <div class="highlight-box">
                    ğŸ’¡ å£è¨£ï¼šå¤–åšå…§è–„ï¼å®¤å…§æš–æ°£å¾ˆå¼·ï¼Œä¸è¦ç©¿å¤ªé›£è„«çš„é«˜é ˜æ¯›è¡£ã€‚
                </div>
                <div class="guide-step">
                    <strong>1. å¿…å‚™è¡£ç‰©</strong>
                    <p>é•·ç‰ˆç¾½çµ¨å¤–å¥—ã€ç™¼ç†±è¡£ã€é˜²æ»‘é˜²æ°´é›ªé´(æœ€é‡è¦)ã€æ¯›å¸½ã€åœå·¾ã€æ‰‹å¥—(æœ€å¥½é˜²æ°´)ã€‚</p>
                </div>
                <div class="guide-step">
                    <strong>2. æ¶²é«”èˆ‡é›»æ± </strong>
                    <p>ğŸ‘‰ <strong>è¡Œå‹•é›»æºï¼š</strong>ä¸€å®šè¦æ”¾éš¨èº«åŒ…åŒ… (ä¸å¯è¨—é‹)ã€‚</p>
                    <p>ğŸ‘‰ <strong>è¶…é100mlæ¶²é«”ï¼š</strong>ä¸€å®šè¦æ”¾è¡Œæç®±è¨—é‹ã€‚</p>
                </div>
            </div>
        </details>

        <!-- Stage 3 -->
        <details>
            <summary>ç¬¬ 3 éšæ®µï¼šå°ç£æ©Ÿå ´å‡ºç™¼ ğŸ‡¹ğŸ‡¼</summary>
            <div class="step-content">
                <div class="highlight-box">
                    ğŸ•’ å»ºè­°èµ·é£›å‰ 2.5 ~ 3 å°æ™‚æŠµé”æ©Ÿå ´ã€‚
                </div>
                <div class="guide-step">
                    <strong>1. å ±åˆ° (Check-in)</strong>
                    <p>æ‰¾èˆªç©ºæ«ƒå°ï¼Œçµ¦è­·ç…§ï¼Œæ›å¤§è¡Œæç®±ã€‚</p>
                    <p><i>ç¢ºèªè¡Œæç®±éäº†Xå…‰æ©Ÿå†é›¢é–‹æ«ƒå°ã€‚</i></p>
                </div>
                <div class="guide-step">
                    <strong>2. å®‰å…¨æª¢æŸ¥ (Security)</strong>
                    <p>æ’éšŠæª¢æŸ¥éš¨èº«åŒ…ã€‚</p>
                    <p>ğŸ‘‰ æ°´å£ºçš„æ°´è¦å€’æ‰ï¼ç­†é›»ã€å¹³æ¿æ‹¿å‡ºä¾†ã€‚</p>
                </div>
                <div class="guide-step">
                    <strong>3. è­‰ç…§æŸ¥é©— (Immigration)</strong>
                    <p>èµ°ã€Œè‡ªå‹•é€šé—œã€é–˜é–€ï¼Œåˆ·è­·ç…§ã€çœ‹é¡é ­ï¼Œé€šéï¼</p>
                </div>
                <div class="guide-step">
                    <strong>4. å»ç™»æ©Ÿé–€ (Gate)</strong>
                    <p>çœ‹ç™»æ©Ÿè­‰ä¸Šçš„ Gate è™Ÿç¢¼ï¼Œå»é‚£é‚Šç­‰é£›æ©Ÿã€‚</p>
                </div>
            </div>
        </details>

        <!-- Stage 4 -->
        <details>
            <summary>ç¬¬ 4 éšæ®µï¼šæŠµé”æ—¥æœ¬ (æœ€ç·Šå¼µçš„ï¼)</summary>
            <div class="step-content">
                <div class="highlight-box">
                    ä¸è¦æ€•ï¼Œè·Ÿè‘—æŒ‡æ¨™ã€Œåˆ°ç€ (Arrival)ã€èµ°å°±å¥½ã€‚
                </div>
                <div class="guide-step">
                    <strong>1. æª¢ç–« (Quarantine)</strong>
                    <p>é€šå¸¸èµ°éå»é«”æº«æ²’å•é¡Œå°±é€šéã€‚</p>
                </div>
                <div class="guide-step">
                    <strong>2. å…¥å¢ƒå¯©æŸ¥ (Immigration)</strong>
                    <p>èµ°åˆ°å¤–åœ‹äººé€šé“ã€‚</p>
                    <p>ğŸ‘‰ å‡ºç¤º <strong>VJW QR Code</strong> + è­·ç…§ã€‚</p>
                    <p>ğŸ‘‰ å£“æŒ‡ç´‹ã€çœ‹é¡é ­æ‹ç…§ã€‚</p>
                    <p>ğŸ‘‰ å•ä¾†å¹¹å˜›ï¼Ÿå›ç­” "Sightseeing" (è§€å…‰)ã€‚</p>
                </div>
                <div class="guide-step">
                    <strong>3. æ‹¿è¡Œæ (Baggage)</strong>
                    <p>çœ‹è¢å¹•æ‰¾èˆªç­è™Ÿç¢¼ï¼Œå»è½‰ç›¤æ‹¿è¡Œæã€‚</p>
                </div>
                <div class="guide-step">
                    <strong>4. ç¨…é—œæª¢æŸ¥ (Customs)</strong>
                    <p>æ¨è‘—è¡Œæå¾€å‡ºå£èµ°ã€‚</p>
                    <p>ğŸ‘‰ å†æ¬¡æƒæ <strong>VJW QR Code</strong> (èµ°é›»å­ç”³å ±é€šé“)ã€‚</p>
                </div>
                <div class="guide-step">
                    <strong>ğŸ‰ æˆåŠŸå…¥å¢ƒï¼</strong>
                    <p>é–€æ‰“é–‹ï¼Œå°±å¯ä»¥å»æ‰¾ç”·å‹äº†ï¼</p>
                </div>
            </div>
        </details>

        <!-- Stage 5 -->
        <details>
            <summary>ç¬¬ 5 éšæ®µï¼šå¿«æ¨‚å›å°ç£ ğŸ </summary>
            <div class="step-content">
                <div class="guide-step">
                    <strong>1. åˆ°æ—¥æœ¬æ©Ÿå ´</strong>
                    <p>æµç¨‹è·Ÿå°ç£ä¸€æ¨£ï¼šCheck-in -> å®‰æª¢ -> å‡ºå¢ƒå¯©æŸ¥ã€‚</p>
                </div>
                <div class="guide-step">
                    <strong>2. æŠµé”å°ç£</strong>
                    <p>ä¸‹é£›æ©Ÿ -> èµ°è‡ªå‹•é€šé—œå…¥å¢ƒ -> æ‹¿è¡Œæã€‚</p>
                </div>
                <div class="highlight-box">
                    ğŸš¨ <strong>çµ•å°ä¸å¯ä»¥å¸¶ï¼š</strong><br>
                    æ–°é®®æ°´æœã€è”¬èœã€è‚‰é¡è£½å“ (ç«è…¿ã€é¦™è…¸ã€æ²’ç†Ÿçš„è›‹)ã€‚<br>
                    è¢«æŠ“åˆ°ç½°éŒ¢ç½°å¾ˆé‡å–”ï¼
                </div>
            </div>
        </details>

    </div>
</div>

<!-- Modal -->
<div id="confirmModal" class="modal-overlay">
    <div class="modal">
        <h3>âš ï¸ ç¢ºå®šé‡ç½®ï¼Ÿ</h3>
        <p style="color:#666; font-size: 0.9rem; margin-bottom: 20px;">é€™æœƒåˆªé™¤å¦³æ‰€æœ‰çš„é›²ç«¯ç´€éŒ„ï¼Œæ¢å¾©æˆé è¨­å€¼ã€‚</p>
        <div class="modal-btns">
            <button class="btn btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
            <button class="btn btn-confirm" onclick="confirmReset()">ç¢ºå®šé‡ç½®</button>
        </div>
    </div>
</div>

<script type="module">
    // 1. Import Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // 2. Configuration (User Provided)
    const firebaseConfig = {
        apiKey: "AIzaSyDFUGYOobmVxYFQMBYz1iQ4z1HIrdbTi8Q",
        authDomain: "travel-55c4b.firebaseapp.com",
        databaseURL: "https://travel-55c4b-default-rtdb.firebaseio.com",
        projectId: "travel-55c4b",
        storageBucket: "travel-55c4b.firebasestorage.app",
        messagingSenderId: "925227625640",
        appId: "1:925227625640:web:7966e45422a9979ff8a69d",
        measurementId: "G-N5V8NBGEHZ"
    };

    // 3. Initialize
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Default Data
    const defaultData = [
        { text: "æª¢æŸ¥è­·ç…§æ•ˆæœŸ (6å€‹æœˆä»¥ä¸Š)", done: false, cat: "å¿…å‚™" },
        { text: "å¡«å¯« Visit Japan Web (å–å¾—QR Code)", done: false, cat: "å¿…å‚™" },
        { text: "æˆªåœ–ï¼šç”·å‹åœ°å€ã€é›»è©±ã€VJW QR", done: false, cat: "å¿…å‚™" },
        { text: "è²·ç¶²å¡/é–‹æ¼«éŠ", done: false, cat: "ç¶²è·¯" },
        { text: "æ›æ—¥å¹£ & æº–å‚™ä¿¡ç”¨å¡", done: false, cat: "éŒ¢åŒ…" },
        { text: "ç¾½çµ¨å¤–å¥— (è“‹å±è‚¡)", done: false, cat: "è¡£ç‰©" },
        { text: "é˜²æ°´é›ªé´ + åšè¥ªå­", done: false, cat: "è¡£ç‰©" },
        { text: "æ‰‹å¥—ã€åœå·¾ã€æ¯›å¸½", done: false, cat: "è¡£ç‰©" },
        { text: "èº«é«”ä¹³æ¶²ã€è­·å”‡è†", done: false, cat: "ä¿é¤Š" },
        { text: "è¡Œå‹•é›»æº (æ”¾éš¨èº«åŒ…)", done: false, cat: "éš¨èº«" },
        { text: "æ„Ÿå†’è—¥/æ­¢ç—›è—¥", done: false, cat: "éš¨èº«" }
    ];

    // DOM Elements
    const itemList = document.getElementById('itemList');
    const input = document.getElementById('itemInput');
    const addBtn = document.getElementById('addBtn');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const modal = document.getElementById('confirmModal');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const cloudStatus = document.getElementById('cloudStatus');

    let currentUser = null;
    let localItems = [];

    // 4. Authentication & Data Listener
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            cloudStatus.innerText = "â˜ï¸ å·²é€£ç·š";
            addBtn.disabled = false;
            
            // Listen to data
            const q = query(collection(db, 'users', user.uid, 'checklist'), orderBy('createdAt', 'desc'));
            
            onSnapshot(q, async (snapshot) => {
                localItems = [];
                snapshot.forEach((doc) => {
                    localItems.push({ id: doc.id, ...doc.data() });
                });

                // If empty (first login), load defaults
                if (localItems.length === 0 && !snapshot.metadata.hasPendingWrites) {
                     await loadDefaults(user.uid);
                } else {
                    render(localItems);
                    loadingOverlay.style.display = 'none';
                }
            });

        } else {
            // Sign in anonymously if not signed in
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Auth Error:", error);
                alert("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");
            }
        }
    });

    // Helper: Load Defaults
    async function loadDefaults(uid) {
        const batch = writeBatch(db);
        defaultData.forEach(item => {
            const docRef = doc(collection(db, 'users', uid, 'checklist'));
            batch.set(docRef, { ...item, createdAt: serverTimestamp() });
        });
        await batch.commit();
    }

    // 5. Render
    function render(items) {
        itemList.innerHTML = '';
        let completedCount = 0;

        items.forEach((item) => {
            if(item.done) completedCount++;
            
            const li = document.createElement('li');
            li.className = item.done ? 'completed' : '';
            
            li.innerHTML = `
                <div class="check-area" onclick="toggleItem('${item.id}', ${item.done})">
                    <div class="custom-checkbox"></div>
                    <div class="item-text-wrapper">
                        ${item.cat ? `<span class="tag">${item.cat}</span>` : ''}
                        <span class="text">${item.text}</span>
                    </div>
                </div>
                <button class="delete-btn" onclick="deleteItem('${item.id}')">Ã—</button>
            `;
            itemList.appendChild(li);
        });

        const percent = items.length === 0 ? 0 : Math.round((completedCount / items.length) * 100);
        progressBar.style.width = percent + '%';
        progressText.innerText = `æº–å‚™é€²åº¦ï¼š${percent}%`;
    }

    // 6. Actions (Interact with Firestore)
    window.toggleItem = async (id, currentStatus) => {
        if(!currentUser) return;
        const itemRef = doc(db, 'users', currentUser.uid, 'checklist', id);
        await updateDoc(itemRef, { done: !currentStatus });
    }

    window.deleteItem = async (id) => {
        if(!currentUser) return;
        if(confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹é …ç›®å—ï¼Ÿ')) {
            await deleteDoc(doc(db, 'users', currentUser.uid, 'checklist', id));
        }
    }

    async function addItem() {
        if(!currentUser) return;
        const text = input.value.trim();
        if (text) {
            await addDoc(collection(db, 'users', currentUser.uid, 'checklist'), {
                text: text,
                done: false,
                cat: "æ–°å¢",
                createdAt: serverTimestamp()
            });
            input.value = '';
        }
    }

    // Modal & Reset Logic
    window.showResetModal = () => modal.style.display = 'flex';
    window.closeModal = () => modal.style.display = 'none';
    
    window.confirmReset = async () => {
        if(!currentUser) return;
        closeModal();
        loadingOverlay.style.display = 'flex';
        loadingOverlay.innerHTML = "<h2>ğŸ”„ é‡ç½®ä¸­...</h2>";
        
        // Delete all existing
        const q = query(collection(db, 'users', currentUser.uid, 'checklist'));
        const snapshot = await getDocs(q);
        const batch = writeBatch(db);
        snapshot.forEach(doc => {
            batch.delete(doc.ref);
        });
        await batch.commit();
        
        // Load defaults will be triggered by onSnapshot automatically if array is empty? 
        // No, because we handle that in onSnapshot logic, but let's force it to be safe or just let the empty snapshot trigger it.
        // Actually, our onSnapshot logic adds defaults if empty. 
        // So deleting everything will trigger "empty" snapshot -> adds defaults.
        
        // Give a small delay for UI
        setTimeout(() => {
             loadingOverlay.style.display = 'none';
        }, 1000);
    }

    // Tab Logic (Same as before)
    window.switchTab = function(tabName) {
        document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(`view-${tabName}`).classList.add('active');
        
        const btns = document.querySelectorAll('.tab-btn');
        if(tabName === 'checklist') btns[0].classList.add('active');
        else btns[1].classList.add('active');
    }

    // Init
    addBtn.addEventListener('click', addItem);
    input.addEventListener('keypress', (e) => { if (e.key === 'Enter') addItem(); });
    modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

</script>
</body>
</html>