<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é†«ç¾å°ç§˜æ›¸ v12 (æ”¯æ´è²¼ä¸Šåœ–ç‰‡)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #FDF2F8; touch-action: manipulation; }
        .card-shadow { box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .upload-box {
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='12' ry='12' stroke='%23FDA4AF' stroke-width='2' stroke-dasharray='6%2c 6' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
            transition: all 0.3s;
            cursor: pointer;
            outline: none; /* ç§»é™¤é è¨­è—è‰²æ¡† */
        }
        .upload-box:active, .upload-box:focus { 
            background-color: #FFF1F2; 
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='12' ry='12' stroke='%23F43F5E' stroke-width='2' stroke-dasharray='0' stroke-linecap='square'/%3e%3c/svg%3e");
        }
        
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); z-index: 999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .tag { @apply px-2 py-0.5 rounded text-[10px] font-bold mr-1 mb-1 inline-block; }
    </style>
</head>
<body class="text-gray-700 h-screen overflow-hidden flex justify-center">

<div id="app" class="w-full max-w-md h-full bg-white shadow-2xl relative flex flex-col">
    
    <!-- Loading Screen -->
    <div v-if="loading" class="loading-overlay">
        <i class="fas fa-circle-notch fa-spin text-4xl text-rose-400 mb-2"></i>
        <p class="text-rose-500 font-bold">é›²ç«¯åŒæ­¥ä¸­...</p>
    </div>

    <!-- Header -->
    <header class="bg-gradient-to-r from-rose-400 to-pink-500 text-white p-6 pt-8 rounded-b-3xl shadow-lg shrink-0 z-20">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h1 class="text-2xl font-bold tracking-wide">Beauty Manager</h1>
                <p class="text-xs text-rose-100 flex items-center">
                    <span class="w-2 h-2 bg-green-400 rounded-full mr-1 animate-pulse"></span> ç—‡ç‹€å°ç­–è³‡æ–™åº«
                </p>
            </div>
            <div class="text-right bg-white/20 p-2 rounded-lg backdrop-blur-sm">
                <p class="text-[10px] text-rose-100 uppercase">Total Spent</p>
                <p class="text-xl font-bold">NT$ {{ formatMoney(totalSpent) }}</p>
            </div>
        </div>
        
        <div class="flex bg-black/10 p-1 rounded-xl backdrop-blur-md">
            <button @click="switchTab('wiki')" :class="['flex-1 py-2 rounded-lg text-xs font-bold transition', currentTab === 'wiki' ? 'bg-white text-rose-500 shadow' : 'text-white/70']">
                <i class="fas fa-search mr-1"></i> ç™¾ç§‘
            </button>
            <button @click="switchTab('clinics')" :class="['flex-1 py-2 rounded-lg text-xs font-bold transition', currentTab === 'clinics' ? 'bg-white text-rose-500 shadow' : 'text-white/70']">
                <i class="fas fa-store mr-1"></i> ç´…é»‘æ¦œ
            </button>
            <button @click="switchTab('records')" :class="['flex-1 py-2 rounded-lg text-xs font-bold transition', currentTab === 'records' ? 'bg-white text-rose-500 shadow' : 'text-white/70']">
                <i class="fas fa-camera mr-1"></i> ç´€éŒ„
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex-1 overflow-y-auto bg-gray-50 pb-20 relative">

        <!-- TAB 1: ç™¾ç§‘ (æœå°‹èˆ‡åˆ—è¡¨) -->
        <div v-if="currentTab === 'wiki'" class="p-4 space-y-4">
            <div v-if="!selectedWikiItem">
                <!-- æœå°‹æ¡† -->
                <div class="sticky top-0 bg-gray-50 z-10 pb-2">
                    <div class="relative">
                        <i class="fas fa-search absolute left-4 top-3.5 text-gray-400 text-sm"></i>
                        <input v-model="wikiSearchQuery" placeholder="è¼¸å…¥ç—‡ç‹€ (å¦‚: æ³•ä»¤ç´‹ã€æ¯›å­”ã€ä¸‹å‚)" class="w-full pl-10 pr-4 py-3 rounded-xl border border-gray-200 focus:border-rose-300 outline-none shadow-sm text-sm">
                        <button v-if="wikiSearchQuery" @click="wikiSearchQuery=''" class="absolute right-3 top-3.5 text-gray-400 hover:text-gray-600"><i class="fas fa-times-circle"></i></button>
                    </div>
                </div>

                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-sm font-bold text-gray-500 pl-2 border-l-4 border-rose-400">{{ wikiSearchQuery ? 'ç¬¦åˆç—‡ç‹€çš„é …ç›®' : 'é†«ç¾é …ç›®æ¸…å–®' }}</h2>
                    <div class="flex gap-2">
                        <button @click="cleanDuplicates" class="text-xs bg-rose-100 text-rose-600 px-3 py-1 rounded-full hover:bg-rose-200"><i class="fas fa-broom mr-1"></i>æ¸…ç†é‡è¤‡</button>
                        <button @click="createNewWikiItem" class="text-xs bg-gray-200 text-gray-600 px-3 py-1 rounded-full"><i class="fas fa-plus"></i> è‡ªè¨‚</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-3">
                    <div v-if="filteredWikiList.length === 0" class="text-center py-10 text-gray-400">
                        <i class="far fa-sad-tear text-2xl mb-2"></i>
                        <p class="text-xs">æ‰¾ä¸åˆ°é—œæ–¼ã€Œ{{ wikiSearchQuery }}ã€çš„è§£æ±ºæ–¹æ¡ˆ</p>
                    </div>

                    <div v-for="item in filteredWikiList" :key="item.id" @click="openWikiDetail(item)" 
                        class="bg-white p-4 rounded-xl card-shadow border border-gray-100 hover:border-rose-300 transition cursor-pointer group relative overflow-hidden">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <span class="text-[10px] text-white bg-rose-400 px-2 py-0.5 rounded mb-1 inline-block font-bold">{{ item.category }}</span>
                                <h3 class="font-bold text-gray-800 text-lg">{{ item.title }}</h3>
                            </div>
                            <i class="fas fa-chevron-right text-gray-300 mt-2"></i>
                        </div>
                        <div class="flex flex-wrap mb-2">
                            <span v-for="sym in (item.symptoms || [])" :key="sym" class="bg-rose-50 text-rose-500 text-[10px] px-2 py-1 rounded-full mr-1 mb-1">#{{ sym }}</span>
                        </div>
                        <div v-if="item.photo" class="h-20 w-full rounded-lg bg-gray-100 bg-cover bg-center mb-2" :style="{backgroundImage: 'url(' + item.photo + ')'}"></div>
                        <div class="flex justify-between items-center border-t border-gray-100 pt-2">
                            <span class="text-xs font-bold text-gray-500">ğŸ’° {{ item.price }}</span>
                            <span v-if="item.quotes && item.quotes.length > 0" class="text-[10px] text-gray-400"><i class="fas fa-pen"></i> {{ item.quotes.length }} ç­†è©¢åƒ¹</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç™¾ç§‘è©³æƒ…é  -->
            <div v-else class="bg-white min-h-full rounded-t-3xl shadow-inner animate-slide-up pb-10">
                <div class="sticky top-0 bg-white z-10 p-4 border-b border-gray-100 flex items-center justify-between rounded-t-3xl">
                    <button @click="closeWikiDetail" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center"><i class="fas fa-arrow-left"></i></button>
                    <span class="font-bold text-gray-800 truncate">{{ selectedWikiItem.title }}</span>
                    <button @click="deleteWikiItem" class="text-red-300"><i class="fas fa-trash"></i></button>
                </div>
                
                <div class="p-5 space-y-6">
                    <!-- 1. ç…§ç‰‡å€ (æ”¯æ´è²¼ä¸Š) -->
                    <div class="w-full h-40 rounded-xl overflow-hidden bg-gray-50 border-2 border-dashed border-rose-200 flex items-center justify-center upload-box relative"
                         tabindex="0"
                         @paste="handlePaste($event, 'wiki')"
                         :style="selectedWikiItem.photo ? {backgroundImage: 'url(' + selectedWikiItem.photo + ')', backgroundSize: 'contain', backgroundRepeat: 'no-repeat', backgroundPosition: 'center', border: 'none'} : {}">
                        
                        <label v-if="!selectedWikiItem.photo" class="absolute inset-0 flex flex-col items-center justify-center cursor-pointer text-gray-400 hover:text-rose-400 pointer-events-none">
                            <i class="fas fa-image text-3xl mb-1"></i>
                            <span class="text-xs">é»æ“Šæ­¤è™• -> æŒ‰ Ctrl+V è²¼ä¸Š</span>
                            <span class="text-[10px] mt-1 text-gray-300">(æˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ)</span>
                        </label>
                        <!-- éš±è—çš„ input ä¾ç„¶ä¿ç•™ï¼Œçµ¦æ‰‹æ©Ÿé»æ“Šç”¨ -->
                        <input type="file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" @change="(e) => processFile(e.target.files[0], 'wiki')">
                        
                        <button v-if="selectedWikiItem.photo" @click.stop="deleteWikiPhoto" class="absolute top-2 right-2 bg-white/80 p-1 rounded-full text-red-500 z-10 hover:bg-white"><i class="fas fa-trash"></i></button>
                    </div>

                    <!-- 2. æ ¸å¿ƒäº”å¤§ç¶­åº¦ -->
                    <div class="space-y-4">
                        <div class="bg-rose-50 p-3 rounded-xl border border-rose-100">
                            <label class="text-xs font-bold text-rose-500 uppercase mb-1 block"><i class="fas fa-bullseye mr-1"></i> é©æ‡‰ç—‡ (Symptoms)</label>
                            <input v-model="selectedWikiItem.symptomsStr" @change="updateWikiItem(selectedWikiItem)" class="w-full bg-white px-2 py-1 rounded text-sm border border-rose-200" placeholder="ç”¨é€—è™Ÿåˆ†éš”ï¼Œå¦‚: æ³•ä»¤ç´‹, é¬†å¼›">
                            <div class="flex flex-wrap mt-2 gap-1">
                                <span v-for="sym in (selectedWikiItem.symptoms || [])" :key="sym" class="bg-white text-rose-400 border border-rose-200 text-[10px] px-2 py-0.5 rounded-full">{{ sym }}</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-gray-50 p-3 rounded-xl border border-gray-100">
                                <label class="text-xs font-bold text-gray-500 uppercase mb-1 block"><i class="fas fa-hourglass-half mr-1"></i> ç¶­æŒå¤šä¹…</label>
                                <input v-model="selectedWikiItem.duration" @change="updateWikiItem(selectedWikiItem)" class="w-full bg-transparent border-b border-gray-300 text-sm focus:border-rose-400 outline-none">
                            </div>
                            <div class="bg-gray-50 p-3 rounded-xl border border-gray-100">
                                <label class="text-xs font-bold text-gray-500 uppercase mb-1 block"><i class="fas fa-band-aid mr-1"></i> ä¿®å¾©æœŸ</label>
                                <input v-model="selectedWikiItem.recovery" @change="updateWikiItem(selectedWikiItem)" class="w-full bg-transparent border-b border-gray-300 text-sm focus:border-rose-400 outline-none">
                            </div>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-xl border border-gray-100">
                            <label class="text-xs font-bold text-gray-500 uppercase mb-1 block"><i class="fas fa-microchip mr-1"></i> åŸç† / ç­†è¨˜</label>
                            <textarea v-model="selectedWikiItem.desc" @change="updateWikiItem(selectedWikiItem)" class="w-full bg-white border border-gray-200 rounded-lg p-2 text-sm h-20"></textarea>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-xl border border-gray-100 flex items-center gap-2">
                             <label class="text-xs font-bold text-gray-500 uppercase whitespace-nowrap"><i class="fas fa-tag mr-1"></i> å¸‚åƒ¹åƒè€ƒ</label>
                             <input v-model="selectedWikiItem.price" @change="updateWikiItem(selectedWikiItem)" class="flex-1 bg-transparent border-b border-gray-300 text-sm focus:border-rose-400 outline-none">
                        </div>
                    </div>

                    <!-- 3. æ¯”åƒ¹ç´€éŒ„ -->
                    <div>
                        <div class="flex justify-between items-end mb-3">
                            <label class="text-xs font-bold text-rose-400 uppercase">æˆ‘çš„è©¢åƒ¹ç´€éŒ„</label>
                        </div>
                        <div class="bg-yellow-50 p-3 rounded-xl border border-yellow-100 mb-3">
                            <div class="flex gap-2 mb-2">
                                <input v-model="newQuote.clinic" placeholder="è¨ºæ‰€" class="w-1/2 p-2 text-sm rounded border border-yellow-200">
                                <input v-model="newQuote.price" type="number" placeholder="åƒ¹æ ¼" class="w-1/2 p-2 text-sm rounded border border-yellow-200">
                            </div>
                            <input v-model="newQuote.note" placeholder="å‚™è¨» (å¦‚:é€ä¿æ¿•)" class="w-full p-2 text-sm rounded border border-yellow-200 mb-2">
                            <button @click="addQuote" class="w-full bg-yellow-500 text-white text-xs font-bold py-2 rounded shadow-sm">æ–°å¢æ¯”åƒ¹</button>
                        </div>
                        <div class="space-y-2">
                            <div v-for="(q, idx) in selectedWikiItem.quotes" :key="idx" class="flex justify-between items-center bg-white border border-gray-100 p-3 rounded-xl">
                                <div><div class="font-bold text-sm">{{ q.clinic }}</div><div class="text-xs text-gray-400">{{ q.note }}</div></div>
                                <div class="text-right"><div class="font-bold text-rose-500">${{ formatMoney(q.price) }}</div><button @click="removeQuote(idx)" class="text-[10px] text-gray-300">åˆªé™¤</button></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 2: ç´…é»‘æ¦œ -->
        <div v-if="currentTab === 'clinics'" class="p-4 space-y-4">
             <div class="flex gap-2 pb-2">
                <button @click="clinicFilter = 'all'" :class="['flex-1 py-1 text-xs font-bold border rounded-full', clinicFilter==='all'?'bg-gray-800 text-white':'bg-white']">å…¨éƒ¨</button>
                <button @click="clinicFilter = 'good'" :class="['flex-1 py-1 text-xs font-bold border rounded-full', clinicFilter==='good'?'bg-rose-500 text-white':'bg-white']">ç´…æ¦œ</button>
                <button @click="clinicFilter = 'bad'" :class="['flex-1 py-1 text-xs font-bold border rounded-full', clinicFilter==='bad'?'bg-gray-500 text-white':'bg-white']">é»‘æ¦œ</button>
            </div>
            <button @click="showAddClinic=!showAddClinic" class="w-full py-2 bg-white border border-rose-200 text-rose-500 rounded-xl text-sm font-bold">æ–°å¢è©•åƒ¹</button>
            <div v-if="showAddClinic" class="bg-white p-4 rounded-xl shadow border-t-4 border-rose-400 animate-fade-in">
                <input v-model="newClinic.name" placeholder="è¨ºæ‰€åç¨±" class="w-full bg-gray-50 p-2 mb-2 text-sm rounded">
                <div class="flex gap-2 mb-2">
                    <select v-model="newClinic.location" class="w-1/2 bg-gray-50 p-2 text-sm rounded"><option value="å°åŒ—">å°åŒ—</option><option value="é«˜é›„">é«˜é›„</option><option value="éŸ“åœ‹">éŸ“åœ‹</option></select>
                    <select v-model="newClinic.status" class="w-1/2 bg-gray-50 p-2 text-sm rounded"><option value="good">æ¨è–¦</option><option value="bad">é¿é›·</option></select>
                </div>
                <textarea v-model="newClinic.note" placeholder="è©•åƒ¹..." class="w-full bg-gray-50 p-2 text-sm rounded mb-2"></textarea>
                <button @click="addClinic" class="w-full bg-rose-500 text-white py-2 rounded text-sm">å„²å­˜</button>
            </div>
            <div v-for="c in filteredClinics" :key="c.id" class="p-4 bg-white rounded-xl card-shadow border-l-4" :class="c.status==='good'?'border-rose-400':'border-gray-500'">
                <div class="flex justify-between items-start">
                    <h3 class="font-bold">{{c.name}} <span class="text-xs font-normal text-gray-500">@{{c.location}}</span></h3>
                    <div class="flex text-yellow-400 text-[10px]"><i v-for="n in 5" :key="n" :class="n <= c.rating ? 'fas fa-star' : 'far fa-star text-gray-300'"></i></div>
                </div>
                <p class="text-xs text-gray-500 mt-1">{{c.note || 'ç„¡å‚™è¨»'}}</p>
                <div class="flex justify-between mt-2"><span class="text-[10px] px-2 py-0.5 rounded bg-gray-100">{{c.status==='good'?'æ¨è–¦':'é¿é›·'}}</span><button @click="removeClinic(c.id)" class="text-gray-300"><i class="fas fa-trash"></i></button></div>
            </div>
        </div>

        <!-- TAB 3: ç´€éŒ„ -->
        <div v-if="currentTab === 'records'" class="p-4 space-y-4">
             <div class="bg-white p-5 rounded-2xl card-shadow border border-gray-100">
                <div class="flex gap-2 overflow-x-auto mb-3 pb-1 no-scrollbar">
                    <button v-for="m in members" :key="m" @click="newRecord.member = m"
                        :class="['px-4 py-1.5 whitespace-nowrap rounded-full text-xs font-bold border transition', newRecord.member === m ? 'bg-rose-500 text-white border-rose-500' : 'bg-white text-gray-500 border-gray-200']">
                        {{ m }}
                    </button>
                </div>
                <div class="space-y-2">
                    <input type="date" v-model="newRecord.date" class="w-full bg-gray-50 p-2 rounded-lg text-sm outline-none">
                    <input v-model="newRecord.item" placeholder="é …ç›® (ä¾‹: éŸ³æ³¢600ç™¼)" class="w-full bg-gray-50 p-2 rounded-lg text-sm outline-none">
                    <div class="flex gap-2">
                        <input type="number" v-model="newRecord.price" placeholder="é‡‘é¡" class="w-full bg-gray-50 p-2 rounded-lg text-sm outline-none">
                        <input v-model="newRecord.clinic" placeholder="è¨ºæ‰€" class="w-full bg-gray-50 p-2 rounded-lg text-sm outline-none">
                    </div>
                    <button @click="addRecord" class="w-full bg-gray-800 text-white py-2.5 rounded-xl font-bold shadow hover:bg-gray-900 mt-2">
                        <i class="fas fa-check mr-1"></i> è¨˜ä¸€ç­† (åŒæ­¥é›²ç«¯)
                    </button>
                </div>
            </div>

            <div class="space-y-4">
                <div v-for="rec in sortedRecords" :key="rec.id" class="bg-white rounded-2xl card-shadow overflow-hidden">
                    <div class="p-4 flex justify-between items-start relative">
                        <div class="flex items-start gap-3">
                            <div :class="['w-10 h-10 rounded-full flex items-center justify-center font-bold text-xs shadow-sm text-white shrink-0', 
                                rec.member === 'å­æ™´' ? 'bg-pink-400' : (rec.member === 'å­æ¶µ' ? 'bg-purple-400' : (rec.member === 'åª½åª½' ? 'bg-rose-500' : 'bg-gray-400'))]">
                                {{ rec.member.substring(0,2) }}
                            </div>
                            <div>
                                <div class="text-sm font-bold text-gray-800">{{ rec.item }}</div>
                                <div class="text-xs text-gray-400 mb-1">{{ rec.date }} <span v-if="rec.clinic">| {{ rec.clinic }}</span></div>
                                <div class="text-sm font-bold text-rose-500">NT$ {{ formatMoney(rec.price) }}</div>
                            </div>
                        </div>
                        <button @click="removeRecord(rec.id)" class="text-gray-300 hover:text-red-400"><i class="fas fa-trash-alt"></i></button>
                    </div>
                    <div v-if="rec.photos && (rec.photos.before || rec.photos.after)" class="flex border-t border-gray-100 bg-gray-50">
                        <div class="flex-1 h-24 bg-cover bg-center border-r border-gray-200 relative" :style="rec.photos.before ? {backgroundImage: 'url(' + rec.photos.before + ')'} : {}">
                            <span v-if="rec.photos.before" class="absolute bottom-0 left-0 bg-black/50 text-white text-[10px] px-1">Before</span>
                        </div>
                        <div class="flex-1 h-24 bg-cover bg-center relative" :style="rec.photos.after ? {backgroundImage: 'url(' + rec.photos.after + ')'} : {}">
                            <span v-if="rec.photos.after" class="absolute bottom-0 left-0 bg-rose-500/80 text-white text-[10px] px-1">After</span>
                        </div>
                    </div>
                    <button @click="openPhotoModal(rec)" class="w-full py-2 bg-rose-50 text-rose-500 text-xs font-bold hover:bg-rose-100 transition border-t border-rose-100 flex items-center justify-center gap-1">
                        <i class="fas fa-camera"></i> {{ (rec.photos && (rec.photos.before || rec.photos.after)) ? 'æŸ¥çœ‹å°æ¯”' : 'ä¸Šå‚³è¡“å‰è¡“å¾Œç…§' }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- PHOTO MODAL (COMMON) -->
    <div v-if="showPhotoModal && currentEditingRecord" class="absolute inset-0 z-50 bg-white flex flex-col animate-slide-up">
        <div class="bg-gray-800 text-white p-4 flex justify-between items-center shrink-0">
            <div><h3 class="font-bold">{{ currentEditingRecord.item }}</h3></div>
            <button @click="closePhotoModal" class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center"><i class="fas fa-times"></i></button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 bg-gray-100 flex flex-col gap-4">
            <!-- BEFORE BOX -->
            <div class="flex-1 bg-white p-3 rounded-xl shadow-sm flex flex-col">
                <div class="flex justify-between items-center mb-2"><span class="text-xs font-bold bg-gray-200 text-gray-600 px-2 py-1 rounded">BEFORE è¡“å‰</span><button v-if="currentEditingRecord.photos?.before" @click="deletePhoto('before')" class="text-red-400 text-xs"><i class="fas fa-trash"></i></button></div>
                <div class="flex-1 relative rounded-lg overflow-hidden bg-gray-50 border-2 border-dashed border-gray-300 flex items-center justify-center upload-box" 
                     tabindex="0"
                     @paste="handlePaste($event, 'record', 'before')"
                     :style="currentEditingRecord.photos?.before ? {backgroundImage: 'url(' + currentEditingRecord.photos.before + ')', backgroundSize: 'contain', backgroundRepeat: 'no-repeat', backgroundPosition: 'center', border: 'none'} : {}">
                    
                    <label v-if="!currentEditingRecord.photos?.before" class="absolute inset-0 flex flex-col items-center justify-center cursor-pointer text-gray-400 pointer-events-none">
                        <i class="fas fa-camera text-2xl mb-1"></i>
                        <span class="text-xs">é»æ“Š -> Ctrl+V è²¼ä¸Š</span>
                    </label>
                    <input type="file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" @change="(e) => processFile(e.target.files[0], 'record', 'before')">
                </div>
            </div>
            
            <!-- AFTER BOX -->
            <div class="flex-1 bg-white p-3 rounded-xl shadow-sm flex flex-col">
                <div class="flex justify-between items-center mb-2"><span class="text-xs font-bold bg-rose-500 text-white px-2 py-1 rounded">AFTER è¡“å¾Œ</span><button v-if="currentEditingRecord.photos?.after" @click="deletePhoto('after')" class="text-red-400 text-xs"><i class="fas fa-trash"></i></button></div>
                <div class="flex-1 relative rounded-lg overflow-hidden bg-gray-50 border-2 border-dashed border-rose-300 flex items-center justify-center upload-box" 
                     tabindex="0"
                     @paste="handlePaste($event, 'record', 'after')"
                     :style="currentEditingRecord.photos?.after ? {backgroundImage: 'url(' + currentEditingRecord.photos.after + ')', backgroundSize: 'contain', backgroundRepeat: 'no-repeat', backgroundPosition: 'center', border: 'none'} : {}">
                    
                    <label v-if="!currentEditingRecord.photos?.after" class="absolute inset-0 flex flex-col items-center justify-center cursor-pointer text-rose-400 pointer-events-none">
                        <i class="fas fa-camera text-2xl mb-1"></i>
                        <span class="text-xs">é»æ“Š -> Ctrl+V è²¼ä¸Š</span>
                    </label>
                    <input type="file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" @change="(e) => processFile(e.target.files[0], 'record', 'after')">
                </div>
            </div>
        </div>
    </div>

</div>

<!-- åˆä½µè…³æœ¬ï¼šåˆå§‹åŒ– Firebase ä¸¦å•Ÿå‹• Vue -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

    // 1. Firebase è¨­å®š
    const firebaseConfig = {
        apiKey: "AIzaSyDFUGYOobmVxYFQMBYz1iQ4z1HIrdbTi8Q",
        authDomain: "travel-55c4b.firebaseapp.com",
        databaseURL: "https://travel-55c4b-default-rtdb.firebaseio.com",
        projectId: "travel-55c4b",
        storageBucket: "travel-55c4b.firebasestorage.app",
        messagingSenderId: "925227625640",
        appId: "1:925227625640:web:e3421427e8006d65f8a69d",
        measurementId: "G-ES7SCGQ9P8"
    };

    // 2. åˆå§‹åŒ– Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const SHARED_APP_ID = 'beauty-manager-family'; 
    
    // æ›è¼‰åˆ° Window ä¾› Vue å…ƒä»¶ä½¿ç”¨
    window.db = db;
    window.auth = auth;
    window.firebaseOps = { collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp, signInAnonymously, onAuthStateChanged, SHARED_APP_ID };

    const { createApp } = Vue;

    // v10 å‡ç´šï¼šå®Œæ•´çš„ç—‡ç‹€èˆ‡è©³ç´°è³‡æ–™
    const defaultWikiData = [
        { 
            title: 'ç¾åœ‹éŸ³æ³¢ (Ulthera)', 
            category: 'æ‹‰æ', 
            symptoms: ['ä¸‹å‚', 'è¼ªå»“ç·šä¸æ˜é¡¯', 'é›™ä¸‹å·´', 'çœ¼çš®é¬†'], 
            principle: 'èšç„¦è¶…éŸ³æ³¢ç†±èƒ½ä½œç”¨æ–¼ç­‹è†œå±¤(SMAS)æ”¶ç¸®ï¼Œåƒé‡˜æ›¸æ©ŸæŠŠçš®è‚‰é‡˜ç·Š', 
            duration: '1~1.5 å¹´', 
            recovery: 'ç„¡å‚·å£ï¼Œå¾®ç´…è…«1-2å¤©', 
            price: '6~9 è¬', 
            desc: 'æ•ˆæœæœ€å¼·ï¼Œä½†ç—›æ„Ÿé«˜ã€‚æœ‰å³æ™‚é¡¯å½±æ¯”è¼ƒå®‰å…¨ã€‚é©åˆä¸‹é¡ç·šã€é›™ä¸‹å·´ã€‚', 
            quotes: [] 
        },
        // ... (å…¶ä»–è³‡æ–™ä¿æŒåŸæ¨£)
    ];

    createApp({
        data() {
            return {
                loading: true,
                currentTab: 'wiki',
                clinicFilter: 'all',
                showAddClinic: false,
                members: ['å­æ™´', 'å­æ¶µ', 'åª½åª½', 'å…¶ä»–'],
                selectedWikiItem: null,
                newQuote: { clinic: '', price: '', note: '' },
                
                wikiSearchQuery: '',
                wikiData: [],
                clinics: [],
                records: [],
                
                newClinic: { name: '', location: 'å°åŒ—', note: '', status: 'good', rating: 5 },
                newRecord: { member: 'å­æ™´', date: new Date().toISOString().split('T')[0], item: '', price: '', clinic: '' },
                showPhotoModal: false,
                currentEditingRecord: null,
            }
        },
        computed: {
            totalSpent() { return this.records.reduce((sum, item) => sum + Number(item.price), 0); },
            sortedRecords() { return [...this.records].sort((a, b) => new Date(b.date) - new Date(a.date)); },
            filteredClinics() {
                if (this.clinicFilter === 'all') return this.clinics;
                return this.clinics.filter(c => c.status === this.clinicFilter);
            },
            filteredWikiList() {
                let list = this.wikiData;
                if (this.wikiSearchQuery) {
                    const lowerQuery = this.wikiSearchQuery.toLowerCase();
                    list = list.filter(item => 
                        item.title.toLowerCase().includes(lowerQuery) || 
                        item.category.toLowerCase().includes(lowerQuery) || 
                        (item.desc && item.desc.toLowerCase().includes(lowerQuery)) ||
                        (item.symptoms && item.symptoms.some(s => s.toLowerCase().includes(lowerQuery)))
                    );
                }
                const seen = new Set();
                return list.filter(item => {
                    if (seen.has(item.title)) { return false; }
                    seen.add(item.title);
                    return true;
                });
            }
        },
        async created() {
            const { SHARED_APP_ID, collection, onSnapshot, query, orderBy, signInAnonymously, onAuthStateChanged, addDoc } = window.firebaseOps;
            const auth = window.auth;
            const db = window.db;

            onAuthStateChanged(auth, async (user) => {
                if (!user) { await signInAnonymously(auth); }
                
                // Wiki
                const wikiRef = collection(db, 'artifacts', SHARED_APP_ID, 'public', 'data', 'wiki_v10');
                onSnapshot(wikiRef, (snapshot) => {
                    this.wikiData = snapshot.docs.map(d => {
                        let data = d.data();
                        if(data.symptoms && Array.isArray(data.symptoms)) {
                            data.symptomsStr = data.symptoms.join(', ');
                        }
                        return { id: d.id, ...data };
                    });
                    if (this.wikiData.length === 0) {
                        defaultWikiData.forEach(item => addDoc(wikiRef, item));
                    }
                });

                // Clinics
                const clinicsRef = collection(db, 'artifacts', SHARED_APP_ID, 'public', 'data', 'clinics');
                onSnapshot(clinicsRef, (snapshot) => { this.clinics = snapshot.docs.map(d => ({ id: d.id, ...d.data() })); });

                // Records
                const recordsRef = collection(db, 'artifacts', SHARED_APP_ID, 'public', 'data', 'records');
                onSnapshot(recordsRef, (snapshot) => { this.records = snapshot.docs.map(d => ({ id: d.id, ...d.data() })); this.loading = false; });
            });
        },
        methods: {
            formatMoney(value) { return Number(value || 0).toLocaleString(); },
            switchTab(tab) { this.currentTab = tab; this.selectedWikiItem = null; },
            
            // WIKI
            openWikiDetail(item) { this.selectedWikiItem = item; },
            closeWikiDetail() { this.selectedWikiItem = null; },
            async createNewWikiItem() { 
                const name = prompt("é …ç›®åç¨±"); 
                if(name) { 
                    const { addDoc, collection, SHARED_APP_ID } = window.firebaseOps;
                    await addDoc(collection(window.db, 'artifacts', SHARED_APP_ID, 'public', 'data', 'wiki_v10'), {
                        title:name, category:'è‡ªè¨‚', price:'-', desc:'', symptoms:[], principle:'', duration:'', recovery:'', quotes:[]
                    });
                } 
            },
            async deleteWikiItem() { 
                if(confirm('åˆªé™¤?')) { 
                    const { deleteDoc, doc, SHARED_APP_ID } = window.firebaseOps;
                    await deleteDoc(doc(window.db, 'artifacts', SHARED_APP_ID, 'public', 'data', 'wiki_v10', this.selectedWikiItem.id));
                    this.selectedWikiItem=null; 
                } 
            },
            // ä¸€éµæ¸…ç†é‡è¤‡è³‡æ–™ (Cleanup Logic)
            async cleanDuplicates() {
                if(!confirm('ç¢ºå®šè¦æ¸…ç†é‡è¤‡çš„é …ç›®å—ï¼Ÿç³»çµ±æœƒä¿ç•™æœ€æ—©çš„ä¸€ç­†ï¼Œä¸¦åˆªé™¤å…¶ä»–é‡è¤‡è³‡æ–™ã€‚')) return;
                
                const seen = new Set();
                const duplicates = [];
                const { deleteDoc, doc, SHARED_APP_ID } = window.firebaseOps;

                this.wikiData.forEach(item => {
                    if (seen.has(item.title)) {
                        duplicates.push(item);
                    } else {
                        seen.add(item.title);
                    }
                });

                if(duplicates.length === 0) {
                    alert('ç›®å‰æ²’æœ‰ç™¼ç¾é‡è¤‡è³‡æ–™å–”ï¼');
                    return;
                }

                this.loading = true; // é¡¯ç¤º Loading
                for (const item of duplicates) {
                    await deleteDoc(doc(window.db, 'artifacts', SHARED_APP_ID, 'public', 'data', 'wiki_v10', item.id));
                }
                this.loading = false;
                alert(`æˆåŠŸæ¸…ç†äº† ${duplicates.length} ç­†é‡è¤‡è³‡æ–™ï¼`);
            },

            async updateWikiItem(item) {
                let symArray = item.symptomsStr ? item.symptomsStr.split(/,|ï¼Œ/).map(s => s.trim()).filter(s => s) : [];
                item.symptoms = symArray;

                const { updateDoc, doc, SHARED_APP_ID } = window.firebaseOps;
                await updateDoc(doc(window.db, 'artifacts', SHARED_APP_ID, 'public', 'data', 'wiki_v10', item.id), {
                    desc: item.desc || '', 
                    price: item.price || '',
                    duration: item.duration || '',
                    recovery: item.recovery || '',
                    symptoms: symArray
                });
            },
            handleWikiImageUpload(event) {
                // Legacy wrapper
                this.processFile(event.target.files[0], 'wiki');
            },
            async deleteWikiPhoto() {
                if(confirm('åˆªé™¤åœ–ç‰‡ï¼Ÿ')) {
                    this.selectedWikiItem.photo = '';
                    const { updateDoc, doc, SHARED_APP_ID } = window.firebaseOps;
                    await updateDoc(doc(window.db, 'artifacts', SHARED_APP_ID, 'public', 'data', 'wiki_v10', this.selectedWikiItem.id), { photo: '' });
                }
            },
            async addQuote() { 
                if(!this.selectedWikiItem) return;
                const newQuotes = [...(this.selectedWikiItem.quotes || []), { ...this.newQuote }];
                const { updateDoc, doc, SHARED_APP_ID } = window.firebaseOps;
                await updateDoc(doc(window.db, 'artifacts', SHARED_APP_ID, 'public', 'data', 'wiki_v10', this.selectedWikiItem.id), { quotes: newQuotes });
                this.newQuote={clinic:'',price:''}; 
            },
            async removeQuote(idx) { 
                const newQuotes = [...this.selectedWikiItem.quotes];
                newQuotes.splice(idx,1);
                const { updateDoc, doc, SHARED_APP_ID } = window.firebaseOps;
                await updateDoc(doc(window.db, 'artifacts', SHARED_APP_ID, 'public', 'data', 'wiki_v10', this.selectedWikiItem.id), { quotes: newQuotes });
            },

            // CLINICS
            async addClinic() { 
                const { addDoc, collection, SHARED_APP_ID } = window.firebaseOps;
                await addDoc(collection(window.db, 'artifacts', SHARED_APP_ID, 'public', 'data', 'clinics'), { ...this.newClinic }); 
                this.showAddClinic=false; 
            },
            async removeClinic(id) { 
                if(confirm('åˆªé™¤?')) {
                    const { deleteDoc, doc, SHARED_APP_ID } = window.firebaseOps;
                    await deleteDoc(doc(window.db, 'artifacts', SHARED_APP_ID, 'public', 'data', 'clinics', id));
                }
            },

            // RECORDS
            async addRecord() { 
                if(!this.newRecord.item) return; 
                const { addDoc, collection, SHARED_APP_ID } = window.firebaseOps;
                await addDoc(collection(window.db, 'artifacts', SHARED_APP_ID, 'public', 'data', 'records'), { ...this.newRecord, photos: { before: '', after: '' } }); 
                this.newRecord.item=''; this.newRecord.price=''; 
            },
            async removeRecord(id) { 
                if(confirm('åˆªé™¤?')) {
                    const { deleteDoc, doc, SHARED_APP_ID } = window.firebaseOps;
                    await deleteDoc(doc(window.db, 'artifacts', SHARED_APP_ID, 'public', 'data', 'records', id));
                }
            },

            // PHOTOS (Common Process)
            openPhotoModal(record) { this.currentEditingRecord = record; if(!this.currentEditingRecord.photos) this.currentEditingRecord.photos = { before: '', after: '' }; this.showPhotoModal = true; },
            closePhotoModal() { this.showPhotoModal = false; this.currentEditingRecord = null; },
            handleImageUpload(event, type) {
                // Legacy wrapper
                this.processFile(event.target.files[0], 'record', type);
            },
            async deletePhoto(type) { 
                if(confirm('åˆªé™¤?')) { 
                    this.currentEditingRecord.photos[type] = '';
                    const { updateDoc, doc, SHARED_APP_ID } = window.firebaseOps;
                    await updateDoc(doc(window.db, 'artifacts', SHARED_APP_ID, 'public', 'data', 'records', this.currentEditingRecord.id), { [`photos.${type}`]: '' });
                } 
            },
            
            // === NEW: PASTE SUPPORT ===
            handlePaste(event, context, subtype) {
                const items = (event.clipboardData || event.originalEvent.clipboardData).items;
                for (let index in items) {
                    const item = items[index];
                    if (item.kind === 'file' && item.type.includes('image/')) {
                        const blob = item.getAsFile();
                        this.processFile(blob, context, subtype);
                        event.preventDefault(); // Prevent double paste behavior if any
                        return;
                    }
                }
            },
            
            processFile(file, context, subtype) {
                if(!file) return;
                
                this.compressImage(file, async (base64) => { 
                    const { updateDoc, doc, SHARED_APP_ID } = window.firebaseOps;
                    
                    if (context === 'wiki') {
                        // Update Wiki
                        this.selectedWikiItem.photo = base64; 
                        await updateDoc(doc(window.db, 'artifacts', SHARED_APP_ID, 'public', 'data', 'wiki_v10', this.selectedWikiItem.id), { photo: base64 });
                    } else if (context === 'record') {
                        // Update Record
                        this.currentEditingRecord.photos[subtype] = base64;
                        await updateDoc(doc(window.db, 'artifacts', SHARED_APP_ID, 'public', 'data', 'records', this.currentEditingRecord.id), { [`photos.${subtype}`]: base64 });
                    }
                });
            },

            compressImage(file, callback) {
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image(); img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const maxWidth = 500; let w = img.width; let h = img.height;
                        if (w > maxWidth) { h *= maxWidth / w; w = maxWidth; }
                        canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                        callback(canvas.toDataURL('image/jpeg', 0.7));
                    };
                };
            }
        }
    }).mount('#app');
</script>

</body>
</html>
