<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é†«ç¾å°ç§˜æ›¸ v13.1 (æ¯”è¼ƒè¡¨ä¿®å¾©ç‰ˆ)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #FDF2F8; touch-action: manipulation; }
        .card-shadow { box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .upload-box {
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='12' ry='12' stroke='%23FDA4AF' stroke-width='2' stroke-dasharray='6%2c 6' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
            transition: all 0.3s;
            cursor: pointer;
            outline: none;
        }
        .upload-box:active, .upload-box:focus { 
            background-color: #FFF1F2; 
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='12' ry='12' stroke='%23F43F5E' stroke-width='2' stroke-dasharray='0' stroke-linecap='square'/%3e%3c/svg%3e");
        }
        
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); z-index: 999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        
        /* === æ¯”è¼ƒè¡¨å¼·åŠ›ä¿®å¾©æ¨£å¼ === */
        /* 1. è¨­å®šæ¯ä¸€åˆ—çš„å¼·åˆ¶é«˜åº¦ (ç¢ºä¿å·¦å³å°é½Š) */
        .row-img { height: 140px; min-height: 140px; }
        .row-std { height: 50px; min-height: 50px; }
        .row-lg  { height: 120px; min-height: 120px; }
        
        /* 2. å®¹å™¨è¨­å®š */
        .compare-table-container { 
            display: flex; 
            overflow-x: auto; 
            padding-bottom: 20px; 
            background: white;
            position: relative; /* é‡è¦ */
        }
        
        /* 3. å·¦å´æ¨™é ­æ¬„ (å‡çµ) */
        .compare-header-col { 
            min-width: 90px; 
            max-width: 90px;
            position: sticky; 
            left: 0; 
            z-index: 20; /* ç¢ºä¿åœ¨å…§å®¹ä¹‹ä¸Šï¼Œä½†åœ¨é ‚éƒ¨é¸å–®ä¹‹ä¸‹ */
            background: #fff1f2; 
            border-right: 2px solid #e5e7eb; 
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
            flex-shrink: 0;
        }
        
        /* 4. å…§å®¹æ¬„ä½ */
        .compare-data-col { 
            min-width: 150px; 
            max-width: 150px; 
            flex-shrink: 0; 
            border-right: 1px solid #f3f4f6;
            background: white;
        }
        
        /* 5. å„²å­˜æ ¼é€šç”¨è¨­å®š */
        .compare-cell { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 4px; 
            border-bottom: 1px solid #f3f4f6; 
            font-size: 12px; 
            box-sizing: border-box; /* ç¢ºä¿ padding ä¸å½±éŸ¿é«˜åº¦ */
        }
        
        .header-cell {
            justify-content: flex-start;
            padding-left: 8px;
            font-weight: bold;
            color: #be123c;
            border-bottom: 1px solid #e5e7eb;
        }

        /* ä¿®æ­£é ‚éƒ¨ Sticky é®æ“‹å•é¡Œ */
        .sticky-top-bar {
            position: sticky;
            top: 0;
            z-index: 30; /* æœ€é«˜å±¤ç´šï¼Œè“‹éå·¦å´æ¨™é ­ */
            background-color: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }
        
        /* è¼¸å…¥æ¡†å„ªåŒ– */
        .cell-input {
            width: 100%;
            height: 100%;
            text-align: center;
            background: transparent;
            outline: none;
        }
        .cell-input:focus {
            background: #ffffff;
            box-shadow: inset 0 0 0 2px #fecdd3;
            border-radius: 4px;
        }
    </style>
</head>
<body class="text-gray-700 h-screen overflow-hidden flex justify-center">

<div id="app" class="w-full max-w-md h-full bg-white shadow-2xl relative flex flex-col">
    
    <!-- Loading Screen -->
    <div v-if="loading" class="loading-overlay">
        <i class="fas fa-circle-notch fa-spin text-4xl text-rose-400 mb-2"></i>
        <p class="text-rose-500 font-bold">é›²ç«¯åŒæ­¥ä¸­...</p>
    </div>

    <!-- Header -->
    <header class="bg-gradient-to-r from-rose-400 to-pink-500 text-white p-6 pt-8 rounded-b-3xl shadow-lg shrink-0 z-20">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h1 class="text-2xl font-bold tracking-wide">Beauty Manager</h1>
                <p class="text-xs text-rose-100 flex items-center">
                    <span class="w-2 h-2 bg-green-400 rounded-full mr-1 animate-pulse"></span> ç—‡ç‹€å°ç­–è³‡æ–™åº«
                </p>
            </div>
            <div class="text-right bg-white/20 p-2 rounded-lg backdrop-blur-sm">
                <p class="text-[10px] text-rose-100 uppercase">Total Spent</p>
                <p class="text-xl font-bold">NT$ {{ formatMoney(totalSpent) }}</p>
            </div>
        </div>
        
        <div class="flex bg-black/10 p-1 rounded-xl backdrop-blur-md overflow-x-auto no-scrollbar">
            <button @click="switchTab('wiki')" :class="['flex-1 py-2 px-3 rounded-lg text-xs font-bold transition whitespace-nowrap', currentTab === 'wiki' ? 'bg-white text-rose-500 shadow' : 'text-white/70']">
                <i class="fas fa-search mr-1"></i> ç™¾ç§‘
            </button>
            <button @click="switchTab('compare')" :class="['flex-1 py-2 px-3 rounded-lg text-xs font-bold transition whitespace-nowrap', currentTab === 'compare' ? 'bg-white text-rose-500 shadow' : 'text-white/70']">
                <i class="fas fa-balance-scale mr-1"></i> æ¯”è¼ƒ
            </button>
            <button @click="switchTab('clinics')" :class="['flex-1 py-2 px-3 rounded-lg text-xs font-bold transition whitespace-nowrap', currentTab === 'clinics' ? 'bg-white text-rose-500 shadow' : 'text-white/70']">
                <i class="fas fa-store mr-1"></i> ç´…é»‘æ¦œ
            </button>
            <button @click="switchTab('records')" :class="['flex-1 py-2 px-3 rounded-lg text-xs font-bold transition whitespace-nowrap', currentTab === 'records' ? 'bg-white text-rose-500 shadow' : 'text-white/70']">
                <i class="fas fa-camera mr-1"></i> ç´€éŒ„
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex-1 overflow-y-auto bg-gray-50 pb-20 relative">

        <!-- TAB 1: ç™¾ç§‘ (æœå°‹èˆ‡åˆ—è¡¨) -->
        <div v-if="currentTab === 'wiki'" class="p-4 space-y-4">
            <!-- (Wiki å…§å®¹ä¿æŒä¸è®Šï¼Œèˆ‡ v13 ç›¸åŒ) -->
            <div v-if="!selectedWikiItem">
                <div class="sticky top-0 bg-gray-50 z-10 pb-2">
                    <div class="relative">
                        <i class="fas fa-search absolute left-4 top-3.5 text-gray-400 text-sm"></i>
                        <input v-model="wikiSearchQuery" placeholder="è¼¸å…¥ç—‡ç‹€ (å¦‚: æ³•ä»¤ç´‹ã€æ¯›å­”)" class="w-full pl-10 pr-4 py-3 rounded-xl border border-gray-200 focus:border-rose-300 outline-none shadow-sm text-sm">
                        <button v-if="wikiSearchQuery" @click="wikiSearchQuery=''" class="absolute right-3 top-3.5 text-gray-400 hover:text-gray-600"><i class="fas fa-times-circle"></i></button>
                    </div>
                </div>
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-sm font-bold text-gray-500 pl-2 border-l-4 border-rose-400">{{ wikiSearchQuery ? 'ç¬¦åˆç—‡ç‹€çš„é …ç›®' : 'é†«ç¾é …ç›®æ¸…å–®' }}</h2>
                    <div class="flex gap-2">
                        <button @click="cleanDuplicates" class="text-xs bg-rose-100 text-rose-600 px-3 py-1 rounded-full hover:bg-rose-200"><i class="fas fa-broom mr-1"></i>æ¸…ç†</button>
                        <button @click="createNewWikiItem" class="text-xs bg-gray-200 text-gray-600 px-3 py-1 rounded-full"><i class="fas fa-plus"></i> è‡ªè¨‚</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 gap-3">
                    <div v-for="item in filteredWikiList" :key="item.id" @click="openWikiDetail(item)" 
                        class="bg-white p-4 rounded-xl card-shadow border border-gray-100 hover:border-rose-300 transition cursor-pointer group relative overflow-hidden">
                        <div class="flex justify-between items-start mb-2">
                            <div><span class="text-[10px] text-white bg-rose-400 px-2 py-0.5 rounded mb-1 inline-block font-bold">{{ item.category }}</span><h3 class="font-bold text-gray-800 text-lg">{{ item.title }}</h3></div>
                            <i class="fas fa-chevron-right text-gray-300 mt-2"></i>
                        </div>
                        <div class="flex flex-wrap mb-2"><span v-for="sym in (item.symptoms || [])" :key="sym" class="bg-rose-50 text-rose-500 text-[10px] px-2 py-1 rounded-full mr-1 mb-1">#{{ sym }}</span></div>
                        <div v-if="item.photo" class="h-20 w-full rounded-lg bg-gray-100 bg-cover bg-center mb-2" :style="{backgroundImage: 'url(' + item.photo + ')'}"></div>
                        <div class="flex justify-between items-center border-t border-gray-100 pt-2"><span class="text-xs font-bold text-gray-500">ğŸ’° {{ item.price }}</span></div>
                    </div>
                </div>
            </div>
            <!-- (Wiki è©³æƒ…é ï¼Œèˆ‡ v13 ç›¸åŒ) -->
            <div v-else class="bg-white min-h-full rounded-t-3xl shadow-inner animate-slide-up pb-10">
                <div class="sticky top-0 bg-white z-10 p-4 border-b border-gray-100 flex items-center justify-between rounded-t-3xl">
                    <button @click="closeWikiDetail" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center"><i class="fas fa-arrow-left"></i></button>
                    <span class="font-bold text-gray-800 truncate">{{ selectedWikiItem.title }}</span>
                    <button @click="deleteWikiItem" class="text-red-300"><i class="fas fa-trash"></i></button>
                </div>
                <div class="p-5 space-y-6">
                    <div class="w-full h-40 rounded-xl overflow-hidden bg-gray-50 border-2 border-dashed border-rose-200 flex items-center justify-center upload-box relative" tabindex="0" @paste="handlePaste($event, 'wiki')" :style="selectedWikiItem.photo ? {backgroundImage: 'url(' + selectedWikiItem.photo + ')', backgroundSize: 'contain', backgroundRepeat: 'no-repeat', backgroundPosition: 'center', border: 'none'} : {}">
                        <label v-if="!selectedWikiItem.photo" class="absolute inset-0 flex flex-col items-center justify-center cursor-pointer text-gray-400 pointer-events-none"><i class="fas fa-image text-3xl mb-1"></i><span class="text-xs">é»æ“Š -> Ctrl+V è²¼åœ–</span></label>
                        <input type="file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" @change="(e) => processFile(e.target.files[0], 'wiki')">
                        <button v-if="selectedWikiItem.photo" @click.stop="deleteWikiPhoto" class="absolute top-2 right-2 bg-white/80 p-1 rounded-full text-red-500 z-10"><i class="fas fa-trash"></i></button>
                    </div>
                    <div class="space-y-4">
                        <div class="bg-rose-50 p-3 rounded-xl border border-rose-100"><label class="text-xs font-bold text-rose-500 uppercase mb-1 block">é©æ‡‰ç—‡</label><input v-model="selectedWikiItem.symptomsStr" @change="updateWikiItem(selectedWikiItem)" class="w-full bg-white px-2 py-1 rounded text-sm border border-rose-200"></div>
                        <div class="bg-gray-50 p-3 rounded-xl border border-gray-100"><label class="text-xs font-bold text-gray-500 uppercase mb-1 block">åŸç† / ç­†è¨˜</label><textarea v-model="selectedWikiItem.desc" @change="updateWikiItem(selectedWikiItem)" class="w-full bg-white border border-gray-200 rounded-lg p-2 text-sm h-20"></textarea></div>
                        <div class="bg-gray-50 p-3 rounded-xl border border-gray-100 flex items-center gap-2"><label class="text-xs font-bold text-gray-500 uppercase whitespace-nowrap">å¸‚åƒ¹åƒè€ƒ</label><input v-model="selectedWikiItem.price" @change="updateWikiItem(selectedWikiItem)" class="flex-1 bg-transparent border-b border-gray-300 text-sm outline-none"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== TAB 2: æ©Ÿå™¨æ¯”è¼ƒ (Comparison - ä¿®å¾©ç‰ˆ) ==================== -->
        <div v-if="currentTab === 'compare'" class="bg-white min-h-full flex flex-col">
            <!-- æ¨™é¡Œåˆ— (z-30) -->
            <div class="p-4 bg-gray-50 sticky-top-bar shadow-sm flex justify-between items-center shrink-0">
                <h2 class="text-sm font-bold text-gray-700 pl-2 border-l-4 border-rose-400">æ©Ÿå™¨è¦æ ¼ PK</h2>
                <button @click="addNewMachine" class="bg-rose-500 text-white text-xs px-3 py-1.5 rounded-full shadow font-bold hover:bg-rose-600 transition">
                    <i class="fas fa-plus"></i> æ–°å¢
                </button>
            </div>

            <!-- æ¯”è¼ƒè¡¨å®¹å™¨ -->
            <div class="compare-table-container flex-1">
                
                <!-- 1. å·¦å´å›ºå®šæ¨™é ­ (z-20) -->
                <div class="compare-header-col flex flex-col">
                    <div class="compare-cell row-img header-cell">åœ–ç‰‡</div>
                    <div class="compare-cell row-std header-cell">æ©Ÿå™¨åç¨±</div>
                    <div class="compare-cell row-std header-cell">ç”¢åœ°</div>
                    <div class="compare-cell row-std header-cell">ç—›æ„Ÿ</div>
                    <div class="compare-cell row-std header-cell">æ¢å¾©æœŸ</div>
                    <div class="compare-cell row-std header-cell">ç¶­æŒæ™‚é–“</div>
                    <div class="compare-cell row-lg header-cell">ç‰¹è‰²/å‚™è¨»</div>
                    <div class="compare-cell row-std header-cell">åƒè€ƒåƒ¹æ ¼</div>
                    <div class="compare-cell row-std header-cell">æ“ä½œ</div>
                </div>

                <!-- 2. å³å´æ©Ÿå™¨æ¬„ä½ (è¿´åœˆ) -->
                <div v-for="(machine, index) in machinesList" :key="machine.id" class="compare-data-col flex flex-col">
                    
                    <!-- åœ–ç‰‡ (row-img: 140px) -->
                    <div class="compare-cell row-img p-2">
                        <div class="w-full h-full bg-gray-50 rounded border border-dashed border-gray-300 flex items-center justify-center relative overflow-hidden upload-box group"
                             tabindex="0" @paste="handlePaste($event, 'machine', null, machine)"
                             :style="machine.photo ? {backgroundImage: 'url(' + machine.photo + ')', backgroundSize: 'contain', backgroundRepeat: 'no-repeat', backgroundPosition: 'center'} : {}">
                            <i v-if="!machine.photo" class="fas fa-camera text-gray-300"></i>
                            <input type="file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" @change="(e) => processFile(e.target.files[0], 'machine', null, machine)">
                            <div v-if="!machine.photo" class="absolute bottom-2 text-[8px] text-gray-400">é»æ“Šè²¼ä¸Š</div>
                        </div>
                    </div>

                    <!-- å±¬æ€§ (row-std: 50px) -->
                    <div class="compare-cell row-std bg-rose-50/30">
                        <input v-model="machine.name" @change="updateMachine(machine)" class="cell-input font-bold text-gray-800" placeholder="åç¨±">
                    </div>
                    <div class="compare-cell row-std">
                        <input v-model="machine.origin" @change="updateMachine(machine)" class="cell-input" placeholder="åœ‹å®¶">
                    </div>
                    <div class="compare-cell row-std">
                        <select v-model="machine.pain" @change="updateMachine(machine)" class="cell-input cursor-pointer">
                            <option value="">-</option>
                            <option value="ä½">ğŸ˜Š ä½</option>
                            <option value="ä¸­">ğŸ˜ ä¸­</option>
                            <option value="é«˜">ğŸ˜­ é«˜</option>
                        </select>
                    </div>
                    <div class="compare-cell row-std">
                        <input v-model="machine.downtime" @change="updateMachine(machine)" class="cell-input" placeholder="å¹¾å¤©">
                    </div>
                    <div class="compare-cell row-std">
                        <input v-model="machine.duration" @change="updateMachine(machine)" class="cell-input" placeholder="å¤šä¹…">
                    </div>
                    
                    <!-- ç‰¹è‰² (row-lg: 120px) -->
                    <div class="compare-cell row-lg">
                        <textarea v-model="machine.features" @change="updateMachine(machine)" class="cell-input resize-none p-1 text-xs leading-relaxed" placeholder="ç‰¹é»..."></textarea>
                    </div>

                    <div class="compare-cell row-std">
                        <input v-model="machine.price" @change="updateMachine(machine)" class="cell-input text-rose-500 font-bold" placeholder="$">
                    </div>

                    <!-- æ“ä½œ (row-std) -->
                    <div class="compare-cell row-std">
                        <button @click="deleteMachine(machine)" class="text-gray-300 hover:text-red-500 w-full h-full"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </div>

                <!-- æ–°å¢æŒ‰éˆ•æ¬„ (ä½”ä½) -->
                <div class="compare-data-col flex items-center justify-center bg-gray-50 border-r border-gray-100 min-h-full cursor-pointer hover:bg-gray-100 transition" @click="addNewMachine" style="min-width: 80px; max-width: 80px;">
                    <div class="text-center text-gray-400">
                        <i class="fas fa-plus-circle text-2xl mb-1"></i>
                    </div>
                </div>

            </div>
        </div>

        <!-- TAB 2: ç´…é»‘æ¦œ (ä¿æŒä¸è®Š) -->
        <div v-if="currentTab === 'clinics'" class="p-4 space-y-4">
             <div class="flex gap-2 pb-2">
                <button @click="clinicFilter = 'all'" :class="['flex-1 py-1 text-xs font-bold border rounded-full', clinicFilter==='all'?'bg-gray-800 text-white':'bg-white']">å…¨éƒ¨</button>
                <button @click="clinicFilter = 'good'" :class="['flex-1 py-1 text-xs font-bold border rounded-full', clinicFilter==='good'?'bg-rose-500 text-white':'bg-white']">ç´…æ¦œ</button>
                <button @click="clinicFilter = 'bad'" :class="['flex-1 py-1 text-xs font-bold border rounded-full', clinicFilter==='bad'?'bg-gray-500 text-white':'bg-white']">é»‘æ¦œ</button>
            </div>
            <button @click="showAddClinic=!showAddClinic" class="w-full py-2 bg-white border border-rose-200 text-rose-500 rounded-xl text-sm font-bold">æ–°å¢è©•åƒ¹</button>
            <div v-if="showAddClinic" class="bg-white p-4 rounded-xl shadow border-t-4 border-rose-400 animate-fade-in">
                <input v-model="newClinic.name" placeholder="è¨ºæ‰€åç¨±" class="w-full bg-gray-50 p-2 mb-2 text-sm rounded">
                <div class="flex gap-2 mb-2">
                    <select v-model="newClinic.location" class="w-1/2 bg-gray-50 p-2 text-sm rounded"><option value="å°åŒ—">å°åŒ—</option><option value="é«˜é›„">é«˜é›„</option><option value="éŸ“åœ‹">éŸ“åœ‹</option></select>
                    <select v-model="newClinic.status" class="w-1/2 bg-gray-50 p-2 text-sm rounded"><option value="good">æ¨è–¦</option><option value="bad">é¿é›·</option></select>
                </div>
                <textarea v-model="newClinic.note" placeholder="è©•åƒ¹..." class="w-full bg-gray-50 p-2 text-sm rounded mb-2"></textarea>
                <button @click="addClinic" class="w-full bg-rose-500 text-white py-2 rounded text-sm">å„²å­˜</button>
            </div>
            <div v-for="c in filteredClinics" :key="c.id" class="p-4 bg-white rounded-xl card-shadow border-l-4" :class="c.status==='good'?'border-rose-400':'border-gray-500'">
                <div class="flex justify-between items-start"><h3 class="font-bold">{{c.name}} <span class="text-xs font-normal text-gray-500">@{{c.location}}</span></h3><div class="flex text-yellow-400 text-[10px]"><i v-for="n in 5" :key="n" :class="n <= c.rating ? 'fas fa-star' : 'far fa-star text-gray-300'"></i></div></div>
                <p class="text-xs text-gray-500 mt-1">{{c.note || 'ç„¡å‚™è¨»'}}</p>
                <div class="flex justify-between mt-2"><span class="text-[10px] px-2 py-0.5 rounded bg-gray-100">{{c.status==='good'?'æ¨è–¦':'é¿é›·'}}</span><button @click="removeClinic(c.id)" class="text-gray-300"><i class="fas fa-trash"></i></button></div>
            </div>
        </div>

        <!-- TAB 3: ç´€éŒ„ -->
        <div v-if="currentTab === 'records'" class="p-4 space-y-4">
             <div class="bg-white p-5 rounded-2xl card-shadow border border-gray-100">
                <div class="flex gap-2 overflow-x-auto mb-3 pb-1 no-scrollbar">
                    <button v-for="m in members" :key="m" @click="newRecord.member = m" :class="['px-4 py-1.5 whitespace-nowrap rounded-full text-xs font-bold border transition', newRecord.member === m ? 'bg-rose-500 text-white border-rose-500' : 'bg-white text-gray-500 border-gray-200']">{{ m }}</button>
                </div>
                <div class="space-y-2">
                    <input type="date" v-model="newRecord.date" class="w-full bg-gray-50 p-2 rounded-lg text-sm outline-none">
                    <input v-model="newRecord.item" placeholder="é …ç›® (ä¾‹: éŸ³æ³¢600ç™¼)" class="w-full bg-gray-50 p-2 rounded-lg text-sm outline-none">
                    <div class="flex gap-2"><input type="number" v-model="newRecord.price" placeholder="é‡‘é¡" class="w-full bg-gray-50 p-2 rounded-lg text-sm outline-none"><input v-model="newRecord.clinic" placeholder="è¨ºæ‰€" class="w-full bg-gray-50 p-2 rounded-lg text-sm outline-none"></div>
                    <button @click="addRecord" class="w-full bg-gray-800 text-white py-2.5 rounded-xl font-bold shadow hover:bg-gray-900 mt-2"><i class="fas fa-check mr-1"></i> è¨˜ä¸€ç­†</button>
                </div>
            </div>
            <div class="space-y-4">
                <div v-for="rec in sortedRecords" :key="rec.id" class="bg-white rounded-2xl card-shadow overflow-hidden">
                    <div class="p-4 flex justify-between items-start relative">
                        <div class="flex items-start gap-3">
                            <div :class="['w-10 h-10 rounded-full flex items-center justify-center font-bold text-xs shadow-sm text-white shrink-0', rec.member === 'å­æ™´' ? 'bg-pink-400' : (rec.member === 'å­æ¶µ' ? 'bg-purple-400' : (rec.member === 'åª½åª½' ? 'bg-rose-500' : 'bg-gray-400'))]">{{ rec.member.substring(0,2) }}</div>
                            <div><div class="text-sm font-bold text-gray-800">{{ rec.item }}</div><div class="text-xs text-gray-400 mb-1">{{ rec.date }} <span v-if="rec.clinic">| {{ rec.clinic }}</span></div><div class="text-sm font-bold text-rose-500">NT$ {{ formatMoney(rec.price) }}</div></div>
                        </div>
                        <button @click="removeRecord(rec.id)" class="text-gray-300 hover:text-red-400"><i class="fas fa-trash-alt"></i></button>
                    </div>
                    <div v-if="rec.photos && (rec.photos.before || rec.photos.after)" class="flex border-t border-gray-100 bg-gray-50">
                        <div class="flex-1 h-24 bg-cover bg-center border-r border-gray-200 relative" :style="rec.photos.before ? {backgroundImage: 'url(' + rec.photos.before + ')'} : {}"></div>
                        <div class="flex-1 h-24 bg-cover bg-center relative" :style="rec.photos.after ? {backgroundImage: 'url(' + rec.photos.after + ')'} : {}"></div>
                    </div>
                    <button @click="openPhotoModal(rec)" class="w-full py-2 bg-rose-50 text-rose-500 text-xs font-bold hover:bg-rose-100 transition border-t border-rose-100 flex items-center justify-center gap-1"><i class="fas fa-camera"></i> {{ (rec.photos && (rec.photos.before || rec.photos.after)) ? 'æŸ¥çœ‹å°æ¯”' : 'ä¸Šå‚³è¡“å‰è¡“å¾Œç…§' }}</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PHOTO MODAL -->
    <div v-if="showPhotoModal && currentEditingRecord" class="absolute inset-0 z-50 bg-white flex flex-col animate-slide-up">
        <div class="bg-gray-800 text-white p-4 flex justify-between items-center shrink-0"><div><h3 class="font-bold">{{ currentEditingRecord.item }}</h3></div><button @click="closePhotoModal" class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center"><i class="fas fa-times"></i></button></div>
        <div class="flex-1 overflow-y-auto p-4 bg-gray-100 flex flex-col gap-4">
            <div class="flex-1 bg-white p-3 rounded-xl shadow-sm flex flex-col"><div class="flex justify-between items-center mb-2"><span class="text-xs font-bold bg-gray-200 text-gray-600 px-2 py-1 rounded">BEFORE è¡“å‰</span><button v-if="currentEditingRecord.photos?.before" @click="deletePhoto('before')" class="text-red-400 text-xs"><i class="fas fa-trash"></i></button></div><div class="flex-1 relative rounded-lg overflow-hidden bg-gray-50 border-2 border-dashed border-gray-300 flex items-center justify-center upload-box" tabindex="0" @paste="handlePaste($event, 'record', 'before')" :style="currentEditingRecord.photos?.before ? {backgroundImage: 'url(' + currentEditingRecord.photos.before + ')', backgroundSize: 'contain', backgroundRepeat: 'no-repeat', backgroundPosition: 'center', border: 'none'} : {}"><label v-if="!currentEditingRecord.photos?.before" class="absolute inset-0 flex flex-col items-center justify-center cursor-pointer text-gray-400 pointer-events-none"><i class="fas fa-camera text-2xl mb-1"></i><span class="text-xs">é»æ“Š -> Ctrl+V è²¼ä¸Š</span></label><input type="file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" @change="(e) => processFile(e.target.files[0], 'record', 'before')"></div></div>
            <div class="flex-1 bg-white p-3 rounded-xl shadow-sm flex flex-col"><div class="flex justify-between items-center mb-2"><span class="text-xs font-bold bg-rose-500 text-white px-2 py-1 rounded">AFTER è¡“å¾Œ</span><button v-if="currentEditingRecord.photos?.after" @click="deletePhoto('after')" class="text-red-400 text-xs"><i class="fas fa-trash"></i></button></div><div class="flex-1 relative rounded-lg overflow-hidden bg-gray-50 border-2 border-dashed border-rose-300 flex items-center justify-center upload-box" tabindex="0" @paste="handlePaste($event, 'record', 'after')" :style="currentEditingRecord.photos?.after ? {backgroundImage: 'url(' + currentEditingRecord.photos.after + ')', backgroundSize: 'contain', backgroundRepeat: 'no-repeat', backgroundPosition: 'center', border: 'none'} : {}"><label v-if="!currentEditingRecord.photos?.after" class="absolute inset-0 flex flex-col items-center justify-center cursor-pointer text-rose-400 pointer-events-none"><i class="fas fa-camera text-2xl mb-1"></i><span class="text-xs">é»æ“Š -> Ctrl+V è²¼ä¸Š</span></label><input type="file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" @change="(e) => processFile(e.target.files[0], 'record', 'after')"></div></div>
        </div>
    </div>

</div>

<!-- Firebase Script -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDFUGYOobmVxYFQMBYz1iQ4z1HIrdbTi8Q",
        authDomain: "travel-55c4b.firebaseapp.com",
        databaseURL: "https://travel-55c4b-default-rtdb.firebaseio.com",
        projectId: "travel-55c4b",
        storageBucket: "travel-55c4b.firebasestorage.app",
        messagingSenderId: "925227625640",
        appId: "1:925227625640:web:e3421427e8006d65f8a69d",
        measurementId: "G-ES7SCGQ9P8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const SHARED_APP_ID = 'beauty-manager-family'; 
    window.db = db; window.auth = auth; window.firebaseOps = { collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy, serverTimestamp, signInAnonymously, onAuthStateChanged, SHARED_APP_ID };

    const { createApp } = Vue;

    const defaultMachines = [
        { name: 'Morpheus 8 (å¢¨è²æ–¯)', origin: 'ä»¥è‰²åˆ—', type: 'é›™æ¥µå¾®é‡', pain: 'é«˜', downtime: '5-7å¤©', duration: '12-18å€‹æœˆ', features: 'æ²»ç™‚æœ€æ·±(7mm)ï¼Œé©åˆæ¶ˆè„‚ã€åš´é‡é¬†å¼›', price: '8-10è¬' },
        { name: 'Sylfirm X (çŸ½è°·é›»æ³¢)', origin: 'ç¾åœ‹', type: 'é›™æ¥µå¾®é‡', pain: 'ä½', downtime: '0-24å°æ™‚', duration: '6-12å€‹æœˆ', features: 'ä¿®å¾©æœŸæ¥µçŸ­ï¼Œé‡å°è‚æ–‘ã€é…’ç³Ÿã€é¤Šè†š', price: '3-6è¬' },
        { name: 'Potenza (ç„¡é™é›»æ³¢)', origin: 'éŸ“åœ‹', type: 'å–®/é›™æ¥µ', pain: 'ä¸­', downtime: '1-3å¤©', duration: 'ç´„12å€‹æœˆ', features: 'ç¨ç‰¹CPtipå¯å°‡ç²¾è¯å°å…¥çœŸçš®å±¤', price: '4-6è¬' },
        { name: 'Genius (ç²¾éˆé›»æ³¢)', origin: 'éŸ“åœ‹', type: 'é›™æ¥µå¾®é‡', pain: 'ä¸­', downtime: '3-7å¤©', duration: '12-18å€‹æœˆ', features: 'èƒ½é‡ç²¾æº–ï¼Œåƒç ‚ç´™ç£¨éï¼Œé‡å°æ·±å±¤ç—˜ç–¤', price: '5-8è¬' },
        { name: 'Virtue RF (ç¥æ¯”é›»æ³¢)', origin: 'éŸ“åœ‹', type: 'å–®/é›™æ¥µ', pain: 'ä½', downtime: '1-3å¤©', duration: 'ç´„12å€‹æœˆ', features: 'å¼·å¤§å†·å»ç³»çµ±ï¼Œèˆ’é©åº¦é«˜ï¼Œæ€•ç—›é¦–é¸', price: '3-5è¬' }
    ];

    const defaultWikiData = [
        { title: 'ç¾åœ‹éŸ³æ³¢ (Ulthera)', category: 'æ‹‰æ', price: '6~9 è¬', desc: 'ã€é‡å°ä¸‹å‚ã€‘æ•ˆæœæœ€å¼·ï¼Œä½†ç—›æ„Ÿé«˜ã€‚', symptoms: ['ä¸‹å‚', 'è¼ªå»“ç·š'], quotes: [] },
        { title: 'é³³å‡°é›»æ³¢ (Thermage FLX)', category: 'ç·Šå¯¦', price: '8~12 è¬', desc: 'ã€é‡å°é¬†å¼›ã€‘å…¨è‡‰ç·Šç·»ç‹è€…ï¼Œç—›æ„Ÿä¸ä½ã€‚', symptoms: ['é¬†å¼›', 'æ³•ä»¤ç´‹'], quotes: [] },
        { title: 'æµ·èŠ™éŸ³æ³¢ (Ultraformer)', category: 'æ‹‰æ', price: '2~5 è¬', desc: 'ã€é«˜CPå€¼ã€‘æ¢é ­å¤šæ¨£ï¼Œé‡å°è‚‰å¤šä¸‹å‚ã€‚', symptoms: ['è‚‰å¤š', 'æº¶è„‚'], quotes: [] },
        { title: 'çš®ç§’é›·å°„ (Pico Laser)', category: 'è†šè³ª', price: '3åƒ~1.5è¬', desc: 'ã€æ–‘é»/æ¯›å­”ã€‘èœ‚å·¢é€é¡è£œå‡¹æ´ã€‚', symptoms: ['æ–‘é»', 'æ¯›å­”'], quotes: [] }
    ];

    createApp({
        data() {
            return {
                loading: true,
                currentTab: 'wiki', // é è¨­ Wiki æˆ– compare
                clinicFilter: 'all',
                showAddClinic: false,
                members: ['å­æ™´', 'å­æ¶µ', 'åª½åª½', 'å…¶ä»–'],
                selectedWikiItem: null,
                newQuote: { clinic: '', price: '', note: '' },
                wikiSearchQuery: '',
                
                wikiData: [],
                clinics: [],
                records: [],
                machinesList: [],
                
                newClinic: { name: '', location: 'å°åŒ—', note: '', status: 'good', rating: 5 },
                newRecord: { member: 'å­æ™´', date: new Date().toISOString().split('T')[0], item: '', price: '', clinic: '' },
                showPhotoModal: false,
                currentEditingRecord: null,
            }
        },
        computed: {
            totalSpent() { return this.records.reduce((sum, item) => sum + Number(item.price), 0); },
            sortedRecords() { return [...this.records].sort((a, b) => new Date(b.date) - new Date(a.date)); },
            filteredClinics() { if (this.clinicFilter === 'all') return this.clinics; return this.clinics.filter(c => c.status === this.clinicFilter); },
            filteredWikiList() {
                let list = this.wikiData;
                if (this.wikiSearchQuery) {
                    const q = this.wikiSearchQuery.toLowerCase();
                    list = list.filter(i => i.title.toLowerCase().includes(q) || i.category.toLowerCase().includes(q) || (i.symptoms && i.symptoms.some(s=>s.includes(q))));
                }
                const seen = new Set(); return list.filter(item => { if(seen.has(item.title)) return false; seen.add(item.title); return true; });
            }
        },
        async created() {
            const { SHARED_APP_ID, collection, onSnapshot, signInAnonymously, onAuthStateChanged, addDoc } = window.firebaseOps;
            const auth = window.auth; const db = window.db;

            onAuthStateChanged(auth, async (user) => {
                if (!user) { await signInAnonymously(auth); }
                
                // 1. Machines Collection
                const machinesRef = collection(db, 'artifacts', SHARED_APP_ID, 'public', 'data', 'machines');
                onSnapshot(machinesRef, (snapshot) => {
                    this.machinesList = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    if (this.machinesList.length === 0) defaultMachines.forEach(m => addDoc(machinesRef, m));
                });

                // 2. Wiki
                const wikiRef = collection(db, 'artifacts', SHARED_APP_ID, 'public', 'data', 'wiki_v10');
                onSnapshot(wikiRef, (snapshot) => {
                    this.wikiData = snapshot.docs.map(d => {
                        let data = d.data();
                        if(data.symptoms && Array.isArray(data.symptoms)) data.symptomsStr = data.symptoms.join(', ');
                        return { id: d.id, ...data };
                    });
                    if (this.wikiData.length === 0) defaultWikiData.forEach(item => addDoc(wikiRef, item));
                });

                // 3. Clinics & Records
                const clinicsRef = collection(db, 'artifacts', SHARED_APP_ID, 'public', 'data', 'clinics');
                onSnapshot(clinicsRef, (s) => { this.clinics = s.docs.map(d => ({ id: d.id, ...d.data() })); });
                const recordsRef = collection(db, 'artifacts', SHARED_APP_ID, 'public', 'data', 'records');
                onSnapshot(recordsRef, (s) => { this.records = s.docs.map(d => ({ id: d.id, ...d.data() })); this.loading = false; });
            });
        },
        methods: {
            formatMoney(value) { return Number(value || 0).toLocaleString(); },
            switchTab(tab) { this.currentTab = tab; this.selectedWikiItem = null; },
            
            // --- MACHINE METHODS ---
            async addNewMachine() {
                const name = prompt("è¼¸å…¥æ–°æ©Ÿå™¨åç¨± (ä¾‹å¦‚: ç´¢å¤«æ³¢)");
                if(name) {
                    const { addDoc, collection, SHARED_APP_ID } = window.firebaseOps;
                    await addDoc(collection(window.db, 'artifacts', SHARED_APP_ID, 'public', 'data', 'machines'), {
                        name, origin:'', type:'', pain:'', downtime:'', duration:'', features:'', price:''
                    });
                }
            },
            async updateMachine(m) {
                const { updateDoc, doc, SHARED_APP_ID } = window.firebaseOps;
                const { id, ...data } = m;
                await updateDoc(doc(window.db, 'artifacts', SHARED_APP_ID, 'public', 'data', 'machines', id), data);
            },
            async deleteMachine(m) {
                if(confirm('ç¢ºå®šåˆªé™¤é€™å°æ©Ÿå™¨è³‡æ–™ï¼Ÿ')) {
                    const { deleteDoc, doc, SHARED_APP_ID } = window.firebaseOps;
                    await deleteDoc(doc(window.db, 'artifacts', SHARED_APP_ID, 'public', 'data', 'machines', m.id));
                }
            },

            // --- WIKI METHODS ---
            openWikiDetail(item) { this.selectedWikiItem = item; },
            closeWikiDetail() { this.selectedWikiItem = null; },
            async createNewWikiItem() { const name = prompt("é …ç›®åç¨±"); if(name) { const { addDoc, collection, SHARED_APP_ID } = window.firebaseOps; await addDoc(collection(window.db, 'artifacts', SHARED_APP_ID, 'public', 'data', 'wiki_v10'), { title:name, category:'è‡ªè¨‚', price:'-', desc:'', symptoms:[], quotes:[] }); } },
            async deleteWikiItem() { if(confirm('åˆªé™¤?')) { const { deleteDoc, doc, SHARED_APP_ID } = window.firebaseOps; await deleteDoc(doc(window.db, 'artifacts', SHARED_APP_ID, 'public', 'data', 'wiki_v10', this.selectedWikiItem.id)); this.selectedWikiItem=null; } },
            async cleanDuplicates() {
                if(!confirm('æ¸…ç†é‡è¤‡è³‡æ–™ï¼Ÿ')) return;
                const seen = new Set(); const duplicates = []; const { deleteDoc, doc, SHARED_APP_ID } = window.firebaseOps;
                this.wikiData.forEach(item => { if (seen.has(item.title)) duplicates.push(item); else seen.add(item.title); });
                if(duplicates.length===0) return alert('ç„¡é‡è¤‡');
                this.loading=true; for(const item of duplicates) await deleteDoc(doc(window.db, 'artifacts', SHARED_APP_ID, 'public', 'data', 'wiki_v10', item.id));
                this.loading=false; alert('æ¸…ç†å®Œæˆ');
            },
            async updateWikiItem(item) {
                let symArray = item.symptomsStr ? item.symptomsStr.split(/,|ï¼Œ/).map(s => s.trim()).filter(s => s) : [];
                item.symptoms = symArray;
                const { updateDoc, doc, SHARED_APP_ID } = window.firebaseOps;
                await updateDoc(doc(window.db, 'artifacts', SHARED_APP_ID, 'public', 'data', 'wiki_v10', item.id), { desc: item.desc||'', price: item.price||'', symptoms: symArray });
            },
            async deleteWikiPhoto() { if(confirm('åˆªé™¤åœ–ç‰‡ï¼Ÿ')) { this.selectedWikiItem.photo = ''; const { updateDoc, doc, SHARED_APP_ID } = window.firebaseOps; await updateDoc(doc(window.db, 'artifacts', SHARED_APP_ID, 'public', 'data', 'wiki_v10', this.selectedWikiItem.id), { photo: '' }); } },
            async addQuote() { if(!this.selectedWikiItem) return; const newQuotes = [...(this.selectedWikiItem.quotes || []), { ...this.newQuote }]; const { updateDoc, doc, SHARED_APP_ID } = window.firebaseOps; await updateDoc(doc(window.db, 'artifacts', SHARED_APP_ID, 'public', 'data', 'wiki_v10', this.selectedWikiItem.id), { quotes: newQuotes }); this.newQuote={clinic:'',price:''}; },
            async removeQuote(idx) { const newQuotes = [...this.selectedWikiItem.quotes]; newQuotes.splice(idx,1); const { updateDoc, doc, SHARED_APP_ID } = window.firebaseOps; await updateDoc(doc(window.db, 'artifacts', SHARED_APP_ID, 'public', 'data', 'wiki_v10', this.selectedWikiItem.id), { quotes: newQuotes }); },

            // --- OTHER METHODS ---
            async addClinic() { const { addDoc, collection, SHARED_APP_ID } = window.firebaseOps; await addDoc(collection(window.db, 'artifacts', SHARED_APP_ID, 'public', 'data', 'clinics'), { ...this.newClinic }); this.showAddClinic=false; },
            async removeClinic(id) { if(confirm('åˆªé™¤?')) { const { deleteDoc, doc, SHARED_APP_ID } = window.firebaseOps; await deleteDoc(doc(window.db, 'artifacts', SHARED_APP_ID, 'public', 'data', 'clinics', id)); } },
            async addRecord() { if(!this.newRecord.item) return; const { addDoc, collection, SHARED_APP_ID } = window.firebaseOps; await addDoc(collection(window.db, 'artifacts', SHARED_APP_ID, 'public', 'data', 'records'), { ...this.newRecord, photos: { before: '', after: '' } }); this.newRecord.item=''; this.newRecord.price=''; },
            async removeRecord(id) { if(confirm('åˆªé™¤?')) { const { deleteDoc, doc, SHARED_APP_ID } = window.firebaseOps; await deleteDoc(doc(window.db, 'artifacts', SHARED_APP_ID, 'public', 'data', 'records', id)); } },
            
            openPhotoModal(record) { this.currentEditingRecord = record; if(!this.currentEditingRecord.photos) this.currentEditingRecord.photos = { before: '', after: '' }; this.showPhotoModal = true; },
            closePhotoModal() { this.showPhotoModal = false; this.currentEditingRecord = null; },
            async deletePhoto(type) { if(confirm('åˆªé™¤?')) { this.currentEditingRecord.photos[type] = ''; const { updateDoc, doc, SHARED_APP_ID } = window.firebaseOps; await updateDoc(doc(window.db, 'artifacts', SHARED_APP_ID, 'public', 'data', 'records', this.currentEditingRecord.id), { [`photos.${type}`]: '' }); } },

            // --- PASTE & IMAGE HANDLER ---
            handlePaste(event, context, subtype, extraData) {
                const items = (event.clipboardData || event.originalEvent.clipboardData).items;
                for (let index in items) {
                    const item = items[index];
                    if (item.kind === 'file' && item.type.includes('image/')) {
                        this.processFile(item.getAsFile(), context, subtype, extraData);
                        event.preventDefault(); return;
                    }
                }
            },
            processFile(file, context, subtype, extraData) {
                if(!file) return;
                this.compressImage(file, async (base64) => { 
                    const { updateDoc, doc, SHARED_APP_ID } = window.firebaseOps;
                    if (context === 'wiki') {
                        this.selectedWikiItem.photo = base64; 
                        await updateDoc(doc(window.db, 'artifacts', SHARED_APP_ID, 'public', 'data', 'wiki_v10', this.selectedWikiItem.id), { photo: base64 });
                    } else if (context === 'record') {
                        this.currentEditingRecord.photos[subtype] = base64;
                        await updateDoc(doc(window.db, 'artifacts', SHARED_APP_ID, 'public', 'data', 'records', this.currentEditingRecord.id), { [`photos.${subtype}`]: base64 });
                    } else if (context === 'machine') {
                        extraData.photo = base64;
                        await updateDoc(doc(window.db, 'artifacts', SHARED_APP_ID, 'public', 'data', 'machines', extraData.id), { photo: base64 });
                    }
                });
            },
            compressImage(file, callback) {
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image(); img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const maxWidth = 500; let w = img.width; let h = img.height;
                        if (w > maxWidth) { h *= maxWidth / w; w = maxWidth; }
                        canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                        callback(canvas.toDataURL('image/jpeg', 0.7));
                    };
                };
            }
        }
    }).mount('#app');
</script>

</body>
</html>
