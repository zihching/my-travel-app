<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#c2a992">
    <title>æ¸…æ½”æ”¶è²»å°å¹«æ‰‹</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* iOS Safe Area Support */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f3f4f6;
            padding-bottom: calc(90px + env(safe-area-inset-bottom));
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }
        
        .no-select { user-select: none; -webkit-user-select: none; }
        input, textarea { user-select: text; -webkit-user-select: text; font-size: 16px !important; }

        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin-bottom: 16px;
            overflow: hidden;
        }

        .btn-primary {
            background-color: #10b981;
            color: white;
            transition: transform 0.1s;
        }
        .btn-primary:active { background-color: #059669; transform: scale(0.98); }
        
        .tag-cash { background-color: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe; }
        .tag-transfer { background-color: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }

        /* Service Tags */
        .tag-stairs { background-color: #ffedd5; color: #9a3412; border: 1px solid #fed7aa; } /* Orange */
        .tag-tank { background-color: #cffafe; color: #155e75; border: 1px solid #a5f3fc; } /* Cyan */

        /* Person Tags */
        .tag-zih-cing { background-color: #f5ebe0; color: #795548; border: 1px solid #e6dbd0; } 
        .tag-zih-han { background-color: #ffe4e6; color: #be185d; border: 1px solid #fda4af; } 
        .tag-zong-jing { background-color: #e0f2fe; color: #0369a1; border: 1px solid #bae6fd; } 

        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            z-index: 11000;
            display: none;
            font-size: 16px;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            width: max-content;
            max-width: 90%;
            text-align: center;
        }

        .badge-scroll::-webkit-scrollbar { display: none; }
        .badge-scroll { -ms-overflow-style: none; scrollbar-width: none; }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            backdrop-filter: blur(2px);
            display: flex;
            align-items: flex-end;
        }
        .modal-content {
            background: white;
            width: 100%;
            max-height: 85vh;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            padding-bottom: calc(30px + env(safe-area-inset-bottom));
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        @media(min-width: 640px) {
            .modal-overlay { align-items: center; justify-content: center; }
            .modal-content { width: 90%; max-width: 500px; border-radius: 20px; padding-bottom: 20px; }
        }
        
        .list-btn:active {
            background-color: #eff6ff;
            transform: scale(0.99);
        }
        
        #loading-overlay {
            position: fixed; inset: 0; background: rgba(255,255,255,0.8);
            z-index: 11000; display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(4px); transition: opacity 0.3s;
        }

        /* Tabs Styles */
        .collector-tab { transition: all 0.2s ease; }
        .collector-tab.active-zih-cing { background-color: #c2a992; color: white; box-shadow: 0 2px 5px rgba(194, 169, 146, 0.4); }
        .collector-tab.active-zih-han { background-color: #ff99ac; color: white; box-shadow: 0 2px 5px rgba(255, 153, 172, 0.4); }
        .collector-tab.active-zong-jing { background-color: #38bdf8; color: white; box-shadow: 0 2px 5px rgba(56, 189, 248, 0.4); }
        
        /* Service Toggle Styles */
        .service-btn { transition: all 0.2s; border: 2px solid transparent; opacity: 0.6; filter: grayscale(0.5); }
        .service-btn.active { opacity: 1; filter: grayscale(0); border-color: currentColor; transform: scale(1.02); }
        .service-btn.active i { animation: bounce 0.5s; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }

        /* Status Styles */
        .status-btn {
            opacity: 0.6; border: 2px solid transparent; filter: grayscale(1); transition: all 0.2s;
        }
        .status-btn.active {
            opacity: 1; filter: grayscale(0); transform: scale(1.05);
        }
        .status-btn.active-red { border-color: #ef4444; background-color: #fee2e2; color: #b91c1c; }
        .status-btn.active-orange { border-color: #f97316; background-color: #ffedd5; color: #c2410c; }

        /* Month Picker Grid */
        .month-btn {
            border: 2px solid #e5e7eb;
            background: white;
            color: #9ca3af;
            padding: 10px 4px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.15s;
            position: relative;
        }
        .month-btn.selected {
            background: #3b82f6; color: white; border-color: #2563eb; transform: scale(1.05);
            box-shadow: 0 4px 6px rgba(59, 130, 246, 0.3);
            z-index: 10;
        }
        .month-btn.paid {
            background: #d1fae5; color: #065f46; border-color: #34d399; cursor: not-allowed;
        }
        .month-btn.paid::after {
            content: attr(data-date); position: absolute; bottom: 2px; left: 50%;
            transform: translateX(-50%); font-size: 9px; line-height: 1; white-space: nowrap;
        }

        /* Annual Report Styles (Updated) */
        .year-dot {
            width: 100%; aspect-ratio: 1; border-radius: 8px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-weight: bold; border: 1px solid #e5e7eb; color: #d1d5db;
            background-color: #f9fafb;
            line-height: 1.2;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .year-dot:active { transform: scale(0.95); }
        .year-dot.paid { background-color: #10b981; color: white; border-color: #059669; }
        .year-dot.warning { background-color: #fff7ed; color: #f97316; border-color: #f97316; border-width: 2px; }

        /* Print Styles */
        @media print {
            #view-entry, #view-settle, #view-settings, #view-report, #mainHeader, #bottomNav, .toast, #loading-overlay, .modal-overlay, button { display: none !important; }
            #printContainer { display: block !important; width: 100%; }
            body { background-color: white; font-size: 12pt; color: black; }
            .print-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
            .print-table th, .print-table td { border: 1px solid #000; padding: 8px; text-align: left; }
            .print-table th { background-color: #f3f4f6 !important; font-weight: bold; -webkit-print-color-adjust: exact; }
            .print-summary { border: 2px solid #000; padding: 15px; margin-bottom: 20px; display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; }
            .print-title { text-align: center; font-size: 24px; font-weight: bold; margin-bottom: 10px; margin-top: 20px; }
        }
        #printContainer { display: none; }
        #mainHeader { transition: background-color 0.3s ease; }
    </style>
</head>
<body class="no-select">

    <div id="loading-overlay">
        <div class="text-emerald-600 font-bold flex flex-col items-center">
            <i class="fa-solid fa-circle-notch fa-spin text-4xl mb-2"></i>
            <span>é€£ç·šåŒæ­¥ä¸­...</span>
        </div>
    </div>

    <div id="toast" class="toast">æ“ä½œæˆåŠŸ</div>

    <!-- Header -->
    <div id="mainHeader" class="bg-[#c2a992] text-white pt-safe sticky top-0 z-20 shadow-lg transition-colors duration-300">
        <div class="px-4 pb-4 pt-2">
            <div class="flex justify-between items-center mb-3">
                <h1 class="text-xl font-bold flex items-center gap-2 text-white drop-shadow-sm">
                    <span id="headerTitleIcon"><i class="fa-solid fa-mug-hot"></i></span> 
                    <span id="headerTitleText">æ”¶è²»å°å¹«æ‰‹</span>
                </h1>
                <div class="text-xs font-medium bg-white/20 px-2 py-1 rounded backdrop-blur-sm shadow-sm flex items-center gap-1">
                    <i class="fa-solid fa-cloud text-[10px]"></i> <span id="headerDate"></span>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-3 text-center">
                <div class="bg-white/10 backdrop-blur-sm rounded-xl p-2 border border-white/20 shadow-sm">
                    <div class="text-xs text-white mb-1 font-medium opacity-90">å€‹äººæ‰‹é ­ (å«LP)</div>
                    <div class="text-xl font-bold tracking-wide drop-shadow-sm" id="headerCashTotal">$0</div>
                </div>
                <div class="bg-white/10 backdrop-blur-sm rounded-xl p-2 border border-white/20 shadow-sm">
                    <div class="text-xs text-white mb-1 font-medium opacity-90">å€‹äººå…¨éƒ¨ç‡Ÿæ”¶</div>
                    <div class="text-xl font-bold tracking-wide drop-shadow-sm" id="headerTransferTotal">$0</div>
                </div>
            </div>
             <div class="mt-2 text-center text-white/90 font-medium">
                <span class="text-xs opacity-90">ä»Šæ—¥å€‹äººç‡Ÿæ”¶: </span>
                <span id="headerGrandTotal" class="font-bold text-sm drop-shadow-sm">$0</span>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-4 max-w-md pb-28">

        <!-- VIEW: ENTRY FORM -->
        <div id="view-entry">

            <!-- COLLECTOR TABS -->
            <div class="flex p-1 bg-gray-100 rounded-xl mb-4 shadow-inner border border-gray-200">
                <button onclick="setCollector('å­æ™´')" id="tab-zih-cing" class="collector-tab flex-1 py-3 rounded-lg text-sm font-bold text-gray-400 flex items-center justify-center gap-1">
                    ğŸ  å­æ™´
                </button>
                <button onclick="setCollector('å­æ¶µ')" id="tab-zih-han" class="collector-tab flex-1 py-3 rounded-lg text-sm font-bold text-gray-400 flex items-center justify-center gap-1">
                    ğŸŒ¸ å­æ¶µ
                </button>
                <button onclick="setCollector('å®—æ•¬')" id="tab-zong-jing" class="collector-tab flex-1 py-3 rounded-lg text-sm font-bold text-gray-400 flex items-center justify-center gap-1">
                    â˜ï¸ å®—æ•¬
                </button>
            </div>

            <!-- ADD FORM -->
            <div class="card p-5 border-t-4 border-[#e6dbd0] transition-colors duration-300" id="entryCard">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-gray-800 flex items-center">
                        <i class="fa-solid fa-pen-circle mr-2 opacity-80"></i> æ–°å¢
                    </h2>
                    <!-- QUICK SELECT BUTTON -->
                    <button onclick="openCustomerSelect()" class="bg-gray-600 text-white text-sm px-4 py-2 rounded-lg shadow active:scale-95 flex items-center transition-all" id="quickSelectBtn">
                        <i class="fa-solid fa-folder-open mr-2"></i> å¿«é€Ÿé¸å®¢æˆ¶
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div class="hidden">
                        <input type="date" id="inputDate">
                    </div>

                    <!-- Service Category Toggle -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1 uppercase tracking-wider">æœå‹™é …ç›®</label>
                        <div class="grid grid-cols-2 gap-3">
                            <button type="button" onclick="setServiceCategory('stairs')" id="btn-cat-stairs" class="service-btn active p-3 rounded-xl bg-orange-50 text-orange-700 font-bold flex justify-center items-center gap-2 shadow-sm">
                                ğŸªœ æ´—æ¨“æ¢¯
                            </button>
                            <button type="button" onclick="setServiceCategory('tank')" id="btn-cat-tank" class="service-btn p-3 rounded-xl bg-cyan-50 text-cyan-700 font-bold flex justify-center items-center gap-2 shadow-sm">
                                ğŸ’§ æ´—æ°´å¡”
                            </button>
                        </div>
                        <input type="hidden" id="inputServiceType" value="stairs">
                    </div>

                    <div class="flex gap-3">
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-gray-500 mb-1 uppercase tracking-wider">åœ°å€ / å®¢æˆ¶</label>
                            <!-- On Input, trigger paid status check -->
                            <input type="text" id="inputAddress" oninput="debounceCheckPaidStatus(this.value)" placeholder="ä¾‹å¦‚ï¼šä¸­æ­£è·¯100è™Ÿ" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-lg focus:border-gray-400 outline-none transition-colors">
                        </div>
                        <div class="w-24">
                            <label class="block text-xs font-bold text-gray-500 mb-1 uppercase tracking-wider">æ¨“å±¤/æˆ¶è™Ÿ</label>
                            <input type="text" id="inputFloor" placeholder="5F" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-lg text-center focus:border-gray-400 outline-none transition-colors">
                        </div>
                    </div>

                    <!-- Month Picker Grid (Inline) -->
                    <div class="bg-gray-50 p-3 rounded-xl border border-gray-200">
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">
                                <i class="fa-regular fa-calendar-check mr-1"></i> æ”¶è²»æœˆä»½
                            </label>
                            <div class="flex items-center bg-white rounded-lg border border-gray-300 overflow-hidden shadow-sm">
                                <button type="button" onclick="changeYear(-1)" class="px-3 py-1 hover:bg-gray-100 text-gray-600 border-r border-gray-200 active:bg-gray-200"><i class="fa-solid fa-chevron-left"></i></button>
                                <span class="px-3 py-1 text-sm font-bold text-emerald-600 min-w-[60px] text-center bg-emerald-50" id="pickerYearDisplay">114å¹´</span>
                                <button type="button" onclick="changeYear(1)" class="px-3 py-1 hover:bg-gray-100 text-gray-600 border-l border-gray-200 active:bg-gray-200"><i class="fa-solid fa-chevron-right"></i></button>
                            </div>
                        </div>
                        <div class="grid grid-cols-4 gap-2" id="monthPickerGrid">
                            <!-- JS Generated 1-12 -->
                        </div>
                        <input type="hidden" id="selectedMonths" value="">
                        <div class="text-right mt-1 text-xs text-blue-500 font-medium h-4" id="statusHint"></div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1 uppercase tracking-wider">é‡‘é¡</label>
                            <input type="number" id="inputAmount" placeholder="$" inputmode="decimal" pattern="[0-9]*" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-xl font-bold text-gray-700 focus:border-gray-400 outline-none transition-colors">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1 uppercase tracking-wider">æ–¹å¼</label>
                            <select id="inputType" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-lg h-[54px] focus:border-gray-400 outline-none transition-colors">
                                <option value="cash">ğŸ’µ ç¾é‡‘</option>
                                <option value="transfer">ğŸ¦ åŒ¯æ¬¾</option>
                                <option value="linepay">ğŸŸ¢ LinePay</option>
                                <option value="dad">ğŸ‘´ åŒ¯çµ¦çˆ¸çˆ¸</option>
                            </select>
                        </div>
                    </div>

                    <!-- Status Toggles -->
                    <div>
                         <label class="block text-xs font-bold text-gray-500 mb-1 uppercase tracking-wider">ç‰¹æ®Šç‹€æ…‹æé†’</label>
                         <div class="flex gap-2 mb-3">
                            <button type="button" onclick="setStatus('no_receipt')" id="btn-status-receipt" class="status-btn flex-1 p-2 rounded-lg bg-red-50 text-red-500 font-bold border border-red-200 flex justify-center items-center gap-1">
                                <i class="fa-solid fa-file-invoice"></i> æ¬ æ”¶æ“š(å·²æ”¶éŒ¢)
                            </button>
                            <button type="button" onclick="setStatus('no_payment')" id="btn-status-payment" class="status-btn flex-1 p-2 rounded-lg bg-orange-50 text-orange-500 font-bold border border-orange-200 flex justify-center items-center gap-1">
                                <i class="fa-solid fa-sack-dollar"></i> æ¬ åŒ¯æ¬¾(å·²çµ¦å–®)
                            </button>
                         </div>
                         <input type="hidden" id="inputStatus" value="completed">
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-2 uppercase tracking-wider">å‚™è¨»</label>
                        <textarea id="inputNote" rows="1" placeholder="å…¶ä»–..." class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:border-gray-400 outline-none h-[54px] transition-colors"></textarea>
                    </div>

                    <div class="grid grid-cols-2 gap-2 mt-2">
                        <button onclick="addToPending()" class="w-full py-4 rounded-xl text-lg font-bold bg-gray-200 text-gray-600 shadow active:scale-95 transition-all flex justify-center items-center">
                            <i class="fa-solid fa-list-check mr-2"></i> åŠ å…¥æ¸…å–®
                        </button>
                        <button onclick="addRecord()" class="w-full btn-primary py-4 rounded-xl text-lg font-bold shadow-lg shadow-gray-300 flex justify-center items-center gap-2 transition-all active:scale-95" id="addBtn">
                            <i class="fa-solid fa-check mr-2"></i> ç›´æ¥æ”¶æ¬¾
                        </button>
                    </div>
                </div>
            </div>

            <!-- PENDING LIST -->
            <div id="pendingContainer" class="hidden mb-6">
                <div class="flex justify-between items-end mb-3 px-1 mt-6">
                    <h3 class="font-bold text-gray-700 uppercase text-sm tracking-wider flex items-center gap-1">
                        <i class="fa-solid fa-clipboard-list text-blue-500"></i> å¾…æ”¶æ¸…å–® (è·¯ç·š)
                    </h3>
                    <span class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded-full" id="pendingCount">0</span>
                </div>
                <div id="pendingList" class="space-y-2">
                    <!-- Pending Items injected here -->
                </div>
            </div>

            <!-- RECENT HISTORY -->
            <div class="flex justify-between items-end mt-8 mb-3 px-1">
                <h3 class="font-bold text-gray-500 uppercase text-sm tracking-wider flex items-center gap-1">
                    <span id="listTitleIcon">ğŸ </span> <span id="listTitleName">å­æ™´</span> çš„æœ€è¿‘ç´€éŒ„
                </h3>
                <span class="text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded-full" id="recordCount">0</span>
            </div>

            <div id="recordList" class="space-y-3 pb-24">
                <!-- Records injected here -->
            </div>
        </div>

        <!-- VIEW: SETTLEMENT -->
        <div id="view-settle" class="hidden">
            <div class="card p-6 bg-white border border-blue-100 shadow-xl">
                <h2 class="text-xl font-bold text-blue-800 mb-6 flex items-center border-b border-blue-100 pb-3">
                    <i class="fa-solid fa-money-bill-transfer mr-2"></i> <span id="settlePageTitle">è–ªæ°´çµç®—</span>
                </h2>
                
                <div class="space-y-6">
                    <!-- Warning Section -->
                    <div id="settleWarnings" class="hidden space-y-2">
                        <!-- Injected -->
                    </div>

                    <!-- Personal Stats Grid -->
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-gray-50 p-3 rounded-xl border border-gray-100 text-center">
                             <div class="text-xs text-gray-500 mb-1">ç¾é‡‘ (æŒæœ‰)</div>
                             <div class="font-bold text-gray-800 text-lg" id="settleCash">$0</div>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-xl border border-blue-100 text-center">
                             <div class="text-xs text-blue-600 mb-1">éŠ€è¡ŒåŒ¯æ¬¾ (æŒæœ‰)</div>
                             <div class="font-bold text-blue-700 text-lg" id="settleTransfer">$0</div>
                        </div>
                        <div class="bg-lime-50 p-3 rounded-xl border border-lime-200 text-center">
                             <div class="text-xs text-lime-700 mb-1">LinePay (æŒæœ‰)</div>
                             <div class="font-bold text-lime-800 text-lg" id="settleLinePay">$0</div>
                        </div>
                        <div class="bg-purple-50 p-3 rounded-xl border border-purple-200 text-center opacity-70">
                             <div class="text-xs text-purple-700 mb-1">å·²åŒ¯çµ¦çˆ¸çˆ¸</div>
                             <div class="font-bold text-purple-800 text-lg" id="settleDad">$0</div>
                        </div>
                    </div>

                    <!-- Total and Salary -->
                    <div class="flex justify-between items-center px-2 pt-2 border-t border-gray-100">
                        <div>
                            <span class="font-bold text-gray-600 block">å€‹äººç¸½ç‡Ÿæ”¶</span>
                            <span class="text-[10px] text-gray-400">(å«çµ¦çˆ¸çˆ¸çš„)</span>
                        </div>
                        <span class="font-bold text-2xl text-emerald-600" id="settleTotal">$0</span>
                    </div>
                    
                    <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200 shadow-sm">
                        <label class="block text-sm font-bold text-yellow-800 mb-2">
                            <i class="fa-solid fa-user-tag mr-1"></i> æˆ‘çš„è–ªæ°´
                        </label>
                        <div class="flex items-center bg-white rounded-lg px-3 border border-yellow-200">
                            <span class="text-xl mr-2 text-gray-400">$</span>
                            <input type="number" id="mySalary" value="0" inputmode="decimal" pattern="[0-9]*" oninput="calculateSettlement()" class="w-full py-3 text-2xl font-bold text-gray-800 text-right outline-none">
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-emerald-500 to-teal-600 p-5 rounded-xl text-center shadow-lg text-white transform scale-105">
                        <div class="text-sm text-emerald-100 mb-1 font-medium">æœ€å¾Œçµ¦çˆ¸çˆ¸çš„éŒ¢</div>
                        <div class="text-4xl font-bold tracking-tight" id="finalToDad">$0</div>
                        <div class="text-[10px] text-emerald-200 mt-1">(ç¾é‡‘+åŒ¯æ¬¾+LinePay) - è–ªæ°´</div>
                    </div>

                    <!-- Others Breakdown (Bottom) -->
                    <div class="mt-8 pt-4 border-t border-gray-200">
                        <h3 class="text-sm font-bold text-gray-400 mb-3">å…¶ä»–äººå“¡åƒè€ƒè³‡æ–™</h3>
                        <div id="collectorBreakdown" class="space-y-2"></div>
                        <!-- Category Stats (Global) -->
                        <div class="grid grid-cols-2 gap-3 mt-3" id="categoryBreakdown"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: REPORT (YEARLY) -->
        <div id="view-report" class="hidden">
            <div class="card p-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-gray-800" id="reportTitle">å¹´åº¦å ±è¡¨</h2>
                     <div class="flex items-center bg-gray-100 rounded-lg overflow-hidden">
                        <button onclick="changeReportYear(-1)" class="px-3 py-1 hover:bg-gray-200 text-gray-600"><i class="fa-solid fa-chevron-left"></i></button>
                        <span class="px-2 font-bold text-emerald-600" id="reportYearDisplay">114å¹´</span>
                        <button onclick="changeReportYear(1)" class="px-3 py-1 hover:bg-gray-200 text-gray-600"><i class="fa-solid fa-chevron-right"></i></button>
                    </div>
                </div>
                
                <div class="text-xs text-gray-400 mb-2 flex gap-3">
                    <div class="flex items-center"><span class="w-2 h-2 rounded-full bg-emerald-500 mr-1"></span> å·²æ”¶</div>
                    <div class="flex items-center"><span class="w-2 h-2 rounded-full bg-white border border-orange-400 mr-1"></span> å¾…è™•ç†</div>
                    <div class="flex items-center"><span class="w-2 h-2 rounded-full bg-gray-100 border border-gray-300 mr-1"></span> æœªæ”¶</div>
                </div>

                <div id="yearReportGrid" class="space-y-4">
                    <!-- JS Injected -->
                </div>
            </div>
        </div>

        <!-- VIEW: SETTINGS & CUSTOMERS -->
        <div id="view-settings" class="hidden">
             <div class="card p-5 border-l-4 border-blue-500 mb-4">
                <h2 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
                    <i class="fa-solid fa-address-book text-blue-500 mr-2"></i> å¸¸ç”¨å®¢æˆ¶ / è·¯ç·šç®¡ç†
                </h2>
                <p class="text-xs text-gray-500 mb-4">å»ºç«‹å¾Œï¼Œè¨˜å¸³æ™‚å¯ç›´æ¥é¸æ“‡ã€‚</p>
                <div class="grid grid-cols-2 gap-2 mb-3">
                    <button onclick="openAddCustomerModal()" class="py-2.5 bg-blue-600 text-white rounded-lg text-sm font-bold shadow active:bg-blue-700">
                        <i class="fa-solid fa-plus mr-1"></i> æ–°å¢å¸¸ç”¨å®¢æˆ¶
                    </button>
                    <button onclick="importFavoritesToPending()" class="py-2.5 bg-emerald-500 text-white rounded-lg text-sm font-bold shadow active:bg-emerald-600">
                        <i class="fa-solid fa-route mr-1"></i> åŒ¯å…¥ä»Šæ—¥è·¯ç·š
                    </button>
                </div>
                <div id="customerListSettings" class="space-y-2 max-h-60 overflow-y-auto pr-1 bg-gray-50 p-2 rounded-xl"></div>
             </div>
             <div class="card p-5">
                <h2 class="text-lg font-bold text-gray-700 mb-4">è³‡æ–™å‚™ä»½èˆ‡å·¥å…·</h2>
                <div class="space-y-3">
                    <div class="p-4 bg-emerald-50 border border-emerald-100 rounded-xl text-emerald-800 text-sm">
                        <i class="fa-solid fa-check-circle mr-2"></i> è³‡æ–™åº«ç‹€æ…‹: 
                        <span class="font-bold text-emerald-600">å·²é€£ç·š (å…¬å…±å€åŸŸ)</span>
                        <div class="text-xs text-emerald-600 mt-1 opacity-75">ID: <span id="userIdDisplay">...</span></div>
                    </div>
                    <button onclick="printAllRecords()" class="w-full p-4 bg-blue-50 border border-blue-200 rounded-xl text-left text-blue-700 flex justify-between items-center shadow-sm active:bg-blue-100">
                        <span class="font-bold"><i class="fa-solid fa-print mr-3"></i> åˆ—å°ç¸½å ±è¡¨ (çµ¦çˆ¸çˆ¸)</span>
                        <i class="fa-solid fa-chevron-right"></i>
                    </button>
                    <button onclick="exportData()" class="w-full p-4 bg-white border border-gray-200 rounded-xl text-left active:bg-gray-50 flex justify-between items-center shadow-sm">
                        <span class="font-medium text-gray-700"><i class="fa-solid fa-download mr-3 text-blue-500 w-5"></i> ä¸‹è¼‰å‚™ä»½ (JSON)</span>
                        <i class="fa-solid fa-chevron-right text-gray-300"></i>
                    </button>
                </div>
            </div>
        </div>

    </div>
    
    <!-- PRINT CONTAINER -->
    <div id="printContainer"></div>

    <!-- Bottom Navigation (FIXED POSITION) -->
    <div class="fixed bottom-0 left-0 w-full bg-white/95 backdrop-blur-md border-t border-gray-200 flex justify-around pb-safe pt-2 z-[9999] shadow-[0_-4px_20px_rgba(0,0,0,0.05)]" id="bottomNav">
        <button onclick="toggleView('entry')" class="flex flex-col items-center w-1/4 py-2 text-emerald-600 transition-colors" id="nav-entry">
            <div class="text-xl mb-1 relative"><i class="fa-solid fa-pen-to-square"></i></div>
            <span class="text-[10px] font-bold">è¨˜å¸³</span>
        </button>
        <button onclick="toggleView('settle')" class="flex flex-col items-center w-1/4 py-2 text-gray-400 transition-colors" id="nav-settle">
            <div class="text-xl mb-1"><i class="fa-solid fa-calculator"></i></div>
            <span class="text-[10px] font-medium">çµç®—</span>
        </button>
        <button onclick="toggleView('report')" class="flex flex-col items-center w-1/4 py-2 text-gray-400 transition-colors" id="nav-report">
            <div class="text-xl mb-1"><i class="fa-solid fa-calendar-days"></i></div>
            <span class="text-[10px] font-medium">å¹´å ±</span>
        </button>
        <button onclick="toggleView('settings')" class="flex flex-col items-center w-1/4 py-2 text-gray-400 transition-colors" id="nav-settings">
            <div class="text-xl mb-1"><i class="fa-solid fa-gear"></i></div>
            <span class="text-[10px] font-medium">è¨­å®š</span>
        </button>
    </div>

    <!-- CUSTOMER SELECT MODAL -->
    <div id="customerModal" class="modal-overlay hidden" onclick="closeCustomerSelect(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-lg font-bold text-gray-800"><i class="fa-solid fa-users text-blue-500"></i> é¸æ“‡å®¢æˆ¶ (<span id="customerModalCollector"></span>)</h3>
                <button onclick="closeCustomerSelect(null)" class="text-gray-400 p-2 bg-gray-100 rounded-full w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <input type="text" id="customerSearch" onkeyup="renderCustomerSelect()" placeholder="æœå°‹åœ°å€..." class="w-full p-3 bg-gray-50 border rounded-xl mb-3 outline-none focus:border-blue-400">
            <div id="customerSelectList" class="space-y-2 pb-4 max-h-[50vh] overflow-y-auto"></div>
        </div>
    </div>

    <!-- HISTORY MODAL -->
    <div id="historyModal" class="modal-overlay hidden" onclick="closeHistory(event)">
        <div class="modal-content h-[70vh] flex flex-col" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-lg font-bold text-gray-800"><i class="fa-solid fa-clock-rotate-left text-orange-500"></i> æ”¶è²»ç´€éŒ„</h3>
                <button onclick="closeHistory(null)" class="text-gray-400 p-2 bg-gray-100 rounded-full w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div id="historyTitle" class="text-sm font-bold text-gray-500 mb-2 px-1"></div>
            <div id="historyList" class="overflow-y-auto flex-1 space-y-2"></div>
        </div>
    </div>

    <!-- CONFIRM COLLECTION MODAL -->
    <div id="confirmCollectionModal" class="modal-overlay hidden" onclick="closeConfirmCollectionModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-lg font-bold text-emerald-600"><i class="fa-solid fa-circle-check"></i> ç¢ºèªæ”¶æ¬¾æ—¥æœŸ</h3>
                <button onclick="closeConfirmCollectionModal(null)" class="text-gray-400 p-2 bg-gray-100 rounded-full w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="space-y-4">
                <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                    <div class="text-sm text-gray-500">é …ç›®</div>
                    <div class="font-bold text-gray-800 text-lg" id="confirmModalAddress"></div>
                    <div class="mt-2">
                        <label class="text-xs text-gray-400">æ”¶è²»æœˆä»½</label>
                        <input type="text" id="confirmModalMonths" class="w-full p-2 border rounded font-bold text-blue-600 bg-white">
                    </div>
                </div>
                <div class="flex gap-2">
                     <div class="flex-1">
                        <label class="block text-xs font-bold text-gray-500 mb-1">æ”¶æ¬¾æ—¥æœŸ</label>
                        <input type="date" id="confirmModalDate" class="w-full p-3 bg-white border-2 border-emerald-100 rounded-xl text-lg font-bold text-gray-700 outline-none focus:border-emerald-400">
                     </div>
                     <div class="flex-1">
                        <label class="block text-xs font-bold text-gray-500 mb-1">æ–¹å¼</label>
                        <select id="confirmModalType" class="w-full p-3 bg-white border-2 border-emerald-100 rounded-xl text-lg h-[54px] focus:border-emerald-400 outline-none">
                            <option value="cash">ç¾é‡‘</option>
                            <option value="transfer">åŒ¯æ¬¾</option>
                            <option value="linepay">LinePay</option>
                            <option value="dad">åŒ¯çµ¦çˆ¸çˆ¸</option>
                        </select>
                     </div>
                </div>
                
                <!-- Status Toggles for Modal -->
                <div>
                     <label class="block text-xs font-bold text-gray-500 mb-1 uppercase tracking-wider">ç‰¹æ®Šç‹€æ…‹</label>
                     <div class="flex gap-2 mb-3">
                        <button type="button" onclick="setModalStatus('no_receipt')" id="modal-status-receipt" class="status-btn flex-1 p-2 rounded-lg bg-red-50 text-red-500 font-bold border border-red-200 flex justify-center items-center gap-1">
                            <i class="fa-solid fa-file-invoice"></i> æ¬ æ”¶æ“š
                        </button>
                        <button type="button" onclick="setModalStatus('no_payment')" id="modal-status-payment" class="status-btn flex-1 p-2 rounded-lg bg-orange-50 text-orange-500 font-bold border border-orange-200 flex justify-center items-center gap-1">
                            <i class="fa-solid fa-sack-dollar"></i> æ¬ åŒ¯æ¬¾
                        </button>
                     </div>
                     <input type="hidden" id="modalInputStatus" value="completed">
                </div>

                <!-- Note Input for Modal (New) -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1 uppercase tracking-wider">å‚™è¨»</label>
                    <textarea id="confirmModalNote" rows="1" placeholder="å¡«å¯«å‚™è¨»..." class="w-full p-3 bg-white border border-gray-200 rounded-xl focus:border-emerald-400 outline-none"></textarea>
                </div>

                <div class="text-center">
                    <span class="text-xs text-gray-400">é‡‘é¡</span>
                    <div class="text-2xl font-bold text-emerald-600" id="confirmModalAmount"></div>
                </div>
                <button id="confirmCollectionBtn" class="w-full py-4 bg-emerald-500 text-white rounded-xl text-xl font-bold shadow-lg shadow-emerald-200 active:scale-95 transition-all">ç¢ºèªæ”¶æ¬¾</button>
            </div>
        </div>
    </div>
    
    <!-- REPORT ACTION MODAL -->
    <div id="reportActionModal" class="modal-overlay hidden" onclick="closeReportActionModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
             <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-lg font-bold text-gray-800" id="reportActionTitle">ç·¨è¼¯ç´€éŒ„</h3>
                <button onclick="closeReportActionModal(null)" class="text-gray-400"><i class="fa-solid fa-times"></i></button>
            </div>
            
            <div id="reportActionContent" class="space-y-4">
                <!-- Dynamic Content -->
            </div>
        </div>
    </div>

    <!-- MONTH PICKER MODAL -->
    <div id="monthPickerModal" class="modal-overlay hidden" onclick="closeMonthPickerModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-gray-700 flex items-center gap-2">é¸æ“‡æœˆä»½ (<span id="modalYearDisplay">114å¹´</span>)</h3>
                <button onclick="closeMonthPickerModal(null)" class="text-gray-400"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="flex items-center justify-center bg-gray-50 rounded-lg p-2 mb-4">
                <button onclick="changeModalYear(-1)" class="p-2 text-gray-500 hover:bg-gray-200 rounded-lg"><i class="fa-solid fa-chevron-left"></i></button>
                <span class="mx-4 font-bold text-lg text-emerald-600" id="modalYearDisplaySpan">114å¹´</span>
                <button onclick="changeModalYear(1)" class="p-2 text-gray-500 hover:bg-gray-200 rounded-lg"><i class="fa-solid fa-chevron-right"></i></button>
            </div>
            <div class="grid grid-cols-4 gap-3 mb-4" id="modalMonthGrid"></div>
            <button onclick="applyModalMonths()" class="w-full btn-primary py-3 rounded-xl font-bold">ç¢ºå®š</button>
        </div>
    </div>

    <!-- ADD/EDIT CUSTOMER MODAL -->
    <div id="addCustomerModal" class="modal-overlay hidden" onclick="closeAddCustomerModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-lg font-bold text-gray-800" id="customerModalTitle"><i class="fa-solid fa-user-plus text-green-600"></i> æ–°å¢å¸¸ç”¨å®¢æˆ¶</h3>
                <button onclick="closeAddCustomerModal(null)" class="text-gray-400 p-2 bg-gray-100 rounded-full w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="space-y-3">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">é è¨­é …ç›®</label>
                    <div class="grid grid-cols-2 gap-2">
                        <button type="button" onclick="setEditCustCategory('stairs')" id="edit-cat-stairs" class="p-2 rounded border text-sm font-bold bg-orange-100 text-orange-800 border-orange-200">ğŸªœ æ´—æ¨“æ¢¯</button>
                        <button type="button" onclick="setEditCustCategory('tank')" id="edit-cat-tank" class="p-2 rounded border text-sm font-bold bg-gray-50 text-gray-400 border-gray-200">ğŸ’§ æ´—æ°´å¡”</button>
                    </div>
                    <input type="hidden" id="editCustCategory" value="stairs">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">åœ°å€ / åç¨± (å¿…å¡«)</label>
                    <input type="text" id="newCustAddr" placeholder="ä¾‹å¦‚ï¼šéŒ¦å·è¡—" class="w-full p-3 bg-gray-50 border rounded-xl outline-none focus:border-green-500 text-lg">
                </div>
                <div class="flex gap-2">
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-gray-500 mb-1">é‡‘é¡ (å¿…å¡«)</label>
                        <input type="number" id="newCustAmt" placeholder="16000" inputmode="decimal" class="w-full p-3 bg-gray-50 border rounded-xl outline-none focus:border-green-500 font-bold text-emerald-600 text-lg">
                    </div>
                    <div class="w-24">
                        <label class="block text-xs font-bold text-gray-500 mb-1">æ¨“å±¤ (å¯ä¸å¡«)</label>
                        <input type="text" id="newCustFloor" placeholder="ä¸å›ºå®š" class="w-full p-3 bg-gray-50 border rounded-xl outline-none focus:border-green-500 text-center text-lg">
                    </div>
                </div>
                <button onclick="saveCustomer()" class="w-full py-3 bg-green-600 text-white rounded-xl font-bold mt-2 shadow text-lg">å„²å­˜</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs and Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, doc, addDoc, deleteDoc, updateDoc, getDoc,
            onSnapshot, query, orderBy, enableIndexedDbPersistence, serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDFUGYOobmVxYFQMBYz1iQ4z1HIrdbTi8Q",
            authDomain: "travel-55c4b.firebaseapp.com",
            databaseURL: "https://travel-55c4b-default-rtdb.firebaseio.com",
            projectId: "travel-55c4b",
            storageBucket: "travel-55c4b.firebasestorage.app",
            messagingSenderId: "925227625640",
            appId: "1:925227625640:web:3dc6a2e45735ceb7f8a69d",
            measurementId: "G-6W8NY3EBZF"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const APP_ID = 'cleaning-app-v1'; 
        let currentUser = null;

        enableIndexedDbPersistence(db).catch((err) => {
            if (err.code == 'failed-precondition') { console.log("Persistence failed: Multiple tabs open."); } 
            else if (err.code == 'unimplemented') { console.log("Persistence not supported."); }
        });

        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try { await signInWithCustomToken(auth, __initial_auth_token); } 
                catch (e) { console.log("Custom token mismatch, falling back to anon."); await signInAnonymously(auth); }
            } else { await signInAnonymously(auth); }
        };
        initAuth();

        onAuthStateChanged(auth, (user) => {
            const loader = document.getElementById('loading-overlay');
            if (user) {
                currentUser = user;
                const uidDisp = document.getElementById('userIdDisplay');
                if(uidDisp) uidDisp.innerText = `...${user.uid.slice(-4)}`;
                setupListeners();
                if(loader) loader.style.display = 'none';
            }
        });

        function setupListeners() {
            const recordsRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'records');
            const customersRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'customers');
            const pendingRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'pending');

            const qRec = query(recordsRef, orderBy('date', 'desc')); 
            onSnapshot(qRec, (snapshot) => {
                let recs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                recs.sort((a, b) => {
                    if (a.date > b.date) return -1;
                    if (a.date < b.date) return 1;
                    const tA = a.createdAt?.seconds || 0;
                    const tB = b.createdAt?.seconds || 0;
                    return tB - tA; 
                });
                window.appState.records = recs;
                window.renderRecords();
                window.updateSummary();
                if(window.appState.currentView === 'report') window.renderYearlyReport();
                const addr = document.getElementById('inputAddress').value;
                if(addr) window.checkPaidStatus(addr);
            });

            const qCust = query(customersRef, orderBy('createdAt', 'desc'));
            onSnapshot(qCust, (snapshot) => {
                window.appState.customers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                window.renderCustomerSettings();
                if(!document.getElementById('customerModal').classList.contains('hidden')) {
                    window.renderCustomerSelect();
                }
                if(window.appState.currentView === 'report') window.renderYearlyReport();
            });

            const qPending = query(pendingRef, orderBy('createdAt', 'desc'));
            onSnapshot(qPending, (snapshot) => {
                window.appState.pending = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                window.renderPendingList();
            });
        }

        window.addRecord = async function() {
            if(!currentUser) { window.showToast("å°šæœªé€£ç·š"); return; }
            const newRecord = getFormData();
            if (!newRecord) return;
            try {
                await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'records'), newRecord);
                clearFormData();
                window.showToast("âœ… å·²æ”¶æ¬¾");
            } catch (e) { console.error(e); window.showToast("âŒ å„²å­˜å¤±æ•—"); }
        };
        
        // Save Record from Report (New function)
        window.addReportRecord = async function(address, year, month, amount) {
             if(!currentUser) return;
             const record = {
                date: new Date().toISOString().split('T')[0], // Default today
                address: address,
                amount: amount,
                floor: '', // Can be updated later
                months: `${year}å¹´ ${month}æœˆ`,
                note: 'è£œç™»',
                type: 'cash', // Default
                category: 'stairs', // Default, logic should fetch from cust
                collector: window.appState.currentCollector,
                status: 'completed',
                createdAt: serverTimestamp()
            };
            
            // Try to find cust defaults
            const cust = window.appState.customers.find(c => c.address === address);
            if(cust) {
                if(cust.amount) record.amount = cust.amount;
                if(cust.category) record.category = cust.category;
                if(cust.floor) record.floor = cust.floor;
            }

             try {
                await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'records'), record);
                window.closeReportActionModal(null);
                window.showToast("âœ… å·²è£œç™»");
             } catch(e) { window.showToast("è£œç™»å¤±æ•—"); }
        };
        
        window.updateReportRecord = async function(docId, date, amount) {
             if(!currentUser) return;
             try {
                 await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'records', docId), {
                     date: date,
                     amount: parseInt(amount)
                 });
                 window.closeReportActionModal(null);
                 window.showToast("å·²æ›´æ–°");
             } catch(e) { window.showToast("æ›´æ–°å¤±æ•—"); }
        };

        window.addToPending = async function() {
            if(!currentUser) { window.showToast("å°šæœªé€£ç·š"); return; }
            const newItem = getFormData();
            if (!newItem) return;
            if(newItem.status === 'completed') newItem.status = 'completed'; 
            
            try {
                await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'pending'), newItem);
                clearFormData();
                window.showToast("ğŸ“‹ å·²åŠ å…¥æ¸…å–®");
            } catch (e) { console.error(e); window.showToast("âŒ åŠ å…¥å¤±æ•—"); }
        };

        window.completePending = async function(docId, data) {
            if(!currentUser) return;
            const record = {
                ...data,
                collector: window.appState.currentCollector,
                createdAt: serverTimestamp()
            };
            try {
                await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'records'), record);
                await deleteDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'pending', docId));
                window.showToast("âœ… å®Œæˆæ”¶æ¬¾");
            } catch(e) { console.error(e); window.showToast("æ“ä½œå¤±æ•—"); }
        };

        window.deleteRecord = async function(docId) {
            if(!currentUser) return;
            if(confirm("ç¢ºå®šåˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ")) {
                await deleteDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'records', docId));
                window.showToast("ğŸ—‘ï¸ å·²åˆªé™¤");
            }
        };
        
        // For Report: Delete and Close
        window.deleteReportRecord = async function(docId) {
             if(!currentUser) return;
             if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿé€™æœˆä»½å°‡è®Šå›æœªæ”¶ç‹€æ…‹")) {
                await deleteDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'records', docId));
                window.closeReportActionModal(null);
                window.showToast("ğŸ—‘ï¸ å·²åˆªé™¤");
            }
        };
        
        window.updateRecordStatus = async function(docId, newStatus) {
             if(!currentUser) return;
             try {
                 await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'records', docId), { status: newStatus });
                 window.showToast("ç‹€æ…‹å·²æ›´æ–°");
             } catch(e) { window.showToast("æ›´æ–°å¤±æ•—"); }
        };

        window.deletePending = async function(docId) {
            if(!currentUser) return;
            if(confirm("å¾æ¸…å–®ç§»é™¤ï¼Ÿ")) {
                await deleteDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'pending', docId));
            }
        };

        window.saveCustomer = async function() {
            if(!currentUser) return;
            const addr = document.getElementById('newCustAddr').value.trim();
            const amt = parseInt(document.getElementById('newCustAmt').value);
            const floor = document.getElementById('newCustFloor').value.trim();
            const cat = document.getElementById('editCustCategory').value;
            
            if(!addr || isNaN(amt)) { alert("è«‹å¡«å¯«åœ°å€å’Œé‡‘é¡"); return; }

            const data = { 
                address: addr, 
                amount: amt, 
                floor: floor, 
                category: cat,
                collector: window.appState.currentCollector
            };
            const editId = window.appState.editingCustomerId;

            try {
                if (editId) {
                    await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'customers', editId), data);
                    window.showToast("å·²æ›´æ–°å®¢æˆ¶");
                } else {
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'customers'), data);
                    window.showToast("å·²æ–°å¢å®¢æˆ¶");
                }
                window.closeAddCustomerModal(null);
            } catch(e) { window.showToast("å„²å­˜å¤±æ•—"); }
        };

        window.deleteCustomer = async function(docId) {
            if(!currentUser) return;
            if(confirm("å¾å¸¸ç”¨åå–®ç§»é™¤ï¼Ÿ")) {
                await deleteDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'customers', docId));
            }
        };

        window.importFavoritesToPending = async function() {
            if(!currentUser) return;
            const current = window.appState.currentCollector;
            const customers = window.appState.customers.filter(c => 
                (c.collector === current) || 
                (!c.collector && current === 'å­æ™´')
            );

            if(customers.length === 0) { alert(`æ²’æœ‰ ${current} çš„å¸¸ç”¨å®¢æˆ¶è³‡æ–™`); return; }
            
            if(confirm(`ç¢ºå®šè¦å°‡ ${customers.length} å€‹å®¢æˆ¶åŠ å…¥å¾…æ”¶æ¸…å–®å—ï¼Ÿ`)) {
                try {
                    let count = 0;
                    for (const c of customers) {
                        await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'pending'), {
                            address: c.address, amount: c.amount, floor: c.floor || '', months: '', note: '', 
                            type: 'cash', category: c.category || 'stairs',
                            collector: current, status: 'completed',
                            createdAt: serverTimestamp()
                        });
                        count++;
                    }
                    window.showToast(`å·²åŒ¯å…¥ ${count} ç­†`);
                    window.toggleView('entry');
                } catch(e) { console.error(e); window.showToast("åŒ¯å…¥éƒ¨åˆ†å¤±æ•—"); }
            }
        };

        function getFormData() {
            const dateInput = document.getElementById('inputDate').value;
            const address = document.getElementById('inputAddress').value.trim();
            const floor = document.getElementById('inputFloor').value.trim();
            const amount = parseInt(document.getElementById('inputAmount').value);
            const type = document.getElementById('inputType').value;
            const categoryElement = document.getElementById('inputServiceType');
            const category = categoryElement ? categoryElement.value : 'stairs';
            const collector = window.appState.currentCollector; 
            const note = document.getElementById('inputNote').value.trim();
            const months = document.getElementById('selectedMonths').value;
            const status = document.getElementById('inputStatus').value || 'completed';

            if (!address) { window.showToast("âš ï¸ è«‹è¼¸å…¥åœ°å€ï¼"); document.getElementById('inputAddress').focus(); return null; }
            if (isNaN(amount)) { window.showToast("âš ï¸ è«‹è¼¸å…¥é‡‘é¡ï¼"); document.getElementById('inputAmount').focus(); return null; }

            return { date: dateInput, address, floor, months, amount, type, category, collector, note, status, createdAt: serverTimestamp() };
        }

        function clearFormData() {
            document.getElementById('inputAddress').value = '';
            document.getElementById('inputFloor').value = '';
            document.getElementById('inputAmount').value = '';
            document.getElementById('inputNote').value = '';
            window.resetMonthPicker();
            window.setStatus('completed'); 
        }
    </script>

    <script>
        // --- UI Logic ---
        window.appState = { 
            records: [], customers: [], pending: [], 
            currentCollector: 'å­æ™´', 
            editingCustomerId: null, 
            currentServiceCategory: 'stairs', 
            currentPendingAction: null, 
            selectedMonthsSet: new Set(), 
            currentBaseAmount: 0,
            pickerYear: 114, 
            modalPickerYear: 114,
            reportYear: 114, 
            pendingMonthTargetId: null,
            currentView: 'entry'
        };

        window.onload = function() {
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            document.getElementById('inputDate').value = dateStr;
            document.getElementById('headerDate').innerText = `${today.getMonth() + 1}/${today.getDate()} (é€±${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][today.getDay()]})`;
            const savedSalary = localStorage.getItem('cleaning_app_salary');
            if(savedSalary) document.getElementById('mySalary').value = savedSalary;
            
            if(document.getElementById('inputServiceType')) {
                window.setServiceCategory('stairs');
            }
            window.setCollector('å­æ™´');
            window.renderMonthPicker();
        };

        // --- Report Logic ---
        window.changeReportYear = function(delta) {
            window.appState.reportYear += delta;
            document.getElementById('reportYearDisplay').innerText = `${window.appState.reportYear}å¹´`;
            window.renderYearlyReport();
        };

        window.renderYearlyReport = function() {
            const container = document.getElementById('yearReportGrid');
            container.innerHTML = '';
            const year = window.appState.reportYear;
            const current = window.appState.currentCollector;

            const addressSet = new Set();
            window.appState.customers.filter(c => (c.collector === current) || (!c.collector && current === 'å­æ™´')).forEach(c => addressSet.add(c.address));
            window.appState.records.filter(r => {
                const rCol = r.collector || 'å­æ™´';
                return rCol === current;
            }).forEach(r => addressSet.add(r.address));

            const addresses = Array.from(addressSet).sort();

            if(addresses.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-10">å°šç„¡è³‡æ–™</div>';
                return;
            }

            addresses.forEach(addr => {
                const monthInfo = Array(13).fill(null); 
                const addrRecords = window.appState.records.filter(r => r.address === addr);
                
                addrRecords.forEach(r => {
                     const d = new Date(r.date);
                     const collectDate = (d instanceof Date && !isNaN(d)) ? `${d.getMonth()+1}/${d.getDate()}` : '??';

                     if (r.months && r.months.includes(`${year}å¹´`)) {
                        const parts = r.months.match(new RegExp(`${year}å¹´\\s*([0-9,]+)`));
                        if(parts && parts[1]) {
                             const paidMonths = parts[1].split(',').map(Number);
                             paidMonths.forEach(m => {
                                 if(m >= 1 && m <= 12) {
                                     let status = 'paid';
                                     if(r.status === 'no_payment' || r.status === 'no_receipt') {
                                         status = 'warning';
                                     }
                                     monthInfo[m] = { status: status, date: collectDate, id: r.id, amount: r.amount, fullDate: r.date };
                                 }
                             });
                        }
                     }
                });

                const card = document.createElement('div');
                card.className = 'bg-white p-3 rounded-lg border border-gray-100 shadow-sm';
                
                let monthHtml = '';
                for(let m=1; m<=12; m++) {
                    const info = monthInfo[m];
                    let className = 'year-dot flex flex-col justify-center leading-none';
                    let content = m; 
                    let onclick = `openReportAction('${addr}', ${year}, ${m}, null)`; // Default add
                    
                    if(info) {
                        onclick = `openReportAction('${addr}', ${year}, ${m}, '${info.id}', '${info.fullDate}', ${info.amount})`; // Edit
                        if(info.status === 'paid') {
                            className += ' paid';
                            content = `<span class="text-[8px] opacity-75">${m}æœˆ</span><span class="text-[10px]">${info.date}</span>`;
                        } else if (info.status === 'warning') {
                            className += ' warning';
                            content = `<span class="text-[8px] opacity-75">${m}æœˆ</span><span class="text-[10px]">${info.date}</span>`;
                        }
                    } else {
                        content = `<span class="text-xs">${m}</span>`;
                    }
                    
                    monthHtml += `<div class="${className}" style="height: 36px;" onclick="${onclick}">${content}</div>`;
                }

                card.innerHTML = `
                    <div class="font-bold text-gray-700 mb-2 border-b pb-1 text-sm flex justify-between">
                        <span>${addr}</span>
                        <span class="text-xs text-gray-300 font-normal">#${year}</span>
                    </div>
                    <div class="grid grid-cols-6 gap-2">
                        ${monthHtml}
                    </div>
                `;
                container.appendChild(card);
            });
        };
        
        window.openReportAction = function(address, year, month, recordId, date, amount) {
             const title = document.getElementById('reportActionTitle');
             const content = document.getElementById('reportActionContent');
             
             if(recordId) {
                 // Edit Mode
                 title.innerText = `ç·¨è¼¯ç´€éŒ„ï¼š${address} (${month}æœˆ)`;
                 content.innerHTML = `
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">æ”¶æ¬¾æ—¥æœŸ</label>
                        <input type="date" id="reportEditDate" value="${date}" class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">é‡‘é¡</label>
                        <input type="number" id="reportEditAmount" value="${amount}" class="w-full p-2 border rounded">
                    </div>
                    <div class="grid grid-cols-2 gap-2 mt-4">
                        <button onclick="deleteReportRecord('${recordId}')" class="py-2 bg-red-100 text-red-600 rounded-lg font-bold">åˆªé™¤ç´€éŒ„</button>
                        <button onclick="updateReportRecord('${recordId}', document.getElementById('reportEditDate').value, document.getElementById('reportEditAmount').value)" class="py-2 bg-blue-600 text-white rounded-lg font-bold">å„²å­˜ä¿®æ”¹</button>
                    </div>
                 `;
             } else {
                 // Add Mode
                 // Try find default amount
                 const cust = window.appState.customers.find(c => c.address === address);
                 const defAmount = cust ? cust.amount : '';
                 const today = new Date().toISOString().split('T')[0];
                 
                 title.innerText = `è£œç™»ç´€éŒ„ï¼š${address} (${month}æœˆ)`;
                 content.innerHTML = `
                    <div class="text-sm text-gray-500 mb-2">ç¢ºå®šè¦è£œç™» <strong>${year}å¹´${month}æœˆ</strong> çš„æ”¶æ¬¾å—ï¼Ÿ</div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">æ”¶æ¬¾æ—¥æœŸ</label>
                        <input type="date" id="reportAddDate" value="${today}" class="w-full p-2 border rounded">
                    </div>
                     <div>
                        <label class="block text-xs text-gray-500 mb-1">é‡‘é¡</label>
                        <input type="number" id="reportAddAmount" value="${defAmount}" placeholder="è¼¸å…¥é‡‘é¡" class="w-full p-2 border rounded">
                    </div>
                    <button onclick="addReportRecord('${address}', ${year}, ${month}, document.getElementById('reportAddAmount').value)" class="w-full py-3 bg-emerald-500 text-white rounded-lg font-bold mt-4">ç¢ºèªè£œç™»</button>
                 `;
             }
             
             document.getElementById('reportActionModal').classList.remove('hidden');
        };
        
        window.closeReportActionModal = function(e) {
            if(e && e.target !== e.currentTarget) return;
            document.getElementById('reportActionModal').classList.add('hidden');
        };

        // --- Status Toggle Logic ---
        window.setStatus = function(status) {
            const input = document.getElementById('inputStatus');
            if (input.value === status) input.value = 'completed';
            else input.value = status;
            
            const current = input.value;
            const btnReceipt = document.getElementById('btn-status-receipt');
            const btnPayment = document.getElementById('btn-status-payment');
            
            const baseClass = 'status-btn flex-1 p-2 rounded-lg font-bold border flex justify-center items-center gap-1 transition-all';
            btnReceipt.className = baseClass + ' bg-red-50 text-red-500 border-red-200';
            btnPayment.className = baseClass + ' bg-orange-50 text-orange-500 border-orange-200';
            
            if(current === 'no_receipt') {
                btnReceipt.className = baseClass + ' active active-red bg-red-100 border-red-400 text-red-700';
            } else if(current === 'no_payment') {
                btnPayment.className = baseClass + ' active active-orange bg-orange-100 border-orange-400 text-orange-700';
            } else {
                btnReceipt.style.opacity = '0.6'; btnReceipt.style.filter = 'grayscale(1)';
                btnPayment.style.opacity = '0.6'; btnPayment.style.filter = 'grayscale(1)';
                return;
            }
            btnReceipt.style.opacity = '1'; btnReceipt.style.filter = 'none';
            btnPayment.style.opacity = '1'; btnPayment.style.filter = 'none';
            if (current === 'no_receipt') { btnPayment.style.opacity = '0.6'; btnPayment.style.filter = 'grayscale(1)'; }
            else if (current === 'no_payment') { btnReceipt.style.opacity = '0.6'; btnReceipt.style.filter = 'grayscale(1)'; }
        };
        
        window.setModalStatus = function(status) {
            const input = document.getElementById('modalInputStatus');
            if (input.value === status) input.value = 'completed';
            else input.value = status;

            const current = input.value;
            const btnReceipt = document.getElementById('modal-status-receipt');
            const btnPayment = document.getElementById('modal-status-payment');
            
            const baseClass = 'status-btn flex-1 p-2 rounded-lg font-bold border flex justify-center items-center gap-1 transition-all';
            btnReceipt.className = baseClass + ' bg-red-50 text-red-500 border-red-200';
            btnPayment.className = baseClass + ' bg-orange-50 text-orange-500 border-orange-200';
            
            if(current === 'no_receipt') {
                 btnReceipt.className = baseClass + ' active active-red bg-red-100 border-red-400 text-red-700';
            } else if(current === 'no_payment') {
                 btnPayment.className = baseClass + ' active active-orange bg-orange-100 border-orange-400 text-orange-700';
            } else {
                btnReceipt.style.opacity = '0.6'; btnReceipt.style.filter = 'grayscale(1)';
                btnPayment.style.opacity = '0.6'; btnPayment.style.filter = 'grayscale(1)';
                return;
            }
            btnReceipt.style.opacity = '1'; btnReceipt.style.filter = 'none';
            btnPayment.style.opacity = '1'; btnPayment.style.filter = 'none';
             if (current === 'no_receipt') { btnPayment.style.opacity = '0.6'; btnPayment.style.filter = 'grayscale(1)'; }
             else if (current === 'no_payment') { btnReceipt.style.opacity = '0.6'; btnReceipt.style.filter = 'grayscale(1)'; }
        };

        // --- Month Picker Logic ---
        window.changeYear = function(delta) {
            window.appState.pickerYear += delta;
            window.renderMonthPicker();
            const addr = document.getElementById('inputAddress').value;
            if(addr) window.checkPaidStatus(addr);
        };

        window.renderMonthPicker = function() {
            document.getElementById('pickerYearDisplay').innerText = `${window.appState.pickerYear}å¹´`;
            const container = document.getElementById('monthPickerGrid');
            container.innerHTML = '';
            for(let i=1; i<=12; i++) {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.id = `mbtn-${i}`;
                btn.className = 'month-btn';
                btn.innerText = `${i}æœˆ`;
                btn.onclick = () => window.toggleMonth(i);
                container.appendChild(btn);
            }
            window.appState.selectedMonthsSet.forEach(key => {
                const [y, m] = key.split('-').map(Number);
                if(y === window.appState.pickerYear) {
                    const btn = document.getElementById(`mbtn-${m}`);
                    if(btn) btn.classList.add('selected');
                }
            });
        };

        window.toggleMonth = function(m) {
            const btn = document.getElementById(`mbtn-${m}`);
            if(btn.classList.contains('paid')) return;

            const key = `${window.appState.pickerYear}-${m}`;

            if(window.appState.selectedMonthsSet.has(key)) {
                window.appState.selectedMonthsSet.delete(key);
                btn.classList.remove('selected');
            } else {
                window.appState.selectedMonthsSet.add(key);
                btn.classList.add('selected');
            }
            window.updateSelectedMonthsInput();
            
            const count = window.appState.selectedMonthsSet.size;
            if(window.appState.currentBaseAmount > 0 && count > 0) {
                const total = window.appState.currentBaseAmount * count;
                document.getElementById('inputAmount').value = total;
            }
        };

        window.updateSelectedMonthsInput = function() {
            const groups = {};
            window.appState.selectedMonthsSet.forEach(key => {
                const [y, m] = key.split('-').map(Number);
                if(!groups[y]) groups[y] = [];
                groups[y].push(m);
            });

            const parts = [];
            Object.keys(groups).sort().forEach(y => {
                const months = groups[y].sort((a,b)=>a-b).join(',');
                parts.push(`${y}å¹´ ${months}æœˆ`);
            });

            document.getElementById('selectedMonths').value = parts.join(', ');
            document.getElementById('statusHint').innerText = parts.join(', ') || 'è«‹é¸æ“‡...';
        };

        window.resetMonthPicker = function() {
            window.appState.selectedMonthsSet.clear();
            document.querySelectorAll('.month-btn').forEach(b => {
                b.classList.remove('selected', 'paid');
                b.removeAttribute('data-date');
            });
            window.updateSelectedMonthsInput();
            window.appState.currentBaseAmount = 0;
        };

        let checkTimeout;
        window.debounceCheckPaidStatus = function(address) {
            clearTimeout(checkTimeout);
            checkTimeout = setTimeout(() => {
                window.checkPaidStatus(address);
            }, 500);
        };

        window.checkPaidStatus = function(address) {
            document.querySelectorAll('.month-btn').forEach(b => {
                b.classList.remove('paid');
                b.removeAttribute('data-date');
            });

            if(!address) return;
            
            const records = window.appState.records.filter(r => r.address === address);
            const paidMap = new Map();

            const regex = /(\d+)å¹´\s*([0-9,]+)/g;

            records.forEach(r => {
                if(r.months) {
                    const d = new Date(r.date);
                    const dateStr = `${d.getMonth()+1}/${d.getDate()}`;
                    let match;
                    const localRegex = new RegExp(regex);
                    while ((match = localRegex.exec(r.months)) !== null) {
                        const y = parseInt(match[1]);
                        const ms = match[2].split(',').map(Number);
                        ms.forEach(m => paidMap.set(`${y}-${m}`, dateStr));
                    }
                }
            });

            const currentPickerYear = window.appState.pickerYear;
            
            for(let m=1; m<=12; m++) {
                const key = `${currentPickerYear}-${m}`;
                if(paidMap.has(key)) {
                    const btn = document.getElementById(`mbtn-${m}`);
                    if(btn) {
                        btn.classList.add('paid');
                        btn.setAttribute('data-date', paidMap.get(key));
                        if(window.appState.selectedMonthsSet.has(key)) {
                            window.appState.selectedMonthsSet.delete(key);
                            btn.classList.remove('selected');
                        }
                    }
                }
            }

            window.updateSelectedMonthsInput();

            const cust = window.appState.customers.find(c => c.address === address);
            if(cust) {
                window.appState.currentBaseAmount = cust.amount;
                if(cust.floor) document.getElementById('inputFloor').value = cust.floor;
                if(cust.category) window.setServiceCategory(cust.category);
            } else {
                window.appState.currentBaseAmount = 0;
            }
        };

        window.setCollector = function(name) {
            window.appState.currentCollector = name;
            const tabs = { 'å­æ™´': 'tab-zih-cing', 'å­æ¶µ': 'tab-zih-han', 'å®—æ•¬': 'tab-zong-jing' };
            const activeClasses = { 'å­æ™´': 'active-zih-cing', 'å­æ¶µ': 'active-zih-han', 'å®—æ•¬': 'active-zong-jing' };
            const themeColors = { 'å­æ™´': 'bg-[#c2a992]', 'å­æ¶µ': 'bg-[#ff99ac]', 'å®—æ•¬': 'bg-sky-400' };
            const btnColors = { 'å­æ™´': 'bg-[#c2a992] text-white', 'å­æ¶µ': 'bg-[#ff99ac] text-white', 'å®—æ•¬': 'bg-sky-400 text-white' };
            const qsColors = { 'å­æ™´': 'bg-[#a38e7a]', 'å­æ¶µ': 'bg-pink-400', 'å®—æ•¬': 'bg-sky-500' };
            const cardColors = { 'å­æ™´': 'border-[#e6dbd0]', 'å­æ¶µ': 'border-[#ffc1cc]', 'å®—æ•¬': 'border-sky-300' };
            const icons = { 'å­æ™´': 'ğŸ ', 'å­æ¶µ': 'ğŸŒ¸', 'å®—æ•¬': 'â˜ï¸' };

            Object.values(tabs).forEach(id => {
                const el = document.getElementById(id);
                el.classList.remove('active-zih-cing', 'active-zih-han', 'active-zong-jing', 'bg-white', 'text-gray-800');
                el.classList.add('text-gray-400');
            });
            document.getElementById(tabs[name]).classList.add(activeClasses[name]);
            document.getElementById(tabs[name]).classList.remove('text-gray-400');

            document.getElementById('mainHeader').className = `${themeColors[name]} text-white pt-safe sticky top-0 z-20 shadow-lg transition-colors duration-300`;
            document.getElementById('addBtn').className = `w-full btn-primary py-4 rounded-xl text-lg font-bold shadow-lg shadow-gray-300 flex justify-center items-center gap-2 transition-all active:scale-95 ${btnColors[name]}`;
            document.getElementById('quickSelectBtn').className = `${qsColors[name]} text-white text-sm px-4 py-2 rounded-lg shadow active:scale-95 flex items-center transition-all`;
            
            const card = document.getElementById('entryCard');
            card.className = `card p-5 border-t-4 transition-colors duration-300 ${cardColors[name]}`;

            document.getElementById('listTitleName').innerText = name;
            document.getElementById('listTitleIcon').innerText = icons[name];
            document.getElementById('settlePageTitle').innerText = `${name} çš„è–ªæ°´çµç®—`;

            renderRecords();
            renderCustomerSettings();
            renderPendingList();
            updateSummary();
            if(window.appState.currentView === 'report') window.renderYearlyReport();
        };

        window.setServiceCategory = function(cat) {
            window.appState.currentServiceCategory = cat;
            const input = document.getElementById('inputServiceType');
            if(input) input.value = cat;
            
            const btnStairs = document.getElementById('btn-cat-stairs');
            const btnTank = document.getElementById('btn-cat-tank');
            
            if (btnStairs && btnTank) {
                btnStairs.className = 'service-btn p-3 rounded-xl bg-orange-50 text-orange-400 font-bold flex justify-center items-center gap-2 shadow-sm';
                btnTank.className = 'service-btn p-3 rounded-xl bg-cyan-50 text-cyan-400 font-bold flex justify-center items-center gap-2 shadow-sm';
                
                if(cat === 'stairs') {
                    btnStairs.classList.add('active', 'text-orange-700', 'border-orange-200');
                    btnStairs.classList.remove('text-orange-400');
                } else {
                    btnTank.classList.add('active', 'text-cyan-700', 'border-cyan-200');
                    btnTank.classList.remove('text-cyan-400');
                }
            }
        };

        window.setEditCustCategory = function(cat) {
            document.getElementById('editCustCategory').value = cat;
            const s = document.getElementById('edit-cat-stairs');
            const t = document.getElementById('edit-cat-tank');
            
            s.className = 'p-2 rounded border text-sm font-bold bg-gray-50 text-gray-400 border-gray-200';
            t.className = 'p-2 rounded border text-sm font-bold bg-gray-50 text-gray-400 border-gray-200';
            
            if(cat === 'stairs') s.className = 'p-2 rounded border text-sm font-bold bg-orange-100 text-orange-800 border-orange-200';
            else t.className = 'p-2 rounded border text-sm font-bold bg-cyan-100 text-cyan-800 border-cyan-200';
        };

        window.renderPendingList = function() {
            const list = document.getElementById('pendingList');
            const container = document.getElementById('pendingContainer');
            const current = window.appState.currentCollector;
            const items = window.appState.pending.filter(i => 
                (i.collector === current) || (!i.collector && current === 'å­æ™´')
            );
            
            if (items.length === 0) { container.classList.add('hidden'); return; }
            container.classList.remove('hidden');
            document.getElementById('pendingCount').innerText = items.length;
            list.innerHTML = '';

            items.forEach(item => {
                const floorId = `p-floor-${item.id}`;
                const monthsId = `p-months-${item.id}`;
                const noteId = `p-note-${item.id}`;
                const typeId = `p-type-${item.id}`;
                const catIcon = item.category === 'tank' ? '<span class="text-cyan-600">ğŸ’§</span>' : '<span class="text-orange-600">ğŸªœ</span>';

                const div = document.createElement('div');
                div.className = 'bg-white p-3 rounded-xl border border-gray-200 shadow-sm relative';
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                            <div class="text-xl">${catIcon}</div>
                            <div>
                                <div class="font-bold text-lg text-gray-800">${item.address}</div>
                            </div>
                        </div>
                        <div class="font-bold text-emerald-600 text-lg">$${item.amount}</div>
                    </div>
                    <div class="space-y-2">
                        <div class="flex gap-2">
                            <input id="${monthsId}" value="${item.months || ''}" readonly onclick="openPendingMonthPicker('${item.id}', '${item.months||''}')" placeholder="é¸æ“‡æœˆä»½" class="bg-blue-50 border border-blue-200 rounded p-2 text-sm w-1/2 text-center text-blue-700 font-bold cursor-pointer">
                            <input id="${floorId}" value="${item.floor || ''}" placeholder="æ¨“å±¤/æˆ¶è™Ÿ" class="bg-gray-50 border rounded p-2 text-sm w-1/2 text-center font-medium">
                        </div>
                        <div class="flex gap-2 items-center">
                            <select id="${typeId}" class="bg-gray-50 border rounded p-2 text-sm w-20">
                                <option value="cash" ${item.type === 'cash' ? 'selected' : ''}>ç¾é‡‘</option>
                                <option value="transfer" ${item.type === 'transfer' ? 'selected' : ''}>åŒ¯æ¬¾</option>
                                <option value="linepay" ${item.type === 'linepay' ? 'selected' : ''}>LinePay</option>
                                <option value="dad" ${item.type === 'dad' ? 'selected' : ''}>åŒ¯çµ¦çˆ¸çˆ¸</option>
                            </select>
                            <input id="${noteId}" value="${item.note || ''}" placeholder="å‚™è¨»..." class="bg-gray-50 border rounded p-2 text-sm flex-1">
                            <button onclick="openConfirmCollectionModal('${item.id}', ${item.amount}, '${item.address}', '${item.category || 'stairs'}')" class="bg-green-500 text-white w-10 h-10 rounded-full shadow flex items-center justify-center active:scale-90 transition-transform flex-shrink-0">
                                <i class="fa-solid fa-check"></i>
                            </button>
                        </div>
                    </div>
                    <button onclick="deletePending('${item.id}')" class="absolute top-2 right-2 text-gray-300 hover:text-red-400 p-1"><i class="fa-solid fa-times"></i></button>
                `;
                list.appendChild(div);
            });
        };

        // --- PENDING MONTH PICKER ---
        window.openPendingMonthPicker = function(itemId, currentStr) {
            window.appState.pendingMonthTargetId = itemId;
            window.appState.modalPickerYear = 114; 
            
            window.appState.tempModalSet = new Set();
            const regex = /(\d+)å¹´\s*([0-9,]+)/g;
            let match;
            while ((match = regex.exec(currentStr)) !== null) {
                const y = parseInt(match[1]);
                const ms = match[2].split(',').map(Number);
                ms.forEach(m => window.appState.tempModalSet.add(`${y}-${m}`));
            }

            renderModalMonthGrid();
            document.getElementById('monthPickerModal').classList.remove('hidden');
        };

        window.changeModalYear = function(delta) {
            window.appState.modalPickerYear += delta;
            renderModalMonthGrid();
        };

        function renderModalMonthGrid() {
            const y = window.appState.modalPickerYear;
            document.getElementById('modalYearDisplay').innerText = `${y}å¹´`;
            document.getElementById('modalYearDisplaySpan').innerText = `${y}å¹´`;
            const grid = document.getElementById('modalMonthGrid');
            grid.innerHTML = '';
            
            for(let i=1; i<=12; i++) {
                const key = `${y}-${i}`;
                const btn = document.createElement('button');
                const isSelected = window.appState.tempModalSet.has(key);
                
                btn.className = `month-btn ${isSelected ? 'selected' : ''} p-2 rounded text-center`;
                btn.innerText = `${i}æœˆ`;
                btn.onclick = function() {
                    if(window.appState.tempModalSet.has(key)) {
                        window.appState.tempModalSet.delete(key);
                        this.classList.remove('selected');
                    } else {
                        window.appState.tempModalSet.add(key);
                        this.classList.add('selected');
                    }
                };
                grid.appendChild(btn);
            }
        }

        window.closeMonthPickerModal = function(e) {
            if(e && e.target !== e.currentTarget) return;
            document.getElementById('monthPickerModal').classList.add('hidden');
        };

        window.applyModalMonths = function() {
            const groups = {};
            window.appState.tempModalSet.forEach(key => {
                const [y, m] = key.split('-').map(Number);
                if(!groups[y]) groups[y] = [];
                groups[y].push(m);
            });
            const parts = [];
            Object.keys(groups).sort().forEach(y => {
                const months = groups[y].sort((a,b)=>a-b).join(',');
                parts.push(`${y}å¹´ ${months}æœˆ`);
            });
            
            const targetId = window.appState.pendingMonthTargetId;
            if(targetId) {
                document.getElementById(`p-months-${targetId}`).value = parts.join(', ');
            }
            closeMonthPickerModal(null);
        };

        // --- NEW MODAL LOGIC ---
        window.openConfirmCollectionModal = function(id, amount, address, category) {
            const floor = document.getElementById(`p-floor-${id}`).value;
            const months = document.getElementById(`p-months-${id}`).value;
            const note = document.getElementById(`p-note-${id}`).value;
            const type = document.getElementById(`p-type-${id}`).value;

            window.appState.currentPendingAction = { id, amount, address, category, floor, months, note, type };
            document.getElementById('confirmModalAddress').innerText = address;
            document.getElementById('confirmModalMonths').value = months; 
            document.getElementById('confirmModalAmount').innerText = `$${amount}`;
            
            // Pre-fill note if existing
            document.getElementById('confirmModalNote').value = note || '';

            const today = new Date().toISOString().split('T')[0];
            document.getElementById('confirmModalDate').value = today;
            
            document.getElementById('confirmModalType').value = type;
            
            // Reset status in modal
            window.setModalStatus('completed');

            document.getElementById('confirmCollectionModal').classList.remove('hidden');
            document.getElementById('confirmCollectionBtn').onclick = doConfirmCollection;
        };

        window.closeConfirmCollectionModal = function(e) {
            if(e && e.target !== e.currentTarget) return;
            document.getElementById('confirmCollectionModal').classList.add('hidden');
        };

        window.doConfirmCollection = function() {
            const action = window.appState.currentPendingAction;
            if(!action) return;

            const date = document.getElementById('confirmModalDate').value;
            const months = document.getElementById('confirmModalMonths').value; 
            const type = document.getElementById('confirmModalType').value; 
            const status = document.getElementById('modalInputStatus').value;
            // Get note from modal input
            const note = document.getElementById('confirmModalNote').value;

            if(!date) { alert("è«‹é¸æ“‡æ—¥æœŸ"); return; }

            window.completePending(action.id, {
                date: date,
                amount: action.amount,
                address: action.address,
                floor: action.floor,
                months: months,
                note: note, // Use updated note
                type: type,
                category: action.category,
                status: status
            });

            closeConfirmCollectionModal(null);
        };

        window.openHistory = function(address) {
            const list = document.getElementById('historyList');
            const title = document.getElementById('historyTitle');
            title.innerText = address;
            list.innerHTML = '';
            
            const history = window.appState.records.filter(r => r.address === address);
            
            if(history.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-400 py-10">å°šç„¡æ­¤åœ°å€çš„ç´€éŒ„</div>';
            } else {
                history.forEach(h => {
                    const d = new Date(h.date);
                    const dateStr = `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`;
                    let typeText = 'ç¾é‡‘';
                    if(h.type === 'transfer') typeText = 'åŒ¯æ¬¾';
                    if(h.type === 'linepay') typeText = 'LinePay';
                    if(h.type === 'dad') typeText = 'åŒ¯çµ¦çˆ¸çˆ¸';

                    const row = document.createElement('div');
                    row.className = 'p-3 border-b border-gray-100 flex justify-between items-center';
                    row.innerHTML = `
                        <div>
                            <div class="text-sm font-bold text-gray-800">${dateStr} <span class="text-xs text-gray-500">(${h.collector})</span></div>
                            <div class="text-xs text-blue-500">${h.months || 'æœªå¡«æœˆä»½'}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-emerald-600">$${h.amount}</div>
                            <div class="text-xs text-gray-400">${typeText}</div>
                        </div>
                    `;
                    list.appendChild(row);
                });
            }
            document.getElementById('historyModal').classList.remove('hidden');
        };

        window.closeHistory = function(e) {
            if(e && e.target !== e.currentTarget) return;
            document.getElementById('historyModal').classList.add('hidden');
        };

        window.renderRecords = function() {
            const list = document.getElementById('recordList');
            const records = window.appState.records.filter(r => {
                const rCol = r.collector || 'å­æ™´'; 
                return rCol === window.appState.currentCollector;
            });
            list.innerHTML = '';
            document.getElementById('recordCount').innerText = records.length;

            if (records.length === 0) {
                list.innerHTML = `<div class="text-center text-gray-400 py-12 opacity-60"><i class="fa-solid fa-clipboard-list text-4xl mb-3"></i><p>å°šç„¡ ${window.appState.currentCollector} çš„ç´€éŒ„</p></div>`;
                return;
            }

            records.forEach(record => {
                // Tag determination
                let tagClass = 'tag-cash';
                let tagText = 'ç¾é‡‘';
                if(record.type === 'transfer') { tagClass = 'tag-transfer'; tagText = 'åŒ¯æ¬¾'; }
                else if(record.type === 'linepay') { tagClass = 'tag-linepay'; tagText = 'LinePay'; }
                else if(record.type === 'dad') { tagClass = 'tag-dad'; tagText = 'å·²åŒ¯çµ¦çˆ¸çˆ¸'; }

                let noteHtml = record.note ? `<div class="text-sm mt-2 p-2 rounded-lg border border-gray-100 bg-gray-50 text-gray-600 flex items-center gap-2"><i class="fa-regular fa-comment-dots"></i> <span>${record.note}</span></div>` : '';
                const dateObj = new Date(record.date);
                const displayDate = `${dateObj.getMonth()+1}/${dateObj.getDate()}`;
                
                let sTag = '';
                if(record.category === 'tank') sTag = `<span class="text-xs font-bold px-2 py-0.5 rounded-full tag-tank flex items-center gap-1">ğŸ’§ æ´—æ°´å¡”</span>`;
                else sTag = `<span class="text-xs font-bold px-2 py-0.5 rounded-full tag-stairs flex items-center gap-1">ğŸªœ æ´—æ¨“æ¢¯</span>`;

                // Status Check
                let statusHtml = '';
                if(record.status === 'no_receipt') {
                    statusHtml = `
                        <div class="mt-2 bg-red-50 p-2 rounded-lg border border-red-200 flex justify-between items-center">
                            <span class="text-xs font-bold text-red-600"><i class="fa-solid fa-triangle-exclamation"></i> å¾…çµ¦æ”¶æ“š</span>
                            <button onclick="updateRecordStatus('${record.id}', 'completed')" class="px-3 py-1 bg-red-500 text-white text-xs rounded-full shadow active:scale-95">å·²è£œå–®</button>
                        </div>
                    `;
                } else if(record.status === 'no_payment') {
                    statusHtml = `
                        <div class="mt-2 bg-orange-50 p-2 rounded-lg border border-orange-200 flex justify-between items-center">
                            <span class="text-xs font-bold text-orange-600"><i class="fa-solid fa-hourglass-half"></i> å¾…ç¢ºèªåŒ¯æ¬¾</span>
                            <button onclick="updateRecordStatus('${record.id}', 'completed')" class="px-3 py-1 bg-orange-500 text-white text-xs rounded-full shadow active:scale-95">æ¬¾é …å·²å…¥</button>
                        </div>
                    `;
                }

                const item = document.createElement('div');
                item.className = 'card p-4 relative border-l-4 ' + (record.type === 'cash' ? 'border-gray-400' : 'border-gray-300');
                item.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1 mr-2">
                            <div class="flex items-center gap-2 mb-1 flex-wrap">
                                <span class="text-xs font-bold text-gray-400 bg-gray-100 px-1.5 py-0.5 rounded">${displayDate}</span>
                                ${sTag}
                                <span class="text-xs font-bold px-2 py-0.5 rounded-full ${tagClass} flex items-center gap-1">
                                    ${tagText}
                                </span>
                            </div>
                            <div class="text-xl font-bold text-gray-800 leading-tight mb-1">
                                ${record.address} 
                                <span class="text-base font-normal text-gray-500 ml-1">${record.floor || ''}</span>
                            </div>
                            <div class="text-sm text-blue-600 font-bold bg-blue-50 inline-block px-2 py-0.5 rounded border border-blue-100">
                                <i class="fa-regular fa-calendar-check mr-1"></i> ${record.months || 'æœªå¡«æœˆä»½'}
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold font-mono text-gray-800">$${record.amount.toLocaleString()}</div>
                        </div>
                    </div>
                    ${statusHtml}
                    ${noteHtml}
                    <button onclick="deleteRecord('${record.id}')" class="absolute top-2 right-2 text-gray-200 hover:text-red-400 p-2"><i class="fa-solid fa-trash-can"></i></button>
                `;
                list.appendChild(item);
            });
        };

        window.renderCustomerSettings = function() {
            const list = document.getElementById('customerListSettings');
            const current = window.appState.currentCollector;
            const customers = window.appState.customers.filter(c => 
                (c.collector === current) || 
                (!c.collector && current === 'å­æ™´')
            );

            list.innerHTML = '';
            if(customers.length === 0) { list.innerHTML = `<div class="text-center text-gray-400 text-xs py-2">å°šæœªå»ºç«‹ ${current} çš„å¸¸ç”¨å®¢æˆ¶</div>`; return; }
            
            customers.forEach(c => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-3 bg-white rounded-lg border border-gray-100 mb-2 shadow-sm';
                const catIcon = c.category === 'tank' ? 'ğŸ’§' : 'ğŸªœ';
                div.innerHTML = `
                    <div class="text-sm">
                        <div class="font-bold text-gray-800"><span class="mr-1">${catIcon}</span> ${c.address} <span class="text-gray-400 text-xs font-normal">${c.floor || 'ä¸å›ºå®š'}</span></div>
                        <div class="text-emerald-600 font-bold">$${c.amount}</div>
                    </div>
                    <div class="flex">
                        <button onclick="openHistory('${c.address}')" class="text-orange-400 hover:text-orange-600 px-2 py-2"><i class="fa-solid fa-clock-rotate-left"></i></button>
                        <button onclick="openEditCustomerModal('${c.id}', '${c.address}', ${c.amount}, '${c.floor || ''}', '${c.category || 'stairs'}')" class="text-gray-400 hover:text-blue-500 px-2 py-2"><i class="fa-solid fa-pen"></i></button>
                        <button onclick="deleteCustomer('${c.id}')" class="text-gray-300 hover:text-red-500 px-2 py-2"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                `;
                list.appendChild(div);
            });
        };

        window.renderCustomerSelect = function() {
            const list = document.getElementById('customerSelectList');
            const search = document.getElementById('customerSearch').value.toLowerCase();
            const current = window.appState.currentCollector;
            const customers = window.appState.customers.filter(c => 
                (c.collector === current) || (!c.collector && current === 'å­æ™´')
            );

            list.innerHTML = '';
            const filtered = customers.filter(c => c.address.toLowerCase().includes(search));
            
            document.getElementById('customerModalCollector').innerText = current;

            if(filtered.length === 0 && search.length > 0) { 
                const btn = document.createElement('button');
                btn.className = 'w-full p-4 bg-blue-50 text-blue-600 rounded-xl font-bold flex items-center justify-center border border-blue-200 active:bg-blue-100';
                btn.onclick = () => selectCustomer(search, '', '', 'stairs'); 
                btn.innerHTML = `<i class="fa-solid fa-plus mr-2"></i> ç›´æ¥å¡«å¯«ï¼š${search}`;
                list.appendChild(btn);
                return; 
            }

            filtered.forEach(c => {
                // Find Last Record
                const lastRec = window.appState.records.find(r => r.address === c.address);
                let lastInfo = 'å°šç„¡ç´€éŒ„';
                if(lastRec) {
                    const d = new Date(lastRec.date);
                    lastInfo = `ä¸Šæ¬¡ï¼š${d.getMonth()+1}/${d.getDate()} (${lastRec.months || '?'}) - ${lastRec.collector}`;
                }

                const btn = document.createElement('button');
                btn.className = 'list-btn w-full p-3 bg-gray-50 border border-gray-100 rounded-xl flex justify-between items-center text-left mb-2 active:bg-blue-50';
                btn.onclick = () => selectCustomer(c.address, c.floor, c.amount, c.category);
                const catIcon = c.category === 'tank' ? 'ğŸ’§' : 'ğŸªœ';
                btn.innerHTML = `
                    <div>
                        <div class="font-bold text-gray-800 text-lg"><span class="mr-1">${catIcon}</span>${c.address} <span class="text-sm font-normal text-gray-500">${c.floor || ''}</span></div>
                        <div class="text-xs text-gray-400 mt-1">${lastInfo}</div>
                    </div>
                    <div class="font-bold text-emerald-600">$${c.amount}</div>
                `;
                list.appendChild(btn);
            });
        };

        window.selectCustomer = function(addr, floor, amount, category) {
            document.getElementById('inputAddress').value = addr;
            document.getElementById('inputFloor').value = floor || '';
            document.getElementById('inputAmount').value = amount || '';
            if(category) window.setServiceCategory(category);
            window.checkPaidStatus(addr); 
            closeCustomerSelect(null);
            showToast("å·²å¡«å…¥è³‡æ–™");
        };

        window.updateSummary = function() {
            let totalCashAll = 0, totalTransferAll = 0, totalLinePayAll = 0, totalDadAll = 0;
            let totalCashMe = 0, totalTransferMe = 0, totalLinePayMe = 0, totalDadMe = 0;
            let breakdown = { 'å­æ™´': { cash: 0, transfer: 0 }, 'å­æ¶µ': { cash: 0, transfer: 0 }, 'å®—æ•¬': { cash: 0, transfer: 0 }, 'å…¶ä»–': { cash: 0, transfer: 0 } };
            let catStats = { 'stairs': 0, 'tank': 0 };
            
            // Warnings
            let pendingReceiptCount = 0;
            let pendingPaymentCount = 0;

            const current = window.appState.currentCollector;

            window.appState.records.forEach(r => {
                let col = r.collector;
                if(!col || (col !== 'å­æ™´' && col !== 'å­æ¶µ' && col !== 'å®—æ•¬')) {
                    col = 'å…¶ä»–';
                    if (r.collector === 'æˆ‘') col = 'å…¶ä»–';
                    if (r.collector === 'å¦¹') col = 'å…¶ä»–';
                    if (r.collector === 'å¼Ÿ') col = 'å…¶ä»–';
                }

                // Handle Status Warning
                if (col === current) {
                    if (r.status === 'no_receipt') pendingReceiptCount++;
                    if (r.status === 'no_payment') pendingPaymentCount++;
                }

                // Logic: If status is 'no_payment', do NOT include in totals yet
                if (r.status === 'no_payment') return;

                // Stats
                if (r.type === 'cash') {
                    totalCashAll += r.amount;
                    if (col === current) totalCashMe += r.amount;
                    breakdown[col].cash += r.amount;
                } else if (r.type === 'transfer') {
                    totalTransferAll += r.amount;
                    if (col === current) totalTransferMe += r.amount;
                    breakdown[col].transfer += r.amount;
                } else if (r.type === 'linepay') {
                    totalLinePayAll += r.amount;
                    if (col === current) totalLinePayMe += r.amount;
                } else if (r.type === 'dad') {
                    totalDadAll += r.amount;
                    if (col === current) totalDadMe += r.amount;
                }

                const cat = r.category === 'tank' ? 'tank' : 'stairs';
                catStats[cat] += r.amount;
            });
            
            const grandTotalMe = totalCashMe + totalTransferMe + totalLinePayMe + totalDadMe;
            const userHolding = totalCashMe + totalTransferMe + totalLinePayMe; // Dad money not held
            const fmt = (n) => `$${n.toLocaleString()}`;

            document.getElementById('headerCashTotal').innerText = fmt(totalCashMe + totalLinePayMe);
            document.getElementById('headerTransferTotal').innerText = fmt(totalTransferMe);
            document.getElementById('headerGrandTotal').innerText = fmt(grandTotalMe);
            
            document.getElementById('settleCash').innerText = fmt(totalCashMe);
            document.getElementById('settleTransfer').innerText = fmt(totalTransferMe);
            document.getElementById('settleLinePay').innerText = fmt(totalLinePayMe);
            document.getElementById('settleDad').innerText = fmt(totalDadMe);
            document.getElementById('settleTotal').innerText = fmt(grandTotalMe);

            // Calculate Final to Dad: (User Holding) - Salary
            const salary = parseInt(document.getElementById('mySalary').value) || 0;
            const finalToDad = userHolding - salary;
            document.getElementById('finalToDad').innerText = fmt(finalToDad);

            document.getElementById('categoryBreakdown').innerHTML = `
                <div class="bg-white p-3 rounded-lg border border-orange-200 text-center">
                    <div class="text-xs text-orange-600 font-bold mb-1">ğŸªœ æ´—æ¨“æ¢¯ (å…¨éƒ¨)</div>
                    <div class="text-xl font-bold text-gray-800">${fmt(catStats.stairs)}</div>
                </div>
                <div class="bg-white p-3 rounded-lg border border-cyan-200 text-center">
                    <div class="text-xs text-cyan-600 font-bold mb-1">ğŸ’§ æ´—æ°´å¡” (å…¨éƒ¨)</div>
                    <div class="text-xl font-bold text-gray-800">${fmt(catStats.tank)}</div>
                </div>
            `;
            
            // Render Warnings
            const warningContainer = document.getElementById('settleWarnings');
            warningContainer.innerHTML = '';
            if (pendingReceiptCount > 0 || pendingPaymentCount > 0) {
                warningContainer.classList.remove('hidden');
                if (pendingReceiptCount > 0) {
                    warningContainer.innerHTML += `<div class="bg-red-100 text-red-800 p-3 rounded-lg text-sm font-bold flex items-center"><i class="fa-solid fa-triangle-exclamation mr-2"></i> æ‚¨æœ‰ ${pendingReceiptCount} ç­†å¸³æ¬¾é‚„æ²’çµ¦æ”¶æ“šï¼</div>`;
                }
                if (pendingPaymentCount > 0) {
                    warningContainer.innerHTML += `<div class="bg-orange-100 text-orange-800 p-3 rounded-lg text-sm font-bold flex items-center"><i class="fa-solid fa-hourglass-half mr-2"></i> æ‚¨æœ‰ ${pendingPaymentCount} ç­†åŒ¯æ¬¾å°šæœªç¢ºèªå…¥å¸³ï¼</div>`;
                }
            } else {
                warningContainer.classList.add('hidden');
            }
        };

        window.calculateSettlement = function() {
            window.updateSummary(); // Re-trigger calculation
        };

        window.addTag = function(text) { const el = document.getElementById('inputNote'); el.value = el.value ? el.value + `ï¼Œ${text}` : text; };
        window.toggleView = function(viewName) {
            window.appState.currentView = viewName;
            ['entry', 'settle', 'settings', 'report'].forEach(v => {
                document.getElementById(`view-${v}`).classList.add('hidden');
                const btn = document.getElementById(`nav-${v}`);
                if(btn) {
                     btn.classList.remove('text-emerald-600'); btn.classList.add('text-gray-400');
                     btn.querySelector('span').className = 'text-[10px] font-medium';
                }
            });
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            const active = document.getElementById(`nav-${viewName}`);
            active.classList.remove('text-gray-400'); active.classList.add('text-emerald-600');
            active.querySelector('span').className = 'text-[10px] font-bold';
            window.scrollTo(0,0);
            
            // Refresh Report on switch
            if(viewName === 'report') window.renderYearlyReport();
        };
        window.showToast = function(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.display = 'block';
            t.style.opacity = '1'; t.style.transform = 'translate(-50%, 0)';
            setTimeout(() => { t.style.display = 'none'; }, 2000);
        };
        window.exportData = function() {
            const data = window.appState;
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `é›²ç«¯æ”¶è²»å‚™ä»½_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
        };
        
        // --- PRINT LOGIC ---
        window.printAllRecords = function() {
            const records = window.appState.records;
            if (records.length === 0) {
                window.showToast("ç›®å‰æ²’æœ‰ç´€éŒ„å¯åˆ—å°");
                return;
            }

            let totalCash = 0;
            let totalTransfer = 0;
            let totalLinePay = 0;
            let totalDad = 0;
            let totalAmount = 0;

            // Calculate totals
            records.forEach(r => {
                // Exclude pending payments from print totals
                if (r.status === 'no_payment') return;

                if(r.type === 'cash') totalCash += r.amount;
                else if(r.type === 'transfer') totalTransfer += r.amount;
                else if(r.type === 'linepay') totalLinePay += r.amount;
                else if(r.type === 'dad') totalDad += r.amount;
                totalAmount += r.amount;
            });

            const dateStr = new Date().toLocaleDateString('zh-TW', {year: 'numeric', month: '2-digit', day: '2-digit'});

            let html = `
                <div class="print-title">æ¸…æ½”æ”¶è²»ç¸½å ±è¡¨</div>
                <div style="text-align:center; margin-bottom:10px;">åˆ—å°æ—¥æœŸï¼š${dateStr}</div>
                
                <div class="print-summary">
                    <div>
                        <div style="font-size:12px;">æœ¬æœŸç¸½æ”¶å…¥</div>
                        <div style="font-size:16px; font-weight:bold;">$${totalAmount.toLocaleString()}</div>
                    </div>
                    <div>
                        <div style="font-size:12px;">ç¾é‡‘ç¸½é¡</div>
                        <div style="font-size:16px; font-weight:bold;">$${totalCash.toLocaleString()}</div>
                    </div>
                    <div>
                        <div style="font-size:12px;">åŒ¯æ¬¾ç¸½é¡</div>
                        <div style="font-size:16px; font-weight:bold;">$${totalTransfer.toLocaleString()}</div>
                    </div>
                    <div>
                        <div style="font-size:12px;">LinePay</div>
                        <div style="font-size:16px; font-weight:bold;">$${totalLinePay.toLocaleString()}</div>
                    </div>
                    <div>
                        <div style="font-size:12px;">å·²åŒ¯çµ¦çˆ¸çˆ¸</div>
                        <div style="font-size:16px; font-weight:bold;">$${totalDad.toLocaleString()}</div>
                    </div>
                </div>

                <table class="print-table">
                    <thead>
                        <tr>
                            <th width="12%">æ—¥æœŸ</th>
                            <th width="10%">ç¶“æ‰‹äºº</th>
                            <th width="25%">åœ°å€/å®¢æˆ¶</th>
                            <th width="10%">é …ç›®</th>
                            <th width="10%">é‡‘é¡</th>
                            <th width="10%">æ–¹å¼</th>
                            <th width="13%">æœˆä»½</th>
                            <th width="10%">å‚™è¨»</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            records.forEach(r => {
                const d = new Date(r.date);
                const dStr = `${d.getMonth()+1}/${d.getDate()}`;
                const cat = r.category === 'tank' ? 'æ°´å¡”' : 'æ¨“æ¢¯';
                let type = 'ç¾é‡‘';
                if(r.type === 'transfer') type = 'åŒ¯æ¬¾';
                if(r.type === 'linepay') type = 'LinePay';
                if(r.type === 'dad') type = 'å·²åŒ¯çˆ¸';
                
                // Mark status in print
                let note = r.note || '';
                if(r.status === 'no_receipt') note += ' (æ¬ æ”¶æ“š)';
                if(r.status === 'no_payment') note += ' (æœªå…¥å¸³)';

                const collector = r.collector || 'å­æ™´';
                const floor = r.floor ? `(${r.floor})` : '';

                html += `
                    <tr>
                        <td>${dStr}</td>
                        <td>${collector}</td>
                        <td>${r.address} ${floor}</td>
                        <td>${cat}</td>
                        <td style="font-weight:bold;">$${r.amount.toLocaleString()}</td>
                        <td>${type}</td>
                        <td style="font-size:11px;">${r.months || ''}</td>
                        <td style="font-size:11px;">${note}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            document.getElementById('printContainer').innerHTML = html;
            window.print();
        };

        window.openAddCustomerModal = function() {
            window.appState.editingCustomerId = null;
            document.getElementById('customerModalTitle').innerHTML = '<i class="fa-solid fa-user-plus text-green-600"></i> æ–°å¢å¸¸ç”¨å®¢æˆ¶';
            document.getElementById('newCustAddr').value = ''; 
            document.getElementById('newCustAmt').value = ''; 
            document.getElementById('newCustFloor').value = '';
            document.getElementById('addCustomerModal').classList.remove('hidden'); 
            window.setEditCustCategory('stairs'); // Default
            setTimeout(() => document.getElementById('newCustAddr').focus(), 100);
        };
        
        window.openEditCustomerModal = function(id, addr, amt, floor, cat) {
            window.appState.editingCustomerId = id;
            document.getElementById('customerModalTitle').innerHTML = '<i class="fa-solid fa-pen-to-square text-blue-600"></i> ç·¨è¼¯å¸¸ç”¨å®¢æˆ¶';
            document.getElementById('newCustAddr').value = addr;
            document.getElementById('newCustAmt').value = amt;
            document.getElementById('newCustFloor').value = floor;
            window.setEditCustCategory(cat || 'stairs');
            document.getElementById('addCustomerModal').classList.remove('hidden');
        };

        window.closeAddCustomerModal = function(e) { if(e && e.target !== e.currentTarget) return; document.getElementById('addCustomerModal').classList.add('hidden'); };
        window.openCustomerSelect = function() {
            // Show modal directly, logic moved inside render
            renderCustomerSelect(); 
            document.getElementById('customerModal').classList.remove('hidden');
        };
        window.closeCustomerSelect = function(e) { if(e && e.target !== e.currentTarget) return; document.getElementById('customerModal').classList.add('hidden'); };
    </script>
</body>
</html>
